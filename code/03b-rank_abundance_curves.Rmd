---
title: "rank abundance curves"
author: "An Bui"
date: "7/16/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
source(here::here("code", "00-set_up.R"))
```

Using BiodiversityR to create rank abundance curves for control plots only.

```{r}
traj_df <- percov %>% 
  # filter for algae only
  filter(group == "algae" & treatment == "CONTROL" & scientific_name != "Macrocystis pyrifera") %>% 
  # calculate mean and sum percent cover across 4 quads (i.e. per transect)
  group_by(sample_ID, scientific_name) %>% 
  summarize(mean_pc = mean(percent_cover),
            sum_pc = sum(percent_cover)) %>% 
  ungroup() %>% 
  # filter out species with 0 observations
  filter(sum_pc > 0) %>% 
  select(-sum_pc) %>% 
  # get into wide form
  pivot_wider(names_from = "scientific_name", values_from = "mean_pc") %>% 
  # make the sample_ID column row names
  column_to_rownames("sample_ID") %>% 
  # replace NA with 0
  replace(is.na(.), 0)

traj_meta <- percov %>% 
  # filter for algae only
  filter(group == "algae" & treatment == "CONTROL") %>% 
  select(sample_ID, date, site, treatment, exp_dates) %>% 
  unite("date_site", date, site, remove = FALSE) %>% 
  # only keep unique descriptors
  unique() %>% 
  arrange(sample_ID) %>% 
  column_to_rownames("sample_ID") %>% 
  mutate(site = as_factor(site))
```

Doing this just for control plots.
```{r}
# calculate rank abundance
control_ra <- rankabundance(traj_df)

# plot, just to get a sense of what's going on
rankabunplot(control_ra, scale = "abundance", addit = FALSE, specnames = c(1:5))

# basically sets up a data frame to plot in ggplot, if desired
control_comp <- rankabuncomp(traj_df, y = traj_meta, factor = "site",
                             return.data = TRUE, specnames = c(1:5), legend = FALSE)

# plot in ggplot
ggplot(control_comp, aes(x = rank, y = abundance)) +
  geom_line(aes(color = Grouping)) +
  geom_point(aes(color = Grouping)) +
  geom_text_repel(data = subset(control_comp, labelit == TRUE),
                  aes(color = Grouping, label = species)) +
  labs(x = "Rank", 
       y = "Abundance (percent cover)",
       color = "Site") +
  facet_wrap(~Grouping)

# ggsave(here::here("figures", "control-ra-percov.jpg"), width = 8, height = 5, dpi = 200)
```

Looks like there's a lot of CCA at CARP, no surprise. Idk if the MOHK plot checks out with what I'd expect, because there's a lot there that's not just Rhodymenia and Chondracanthus. Going to try this with biomass.  

Now biomass, for control plots.

```{r}
control_biomass <- biomass %>% 
  filter(group == "algae" & treatment == "CONTROL" & scientific_name != "Macrocystis pyrifera") %>% 
  # calculate total dry mass per survey
  group_by(site, year, month, treatment, date, scientific_name) %>% 
  summarize(total_biomass = sum(dry_gm2)) %>% 
  ungroup() %>% 
  # create a sample_ID for each sampling date at each site
  unite("sample_ID", site, date, remove = FALSE) %>% 
    # get into wide form
  pivot_wider(names_from = "scientific_name", values_from = "total_biomass") %>% 
  # make the sample_ID column row names
  column_to_rownames("sample_ID") %>% 
  # replace NA with 0
  replace(is.na(.), 0) %>% 
  select(-(site:date))
```

```{r}
# calculate rank abundance
control_ra_bio <- rankabundance(control_biomass)

# plot, just to get a sense of what's going on
rankabunplot(control_ra_bio, scale = "abundance", addit = FALSE, specnames = c(1:5))

# basically sets up a data frame to plot in ggplot, if desired
control_comp_bio <- rankabuncomp(control_biomass, y = traj_meta, factor = "site",
                             return.data = TRUE, specnames = c(1:5), legend = FALSE) %>% 
  rename("site" = Grouping)

# plot in ggplot
ggplot(control_comp_bio, aes(x = rank, y = abundance)) +
  geom_line(aes(color = Grouping)) +
  geom_point(aes(color = Grouping)) +
  geom_text_repel(data = subset(control_comp_bio, labelit == TRUE),
                  aes(color = Grouping, label = species)) +
  labs(x = "Rank", 
       y = "Abundance",
       color = "Site") +
  facet_wrap(~site)

# ggsave(here::here("figures", "control-ra-biomass.jpg"), width = 8, height = 5, dpi = 200)
```

Create a table with the rank abundance plot results using data frame `control_comp_bio`.
```{r}
rankabund_table_fxn <- function(df, site_selection) {
  df %>% 
    select(species, rank, proportion, site) %>% 
    filter(site == {{ site_selection }} & proportion > 1) %>% 
    group_by(site) %>% 
    gt(rowname_col = "species") %>% 
    gtsave(paste("rankabund-table-", site_selection, ".pdf", sep = ""), path = here::here("tables"))
}

for(i in 1:length(LTE_sites)) {
  site_selection <- LTE_sites[i]
  rankabund_table_fxn(control_comp_bio, site_selection)
}
```

Create a table with the rank abundance results using the annual biomass surveys.
```{r}
annual_biomass <- biomass_annual %>% 
  filter(group == "algae" & scientific_name != "Macrocystis pyrifera") %>% 
  # calculate total dry mass per survey
  group_by(site, year, month, date, scientific_name) %>% 
  summarize(total_biomass = sum(dry_gm2)) %>% 
  ungroup() %>% 
  # create a sample_ID for each sampling date at each site
  unite("sample_ID", site, date, remove = FALSE) %>% 
    # get into wide form
  pivot_wider(names_from = "scientific_name", values_from = "total_biomass") %>% 
  # make the sample_ID column row names
  column_to_rownames("sample_ID") %>% 
  # replace NA with 0
  replace(is.na(.), 0) %>% 
  select(-(site:date))

annual_meta <- biomass_annual %>% 
  # filter for algae only
  filter(group == "algae" & scientific_name != "Macrocystis pyrifera") %>% 
  select(sample_ID, date, site) %>% 
  unite("date_site", date, site, remove = FALSE) %>% 
  # only keep unique descriptors
  unique() %>% 
  arrange(sample_ID) %>% 
  column_to_rownames("sample_ID") %>% 
  mutate(site = as_factor(site))

annual_comp_bio <- rankabuncomp(annual_biomass, y = annual_meta, factor = "site",
                             return.data = TRUE, specnames = c(1:5), legend = FALSE) %>% 
    rename("site" = Grouping) %>% 
  mutate(site = fct_relevel(site, c("BULL", "AQUE", "AHND", "NAPL", "IVEE", "GOLB", "ABUR", "MOHK", "CARP", "SCDI", "SCTW")))

for(i in 1:length(LTER_sites)) {
  site_selection <- LTER_sites[i]
  rankabund_table_fxn(annual_comp_bio, site_selection)
}

rankabund_table_fxn(annual_comp_bio, "AQUE")
```

making a table of species x site, each cell is proportion of biomass at site
```{r}
sp_site_table <- annual_comp_bio %>% 
  select(species, site, proportion) %>% 
  pivot_wider(names_from = "site", values_from = "proportion") %>% 
  # order sites
  # select(species, BULL, AQUE, AHND, NAPL, IVEE, GOLB, ABUR, MOHK, CARP, SCDI, SCTW) %>% 
  # select only sites of interest
  select(species, BULL, AQUE, IVEE, MOHK, CARP) %>% 
  # filter for common species
  filter(species %in% common_algae_df$scientific_name)

sp_site_table %>% 
  gt(rowname_col = "species") %>% 
  data_color(columns = vars(BULL, AQUE, IVEE, MOHK, CARP),
             colors = scales::col_numeric(palette = c("#FFFFFF", "#009BB0"), domain = c(0, 50.9))) %>% 
  fmt_missing(columns = 2:6,
              missing_text = "--") %>% 
  gtsave("sp_site_table-selection.png", path = here::here("tables"))
  
```

