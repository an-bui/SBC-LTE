---
title: "Community"
author: "An Bui"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 0. set up
```{r}
source(here::here("code", "00-set_up.R"))
```

# 1. data wrangling

Getting a community matrix and its metadata together.

```{r}
comm_df <- biomass %>% 
  filter(sp_code != "MAPY") %>% 
  new_group_column() %>% 
  dplyr::select(site, year, month, treatment, date, new_group, sp_code, dry_gm2) %>% 
  pivot_wider(names_from = treatment, values_from = dry_gm2) %>% 
  dplyr::select(-annual) %>% 
  mutate(delta_continual = continual - control) %>% 
  drop_na(delta_continual) %>% 
  # take out years where continual removal hadn't happened yet
  drop_na(delta_continual) %>% 
  mutate(exp_dates = case_when(
    # after for continual removal:
    site == "aque" & date >= aque_after_date_continual ~ "after",
    site == "napl" & date >= napl_after_date_continual ~ "after",
    site == "mohk" & date >= mohk_after_date_continual ~ "after",
    site == "carp" & date >= carp_after_date_continual ~ "after",
    # everything else is "during" the experiment
    TRUE ~ "during"
  ),
  exp_dates = fct_relevel(exp_dates, c("during", "after"))) %>% 
  time_since_columns_continual() %>% 
  kelp_year_column() %>% 
  comparison_column_continual() %>% 
  left_join(., enframe(sites_full), by = c("site" = "name")) %>% 
  rename(site_full = value) %>% 
  mutate(site_full = fct_relevel(site_full, "Arroyo Quemado", "Naples", "Mohawk", "Carpinteria")) %>% 
  full_join(., site_quality, by = "site") %>% 
  dplyr::select(-delta_continual) %>% 
  pivot_longer(cols = c(control, continual), names_to = "treatment", values_to = "dry_gm2") %>% 
  # create sample_ID
  unite("sample_ID", site, treatment, date, sep = "_", remove = FALSE) %>% 
  filter(site != "ivee")

comm_meta_continual <- comm_df %>% 
  select(sample_ID:exp_dates, quarter:treatment, -sp_code, -new_group) %>% 
  filter(treatment == "continual") %>% 
  drop_na(comp_2yrs) %>% 
  # weird point?
  filter(sample_ID != "mohk_control_2020-08-12") %>% 
  unique()

comm_meta_control <- comm_df %>% 
  select(sample_ID:exp_dates, quarter:treatment, -sp_code, -new_group) %>% 
  filter(treatment == "control") %>% 
  drop_na(comp_2yrs) %>% 
  # weird point?
  filter(sample_ID != "mohk_control_2020-08-12") %>% 
  unique()

comm_mat_continual_algae <- comm_df %>% 
  filter(new_group == "algae") %>% 
  filter(sample_ID %in% comm_meta_continual$sample_ID) %>% 
  select(sample_ID, sp_code, dry_gm2) %>% 
  pivot_wider(names_from = sp_code, values_from = dry_gm2) %>% 
  # make the sample_ID column row names
  column_to_rownames("sample_ID") %>% 
  replace(is.na(.), 0)

comm_mat_control_algae <- comm_df %>% 
  filter(new_group == "algae") %>% 
  filter(sample_ID %in% comm_meta_control$sample_ID) %>% 
  select(sample_ID, sp_code, dry_gm2) %>% 
  pivot_wider(names_from = sp_code, values_from = dry_gm2) %>% 
  # make the sample_ID column row names
  column_to_rownames("sample_ID") %>% 
  replace(is.na(.), 0)
  

comm_mat_continual_epi_inverts <- comm_df %>% 
  filter(new_group == "epi_inverts") %>% 
  filter(sample_ID %in% comm_meta_continual$sample_ID) %>% 
  select(sample_ID, sp_code, dry_gm2) %>% 
  pivot_wider(names_from = sp_code, values_from = dry_gm2) %>% 
  # make the sample_ID column row names
  column_to_rownames("sample_ID") %>% 
  replace(is.na(.), 0)

comm_mat_control_epi_inverts <- comm_df %>% 
  filter(new_group == "epi_inverts") %>% 
  filter(sample_ID %in% comm_meta_control$sample_ID) %>% 
  select(sample_ID, sp_code, dry_gm2) %>% 
  pivot_wider(names_from = sp_code, values_from = dry_gm2) %>% 
  # make the sample_ID column row names
  column_to_rownames("sample_ID") %>% 
  replace(is.na(.), 0)

```

# 2. Bray-Curtis 

## a. algae: removal plots
```{r}
bc_continual_dist <- vegdist(comm_mat_continual_algae, "bray")
bc_continual_nmds <- metaMDS(comm_mat_continual_algae, "bray")
stressplot(bc_continual_nmds)

bc_continual_plotdf <- scores(bc_continual_nmds, display = "sites") %>%
    as_tibble() %>% 
    bind_cols(comm_meta_continual, .)

simper_algae <- simper(comm_mat_continual_algae, comm_meta_continual$treatment)
simper_algae
# PTCA, CYOS, DL, CC, EC, R, CO

bc_continual_species <- scores(bc_continual_nmds, display = "species") %>% 
  as.data.frame() %>% 
  rownames_to_column("sp_code") %>% 
  filter(sp_code %in% c("PTCA", "CYOS", "DL", "CC", "EC", "R", "CO")) %>% 
  left_join(., spp_names, by = "sp_code")

adonis2(comm_mat_continual_algae ~ comp_2yrs, data = comm_meta_continual)

algae_betadisper <- betadisper(bc_continual_dist, comm_meta_continual$comp_2yrs)
anova(algae_betadisper)
# not significantly different in dispersion
```

### i. centroids
```{r}
# centroids
algae_scores <- scores(bc_continual_nmds, display = c("sites"))

algae_centroids <- aggregate(algae_scores ~ comp_2yrs*site_full, data = comm_meta_continual, FUN = "mean")

aque_centroids_contin <- algae_centroids %>% 
  filter(site_full == "Arroyo Quemado")
napl_centroids_contin <- algae_centroids %>% 
  filter(site_full == "Naples")
mohk_centroids_contin <- algae_centroids %>% 
  filter(site_full == "Mohawk")
carp_centroids_contin <- algae_centroids %>% 
  filter(site_full == "Carpinteria")

# aque_centroids_cont <- algae_centroids %>% 
#   filter(site_full == "Arroyo Quemado" & treatment == "control")
# napl_centroids_cont <- algae_centroids %>% 
#   filter(site_full == "Naples" & treatment == "control")
# mohk_centroids_cont <- algae_centroids %>% 
#   filter(site_full == "Mohawk" & treatment == "control")
# carp_centroids_cont <- algae_centroids %>% 
#   filter(site_full == "Carpinteria" & treatment == "control")

aque_continual_plotdf <- bc_continual_plotdf %>% 
  filter(site_full == "Arroyo Quemado")
napl_continual_plotdf <- bc_continual_plotdf %>% 
  filter(site_full == "Naples")
mohk_continual_plotdf <- bc_continual_plotdf %>% 
  filter(site_full == "Mohawk")
carp_continual_plotdf <- bc_continual_plotdf %>% 
  filter(site_full == "Carpinteria")

# aque_control_plotdf <- bc_continual_plotdf %>% 
#   filter(site_full == "Arroyo Quemado" & treatment == "control")
# napl_control_plotdf <- bc_continual_plotdf %>% 
#   filter(site_full == "Naples" & treatment == "control")
# mohk_control_plotdf <- bc_continual_plotdf %>% 
#   filter(site_full == "Mohawk" & treatment == "control")
# carp_control_plotdf <- bc_continual_plotdf %>% 
#   filter(site_full == "Carpinteria" & treatment == "control")
```

### ii. sda plot
```{r}
algae_sda_nmds_plot <- ggplot(bc_continual_plotdf, aes(x = NMDS1, y = NMDS2)) +
  # make sure plot is square (ratio comes from axis limits)
  coord_fixed(3.75/2.75) +
  # x and y axes at 0
  geom_vline(xintercept = 0, color = "grey", lty = 2) +
  geom_hline(yintercept = 0, color = "grey", lty = 2) +
  # site points
  geom_point(aes(shape = site_full, fill = comp_2yrs), size = 4, alpha = 0.9) +
  # ellipse
  stat_ellipse(aes(color = comp_2yrs), size = 1) +
  # colors and linetypes
  scale_alpha_manual(values = c("continual" = 1), guide = "none") +
  scale_color_manual(values = c(start_col, during_col, after_col), guide = "none") +
  scale_fill_manual(values = c(start_col, during_col, after_col), guide = "none") +
  scale_linetype_manual(values = c("continual" = 1)) +
  scale_shape_manual(values = c(aque_shape, napl_shape, mohk_shape, carp_shape)) +
  # arrows for species from SIMPER
  geom_text_repel(data = bc_continual_species, 
                  aes(x = NMDS1, y = NMDS2, 
                      label = stringr::str_wrap(scientific_name, 10, width = 40)),
                  color = "#C70000", lineheight = 0.8) +
  geom_segment(data = bc_continual_species,
               aes(x = 0, y = 0,
                   xend = NMDS1, yend = NMDS2),
               arrow = arrow(length = unit(0.5, "cm")), 
               color = "#C70000", size = 1) +
  # plot aesthetics
  theme_classic() +
  scale_x_continuous(limits = c(-1.75, 2)) +
  scale_y_continuous(limits = c(-1.25, 1.5), breaks = seq(-1, 1.5, by = 1)) +
  theme(axis.title = element_text(size = 22),
        axis.text = element_text(size = 20),
        legend.text = element_text(size = 20), 
        legend.title = element_text(size = 20),
        legend.position = "none") +
  # ellipse labels. clown shit
  annotate("text", x = -1.2, y = -0.75, label = "Start of", size = 10, col = start_col) +
  annotate("text", x = -1.2, y = -0.9, label = "removal", size = 10, col = start_col) +
  annotate("text", x = 1.7, y = 0.85, label = "End of", size = 10, col = during_col) +
  annotate("text", x = 1.7, y = 0.7, label = "removal", size = 10, col = during_col) +
  annotate("text", x = -1.4, y = 1.05, label = "Recovery", size = 10, col = after_col) +
  annotate("text", x = -1.4, y = 0.9, label = "period", size = 10, col = after_col) +
  # stress annotation
  annotate("text", x = -1.6, y = -1.25, label = "Stress = 0.2", size = 5)
algae_sda_nmds_plot
```

### iii. year centroids

```{r}
comm_meta_continual <- comm_df %>% 
  select(sample_ID:exp_dates, quarter:treatment, -sp_code, -new_group) %>% 
  # drop_na(comp_2yrs) %>% 
  # weird point?
  filter(sample_ID != "mohk_control_2020-08-12") %>% 
  unique()

comm_mat_continual_algae <- comm_df %>% 
  filter(new_group == "algae") %>% 
  filter(sample_ID %in% comm_meta_continual$sample_ID) %>% 
  select(sample_ID, sp_code, dry_gm2) %>% 
  pivot_wider(names_from = sp_code, values_from = dry_gm2) %>% 
  # make the sample_ID column row names
  column_to_rownames("sample_ID") %>% 
  replace(is.na(.), 0)

bc_continual_dist <- vegdist(comm_mat_continual_algae, "bray")
bc_continual_nmds <- metaMDS(comm_mat_continual_algae, "bray")

bc_continual_plotdf <- scores(bc_continual_nmds, display = "sites") %>%
    as_tibble() %>% 
    bind_cols(comm_meta_continual, .)

adonis2(comm_mat_continual_algae ~ kelp_year, data = comm_meta_continual)

algae_betadisper <- betadisper(bc_continual_dist, comm_meta_continual$kelp_year)
anova(algae_betadisper)

algae_scores <- scores(bc_continual_nmds, display = "sites", "species")
algae_year_centroids <- aggregate(algae_scores ~ site_full*treatment*kelp_year, data = comm_meta_continual, FUN = "mean")

aque_centroids_contin <- algae_year_centroids %>% 
  filter(site_full == "Arroyo Quemado" & treatment == "continual")
napl_centroids_contin <- algae_year_centroids %>% 
  filter(site_full == "Naples" & treatment == "continual")
mohk_centroids_contin <- algae_year_centroids %>% 
  filter(site_full == "Mohawk" & treatment == "continual")
carp_centroids_contin <- algae_year_centroids %>% 
  filter(site_full == "Carpinteria" & treatment == "continual")

aque_centroids_cont <- algae_year_centroids %>% 
  filter(site_full == "Arroyo Quemado" & treatment == "control")
napl_centroids_cont <- algae_year_centroids %>% 
  filter(site_full == "Naples" & treatment == "control")
mohk_centroids_cont <- algae_year_centroids %>% 
  filter(site_full == "Mohawk" & treatment == "control")
carp_centroids_cont <- algae_year_centroids %>% 
  filter(site_full == "Carpinteria" & treatment == "control")

ggplot(aque_centroids_contin, aes(x = NMDS1, y = NMDS2, alpha = treatment)) +
  geom_segment(aes(x = NMDS1, y = NMDS2, 
                   xend = c(tail(NMDS1, n = -1), NA), 
                   yend = c(tail(NMDS2, n = -1), NA)),
               arrow = arrow(length = unit(0.3, "cm")),
               size = 1, color = aque_col) +
  geom_segment(data = napl_centroids_contin, 
               aes(x = NMDS1, y = NMDS2, 
                   xend = c(tail(NMDS1, n = -1), NA), 
                   yend = c(tail(NMDS2, n = -1), NA)),
               arrow = arrow(length = unit(0.3, "cm")),
               size = 1, color = napl_col) +
  geom_segment(data = mohk_centroids_contin, 
               aes(x = NMDS1, y = NMDS2, 
                   xend = c(tail(NMDS1, n = -1), NA), 
                   yend = c(tail(NMDS2, n = -1), NA)),
               arrow = arrow(length = unit(0.3, "cm")),
               size = 1, color = mohk_col) +
  geom_segment(data = carp_centroids_contin, 
               aes(x = NMDS1, y = NMDS2, 
                   xend = c(tail(NMDS1, n = -1), NA), 
                   yend = c(tail(NMDS2, n = -1), NA)),
               arrow = arrow(length = unit(0.3, "cm")),
               size = 1, color = carp_col) +
  geom_segment(data = aque_centroids_cont,
               aes(x = NMDS1, y = NMDS2, 
                   xend = c(tail(NMDS1, n = -1), NA), 
                   yend = c(tail(NMDS2, n = -1), NA)),
               arrow = arrow(length = unit(0.3, "cm")),
               size = 1, color = aque_col) +
  geom_segment(data = napl_centroids_cont, 
               aes(x = NMDS1, y = NMDS2, 
                   xend = c(tail(NMDS1, n = -1), NA), 
                   yend = c(tail(NMDS2, n = -1), NA)),
               arrow = arrow(length = unit(0.3, "cm")),
               size = 1, color = napl_col) +
  geom_segment(data = mohk_centroids_cont, 
               aes(x = NMDS1, y = NMDS2, 
                   xend = c(tail(NMDS1, n = -1), NA), 
                   yend = c(tail(NMDS2, n = -1), NA)),
               arrow = arrow(length = unit(0.3, "cm")),
               size = 1, color = mohk_col) +
  geom_segment(data = carp_centroids_cont, 
               aes(x = NMDS1, y = NMDS2, 
                   xend = c(tail(NMDS1, n = -1), NA), 
                   yend = c(tail(NMDS2, n = -1), NA)),
               arrow = arrow(length = unit(0.3, "cm")),
               size = 1, color = carp_col) +
  scale_alpha_manual(values = c("continual" = 1, "control" = 0.6)) +
  coord_cartesian() +
  theme_classic()

  
```


## b. algae: control only

```{r}
bc_control_dist <- vegdist(comm_mat_control_algae, "bray")
bc_control_nmds <- metaMDS(comm_mat_control_algae, "bray")
stressplot(bc_control_nmds)

bc_control_plotdf <- scores(bc_control_nmds, display = "sites") %>%
    as_tibble() %>% 
    bind_cols(comm_meta_control, .)

bc_control_species <- scores(bc_control_nmds, display = "species") %>% 
  as.data.frame() %>% 
  rownames_to_column("scientific_name")

adonis2(comm_mat_control_algae ~ comp_2yrs, data = comm_meta_control)
anova(betadisper(bc_control_dist, comm_meta_control$comp_2yrs))
# differences in dispersion

algae_control_sda_nmds_plot <- ggplot(bc_control_plotdf, aes(x = NMDS1, y = NMDS2, fill = comp_2yrs)) +
  coord_fixed(3.75/2.5) +
  geom_vline(xintercept = 0, color = "grey", lty = 2) +
  geom_hline(yintercept = 0, color = "grey", lty = 2) +
  geom_point(aes(shape = site_full, fill = comp_2yrs), size = 4, alpha = 0.9) +
  stat_ellipse(aes(color = comp_2yrs), size = 1, lty = 2) +
  # scale_alpha_manual(values = c("control" = 0.5, "continual" = 1), guide = "none") +
  scale_color_manual(values = c(start_col, during_col, after_col), guide = "none") +
  scale_fill_manual(values = c(start_col, during_col, after_col), guide = "none") +
  scale_linetype_manual(values = c("control" = 2, "continual" = 1)) +
  scale_shape_manual(values = c(aque_shape, napl_shape, mohk_shape, carp_shape)) +
  theme_classic() +
  scale_x_continuous(limits = c(-1.75, 2)) +
  scale_y_continuous(limits = c(-1, 1.5), breaks = seq(-1, 1.5, by = 1)) +
  theme(axis.title = element_text(size = 22),
        axis.text = element_text(size = 20),
        legend.text = element_text(size = 20), 
        legend.title = element_text(size = 20),
        # plot.margin = margin(0, 0, 0, 0),
        legend.position = "none") +
  annotate("text", x = -1.5, y = -0.75, label = "Start of", size = 10, col = start_col) +
  annotate("text", x = -1.5, y = -0.85, label = "removal", size = 10, col = start_col) +
  annotate("text", x = 1.7, y = 0.85, label = "End of", size = 10, col = during_col) +
  annotate("text", x = 1.7, y = 0.75, label = "removal", size = 10, col = during_col) +
  annotate("text", x = -1.4, y = 1.05, label = "Recovery", size = 10, col = after_col) +
  annotate("text", x = -1.4, y = 0.95, label = "period", size = 10, col = after_col) +
  annotate("text", x = -1.6, y = -1, label = "Stress = 0.2", size = 5)
algae_control_sda_nmds_plot
```

## c. inverts: removal plots

```{r}
bc_inverts_continual_dist <- vegdist(comm_mat_continual_epi_inverts, "bray")
bc_inverts_continual_nmds <- metaMDS(comm_mat_continual_epi_inverts, "bray")
stressplot(bc_inverts_continual_nmds)

bc_inverts_continual_plotdf <- scores(bc_inverts_continual_nmds, display = "sites") %>%
    as_tibble() %>% 
    bind_cols(comm_meta_continual, .)

simper_inverts <- simper(comm_mat_continual_epi_inverts, comm_meta_continual$treatment)
summary(simper_inverts)
# MUCA, ANSP, TEAU, STMO, CRGI, URLO, CUSP

bc_inverts_continual_species <- scores(bc_inverts_continual_nmds, display = "species") %>% 
  as.data.frame() %>% 
  rownames_to_column("sp_code") %>% 
  filter(sp_code %in% c("MUCA", "ANSP", "TEAU", "STMO", "CRGI", "URLO", "CUSP")) %>% 
  left_join(., spp_names, by = "sp_code")

adonis2(comm_mat_continual_epi_inverts ~ comp_2yrs, data = comm_meta_continual)

inverts_betadisper <- betadisper(bc_inverts_continual_dist, comm_meta_continual$comp_2yrs)
anova(inverts_betadisper)
# significantly different in dispersion
```

### i. centroids

no centroids, I've decided

### ii. sda plot
```{r}
inverts_sda_nmds_plot <- ggplot(bc_inverts_continual_plotdf, aes(x = NMDS1, y = NMDS2)) +
  coord_fixed(3/3.25) +
  geom_vline(xintercept = 0, color = "grey", lty = 2) +
  geom_hline(yintercept = 0, color = "grey", lty = 2) +
  geom_point(aes(shape = site_full, fill = comp_2yrs), size = 4, alpha = 0.9) +
  stat_ellipse(aes(color = comp_2yrs), size = 1) +
  # scale_alpha_manual(values = c("control" = 0.5, "continual" = 1), guide = "none") +
  scale_color_manual(values = c(start_col, during_col, after_col), guide = "none") +
  scale_fill_manual(values = c(start_col, during_col, after_col), guide = "none") +
  scale_linetype_manual(values = c("control" = 2, "continual" = 1)) +
  scale_shape_manual(values = c(aque_shape, napl_shape, mohk_shape, carp_shape)) +
  # arrows for species from SIMPER
  geom_text_repel(data = bc_inverts_continual_species, 
                  aes(x = NMDS1, y = NMDS2, label = stringr::str_wrap(scientific_name, 10, width = 30)),
                  color = "#C70000", lineheight = 0.8) +
  geom_segment(data = bc_inverts_continual_species,
               aes(x = 0, y = 0,
                   xend = NMDS1, yend = NMDS2),
               arrow = arrow(length = unit(0.5, "cm")), 
               color = "#C70000", size = 1) +
  theme_classic() +
  scale_x_continuous(limits = c(-1.5, 1.5)) +
  scale_y_continuous(limits = c(-1.75, 1.5), breaks = seq(-2, 2, by = 1)) +
  theme(axis.title = element_text(size = 22),
        axis.text = element_text(size = 20),
        legend.text = element_text(size = 20), 
        legend.title = element_text(size = 20)) +
  labs(shape = "Site") +
  annotate("text", x = -0.5, y = -1.1, label = "Start of", size = 10, col = start_col) +
  annotate("text", x = -0.5, y = -1.25, label = "removal", size = 10, col = start_col) +
  annotate("text", x = 0.8, y = -1.3, label = "End of", size = 10, col = during_col) +
  annotate("text", x = 0.8, y = -1.45, label = "removal", size = 10, col = during_col) +
  annotate("text", x = 1.3, y = -0.3, label = "Recovery", size = 10, col = after_col) +
  annotate("text", x = 1.3, y = -0.45, label = "period", size = 10, col = after_col) +
  annotate("text", x = -1.4, y = -1.75, label = "Stress = 0.3", size = 5)
inverts_sda_nmds_plot
```

## d. inverts: control

```{r}
bc_inverts_control_dist <- vegdist(comm_mat_control_epi_inverts, "bray")
bc_inverts_control_nmds <- metaMDS(comm_mat_control_epi_inverts, "bray")
stressplot(bc_inverts_control_nmds)

bc_inverts_control_plotdf <- scores(bc_inverts_control_nmds, display = "sites") %>%
    as_tibble() %>% 
    bind_cols(comm_meta_control, .)

bc_inverts_control_species <- scores(bc_inverts_control_nmds, display = "species") %>% 
  as.data.frame() %>% 
  rownames_to_column("scientific_name")

simper_inverts <- simper(comm_mat_control_epi_inverts, comm_meta_control$treatment)
summary(simper_inverts)
# MUCA, ANSP, TEAU, STMO, CRGI, URLO, CUSP

adonis2(comm_mat_control_epi_inverts ~ comp_2yrs, data = comm_meta_control)

inverts_betadisper <- betadisper(bc_inverts_control_dist, comm_meta_control$comp_2yrs)
anova(inverts_betadisper)
# significantly different in dispersion

inverts_control_sda_nmds_plot <- ggplot(bc_inverts_control_plotdf, aes(x = NMDS1, y = NMDS2, fill = comp_2yrs)) +
  coord_fixed(3/3.25) +
  geom_vline(xintercept = 0, color = "grey", lty = 2) +
  geom_hline(yintercept = 0, color = "grey", lty = 2) +
  geom_point(aes(shape = site_full, fill = comp_2yrs), size = 4, alpha = 0.9) +
  stat_ellipse(aes(color = comp_2yrs), size = 1, lty = 2) +
  # scale_alpha_manual(values = c("control" = 0.5, "continual" = 1), guide = "none") +
  scale_color_manual(values = c(start_col, during_col, after_col), guide = "none") +
  scale_fill_manual(values = c(start_col, during_col, after_col), guide = "none") +
  scale_linetype_manual(values = c("control" = 2, "continual" = 1)) +
  scale_shape_manual(values = c(aque_shape, napl_shape, mohk_shape, carp_shape)) +
  theme_classic() +
  scale_x_continuous(limits = c(-1.5, 1.5)) +
  scale_y_continuous(limits = c(-1.75, 1.5), breaks = seq(-2, 2, by = 1)) +
  theme(axis.title = element_text(size = 22),
        axis.text = element_text(size = 20),
        legend.text = element_text(size = 20), 
        legend.title = element_text(size = 20)) +
  labs(shape = "Site") +
  annotate("text", x = -1, y = -1.3, label = "Start of", size = 10, col = start_col) +
  annotate("text", x = -1, y = -1.45, label = "removal", size = 10, col = start_col) +
  annotate("text", x = 0.7, y = -1.35, label = "End of", size = 10, col = during_col) +
  annotate("text", x = 0.7, y = -1.5, label = "removal", size = 10, col = during_col) +
  annotate("text", x = 1.2, y = 0.4, label = "Recovery", size = 10, col = after_col) +
  annotate("text", x = 1.2, y = 0.25, label = "period", size = 10, col = after_col) +
  annotate("text", x = -1.4, y = -1.75, label = "Stress = 0.2", size = 5)
inverts_control_sda_nmds_plot
```


## e. potential manuscript figures

```{r}
fig4 <- (algae_sda_nmds_plot | inverts_sda_nmds_plot) +
  plot_layout(widths = c(1, 1)) +
  plot_annotation(tag_levels = "A") &
  theme(plot.tag = element_text(size = 30))

fig4

ggsave(here::here("figures", paste("fig4_", todays_date, ".jpg", sep = "")), plot = fig4, height = 9.5, width = 22, dpi = 150)

supp_control <- (algae_control_sda_nmds_plot | inverts_control_sda_nmds_plot) +
  plot_layout(widths = c(1, 1)) +
  plot_annotation(tag_levels = "A") &
  theme(plot.tag = element_text(size = 30))
supp_control

ggsave(here::here("figures", paste("fig4_supp_", todays_date, ".jpg", sep = "")), plot = supp_control, height = 9.5, width = 22, dpi = 150)
```


# 3. rank abundances

```{r}
# algae: 2 year comparison
start_meta <- comm_meta_continual %>% 
  filter(comp_2yrs == "start") 

start_algae <- comm_mat_continual_algae %>% 
  rownames_to_column("sample_ID") %>% 
  filter(sample_ID %in% start_meta$sample_ID) %>% 
  column_to_rownames("sample_ID")

during_meta <- comm_meta_continual %>% 
  filter(comp_2yrs == "during") 

during_algae <- comm_mat_continual_algae %>% 
  rownames_to_column("sample_ID") %>% 
  filter(sample_ID %in% during_meta$sample_ID) %>% 
  column_to_rownames("sample_ID")

after_meta <- comm_meta_continual %>% 
  filter(comp_2yrs == "after")

after_algae <- comm_mat_continual_algae %>% 
  rownames_to_column("sample_ID") %>% 
  filter(sample_ID %in% after_meta$sample_ID) %>% 
  column_to_rownames("sample_ID")

# ranks for first 2 years of experiment
ra_algae_start_control <- rankabundance(x = start_algae, y = start_meta,
              factor = "treatment", level = c("control")) %>% 
  as.data.frame() %>% 
  rownames_to_column("sp_code") %>% 
  dplyr::select(sp_code, rank, proportion, pupper, plower) %>% 
  pivot_longer(cols = c("rank", "proportion"), names_to = "metric", values_to = "abund") %>% 
  mutate(exp_dates = "start")

ra_algae_start_continual <- rankabundance(x = start_algae, y = start_meta,
                                           factor = "treatment", level = c("continual")) %>% 
  as.data.frame() %>% 
  rownames_to_column("sp_code") %>% 
  dplyr::select(sp_code, rank, proportion, pupper, plower) %>% 
  pivot_longer(cols = c("rank", "proportion"), names_to = "metric", values_to = "abund") %>% 
  mutate(exp_dates = "start")
 
# ranks for last 2 years of experiment
ra_algae_during_control <- rankabundance(x = during_algae, y = during_meta,
              factor = "treatment", level = c("control")) %>% 
  as.data.frame() %>% 
  rownames_to_column("sp_code") %>% 
  dplyr::select(sp_code, rank, proportion, pupper, plower) %>% 
  pivot_longer(cols = c("rank", "proportion"), names_to = "metric", values_to = "abund") %>% 
  mutate(exp_dates = "during")

ra_algae_during_continual <- rankabundance(x = during_algae, y = during_meta,
                                           factor = "treatment", level = c("continual")) %>% 
  as.data.frame() %>% 
  rownames_to_column("sp_code") %>% 
  dplyr::select(sp_code, rank, proportion, pupper, plower) %>% 
  pivot_longer(cols = c("rank", "proportion"), names_to = "metric", values_to = "abund") %>% 
  mutate(exp_dates = "during")

# ranks for most recent 2 years
ra_algae_after_control <- rankabundance(x = after_algae, y = after_meta,
              factor = "treatment", level = c("control")) %>% 
  as.data.frame() %>% 
  rownames_to_column("sp_code") %>% 
  dplyr::select(sp_code, rank, proportion, pupper, plower) %>% 
  pivot_longer(cols = c("rank", "proportion"), names_to = "metric", values_to = "abund") %>% 
  mutate(exp_dates = "after")

ra_algae_after_continual <- rankabundance(x = after_algae, y = after_meta,
                                          factor = "treatment", level = c("continual")) %>% 
  as.data.frame() %>% 
  rownames_to_column("sp_code") %>% 
  dplyr::select(sp_code, rank, proportion, pupper, plower) %>% 
  pivot_longer(cols = c("rank", "proportion"), names_to = "metric", values_to = "abund") %>% 
  mutate(exp_dates = "after")

ra_algae_continual <- rbind(ra_algae_start_continual,
                            ra_algae_during_continual, 
                            ra_algae_after_continual)

ra_algae_control <- rbind(ra_algae_start_control,
                            ra_algae_during_control, 
                            ra_algae_after_control) %>% 
  mutate(exp_dates = fct_relevel(exp_dates, "start", "during", "after")) %>% 
  filter(metric == "rank") %>% 
  filter(sp_code %in% c("PTCA", "CO", "CC", "EGME", "CYOS", "DL", "R"))

ra_algae_continual %>% 
  mutate(exp_dates = fct_relevel(exp_dates, "start", "during", "after")) %>% 
  filter(metric == "rank") %>% 
  filter(sp_code %in% c("PTCA", "CO", "CC", "EGME", "CYOS", "DL", "R")) %>% 
  ggplot(aes(x = exp_dates, y = abund, color = sp_code)) +
  geom_point(aes(group = sp_code), size = 4) +
  geom_line(aes(group = sp_code), size = 1) +
  geom_text(data = ra_algae_continual %>% 
              filter(sp_code %in% c("PTCA", "CO", "CC", "EGME", "CYOS", "DL", "R") &
                       metric == "rank" &
                       exp_dates == "start"), 
            aes(group = sp_code, x = 0.85, y = abund, label = sp_code),
            size = 5) +
  scale_y_continuous(trans = "reverse") +
  labs(x = "",
       y = "Species rank",
       col = "") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.position = "none")

ra_algae_control %>% 
  mutate(exp_dates = fct_relevel(exp_dates, "start", "during", "after")) %>% 
  filter(metric == "rank") %>% 
  filter(sp_code %in% c("PTCA", "CO", "CC", "EGME", "CYOS", "DL", "R")) %>% 
  ggplot(aes(x = exp_dates, y = abund, color = sp_code)) +
  geom_point(aes(group = sp_code), size = 4) +
  geom_line(aes(group = sp_code), size = 1) +
  geom_text(data = ra_algae_control %>% 
              filter(sp_code %in% c("PTCA", "CO", "CC", "EGME", "CYOS", "DL", "R") &
                       metric == "rank" &
                       exp_dates == "start"), 
            aes(group = sp_code, x = 0.85, y = abund, label = sp_code),
            size = 5) +
  scale_y_continuous(trans = "reverse") +
  labs(x = "",
       y = "Species rank",
       col = "") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.position = "none")
```

# 4. delta biomass for functional groups

```{r}
delta_fg_df <- biomass %>% 
  filter(sp_code != "MAPY") %>% 
  # make a new column for after dates
  after_dates_column() %>% 
  # make a new column for during and after and set factor levels
  exp_dates_column() %>% 
  # make a new column for group
  new_group_column() %>% 
  group_by(site, year, month, treatment, date, exp_dates, new_group) %>% 
  summarize(dry_gm2 = sum(dry_gm2)) %>% 
  ungroup() %>% 
  dplyr::select(site, year, month, treatment, date, exp_dates, new_group, dry_gm2) %>% 
  pivot_wider(names_from = treatment, values_from = dry_gm2) %>% 
  dplyr::select(-annual) %>% 
  mutate(delta_continual = continual - control) %>% 
  drop_na(delta_continual) %>% 
  mutate(quarter = case_when(
    month <= 3 ~ "Q1",
    month <= 6 ~ "Q2",
    month <= 9 ~ "Q3",
    TRUE ~ "Q4"
  )) %>% 
  # calculate time since start of experiment
  mutate(time_yrs = case_when(
    # AQUE, NAPL, MOHK, CARP: continual started in 2010
    quarter == "Q1" ~ year + 0.125 - 2010,
    quarter == "Q2" ~ year + 0.375 - 2010,
    quarter == "Q3" ~ year + 0.625 - 2010,
    quarter == "Q4" ~ year + 0.875 - 2010
  )) %>% 
  group_by(site) %>% 
  mutate(time_since_start = time_yrs - min(time_yrs)) %>% 
  ungroup() %>% 
  # calculate time since end of experiment
  group_by(site, exp_dates) %>% 
  mutate(time_since_end = case_when(
    exp_dates == "during" ~ -(max(time_yrs) + 0.25 - time_yrs),
    exp_dates == "after" ~ time_yrs - min(time_yrs)
  )) %>% 
  ungroup() %>% 
  filter(time_since_end > -8.5) %>% 
  left_join(., enframe(sites_full), by = c("site" = "name")) %>% 
  rename(site_full = value) %>% 
  mutate(site_full = fct_relevel(site_full, "Arroyo Quemado (AQUE)", "Naples (NAPL)", "Mohawk (MOHK)", "Carpinteria (CARP)")) %>% 
  # create a new column for "kelp year"
  mutate(quarter = fct_relevel(quarter, "Q2", "Q3", "Q4", "Q1")) %>% 
  mutate(kelp_year = case_when(
    quarter %in% c("Q2", "Q3", "Q4") ~ year,
    quarter == "Q1" ~ year - 1
  )) %>% 
  mutate(kelp_year = paste("kelp_", kelp_year, "-", kelp_year + 1, sep = "")) %>% 
  # create a column for the points to compare for "2 year interval"
  mutate(comp_2yrs = case_when(
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2010-2011", "kelp_2011-2012") ~ "start",
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2015-2016", "kelp_2016-2017") ~ "during", 
    site == "ivee" & kelp_year %in% c("kelp_2011-2012", "kelp_2012-2013") ~ "start",
    site == "ivee" & kelp_year %in% c("kelp_2015-2016", "kelp_2016-2017") ~ "during",
    kelp_year %in% c("kelp_2020-2021", "kelp_2021-2022") ~ "after"
  )) %>% 
  mutate(comp_2yrs = fct_relevel(comp_2yrs, "start", "during", "after")) %>% 
  # create a column for the points to compare for "3 year interval"
  mutate(comp_3yrs = case_when(
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2010-2011", "kelp_2011-2012", "kelp_2012-2013") ~ "start",
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2014-2015", "kelp_2015-2016", "kelp_2016-2017") ~ "during", 
    site == "ivee" & kelp_year %in% c("kelp_2011-2012", "kelp_2012-2013", "kelp_2013-2014") ~ "start",
    site == "ivee" & kelp_year %in% c("kelp_2014-2015", "kelp_2015-2016", "kelp_2016-2017") ~ "during",
    kelp_year %in% c("kelp_2019-2020", "kelp_2020-2021", "kelp_2021-2022") ~ "after"
  )) %>% 
  mutate(comp_3yrs = fct_relevel(comp_3yrs, "start", "during", "after")) %>% 
  full_join(., site_quality, by = "site")

delta_fg_df %>%
  # filter(comp_2yrs %in% c("during", "after")) %>%
  # take out fish with big biomass
  filter(!(new_group == "fish" & date == "2014-08-15")) %>% 
  # filter(new_group %in% c("algae", "epi_inverts", "endo_inverts")) %>% 
  # mutate(new_group = fct_relevel(new_group, "algae", "epi_inverts", "endo_inverts")) %>% 
  # filter(new_group != "endo_inverts") %>% 
  # mutate(new_group = fct_relevel(new_group, "algae", "epi_inverts", "carn_inverts", "herb_inverts", "fish")) %>% 
  ggplot() +
  geom_hline(aes(yintercept = 0), lty = 2, color = "grey") +
  # geom_jitter(aes(x = exp_dates, y = delta_continual, col = exp_dates, shape = exp_dates), alpha = 0.4) +
  stat_summary(aes(x = exp_dates, y = delta_continual, col = exp_dates), fun.data = mean_se, geom = "errorbar", size = 1, width = 0.2) +
  stat_summary(aes(x = exp_dates, y = delta_continual, col = exp_dates, shape = exp_dates), fun = mean, geom = "point", size = 4) +
  labs(x = "",
       y = "delta biomass (g dry/m2)",
       col = "", shape = "") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 16),
        legend.position = "none") +
  facet_wrap(~new_group, scales = "free") 
ggsave(here::here("figures", "fg_biomass_exp-dates_deltas_no-jitter_2022-05-25.jpg"), width = 7, height = 6, dpi = 150)

delta_fg_df %>%
  filter(comp_2yrs %in% c("during", "after")) %>%
  # take out fish with big biomass
  filter(!(new_group == "fish" & date == "2014-08-15")) %>% 
  # filter(new_group != "endo_inverts") %>% 
  # mutate(new_group = fct_relevel(new_group, "algae", "epi_inverts", "carn_inverts", "herb_inverts", "fish")) %>% 
  ggplot() +
  geom_hline(aes(yintercept = 0), lty = 2, color = "grey") +
  geom_jitter(aes(x = exp_dates, y = delta_continual, col = exp_dates, shape = exp_dates), alpha = 0.4) +
  stat_summary(aes(x = exp_dates, y = delta_continual, col = exp_dates), fun.data = mean_se, geom = "errorbar", size = 1, width = 0.2) +
  stat_summary(aes(x = exp_dates, y = delta_continual, col = exp_dates, shape = exp_dates), fun = mean, geom = "point", size = 4) +
  labs(x = "Group",
       y = "\U0394 biomass (treatment - control)",
       col = "", shape = "") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 16),
        legend.position = "none") +
  facet_wrap(~new_group, scales = "free")

delta_fg_df %>%
  filter(comp_2yrs %in% c("during", "after")) %>%
  filter(new_group == "endo_inverts") %>% 
  ggplot() +
  geom_hline(aes(yintercept = 0), lty = 2, color = "grey") +
  geom_jitter(aes(x = new_group, y = delta_continual, col = exp_dates, shape = exp_dates), alpha = 0.4) +
  stat_summary(aes(x = new_group, y = delta_continual, col = exp_dates), fun.data = mean_se, geom = "errorbar", size = 1, width = 0.2) +
  stat_summary(aes(x = new_group, y = delta_continual, col = exp_dates, shape = exp_dates), fun = mean, geom = "point", size = 4) +
  labs(x = "Group",
       y = "\U0394 biomass (treatment - control)",
       col = "", shape = "") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 16))
```


# 5. delta biomass for focal species

## a. wrangling

```{r}
delta_sp_df <- biomass %>% 
  filter(sp_code != "MAPY") %>% 
  # dplyr::select(-sp_code) %>% 
  # # make a new column for after dates
  after_dates_column() %>% 
  # make a new column for during and after and set factor levels
  exp_dates_column() %>% 
  dplyr::select(site, year, month, treatment, date, exp_dates, sp_code, dry_gm2) %>% 
  pivot_wider(names_from = treatment, values_from = dry_gm2) %>% 
  dplyr::select(-annual) %>% 
  mutate(delta_continual = continual - control) %>% 
  drop_na(delta_continual) %>% 
  time_since_columns_continual() %>% 
  kelp_year_column() %>% 
  comparison_column_continual() %>% 
  left_join(., enframe(sites_full), by = c("site" = "name")) %>% 
  rename(site_full = value) %>% 
  mutate(site_full = fct_relevel(site_full, "Arroyo Quemado", "Naples", "Mohawk", "Carpinteria")) %>% 
  full_join(., site_quality, by = "site")
```

## b. algae

### during/after

```{r}
# during and after comparison
delta_sp_df %>% 
  filter(sp_code %in% algae_spp) %>% 
  drop_na(comp_2yrs) %>% 
  # filter(sp_code %in% c("PTCA", "CO", "CC", "EGME", "CYOS", "DL", "R")) %>% 
  # mutate(sp_code = fct_relevel(sp_code, "CYOS", "EGME", "PTCA", "CC", "DL", "R", "CO")) %>% 
  # filter(comp_2yrs %in% c("during", "after")) %>% 
  ggplot() +
  geom_hline(aes(yintercept = 0), lty = 2, color = "grey") +
  # geom_jitter(aes(x = exp_dates, y = delta_continual, col = exp_dates, shape = exp_dates), alpha = 0.4) +
  stat_summary(aes(x = comp_2yrs, y = delta_continual, col = comp_2yrs), fun.data = mean_se, geom = "errorbar", size = 1, width = 0.2) +
  stat_summary(aes(x = comp_2yrs, y = delta_continual, col = comp_2yrs, shape = exp_dates), fun = mean, geom = "point", size = 4) +
  labs(x = "Species",
       y = "\U0394 biomass (treatment - control)",
       col = "", shape = "") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 16),
        legend.position = "none") +
  facet_wrap(~sp_code, scales = "free")

ggsave(here::here("figures", "sda_algae_panel.jpg"), height = 20, width = 20, dpi = 200)
```

### during/after tile or table

```{r}
sda_algae_df <- delta_sp_df %>% 
  filter(sp_code %in% algae_spp) %>% 
  drop_na(comp_2yrs) %>% 
  group_by(sp_code, comp_2yrs) %>% 
  summarize(mean_deltas = mean(delta_continual),
            mean_continual = mean(continual)) %>% 
  ungroup() %>% 
  mutate(fill = case_when(
    round(mean_deltas, 3) > 0 ~ "> control",
    round(mean_deltas, 3) < 0 ~ "< control",
    round(mean_deltas, 3) == 0 ~ "no difference"
  )) %>% 
  mutate(fill = fct_relevel(fill, "> control", "no difference", "< control")) %>% 
  arrange(sp_code) %>% 
  mutate(facet_col = case_when(
    comp_2yrs == "start" & fill == "> control" ~ "facet1",
    comp_2yrs == "start" & fill == "no difference" ~ "facet2",
    comp_2yrs == "start" & fill == "< control" ~ "facet3"
  )) %>% 
  fill(facet_col, .direction = "down") %>% 
  left_join(., algae_spp_names, by = "sp_code")
```

```{r}
sda_algae_greater <- sda_algae_df %>% 
  filter(facet_col == "facet1") %>% 
  arrange(desc(scientific_name)) %>% 
  mutate(scientific_name = fct_inorder(scientific_name)) %>% 
  ggplot() +
  # geom_raster(aes(x = comp_2yrs, y = sp_code, fill = fill), color = "#FFFFFF") +
  geom_tile(aes(x = comp_2yrs, y = scientific_name, fill = fill), color = "#FFFFFF", width = 1, height = 1) +
  geom_text(aes(x = comp_2yrs, y = scientific_name, label = signif(mean_continual, 2)), size = 3) +
  scale_fill_manual(values = c("> control" = "#eb5a1c", "no difference" = "#accaf2", "< control" = "#498c49")) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0), labels = function(x) str_wrap(x, width = 30)) +
  theme_bw() +
  labs(x = " ",
       y = " ",
       fill = " ") +
  coord_fixed() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 0.75)) 
sda_algae_greater

sda_algae_nodiff <- sda_algae_df %>% 
  filter(facet_col == "facet2") %>% 
  arrange(desc(scientific_name)) %>% 
  mutate(scientific_name = fct_inorder(scientific_name)) %>% 
  ggplot() +
  # geom_raster(aes(x = comp_2yrs, y = sp_code, fill = fill), color = "#FFFFFF") +
  geom_tile(aes(x = comp_2yrs, y = scientific_name, fill = fill), color = "#FFFFFF", width = 1, height = 1) +
  geom_text(aes(x = comp_2yrs, y = scientific_name, label = signif(mean_deltas, 2)), size = 3) +
  scale_fill_manual(values = c("> control" = "#eb5a1c", "no difference" = "#accaf2", "< control" = "#498c49")) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  theme_bw() +
  labs(x = " ",
       y = " ",
       fill = " ") +
  coord_fixed() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 0.75)) 
sda_algae_nodiff

sda_algae_lesser <- sda_algae_df %>% 
  filter(facet_col == "facet3") %>% 
  arrange(desc(scientific_name)) %>% 
  mutate(scientific_name = fct_inorder(scientific_name)) %>% 
  ggplot() +
  # geom_raster(aes(x = comp_2yrs, y = sp_code, fill = fill), color = "#FFFFFF") +
  geom_tile(aes(x = comp_2yrs, y = scientific_name, fill = fill), color = "#FFFFFF", width = 1, height = 1) +
  geom_text(aes(x = comp_2yrs, y = scientific_name, label = round(mean_continual, 2)), size = 3) +
  scale_fill_manual(values = c("> control" = "#eb5a1c", "no difference" = "#accaf2", "< control" = "#498c49")) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  theme_bw() +
  labs(x = " ",
       y = " ",
       fill = " ") +
  coord_fixed() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 0.75)) 
sda_algae_lesser

sda_algae_tile <- sda_algae_greater + sda_algae_nodiff + sda_algae_lesser

sda_algae_tile
```


### during/after histogram

```{r}
sda_algae_hist <- delta_sp_df %>% 
  filter(sp_code %in% algae_spp) %>% 
  drop_na(comp_2yrs) %>% 
  group_by(sp_code, comp_2yrs) %>% 
  summarize(mean_deltas = mean(delta_continual)) %>% 
  ungroup() %>% 
  mutate(fill = case_when(
    mean_deltas > 0 ~ "> control",
    mean_deltas < 0 ~ "< control",
    mean_deltas == 0 ~ "no difference"
  )) %>% 
  mutate(fill = fct_relevel(fill, "> control", "no difference", "< control")) %>% 
  ggplot() +
  geom_histogram(aes(x = comp_2yrs, fill = fill), position = "dodge", stat = "count") +
  scale_fill_manual(values = c("> control" = "#eb5a1c", "no difference" = "#accaf2", "< control" = "#498c49")) +
  # aesthetics
  scale_y_continuous(expand = c(0, 0), limits = c(0, 32)) +
  theme_bw() +
  theme(axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        legend.text = element_text(size = 16), 
        legend.title = element_text(size = 16),
        legend.position = c(0.15, 0.9),
        plot.margin = margin(0, 0, 0, 0),
        panel.grid.minor = element_line(color = "white")) +
  labs(x = "Time period", 
       y = "Number of species",
       fill = "\U0394 biomass",
       title = "Algae")
```


### timeseries of deltas

```{r}
# timeseries of deltas
delta_sp_df %>% 
  # filter(sp_code %in% c("PTCA", "CO", "CC", "EGME", "CYOS", "DL", "R")) %>% 
  # mutate(sp_code = fct_relevel(sp_code, "CYOS", "EGME", "PTCA", "CC", "DL", "R", "CO")) %>% 
  filter(sp_code %in% c("PTCA", "EGME", "CYOS")) %>% 
  mutate(sp_code = fct_relevel(sp_code, "CYOS", "EGME", "PTCA")) %>% 
  group_by(sp_code) %>%
  ungroup() %>% 
  ggplot(aes(x = time_since_end, y = delta_continual, col = sp_code)) +
  geom_hline(aes(yintercept = 0), lty = 2, color = "grey") +
  geom_vline(aes(xintercept = 0), lty = 2) +
  geom_rect(aes(xmin = -4, xmax = -2.5, ymin = 0, ymax = 100), 
            alpha = 0.1, fill = "#fae1e1", inherit.aes = FALSE) +
  stat_summary(aes(x = time_since_end, y = delta_continual, col = sp_code), fun = mean, geom = "line", size = 1) +
  stat_summary(aes(x = time_since_end, y = delta_continual, col = sp_code), fun = mean, geom = "point", size = 1) +
  labs(x = "Time since end of removal",
       y = "\U0394 biomass (treatment - control)",
       col = "", shape = "",
       title = "\U0394 macroalgae") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 16),
        plot.title = element_text(size = 18),
        legend.position = c(0.1, 0.3))
```

### timeseries of raw biomass

x: time since end of removal  
y: raw biomass in continual removal plots  

```{r}
delta_sp_df %>% 
  filter(sp_code %in% c("PTCA", "EGME", "CYOS")) %>% 
  mutate(sp_code = fct_relevel(sp_code, "CYOS", "EGME", "PTCA")) %>% 
  ggplot(aes(x = time_since_end, y = continual, col = sp_code)) +
  geom_hline(aes(yintercept = 0), lty = 2, color = "grey") +
  geom_vline(aes(xintercept = 0), lty = 2) +
  geom_rect(aes(xmin = -4, xmax = -2.5, ymin = 0, ymax = 200), 
            alpha = 0.1, fill = "#fae1e1", inherit.aes = FALSE) +
  stat_summary(aes(x = time_since_end, y = continual, col = sp_code), fun = mean, geom = "line", size = 1) +
  stat_summary(aes(x = time_since_end, y = continual, col = sp_code), fun = mean, geom = "point", size = 1) +
  
  labs(x = "Time since end of removal",
       y = "biomass (dry g/m2)",
       col = "", shape = "",
       title = "Continual removal plots") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 16),
        plot.title = element_text(size = 18),
        legend.position = c(0.15, 0.8)) 
  # facet_wrap(~sp_code, scales = "free", nrow = 2)

delta_sp_df %>% 
  filter(sp_code %in% c("PTCA", "EGME", "CYOS")) %>% 
  mutate(sp_code = fct_relevel(sp_code, "CYOS", "EGME", "PTCA")) %>% 
  # filter(comp_2yrs %in% c("during", "after")) %>% 
  ggplot(aes(x = time_since_end, y = control, col = sp_code)) +
  geom_hline(aes(yintercept = 0), lty = 2, color = "grey") +
  geom_vline(aes(xintercept = 0), lty = 2) +
  geom_rect(aes(xmin = -4, xmax = -2.5, ymin = 0, ymax = 70), 
            alpha = 0.1, fill = "#fae1e1", inherit.aes = FALSE) +
  stat_summary(aes(x = time_since_end, y = control, col = sp_code), fun = mean, geom = "line", size = 1) +
  stat_summary(aes(x = time_since_end, y = control, col = sp_code), fun = mean, geom = "point", size = 1) +
  scale_y_continuous(limits = c(0, 70)) +
  
  labs(x = "Time since end of removal",
       y = "biomass (dry g/m2)",
       col = "", shape = "",
       title = "Control plots") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 16),
        plot.title = element_text(size = 18),
        legend.position = "none") 
```
 

### delta timeseries with annual means

```{r}
# delta timeseries with annual means
algae_am <- delta_sp_df %>% 
  filter(sp_code %in% c("PTCA", "CO", "CC", "EGME", "CYOS", "DL", "R")) %>% 
  mutate(sp_code = fct_relevel(sp_code, "CYOS", "EGME", "PTCA", "CC", "DL", "R", "CO")) %>% 
  group_by(sp_code, kelp_year) %>%
  summarize(mean_delta = mean(delta_continual, na.rm = TRUE),
            mean_tse = mean(time_since_end),
            se_delta = se(delta_continual),
            mean_continual = mean(continual, na.rm = TRUE),
            se_continual = se(continual)) %>%
  ungroup() %>% 
  # group_by(sp_code) %>% 
  # mutate(sp_label = case_when(
  #   mean_tse == min(mean_tse) ~ sp_code,
  #   FALSE ~ ""
  # )) %>% 
  ggplot(aes(x = mean_tse, y = mean_continual, col = sp_code)) +
  geom_line(size = 1) +
  geom_errorbar(aes(ymin = mean_continual - se_continual, ymax = mean_continual + se_continual), alpha = 0.4) +
  labs(x = "Time since end of removal", y = "Mean biomass",
       caption = "summarized by kelp year across sites",
       title = "Macroalgae") +
  scale_x_continuous(limits = c(-7.5, 3)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 16),
        legend.position = "none") 
algae_am

algae_am_v2 <- delta_sp_df %>% 
  filter(sp_code %in% c("PTCA", "EGME", "CYOS")) %>% 
  mutate(sp_code = fct_relevel(sp_code, "CYOS", "EGME", "PTCA")) %>% 
  mutate(year_since_end = round(time_since_end)) %>% 
  group_by(sp_code, year_since_end) %>% 
  summarize(mean_delta = mean(delta_continual, na.rm = TRUE),
            mean_tse = mean(time_since_end),
            se_delta = se(delta_continual),
            mean_continual = mean(continual, na.rm = TRUE),
            se_continual = se(continual)) %>%
  ungroup() %>% 
  # group_by(sp_code) %>% 
  # mutate(sp_label = case_when(
  #   mean_tse == min(mean_tse) ~ sp_code,
  #   FALSE ~ ""
  # )) %>% 
  ggplot(aes(x = year_since_end, y = mean_continual, col = sp_code)) +
  geom_line(size = 1) +
  geom_errorbar(aes(ymin = mean_continual - se_continual, ymax = mean_continual + se_continual), alpha = 0.4) +
  labs(x = "Time since end of removal", y = "Mean biomass (dry g/m2)",
       caption = "summarized by year since end across sites",
       title = "Macroalgae") +
  scale_x_continuous(limits = c(-7.5, 5.5)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 16)) 
algae_am_v2

algae_am_v3 <- delta_sp_df %>% 
  filter(sp_code %in% c("PTCA", "CO", "CC", "EGME", "CYOS", "DL", "R")) %>% 
  mutate(sp_code = fct_relevel(sp_code, "CYOS", "EGME", "PTCA", "CC", "DL", "R", "CO")) %>% 
  filter(quarter == "Q3") %>% 
  # filter out naples extended dates
  filter(!(site == "napl" & time_since_end == 4)) %>% 
  # group_by(sp_code) %>% 
  # summarize(mean_delta = mean(delta_continual, na.rm = TRUE),
  #           mean_tse = mean(time_since_end),
  #           se_delta = se(delta_continual),
  #           mean_continual = mean(continual, na.rm = TRUE),
  #           se_continual = se(continual)) %>%
  # ungroup() %>% 
  ggplot(aes(x = time_since_end, y = continual, col = sp_code)) +
  stat_summary(fun = "mean", geom = "line") +
  stat_summary(fun.data = "mean_se", geom = "errorbar") +
  labs(x = "Time since end of removal", y = "Mean biomass",
       caption = "annual mean",
       title = "Macroalgae") +
  # scale_x_continuous(limits = c(-7.5, 3)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 16)) 
algae_am_v3
```

## c. epilithic inverts

### during/after comparison
```{r}
# during/after comparison
delta_sp_df %>% 
  filter(sp_code %in% invert_spp) %>% 
  drop_na(comp_2yrs) %>% 
  # filter(sp_code %in% c("TEAU", "URLO", "MUCA", "DIOR", "ANSP", "CUPI", "CUSP", "STMO")) %>% 
  # mutate(sp_code = fct_relevel(sp_code, "TEAU", "URLO", "MUCA", "DIOR", "ANSP", "CUPI", "CUSP", "STMO")) %>%
  # filter(comp_2yrs %in% c("during", "after")) %>% 
  ggplot() +
  geom_hline(aes(yintercept = 0), lty = 2, color = "grey") +
  # geom_jitter(aes(x = exp_dates, y = delta_continual, col = exp_dates, shape = exp_dates), alpha = 0.4) +
  stat_summary(aes(x = comp_2yrs, y = delta_continual, col = comp_2yrs), fun.data = mean_se, geom = "errorbar", size = 1, width = 0.2) +
  stat_summary(aes(x = comp_2yrs, y = delta_continual, col = comp_2yrs, shape = comp_2yrs), fun = mean, geom = "point", size = 4) +
  labs(x = "Species",
       y = "\U0394 biomass (treatment - control)",
       col = "", shape = "") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 16),
        legend.position = "none") +
  facet_wrap(~sp_code, scales = "free")

ggsave(here::here("figures", "sda_invert_panel.jpg"), height = 30, width = 30, dpi = 200)
```

### during/after tile 

```{r}
sda_epi_df <- delta_sp_df %>% 
  left_join(., guilds, by = c("sp_code" = "sp.code")) %>% 
  filter(new_group == "epilithic.sessile.invert") %>% 
  drop_na(comp_2yrs) %>% 
  group_by(sp_code, comp_2yrs) %>% 
  summarize(mean_deltas = mean(delta_continual),
            mean_continual = mean(continual)) %>% 
  ungroup() %>% 
  mutate(fill = case_when(
    round(mean_deltas, 3) > 0 ~ "> control",
    round(mean_deltas, 3) < 0 ~ "< control",
    round(mean_deltas, 3) == 0 ~ "no difference"
  )) %>% 
  mutate(fill = fct_relevel(fill, "> control", "no difference", "< control")) %>% 
  mutate(facet_col = case_when(
    comp_2yrs == "start" & fill == "> control" ~ "facet1",
    sp_code %in% c("HC", "HPAC", "MT") ~ "facet1",
    comp_2yrs == "start" & fill == "no difference" ~ "facet2",
    sp_code %in% c("PHSP", "AS", "BOW", "BA", "BN", "BCAL",
                   "CESP", "COST", "CHPR", "CL", "CY", "CRGI",
                   "CROC", "CUSP", "DC", "ARUD") ~ "facet2", 
    comp_2yrs == "start" & fill == "< control" ~ "facet3"
  )) %>% 
  fill(facet_col, .direction = "down") %>% 
  left_join(., epi_spp_names, by = "sp_code")

sda_epi_facet1 <- sda_epi_df %>% 
  filter(facet_col %in% c("facet1")) %>% 
  arrange(comp_2yrs, desc(fill), desc(scientific_name)) %>%
  mutate(scientific_name = fct_inorder(scientific_name)) %>% 
  ggplot() +
  geom_tile(aes(x = comp_2yrs, y = scientific_name, fill = fill), color = "#FFFFFF", width = 1, height = 1) +
  geom_text(aes(x = comp_2yrs, y = scientific_name, label = signif(mean_continual, 2)), size = 3) +
  scale_fill_manual(values = c("> control" = "#eb5a1c", "no difference" = "#accaf2", "< control" = "#498c49")) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0), labels = function(x) str_wrap(x, width = 40)) +
  theme_bw() +
  labs(x = " ",
       y = " ",
       fill = " ") +
  coord_fixed() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 0.75)) 
sda_epi_facet1

sda_epi_facet2 <- sda_epi_df %>% 
  filter(facet_col == "facet2") %>% 
  arrange(comp_2yrs, desc(fill), desc(scientific_name)) %>%
  mutate(scientific_name = fct_inorder(scientific_name)) %>% 
  ggplot() +
  # geom_raster(aes(x = comp_2yrs, y = sp_code, fill = fill), color = "#FFFFFF") +
  geom_tile(aes(x = comp_2yrs, y = scientific_name, fill = fill), color = "#FFFFFF", width = 1, height = 1) +
  geom_text(aes(x = comp_2yrs, y = scientific_name, label = signif(mean_continual, 2)), size = 3) +
  scale_fill_manual(values = c("> control" = "#eb5a1c", "no difference" = "#accaf2", "< control" = "#498c49")) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  theme_bw() +
  labs(x = " ",
       y = " ",
       fill = " ") +
  coord_fixed() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 0.75)) 
sda_epi_facet2

sda_epi_facet3 <- sda_epi_df %>% 
  filter(facet_col == "facet3") %>% 
  arrange(desc(scientific_name)) %>% 
  mutate(scientific_name = fct_inorder(scientific_name)) %>% 
  ggplot() +
  # geom_raster(aes(x = comp_2yrs, y = sp_code, fill = fill), color = "#FFFFFF") +
  geom_tile(aes(x = comp_2yrs, y = scientific_name, fill = fill), color = "#FFFFFF", width = 1, height = 1) +
  geom_text(aes(x = comp_2yrs, y = scientific_name, label = signif(mean_continual, 2)), size = 3) +
  scale_fill_manual(values = c("> control" = "#eb5a1c", "no difference" = "#accaf2", "< control" = "#498c49")) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  theme_bw() +
  labs(x = " ",
       y = " ",
       fill = " ") +
  coord_fixed() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 0.75)) 
sda_epi_facet3

sda_epi_tile <- sda_epi_facet1 + sda_epi_facet2 + sda_epi_facet3

sda_epi_tile

plots_together_tile <- sda_algae_tile / sda_epi_tile &
  plot_annotation(tag_levels = list(c("A", "", "", "B", "", ""))) &
  theme(plot.tag = element_text(size = 20))
plots_together_tile


ggsave(here::here("figures", paste("algae_invert_tile-", todays_date, ".jpg", sep = "")), 
       plot = plots_together_tile, 
       height = 12, width = 14, dpi = 150)
```

### during/after histogram
```{r}
sda_invert_hist <- delta_sp_df %>% 
  left_join(., guilds, by = c("sp_code" = "sp.code")) %>% 
  filter(new_group == "epilithic.sessile.invert") %>% 
  drop_na(comp_2yrs) %>% 
  group_by(sp_code, comp_2yrs) %>% 
  summarize(mean_deltas = mean(delta_continual)) %>% 
  ungroup() %>% 
  mutate(fill = case_when(
    mean_deltas > 0 ~ "> control",
    mean_deltas < 0 ~ "< control",
    mean_deltas == 0 ~ "no difference"
  )) %>% 
  mutate(fill = fct_relevel(fill, "> control", "no difference", "< control")) %>% 
  ggplot() +
  geom_histogram(aes(x = comp_2yrs, fill = fill), position = "dodge", stat = "count") +
  scale_fill_manual(values = c("> control" = "#eb5a1c", "no difference" = "#accaf2", "< control" = "#498c49")) +
  # aesthetics
  scale_y_continuous(expand = c(0, 0), limits = c(0, 40)) +
  theme_bw() +
  theme(axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        legend.text = element_text(size = 16), 
        legend.title = element_text(size = 16),
        legend.position = "none",
        plot.margin = margin(0, 0, 0, 0),
        panel.grid.minor = element_line(color = "white")) +
  labs(x = "Time period", 
       y = "Number of species",
       fill = "\U0394 biomass",
       title = "Epilithic invertebrates")

plots_together <- sda_algae_hist + sda_invert_hist &
    plot_annotation(tag_levels = "A") &
    theme(plot.tag = element_text(size = 20))

ggsave(here::here("figures", paste("sda_hist_", todays_date, ".jpg", sep = "")), plot = plots_together, height = 8, width = 16, dpi = 150)
```


### timeseries of deltas

```{r}
# timeseries of deltas
delta_sp_df %>% 
  filter(sp_code %in% c("TEAU", "URLO", "MUCA", "DIOR", "ANSP", "CUPI", "CUSP", "STMO")) %>% 
  ggplot(aes(x = time_since_end, y = delta_continual, col = sp_code)) +
  geom_hline(aes(yintercept = 0), lty = 2, color = "grey") +
  geom_vline(aes(xintercept = 0), lty = 2) +
  geom_rect(aes(xmin = -4, xmax = -2.5, ymin = -20, ymax = 20), 
            alpha = 0.1, fill = "#fae1e1", inherit.aes = FALSE) +
  stat_summary(aes(x = time_since_end, y = delta_continual, col = sp_code), fun = mean, geom = "line", size = 1) +
  stat_summary(aes(x = time_since_end, y = delta_continual, col = sp_code), fun = mean, geom = "point", size = 1) +
  labs(x = "Time since end of removal",
       y = "\U0394 biomass (treatment - control)",
       col = "", shape = "",
       title = "\U0394 epilithic inverts") +
  theme_bw() +
  guides(col = guide_legend(nrow = 4)) +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 12),
        plot.title = element_text(size = 18),
        legend.position = c(0.15, 0.2))

```

### timeseries of raw biomass
```{r}
delta_sp_df %>% 
  filter(sp_code %in% c("TEAU", "URLO", "ANSP")) %>% 
  ggplot(aes(x = time_since_end, y = continual, col = sp_code)) +
  geom_hline(aes(yintercept = 0), lty = 2, color = "grey") +
  geom_vline(aes(xintercept = 0), lty = 2) +
  geom_rect(aes(xmin = -4, xmax = -2.5, ymin = 0, ymax = 20), 
            alpha = 0.1, fill = "#fae1e1", inherit.aes = FALSE) +
  stat_summary(aes(x = time_since_end, y = continual, col = sp_code), fun = mean, geom = "line", size = 1) +
  stat_summary(aes(x = time_since_end, y = continual, col = sp_code), fun = mean, geom = "point", size = 1) +
  labs(x = "Time since end of removal",
       y = "biomass (dry g/m2)",
       col = "", shape = "",
       title = "Continual removal plots") +
  theme_bw() +
  guides(col = guide_legend(nrow = 4)) +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 12),
        plot.title = element_text(size = 18),
        legend.position = c(0.12, 0.8))

delta_sp_df %>% 
  filter(sp_code %in% c("TEAU", "URLO", "MUCA", "DIOR", "ANSP", "CUPI", "CUSP", "STMO")) %>% 
  ggplot(aes(x = time_since_end, y = control, col = sp_code)) +
  geom_hline(aes(yintercept = 0), lty = 2, color = "grey") +
  geom_vline(aes(xintercept = 0), lty = 2) +
  geom_rect(aes(xmin = -4, xmax = -2.5, ymin = 0, ymax = 20), 
            alpha = 0.1, fill = "#fae1e1", inherit.aes = FALSE) +
  stat_summary(aes(x = time_since_end, y = control, col = sp_code), fun = mean, geom = "line", size = 1) +
  stat_summary(aes(x = time_since_end, y = control, col = sp_code), fun = mean, geom = "point", size = 1) +
  labs(x = "Time since end of removal",
       y = "biomass (dry g/m2)",
       col = "", shape = "",
       title = "Control plots") +
  theme_bw() +
  guides(col = guide_legend(nrow = 4)) +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 12),
        plot.title = element_text(size = 18),
        legend.position = c(0.15, 0.85))
```



### delta timeseries with annual means

```{r}
# delta timeseries with annual means
epi_inverts_am <- delta_sp_df %>% 
  filter(sp_code %in% c("TEAU", "URLO", "MUCA", "DIOR", "ANSP", "CUPI", "CUSP", "STMO")) %>% 
  group_by(sp_code, kelp_year) %>% 
  summarize(mean_delta = mean(delta_continual, na.rm = TRUE), 
            mean_tse = mean(time_since_end),
            se_delta = se(delta_continual),
            mean_continual = mean(continual, na.rm = TRUE),
            se_continual = se(continual)) %>% 
  ungroup() %>% 
  group_by(sp_code) %>% 
  mutate(sp_label = case_when(
    mean_tse == min(mean_tse) ~ sp_code,
    FALSE ~ ""
  )) %>% 
  ggplot(aes(x = mean_tse, y = mean_continual, col = sp_code)) +
  geom_line(size = 1) +
  geom_errorbar(aes(ymin = mean_continual - se_continual, ymax = mean_continual + se_continual), alpha = 0.4) +
  labs(x = "Time since end of removal", y = "Mean biomass",
       caption = "summarized by kelp year across sites",
       title = "Epilithic invertebrates") +
  geom_text_repel(aes(x = mean_tse, y = mean_continual, label = sp_label), 
                  direction = "y", size = 5) +
  scale_x_continuous(limits = c(-7.5, 3)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 16),
        legend.position = "none") 
epi_inverts_am
```

## d. tiles by tax group

### function
```{r}
taxon_tile_function <- function(taxon, group = c("algae", "epi")) {
  df <- if(taxon %in% algae_orders & group == "algae") {
    sda_algae_df
  } else if(taxon %in% epi_classes & group == "epi") {
    sda_epi_df
  } else {
    warning("The inputs provided (", order, " and ", group, ") are not as expected. Double check spelling.")
    return(NA)
  }
  
  df %>% 
    filter(tax_group == {{ taxon }}) %>% 
    arrange(comp_2yrs, desc(fill), desc(scientific_name)) %>% 
    mutate(scientific_name = fct_inorder(scientific_name)) %>% 
    ggplot() +
    # geom_raster(aes(x = comp_2yrs, y = sp_code, fill = fill), color = "#FFFFFF") +
    geom_tile(aes(x = comp_2yrs, y = scientific_name, fill = fill), color = "#FFFFFF", width = 1, height = 1) +
    geom_text(aes(x = comp_2yrs, y = scientific_name, label = round(mean_continual, 2)), size = 3.5) +
    scale_fill_manual(values = c("> control" = "#eb5a1c", "no difference" = "#accaf2", "< control" = "#498c49")) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_discrete(expand = c(0, 0), labels = function(x) str_wrap(x, width = 20)) +
    theme_bw() +
    labs(x = " ",
         y = " ",
         fill = " ",
         title = str_wrap(taxon, 10)) +
    coord_fixed() +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 45, hjust = 0.75)) 
}

# test
taxon_tile_function("Bryopsidales", "epi")
```

### algae

```{r}
sda_algae_coral <- taxon_tile_function("Corallinales", "algae")
sda_algae_ceram <- taxon_tile_function("Ceramiales", "algae")
sda_algae_lamin <- taxon_tile_function("Laminariales", "algae")
sda_algae_rhodo <- taxon_tile_function("Unidentified Rhodophyta", "algae")
sda_algae_gigar <- taxon_tile_function("Gigartinales", "algae")
sda_algae_clado <- taxon_tile_function("Cladophorales", "algae")
sda_algae_bryop <- taxon_tile_function("Bryopsidales", "algae")
sda_algae_ectoc <- taxon_tile_function("Ectocarpales", "algae")
sda_algae_fucal <- taxon_tile_function("Fucales", "algae")
sda_algae_desma <- taxon_tile_function("Desmarestiales", "algae")
sda_algae_dicty <- taxon_tile_function("Dictyotales", "algae")
sda_algae_hilde <- taxon_tile_function("Hildenbrandiales", "algae")
sda_algae_rhody <- taxon_tile_function("Rhodymeniales", "algae")
sda_algae_chlor <- taxon_tile_function("Unidentified Chlorophyta", "algae")
sda_algae_gelid <- taxon_tile_function("Gelidiales", "algae")
sda_algae_graci <- taxon_tile_function("Gracilariales", "algae")
sda_algae_palma <- taxon_tile_function("Palmariales", "algae")
sda_algae_halym <- taxon_tile_function("Halymeniales", "algae")
sda_algae_nemal <- taxon_tile_function("Nemaliales", "algae")
sda_algae_ochro <- taxon_tile_function("Unidentified Ochrophyta", "algae")
sda_algae_ulval <- taxon_tile_function("Ulvales", "algae")

# chlorophyta
sda_algae_ulval
sda_algae_bryop
sda_algae_clado
sda_algae_chlor

# rhodophyta
sda_algae_rhody
sda_algae_halym
sda_algae_graci
sda_algae_ceram
sda_algae_gelid
sda_algae_gigar
sda_algae_nemal
sda_algae_coral
sda_algae_palma
sda_algae_hilde
sda_algae_rhodo

# ochrophyta
sda_algae_ectoc
sda_algae_lamin
sda_algae_fucal
sda_algae_desma
sda_algae_dicty
sda_algae_ochro

sda_algae_by_tax <- ((sda_algae_ulval / sda_algae_bryop / sda_algae_clado / sda_algae_chlor / sda_algae_rhody / sda_algae_halym) | 
  (sda_algae_graci / sda_algae_ceram / sda_algae_gelid) |
  (sda_algae_gigar / sda_algae_nemal / sda_algae_coral) | 
  (sda_algae_palma / sda_algae_hilde / sda_algae_rhodo / sda_algae_ectoc / sda_algae_lamin) |
  (sda_algae_fucal / sda_algae_desma / sda_algae_dicty / sda_algae_ochro))
sda_algae_by_tax 

ggsave(here::here("figures", paste("sda_algae_by_tax-", todays_date, ".jpg", sep = "")), 
       plot = sda_algae_by_tax,  
       height = 14, width = 20, dpi = 150)

```

### epi inverts
```{r}
sda_epi_hydro <- taxon_tile_function("Hydrozoa", "epi")
sda_epi_antho <- taxon_tile_function("Anthozoa", "epi")
sda_epi_ascid <- taxon_tile_function("Ascidiacea", "epi")
sda_epi_malac <- taxon_tile_function("Malacostraca", "epi")
sda_epi_hexan <- taxon_tile_function("Hexanauplia", "epi")
sda_epi_gymno <- taxon_tile_function("Gymnolaemata", "epi")
sda_epi_polyc <- taxon_tile_function("Polychaeta", "epi")
sda_epi_bival <- taxon_tile_function("Bivalvia", "epi")
sda_epi_steno <- taxon_tile_function("Stenolaemata", "epi")
sda_epi_holot <- taxon_tile_function("Holothuroidea", "epi")
sda_epi_demos <- taxon_tile_function("Demospongiae", "epi")
sda_epi_calca <- taxon_tile_function("Calcarea", "epi")
sda_epi_gastr <- taxon_tile_function("Gastropoda", "epi")
sda_epi_entop <- taxon_tile_function("Unidentified Entoprocta", "epi")
sda_epi_bryoz <- taxon_tile_function("Unidentified Bryozoa", "epi")

# porifera
sda_epi_demos
sda_epi_calca

# cnidaria
sda_epi_hydro
sda_epi_antho

# mollusca
sda_epi_gastr
sda_epi_bival

# annelida
sda_epi_polyc

# arthropoda
sda_epi_malac
sda_epi_hexan

# Bryozoa
sda_epi_steno
sda_epi_gymno
sda_epi_bryoz

# entoprocta
sda_epi_entop

# echinodermata
sda_epi_holot

# chordata
sda_epi_ascid

sda_epi_by_tax <- (((sda_epi_demos / sda_epi_calca / sda_epi_hydro) | (sda_epi_antho)) | (sda_epi_gastr / sda_epi_bival / sda_epi_polyc) | (sda_epi_malac / sda_epi_hexan / sda_epi_gymno) | (sda_epi_steno / sda_epi_bryoz / sda_epi_entop / sda_epi_holot) | sda_epi_ascid) 
sda_epi_by_tax

ggsave(here::here("figures", paste("sda_epi_by_tax-", todays_date, ".jpg", sep = "")), 
       plot = sda_epi_by_tax,  
       height = 10, width = 20, dpi = 150)
```


## e. endolithic invertebrates

### during/after comparison

```{r}
# during/after comparison
delta_sp_df %>% 
  filter(sp_code %in% c("CHOV", "PACA")) %>% 
  mutate(sp_code = fct_relevel(sp_code, "CHOV", "PACA")) %>%
  filter(comp_2yrs %in% c("during", "after")) %>% 
  ggplot() +
  geom_hline(aes(yintercept = 0), lty = 2, color = "grey") +
  geom_jitter(aes(x = exp_dates, y = delta_continual, col = exp_dates, shape = exp_dates), alpha = 0.4) +
  stat_summary(aes(x = exp_dates, y = delta_continual, col = exp_dates), fun.data = mean_se, geom = "errorbar", size = 1, width = 0.2) +
  stat_summary(aes(x = exp_dates, y = delta_continual, col = exp_dates, shape = exp_dates), fun = mean, geom = "point", size = 4) +
  labs(x = "Species",
       y = "\U0394 biomass (treatment - control)",
       col = "", shape = "") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 16),
        legend.position = "none") +
  facet_wrap(~sp_code, nrow = 1, scales = "free")
```

### timeseries of deltas
```{r}
# timeseries of deltas
delta_sp_df %>% 
  filter(sp_code %in% c("CHOV", "PACA")) %>% 
  # filter(site == "carp") %>% 
  ggplot(aes(x = time_since_end, y = delta_continual, col = sp_code)) +
  geom_hline(aes(yintercept = 0), lty = 2, color = "grey") +
  geom_vline(aes(xintercept = 0), lty = 2) +
  geom_rect(aes(xmin = -4, xmax = -2.5, ymin = -310, ymax = 200, group = site_full), 
            alpha = 0.1, fill = "#fae1e1", inherit.aes = FALSE) +
  stat_summary(aes(x = time_since_end, y = delta_continual, col = sp_code), fun = mean, geom = "line", size = 1) +
  stat_summary(aes(x = time_since_end, y = delta_continual, col = sp_code), fun = mean, geom = "point", size = 1) +
  labs(x = "Time since end of removal",
       y = "\U0394 biomass (treatment - control)",
       col = "", shape = "",
       title = "\U0394 endolithic inverts") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 12),
        plot.title = element_text(size = 18),
        legend.position = c(0.35, 0.9)) +
  facet_wrap(~site_full, scales = "free_y")
```

### timeseries raw biomass
```{r}
delta_sp_df %>% 
  filter(sp_code %in% c("CHOV", "PACA")) %>% 
  ggplot(aes(x = time_since_end, y = continual, col = sp_code)) +
  geom_hline(aes(yintercept = 0), lty = 2, color = "grey") +
  geom_vline(aes(xintercept = 0), lty = 2) +
  geom_rect(aes(xmin = -4, xmax = -2.5, ymin = 0, ymax = 300),
            alpha = 0.1, fill = "#fae1e1", inherit.aes = FALSE) +
  stat_summary(aes(x = time_since_end, y = continual, col = sp_code), fun = mean, geom = "line", size = 1) +
  stat_summary(aes(x = time_since_end, y = continual, col = sp_code), fun = mean, geom = "point", size = 1) +
  labs(x = "Time since end of removal",
       y = "biomass (dry g/m2)",
       col = "", shape = "",
       title = "Continual removal plots") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 12),
        plot.title = element_text(size = 18),
        legend.position = "right") +
  facet_wrap(~site_full, scales = "free_y")

delta_sp_df %>% 
  filter(sp_code %in% c("CHOV", "PACA")) %>% 
  ggplot(aes(x = time_since_end, y = control, col = sp_code)) +
  geom_hline(aes(yintercept = 0), lty = 2, color = "grey") +
  geom_vline(aes(xintercept = 0), lty = 2) +
  geom_rect(aes(xmin = -4, xmax = -2.5, ymin = 0, ymax = 200),
            alpha = 0.1, fill = "#fae1e1", inherit.aes = FALSE) +
  stat_summary(aes(x = time_since_end, y = control, col = sp_code), fun = mean, geom = "line", size = 1) +
  stat_summary(aes(x = time_since_end, y = control, col = sp_code), fun = mean, geom = "point", size = 1) +
  labs(x = "Time since end of removal",
       y = "biomass (dry g/m2)",
       col = "", shape = "",
       title = "Control plots") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 12),
        plot.title = element_text(size = 18),
        legend.position = "right") +
  facet_wrap(~site_full, scales = "free_y")
```


### delta timeseries with annual means

```{r}
# delta timeseries with annual means
endo_inverts_am <- delta_sp_df %>% 
  filter(sp_code %in% c("CHOV", "PACA")) %>% 
  group_by(sp_code, kelp_year) %>% 
  summarize(mean_delta = mean(delta_continual, na.rm = TRUE), 
            mean_tse = mean(time_since_end),
            se_delta = se(delta_continual),
            mean_continual = mean(continual, na.rm = TRUE),
            se_continual = se(continual)) %>% 
  ungroup() %>% 
  group_by(sp_code) %>% 
  mutate(sp_label = case_when(
    mean_tse == min(mean_tse) ~ sp_code,
    FALSE ~ ""
  )) %>% 
  ggplot(aes(x = mean_tse, y = mean_continual, col = sp_code)) +
  geom_line(size = 1) +
  geom_errorbar(aes(ymin = mean_continual - se_continual, ymax = mean_continual + se_continual), alpha = 0.4) +
  labs(x = "Time since end of removal", y = "Mean biomass",
       caption = "summarized by kelp year across sites", 
       title = "Endolithic invertebrates") +
  geom_text_repel(aes(x = mean_tse, y = mean_continual, label = sp_label), 
                  direction = "y", size = 5) +
  scale_x_continuous(limits = c(-7.5, 3)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 16),
        legend.position = "none") 
endo_inverts_am
```

### plots together

```{r}
plots_together_am <- algae_am / epi_inverts_am / endo_inverts_am &
  plot_annotation(tag_levels = "A") &
  theme(plot.tag = element_text(size = 20))
plots_together_am

ggsave(here::here("figures", paste("algae_invert_annual_means-", todays_date, ".jpg", sep = "")), 
       plot = plots_together_am, 
       height = 14, width = 16, dpi = 150)

# biomass %>% 
#   select(sp_code, scientific_name, common_name, new_group) %>% 
#   filter(sp_code %in% c("PTCA", "CO", "CC", "EGME", "CYOS", "DL", "R", "TEAU", "URLO", "MUCA", "DIOR", "ANSP", "CUPI", "CUSP", "STMO", "CHOV", "PACA")) %>% 
#   unique() %>% 
#   mutate(sp_code = fct_relevel(sp_code, "PTCA", "CO", "CC", "EGME", "CYOS", "DL", "R", "TEAU", "URLO", "MUCA", "DIOR", "ANSP", "CUPI", "CUSP", "STMO", "CHOV", "PACA")) %>% 
#   gt(
#     groupname_col = "new_group"
#   ) 
```


# 6. proportion algae

## a. continual only

```{r}
prop_algae_biomass <- comm_df %>% 
  filter(new_group == "algae") %>% 
  # filter(sample_ID == "CARP_2000-09-08") %>% 
  filter(sp_code != "MAPY") %>% 
  dplyr::select(site, sample_ID:exp_dates, quarter:treatment, sp_code, dry_gm2) %>% 
  filter(dry_gm2 > 0) %>% 
  # create a new column where total biomass for the species for the whole site is calculated
  group_by(site, treatment, date) %>%
  mutate(total_dry = sum(dry_gm2)) %>%
  ungroup() %>%
  # create a new column where percent of total biomass per survey for each species is calculated
  mutate(percent_sp_dry = dry_gm2/total_dry) %>% 
  # replace NaNs with 0 (which happens when there's nothing in the survey)
  # mutate_at(vars("percent_sp_dry", "percent_sp_wet"), list(~ ifelse(. = NaN, 0, .))) %>%
  # double check to make sure the percents worked out...
  dplyr::select(sample_ID:exp_dates, quarter:treatment, sp_code, dry_gm2, percent_sp_dry, total_dry) %>% 
  unique() %>% 
  group_by(sample_ID) %>% 
  mutate(total_percent_dry = sum(percent_sp_dry)) %>% 
  ungroup() %>% 
  group_by(sp_code) %>% 
  mutate(label = case_when(
    date == min(date) ~ sp_code,
    FALSE ~ ""
  ))

prop_algae_ts <- prop_algae_biomass %>% 
  # drop_na(comp_2yrs) %>% 
  # filter(sp_code == "PTCA") %>% 
  filter(sp_code %in% c("CYOS", "EGME", "PTCA")) %>% 
  # filter(sp_code %in% c("PTCA", "CO", "CC", "EGME", "CYOS", "DL", "R")) %>%
  ungroup() %>% 
  # mutate(sp_code = fct_relevel(sp_code, "CYOS", "EGME", "PTCA", "CC", "DL", "R", "CO")) %>% 
  filter(treatment == "continual") %>% 
  ggplot(aes(x = time_since_end, y = percent_sp_dry, col = sp_code)) +
  # stat_summary(aes(group = sp_code), fun = mean, geom = "point", size = 2) +
  geom_hline(aes(yintercept = 0), lty = 2) +
  geom_vline(aes(xintercept = 0), lty = 2) +
  geom_rect(aes(xmin = -4, xmax = -2.5, ymin = 0, ymax = 1), 
            alpha = 0.1, fill = "#fae1e1", inherit.aes = FALSE) +
  stat_summary(aes(group = sp_code), fun = mean, geom = "line", size = 2.5, alpha = 0.8) +
  stat_summary(aes(group = sp_code), fun = mean, geom = "point", col = "white") +
  annotate("text", x = -8.2, y = 0.12, color = "#E69512", label = "CYOS", size = 6) +
  annotate("text", x = -8.2, y = 0.45, color = "#4C4976", label = "PTCA", size = 6) +
  annotate("text", x = -8.2, y = 0.03, color = "#D3105C", label = "EGME", size = 6) +
  scale_x_continuous(limits = c(-8.3, 4.8)) +
  scale_color_manual(values = c("#E69512", "#D3105C","#4C4976")) +
  # stat_summary(aes(group = sp_code), fun.data = "mean_se", geom = "errorbar", alpha = 0.4) +
  labs(x = "Time since end of removal",
       y = "Percent biomass",
       title = "Algae",
       col = "") +
  # guides(col = guide_legend(ncol = 2)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 12),
        plot.title = element_text(size = 18),
        legend.position = "none") 
prop_algae_ts

prop_algae_biomass %>% 
  # drop_na(comp_2yrs) %>% 
  # filter(sp_code == "PTCA") %>% 
  filter(sp_code %in% c("CO", "BO", "CAL")) %>% 
  # filter(sp_code %in% c("PTCA", "CO", "CC", "EGME", "CYOS", "DL", "R")) %>%
  ungroup() %>% 
  # mutate(sp_code = fct_relevel(sp_code, "CYOS", "EGME", "PTCA", "CC", "DL", "R", "CO")) %>% 
  filter(treatment %in% c("control")) %>% 
  ggplot(aes(x = time_since_end, y = percent_sp_dry, col = sp_code)) +
  # stat_summary(aes(group = sp_code), fun = mean, geom = "point", size = 2) +
  geom_hline(aes(yintercept = 0), lty = 2) +
  geom_vline(aes(xintercept = 0), lty = 2) +
  geom_rect(aes(xmin = -4, xmax = -2.5, ymin = 0, ymax = 1), 
            alpha = 0.1, fill = "#fae1e1", inherit.aes = FALSE) +
  stat_summary(aes(group = sp_code), fun = mean, geom = "line", size = 2.5, alpha = 0.8) +
  stat_summary(aes(group = sp_code), fun = mean, geom = "point", col = "white") +
  scale_x_continuous(limits = c(-8.3, 4.8)) +
  # stat_summary(aes(group = sp_code), fun.data = "mean_se", geom = "errorbar", alpha = 0.4) +
  labs(x = "Time since end of removal",
       y = "Percent biomass",
       title = "Algae",
       col = "") +
  # guides(col = guide_legend(ncol = 2)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 12),
        plot.title = element_text(size = 18)) 

prop_algae_biomass %>% 
  # drop_na(comp_2yrs) %>% 
  # filter(sp_code == "PTCA") %>% 
  filter(sp_code %in% c("PTCA", "CO", "CC", "EGME", "CYOS", "DL", "R")) %>%
  ungroup() %>% 
  mutate(sp_code = fct_relevel(sp_code, "CYOS", "EGME", "PTCA", "CC", "DL", "R", "CO")) %>% 
  filter(treatment == "control") %>% 
  ggplot(aes(x = time_since_end, y = percent_sp_dry, col = sp_code)) +
  # stat_summary(aes(group = sp_code), fun = mean, geom = "point", size = 2) +
  geom_hline(aes(yintercept = 0), lty = 2) +
  geom_vline(aes(xintercept = 0), lty = 2) +
  geom_rect(aes(xmin = -4, xmax = -2.5, ymin = 0, ymax = 1), 
            alpha = 0.1, fill = "#fae1e1", inherit.aes = FALSE) +
  stat_summary(aes(group = sp_code), fun = mean, geom = "line", size = 1) +
  # stat_summary(aes(group = sp_code), fun.data = "mean_se", geom = "errorbar", alpha = 0.4) +
  labs(x = "Time since end of removal",
       y = "Percent biomass",
       title = "Control plots",
       col = "") +
  guides(col = guide_legend(ncol = 2)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 12),
        plot.title = element_text(size = 18),
        legend.position = c(0.12, 0.85))

prop_algae_biomass %>% 
  filter(sp_code %in% c("PTCA", "CO", "CC", "EGME", "CYOS", "DL", "R")) %>%
  # mutate(sp_code = fct_relevel(sp_code, "CYOS", "EGME", "PTCA", "CC", "DL", "R", "CO")) %>% 
  filter(treatment == "continual") %>% 
  filter(site_full == "Mohawk (MOHK)") %>% 
  # calculate mean percent biomass across species per
  group_by(year, sp_code) %>% 
  mutate(mean_prop = mean(percent_sp_dry, na.rm = TRUE),
         se_prop = se(percent_sp_dry)) %>% 
  ungroup() %>% 
  select(year, sp_code, mean_prop) %>% 
  unique() %>% 
  mutate(label = case_when(
    year == min(year) ~ sp_code,
    FALSE ~ ""
  )) %>% 
  mutate(sp_code = fct_relevel(sp_code, "CYOS", "EGME", "PTCA", "CC", "DL", "R", "CO")) %>%   
  ggplot(aes(x = year, y = mean_prop, col = sp_code)) +
  geom_rect(aes(xmin = 2013, xmax = 2015, ymin = 0, ymax = 0.6), 
            alpha = 0.1, fill = "#fae1e1", inherit.aes = FALSE) +
  geom_rect(aes(xmin = 2016, xmax = 2017, ymin = 0, ymax = 0.6), 
            alpha = 0.1, fill = "lightblue", inherit.aes = FALSE) +
  geom_point() +
  geom_line() +
  expand_limits(x = c(2009.3, 2022)) +
  scale_x_continuous(n.breaks = 12, labels = c("", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022")) +
  labs(x = "Year",
       y = "Percent biomass",
       title = "Macroalgae") +
  geom_text_repel(aes(x = 2009.4, label = label), direction = "y") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.position = "none",
        plot.title = element_text(size = 20),
        axis.text.x = element_text(angle = 45, hjust = 1))

prop_algae_biomass %>% 
  filter(sp_code %in% c("PTCA", "CO", "CC", "EGME", "CYOS", "DL", "R")) %>%
  # mutate(sp_code = fct_relevel(sp_code, "CYOS", "EGME", "PTCA", "CC", "DL", "R", "CO")) %>% 
  filter(treatment == "continual") %>% 
  # filter(site_full == "Mohawk (MOHK)") %>% 
  # calculate mean percent biomass across species per
  group_by(year, sp_code) %>% 
  mutate(mean_prop = mean(percent_sp_dry, na.rm = TRUE),
         se_prop = se(percent_sp_dry)) %>% 
  ungroup() %>% 
  select(year, sp_code, mean_prop) %>% 
  unique() %>% 
  mutate(label = case_when(
    year == min(year) ~ sp_code,
    FALSE ~ ""
  )) %>% 
  mutate(sp_code = fct_relevel(sp_code, "CYOS", "EGME", "PTCA", "CC", "DL", "R", "CO")) %>%   
  ggplot(aes(x = year, y = mean_prop, col = sp_code)) +
  geom_rect(aes(xmin = 2013, xmax = 2015, ymin = 0, ymax = 0.6), 
            alpha = 0.1, fill = "#fae1e1", inherit.aes = FALSE) +
  geom_rect(aes(xmin = 2016, xmax = 2017, ymin = 0, ymax = 0.6), 
            alpha = 0.1, fill = "lightblue", inherit.aes = FALSE) +
  geom_point() +
  geom_line() +
  expand_limits(x = c(2009.3, 2022)) +
  scale_x_continuous(n.breaks = 12, labels = c("", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022")) +
  labs(x = "Year",
       y = "Percent biomass",
       title = "Continual removal plots") +
  geom_text_repel(aes(x = 2009.4, label = label), direction = "y") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.position = "none",
        plot.title = element_text(size = 20),
        axis.text.x = element_text(angle = 45, hjust = 1))
```

## b. delta continual algae biomass

```{r}
delta_prop_algae_biomass <- comm_df %>% 
  filter(new_group == "algae") %>% 
  # filter(sample_ID == "CARP_2000-09-08") %>% 
  filter(sp_code != "MAPY") %>% 
  select(site, sample_ID:exp_dates, quarter:treatment, sp_code, dry_gm2) %>% 
  filter(dry_gm2 > 0) %>% 
  # create a new column where total biomass for the species for the whole site is calculated
  group_by(site, treatment, date) %>%
  mutate(total_dry = sum(dry_gm2)) %>%
  ungroup() %>%
  # create a new column where percent of total biomass per survey for each species is calculated
  mutate(percent_sp_dry = dry_gm2/total_dry) %>% 
  # replace NaNs with 0 (which happens when there's nothing in the survey)
  # mutate_at(vars("percent_sp_dry", "percent_sp_wet"), list(~ ifelse(. = NaN, 0, .))) %>%
  # double check to make sure the percents worked out...
  select(sample_ID:exp_dates, quarter:treatment, sp_code, dry_gm2, percent_sp_dry, total_dry) %>% 
  unique() %>% 
  group_by(sample_ID) %>% 
  mutate(total_percent_dry = sum(percent_sp_dry)) %>% 
  ungroup() %>% 
  select(-sample_ID, -total_percent_dry, -total_dry, -dry_gm2) %>% 
  pivot_wider(names_from = treatment, values_from = percent_sp_dry) %>% 
  mutate(control = replace_na(control, 0),
         continual = replace_na(continual, 0)) %>% 
  mutate(delta_prop = continual - control)

delta_prop_algae_biomass %>% 
  # drop_na(comp_2yrs) %>% 
  # filter(sp_code == "PTCA") %>% 
  filter(sp_code %in% c("PTCA", "CO", "CC", "EGME", "CYOS", "DL", "R")) %>%
  mutate(sp_code = fct_relevel(sp_code, "CYOS", "EGME", "PTCA", "CC", "DL", "R", "CO")) %>% 
  # filter(treatment == "continual") %>% 
  ggplot(aes(x = time_since_end, y = delta_prop, col = sp_code)) +
  geom_hline(aes(yintercept = 0), lty = 2) +
  geom_vline(aes(xintercept = 0), lty = 2) +
  geom_rect(aes(xmin = -4, xmax = -2.5, ymin = -0.6, ymax = 0.6), 
            alpha = 0.1, fill = "#fae1e1", inherit.aes = FALSE) +
  # geom_jitter(alpha = 0.4) +
  # stat_summary(aes(group = sp_code), fun = mean, geom = "point", size = 2, alpha = 0.8) +
  stat_summary(aes(group = sp_code), fun = mean, geom = "line", size = 1) +
  # stat_summary(aes(group = sp_code), fun.data = "mean_se", geom = "errorbar", alpha = 0.4) +
  # geom_text_repel(data = test, 
  #           aes(group = sp_code, x = -8, y = mean, label = sp_code),
  #           size = 6) +
  labs(x = "Time since end of removal",
       y = "\U0394 percent biomass (treatment - control)",
       title = "Macroalgae", col = "") +
  theme_bw() +
  guides(col = guide_legend(ncol = 2)) +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 12),
        plot.title = element_text(size = 18),
        legend.position = c(0.8, 0.85))


```

## c. basic line plot

```{r}
prop_algae_biomass_sda <- comm_df %>% 
  filter(new_group == "algae") %>% 
  # filter(sample_ID == "CARP_2000-09-08") %>% 
  filter(sp_code != "MAPY") %>% 
  select(site, sample_ID:exp_dates, quarter:treatment, sp_code, dry_gm2) %>% 
  filter(dry_gm2 > 0) %>% 
  # create a new column where total biomass for the species for the whole site is calculated
  group_by(site, treatment, date) %>%
  mutate(total_dry = sum(dry_gm2)) %>%
  ungroup() %>%
  # create a new column where percent of total biomass per survey for each species is calculated
  mutate(percent_sp_dry = dry_gm2/total_dry) %>% 
  # replace NaNs with 0 (which happens when there's nothing in the survey)
  # mutate_at(vars("percent_sp_dry", "percent_sp_wet"), list(~ ifelse(. = NaN, 0, .))) %>%
  # double check to make sure the percents worked out...
  select(sample_ID:exp_dates, quarter:treatment, sp_code, dry_gm2, percent_sp_dry, total_dry) %>% 
  unique() %>% 
  group_by(sample_ID) %>% 
  mutate(total_percent_dry = sum(percent_sp_dry)) %>% 
  ungroup() %>% 
  drop_na(comp_2yrs) %>% 
  group_by(sp_code, comp_2yrs) %>% 
  summarize(mean_prop = mean(percent_sp_dry)) %>% 
  ungroup() %>% 
  group_by(sp_code, comp_2yrs) %>% 
  mutate(color = case_when(
    mean_prop > 0.05 ~ sp_code
  ))
  # pivot_wider(names_from = comp_2yrs, values_from = mean_prop) %>% 
  # select(sp_code, start, during, after) %>% 
  # replace_na(list(start = 0, during = 0, after = 0)) %>% 
  # # column_to_rownames("sp_code") %>% 
  # make_long(sp_code, start, during, after)

ggplot(prop_algae_biomass_sda, aes(x = comp_2yrs, y = mean_prop)) +
  # geom_point(aes(col = sp_code)) +
  geom_line(aes(group = sp_code, col = color)) +
  geom_text_repel(aes(x = comp_2yrs, y = mean_prop, label = color, color = color))
```

## d. sankey plot

```{r}
prop_algae_biomass_sda_sankey <- delta_sp_df %>% 
  filter(sp_code %in% algae_spp) %>% 
  drop_na(comp_2yrs) %>% 
  group_by(sp_code, comp_2yrs) %>% 
  summarize(mean_deltas = mean(delta_continual)) %>% 
  ungroup() %>% 
  mutate(diff = case_when(
    mean_deltas > 0 ~ "> control",
    mean_deltas < 0 ~ "< control",
    mean_deltas == 0 ~ "no difference"
  )) %>% 
  mutate(diff = fct_relevel(diff, "> control", "no difference", "< control")) %>% 
  select(-mean_deltas) %>% 
  pivot_wider(names_from = comp_2yrs, values_from = diff) %>%
  select(sp_code, start, during, after) %>% 
  mutate(color = case_when(
    sp_code %in% c("PTCA", "CYOS", "CC", "R", "EGME", "DL") ~ sp_code,
    TRUE ~ " "
  )) %>% 
  mutate(color = fct_relevel(color," ", "PTCA", "CYOS", "CC", "R", "EGME", "DL"))

algae_sankey <- ggplot(prop_algae_biomass_sda_sankey, 
       aes(axis1 = start, axis2 = during, axis3 = after)) +
  scale_x_discrete(limits = c("start", "during", "after"), expand = c(.05, .05)) +
  scale_y_discrete(expand = c(0, 0)) +
  geom_alluvium(aes(fill = color), alpha = 0.8) +
  scale_fill_manual(values = c("#F0F0F0", "#E69512", "#D3105C", "#3B4F8E", 
                               "#3A5D3D", "#4C4976", "#6C91BD")) +
  # scale_fill_viridis(option = "viridis", discrete = TRUE) +
  geom_stratum(color = "grey") +
  geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 4) +
  labs(fill = "Species code",
       title = "Algae") +
  theme_bw() +
  theme(legend.position = "right",
        panel.grid = element_line(color = "white"), 
        axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        legend.text = element_text(size = 16))
algae_sankey
```


# 7. proportion epilithic invert biomass

## a. continual only

```{r}
prop_epi_inverts_biomass <- comm_df %>% 
  filter(new_group == "epi_inverts") %>% 
  # filter(sample_ID == "CARP_2000-09-08") %>% 
  dplyr::select(site, sample_ID:exp_dates, quarter:treatment, sp_code, dry_gm2) %>% 
  filter(dry_gm2 > 0) %>% 
  # create a new column where total biomass for the species for the whole site is calculated
  group_by(site, treatment, date) %>%
  mutate(total_dry = sum(dry_gm2)) %>%
  ungroup() %>%
  # create a new column where percent of total biomass per survey for each species is calculated
  mutate(percent_sp_dry = dry_gm2/total_dry) %>% 
  # replace NaNs with 0 (which happens when there's nothing in the survey)
  # mutate_at(vars("percent_sp_dry", "percent_sp_wet"), list(~ ifelse(. = NaN, 0, .))) %>%
  # double check to make sure the percents worked out...
  dplyr::select(sample_ID:exp_dates, quarter:treatment, sp_code, dry_gm2, percent_sp_dry, total_dry) %>% 
  unique() %>% 
  group_by(sample_ID) %>% 
  mutate(total_percent_dry = sum(percent_sp_dry))

test <- prop_epi_inverts_biomass %>% 
  filter(comp_2yrs == "start" & treatment == "continual") %>% 
  filter(sp_code %in% c("TEAU", "URLO", "MUCA", "DIOR", "ANSP", "CUPI", "CUSP", "STMO")) %>% 
  group_by(sp_code) %>% 
  summarize(mean = mean(percent_sp_dry))

prop_epi_inverts_ts <- prop_epi_inverts_biomass %>% 
  # drop_na(comp_2yrs) %>% 
  filter(sp_code %in% c("ANSP", "TEAU", "URLO", "MUCA")) %>% 
  # filter(sp_code %in% c("TEAU", "URLO", "MUCA", "DIOR", "ANSP", "CUPI", "CUSP", "STMO")) %>% 
  filter(treatment == "continual") %>% 
  ggplot(aes(x = time_since_end, y = percent_sp_dry, col = sp_code)) +
  geom_hline(aes(yintercept = 0), lty = 2) +
  geom_vline(aes(xintercept = 0), lty = 2) +
  geom_rect(aes(xmin = -4, xmax = -2.5, ymin = 0, ymax = 1), 
            alpha = 0.1, fill = "#fae1e1", inherit.aes = FALSE) +
  # geom_jitter(alpha = 0.4) +
  stat_summary(aes(group = sp_code), fun = mean, geom = "line", size = 2.5) +
  stat_summary(aes(group = sp_code), fun = mean, geom = "point", col = "white") +
  annotate("text", x = -8.2, y = 0.4, color = "#84A6A2", label = "ANSP", size = 6) +
  annotate("text", x = -8.2, y = 0.2, color = "#BE5A47", label = "TEAU", size = 6) +
  annotate("text", x = -8.2, y = 0.12, color = "#604A76", label = "URLO", size = 6) +
  annotate("text", x = -8.2, y = 0.35, color = "#4A5352", label = "MUCA", size = 6) +
  scale_x_continuous(limits = c(-8.3, 4.8)) +
  scale_color_manual(values = c("ANSP" = "#84A6A2", 
                                "TEAU" = "#BE5A47", 
                                "URLO" = "#604A76", 
                                "MUCA" = "#4A5352")) +
  # geom_text_repel(data = test, 
  #           aes(group = sp_code, x = -8, y = mean, label = sp_code),
  #           size = 6) +
  labs(x = "Time since end of removal",
       y = "Percent biomass",
       title = "Epilithic inverts",
       col = "") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 12),
        plot.title = element_text(size = 18),
        legend.position = "none")
prop_epi_inverts_ts

prop_epi_inverts_biomass %>% 
  filter(sp_code %in% c("TEAU", "URLO", "MUCA", "DIOR", "ANSP", "CUPI", "CUSP", "STMO")) %>% 
  filter(treatment == "control") %>% 
  # calculate mean percent biomass across species per
  group_by(year, sp_code) %>% 
  mutate(mean_prop = mean(percent_sp_dry, na.rm = TRUE),
         se_prop = se(percent_sp_dry)) %>% 
  ungroup() %>% 
  select(year, sp_code, mean_prop) %>% 
  unique() %>% 
  mutate(label = case_when(
    year == min(year) ~ sp_code,
    FALSE ~ ""
  )) %>% 
  ggplot(aes(x = year, y = mean_prop, col = sp_code)) +
  geom_rect(aes(xmin = 2013, xmax = 2015, ymin = 0, ymax = 0.8), 
            alpha = 0.1, fill = "#fae1e1", inherit.aes = FALSE) +
  geom_rect(aes(xmin = 2016, xmax = 2017, ymin = 0, ymax = 0.8), 
            alpha = 0.1, fill = "lightblue", inherit.aes = FALSE) +
  geom_point() +
  geom_line() +
  expand_limits(x = c(2009.3, 2022)) +
  scale_x_continuous(n.breaks = 12, labels = c("", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022")) +
  labs(x = "Year",
       y = "Percent biomass",
       title = "Control plots") +
  geom_text_repel(aes(x = 2009.4, label = label), direction = "y") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.position = "none",
        plot.title = element_text(size = 20),
        axis.text.x = element_text(angle = 45, hjust = 1))
```


## b. delta continual 

```{r}
delta_prop_epi_inverts_biomass <- comm_df %>% 
  filter(new_group == "epi_inverts") %>% 
  # filter(sample_ID == "CARP_2000-09-08") %>% 
  select(sample_ID:exp_dates, quarter:treatment, sp_code, dry_gm2) %>% 
  filter(dry_gm2 > 0) %>% 
  # create a new column where total biomass for the species for the whole site is calculated
  group_by(site, treatment, date) %>%
  mutate(total_dry = sum(dry_gm2)) %>%
  ungroup() %>%
  # create a new column where percent of total biomass per survey for each species is calculated
  mutate(percent_sp_dry = dry_gm2/total_dry) %>% 
  # replace NaNs with 0 (which happens when there's nothing in the survey)
  # mutate_at(vars("percent_sp_dry", "percent_sp_wet"), list(~ ifelse(. = NaN, 0, .))) %>%
  # double check to make sure the percents worked out...
  select(sample_ID:exp_dates, quarter:treatment, sp_code, dry_gm2, percent_sp_dry, total_dry) %>% 
  unique() %>% 
  group_by(sample_ID) %>% 
  mutate(total_percent_dry = sum(percent_sp_dry)) %>% 
  ungroup() %>% 
  select(-sample_ID, -total_percent_dry, -total_dry, -dry_gm2) %>% 
  pivot_wider(names_from = treatment, values_from = percent_sp_dry) %>% 
  mutate(control = replace_na(control, 0),
         continual = replace_na(continual, 0)) %>% 
  mutate(delta_prop = continual - control)

delta_prop_epi_inverts_biomass %>% 
  # drop_na(comp_2yrs) %>% 
  # filter(sp_code == "PTCA") %>% 
  filter(sp_code %in% c("TEAU", "URLO", "MUCA", "DIOR", "ANSP", "CUPI", "CUSP", "STMO")) %>%
  # filter(treatment == "continual") %>% 
  ggplot(aes(x = time_since_end, y = delta_prop, col = sp_code)) +
  geom_hline(aes(yintercept = 0)) +
  geom_vline(aes(xintercept = 0)) +
  geom_rect(aes(xmin = -4, xmax = -2.5, ymin = -0.4, ymax = 0.6), alpha = 0.3, fill = "lightgrey") +
  # geom_jitter(alpha = 0.4) +
  stat_summary(aes(group = sp_code), fun = mean, geom = "point", size = 3, alpha = 0.8) +
  stat_summary(aes(group = sp_code), fun = mean, geom = "line") +
  # geom_text_repel(data = test, 
  #           aes(group = sp_code, x = -8, y = mean, label = sp_code),
  #           size = 6) +
  labs(x = "Time since end of removal",
       y = "delta percent biomass",
       title = "Eplithic invertebrates") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.position = "bottom",
        plot.title = element_text(size = 20))
```

## c. sankey plot

```{r}
prop_epi_biomass_sda_sankey <- delta_sp_df %>% 
  left_join(., guilds, by = c("sp_code" = "sp.code")) %>% 
  filter(new_group == "epilithic.sessile.invert") %>% 
  drop_na(comp_2yrs) %>% 
  group_by(sp_code, comp_2yrs) %>% 
  summarize(mean_deltas = mean(delta_continual)) %>% 
  ungroup() %>% 
  mutate(diff = case_when(
    mean_deltas > 0 ~ "> control",
    mean_deltas < 0 ~ "< control",
    mean_deltas == 0 ~ "no difference"
  )) %>% 
  mutate(diff = fct_relevel(diff, "> control", "no difference", "< control")) %>% 
  select(-mean_deltas) %>% 
  pivot_wider(names_from = comp_2yrs, values_from = diff) %>%
  select(sp_code, start, during, after) %>% 
  mutate(color = case_when(
    sp_code %in% c("TEAU", "URLO", "MUCA", "DIOR", "ANSP", "CUPI", "CUSP", "STMO") ~ sp_code,
    TRUE ~ " "
  )) %>% 
  mutate(color = fct_relevel(color, " ", "TEAU", "URLO", "MUCA", "DIOR", "ANSP", "CUPI", "CUSP", "STMO"))

epi_sankey <- ggplot(prop_epi_biomass_sda_sankey, 
       aes(axis1 = start, axis2 = during, axis3 = after)) +
  scale_x_discrete(limits = c("start", "during", "after"), expand = c(.05, .05)) +
  scale_y_discrete(expand = c(0, 0)) +
  geom_alluvium(aes(fill = color), alpha = 0.8) +
  scale_fill_manual(values = c("#F0F0F0",
                               "#84A6A2", "#4A5352", "#151E2F",
                               "#D7C8C6", "#BE5A47", "#604A76", "#575b78", "#307e8a")) +
  # scale_fill_viridis(option = "viridis", discrete = TRUE) +
  geom_stratum(color = "grey") +
  geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 4) +
  labs(fill = "Species code",
       title = "Epilithic invertebrates") +
  theme_bw() +
  theme(legend.position = "right",
        panel.grid = element_line(color = "white"), 
        axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        legend.text = element_text(size = 16))
epi_sankey
```

## prop plots together

```{r}
plots_together_prop <- prop_algae_ts / prop_epi_inverts_ts &
  plot_annotation(tag_levels = "A") &
  theme(plot.tag = element_text(size = 20))
plots_together_prop


ggsave(here::here("figures", paste("fig4-", todays_date, ".jpg", sep = "")), 
       plot = plots_together_prop, 
       height = 8, width = 9, dpi = 150)
```

## sankey plots together

```{r}
plots_together_sankey <- algae_sankey / epi_sankey &
  plot_annotation(tag_levels = "A") &
  theme(plot.tag = element_text(size = 20))
plots_together_sankey

ggsave(here::here("figures", paste("algae_invert_sankey-", todays_date, ".jpg", sep = "")), 
       plot = plots_together_sankey, 
       height = 9, width = 9, dpi = 150)
```



# 8. proportion endolithic inverts

## a. continual only

```{r}
prop_endo_inverts_biomass <- comm_df %>% 
  filter(new_group == "endo_inverts") %>% 
  # filter(sample_ID == "CARP_2000-09-08") %>% 
  select(site, sample_ID:exp_dates, quarter:treatment, sp_code, dry_gm2) %>% 
  filter(dry_gm2 > 0) %>% 
  # create a new column where total biomass for the species for the whole site is calculated
  group_by(site, treatment, date) %>%
  mutate(total_dry = sum(dry_gm2)) %>%
  ungroup() %>%
  # create a new column where percent of total biomass per survey for each species is calculated
  mutate(percent_sp_dry = dry_gm2/total_dry) %>% 
  # replace NaNs with 0 (which happens when there's nothing in the survey)
  # mutate_at(vars("percent_sp_dry", "percent_sp_wet"), list(~ ifelse(. = NaN, 0, .))) %>%
  # double check to make sure the percents worked out...
  select(sample_ID:exp_dates, quarter:treatment, sp_code, dry_gm2, percent_sp_dry, total_dry) %>% 
  unique() %>% 
  group_by(sample_ID) %>% 
  mutate(total_percent_dry = sum(percent_sp_dry)) %>% 
  ungroup() %>% 
  complete(site_full, treatment, sp_code,  time_since_end, fill = list(percent_sp_dry = 0))

prop_endo_inverts_ts <- prop_endo_inverts_biomass %>% 
  filter(treatment == "continual") %>% 
  ggplot(aes(x = time_since_end, y = percent_sp_dry, col = sp_code)) +
  geom_hline(aes(yintercept = 0), lty = 2) +
  geom_vline(aes(xintercept = 0), lty = 2) +
  geom_rect(aes(xmin = -4, xmax = -2.5, ymin = 0, ymax = 1), 
            alpha = 0.1, fill = "#fae1e1", inherit.aes = FALSE) +
  # geom_jitter(alpha = 0.4) +
  stat_summary(aes(group = sp_code), fun = mean, geom = "line", size = 2.5) +
  stat_summary(aes(group = sp_code), fun = mean, geom = "point", col = "white") +
  # geom_text_repel(data = test, 
  #           aes(group = sp_code, x = -8, y = mean, label = sp_code),
  #           size = 6) +
  labs(x = "Time since end of removal",
       y = "Percent biomass",
       title = "Endolithic inverts",
       col = "") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 12),
        plot.title = element_text(size = 18),
        legend.position = c(0.12, 0.85)) +
  facet_wrap(~site_full)
prop_endo_inverts_ts
```

# 9. delta biomass for fg groups

```{r}
fg_deltas <- delta_fg_df %>% 
  filter(new_group %in% c("algae", "epi_inverts", "endo_inverts")) %>% 
  mutate(new_group = fct_relevel(new_group, "algae", "epi_inverts", "endo_inverts")) %>% 
  ggplot(aes(x = time_since_end, y = continual)) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(aes(fill = site, shape = site)) +
  scale_shape_manual(values = shape_palette_site) +
  scale_fill_manual(values = color_palette_site) +
  geom_smooth(aes(group = exp_dates), method = "lm", col = "#000000") +
  facet_wrap(~new_group, ncol = 1, scales = "free") +
  theme_bw() + 
  theme(axis.title = element_text(size = 16),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 14), 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of experiment", 
       y = "Raw biomass")
fg_deltas
```

# 10. log response ratio
new 2022-05-19

## a. data frames
```{r}
# annual
lrr_df_annual <- biomass %>% 
  filter(sp_code != "MAPY") %>% 
  # dplyr::select(-sp_code) %>% 
  # # make a new column for after dates
  after_dates_column() %>% 
  # make a new column for during and after and set factor levels
  exp_dates_column() %>% 
  dplyr::select(site, year, month, treatment, date, exp_dates, sp_code, dry_gm2) %>% 
  pivot_wider(names_from = treatment, values_from = dry_gm2) %>% 
  dplyr::select(-continual) %>% 
  mutate(delta_annual = annual - control) %>% 
  drop_na(delta_annual) %>% 
  mutate(exp_dates = case_when(
    # after for annual removal:
    site == "aque" & date >= aque_after_date_annual ~ "after",
    site == "napl" & date >= napl_after_date_annual ~ "after",
    site == "ivee" & date >= ivee_after_date_annual ~ "after",
    site == "mohk" & date >= mohk_after_date_annual ~ "after",
    site == "carp" & date >= carp_after_date_annual ~ "after",
    # everything else is "during" the experiment
    TRUE ~ "during"
  ),
  exp_dates = fct_relevel(exp_dates, c("during", "after"))) %>% 
  # create a column for quarter
  mutate(quarter = case_when(
    month <= 3 ~ "Q1",
    month <= 6 ~ "Q2",
    month <= 9 ~ "Q3",
    TRUE ~ "Q4"
  )) %>% 
  # calculate time since start of experiment
  mutate(time_yrs = case_when(
    # AQUE, NAPL, MOHK, CARP: control and annual started in 2008
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q1" ~ year + 0.125 - 2008,
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q2" ~ year + 0.375 - 2008,
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q3" ~ year + 0.625 - 2008,
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q4" ~ year + 0.875 - 2008, 
    # IVEE control and annual started in 2011
    site == "ivee" & quarter == "Q1" ~ year + 0.125 - 2011,
    site == "ivee" & quarter == "Q2" ~ year + 0.375 - 2011,
    site == "ivee" & quarter == "Q3" ~ year + 0.625 - 2011,
    site == "ivee" & quarter == "Q4" ~ year + 0.875 - 2011
  )) %>% 
  group_by(site) %>% 
  mutate(time_since_start = time_yrs - min(time_yrs)) %>% 
  ungroup() %>% 
  # calculate time since end of experiment
  group_by(site, exp_dates) %>% 
  # if "after", then simple: the time in years - the minimum time in years
  # if "during", then more complex: take the max time in years and add 0.25, then subtract the time in years
  mutate(time_since_end = case_when(
    exp_dates == "during" ~ -(max(time_yrs) + 0.25 - time_yrs),
    exp_dates == "after" ~ time_yrs - min(time_yrs)
  )) %>% 
  ungroup() %>% 
  left_join(., enframe(sites_full), by = c("site" = "name")) %>% 
  rename(site_full = value) %>% 
  mutate(site_full = fct_relevel(site_full, "Arroyo Quemado", "Naples", "Isla Vista", "Mohawk", "Carpinteria")) %>% 
  # create a new column for "kelp year"
  mutate(quarter = fct_relevel(quarter, "Q2", "Q3", "Q4", "Q1")) %>% 
  mutate(kelp_year = case_when(
    quarter %in% c("Q2", "Q3", "Q4") ~ year,
    quarter == "Q1" ~ year - 1
  )) %>% 
  mutate(kelp_year = paste("kelp_", kelp_year, "-", kelp_year + 1, sep = "")) %>% 
  # create a column for the points to compare for "2 year interval"
  mutate(comp_2yrs = case_when(
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2008-2009", "kelp_2009-2010") ~ "start",
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2015-2016", "kelp_2016-2017") ~ "during", 
    site == "ivee" & kelp_year %in% c("kelp_2011-2012", "kelp_2012-2013") ~ "start",
    site == "ivee" & kelp_year %in% c("kelp_2015-2016", "kelp_2016-2017") ~ "during",
    kelp_year %in% c("kelp_2020-2021", "kelp_2021-2022") ~ "after"
  )) %>% 
  mutate(comp_2yrs = fct_relevel(comp_2yrs, "start", "during", "after")) %>% 
  # create a column for the points to compare for "3 year interval"
  mutate(comp_3yrs = case_when(
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2008-2009", "kelp_2009-2010", "kelp_2010-2011") ~ "start",
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2014-2015", "kelp_2015-2016", "kelp_2016-2017") ~ "during", 
    site == "ivee" & kelp_year %in% c("kelp_2011-2012", "kelp_2012-2013", "kelp_2013-2014") ~ "start",
    site == "ivee" & kelp_year %in% c("kelp_2014-2015", "kelp_2015-2016", "kelp_2016-2017") ~ "during",
    kelp_year %in% c("kelp_2019-2020", "kelp_2020-2021", "kelp_2021-2022") ~ "after"
  )) %>% 
  mutate(comp_3yrs = fct_relevel(comp_3yrs, "start", "during", "after")) %>% 
  dplyr::select(-delta_annual) %>% 
  filter(year < 2017) %>% 
  pivot_longer(cols = control:annual, names_to = "treatment", values_to = "dry_gm2") %>% 
  group_by(treatment, exp_dates, sp_code) %>% 
  summarize(mean_biomass = mean(dry_gm2, na.rm = TRUE),
            sample_n = length(dry_gm2),
            se_biomass = sd(dry_gm2, na.rm = TRUE)/sqrt(sample_n)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = treatment, values_from = c(mean_biomass, se_biomass, sample_n)) %>%
  drop_na(sp_code) %>% 
  group_by(exp_dates, sp_code) %>% 
  # log response ratio, degrees of freedom, tscore, margin error with 95% confidence interval
  mutate(# log response ratio
    lrr_annual = log2(mean_biomass_annual/mean_biomass_control),
    # degrees of freedom
    df_annual = sample_n_annual - 1,
    # tscore
    tscore_annual = qt(p = 0.5/2, df = df_annual, lower.tail = FALSE),
    # margin error
    me_annual = tscore_annual*se_biomass_annual
  ) %>% 
  ungroup() %>% 
  # attach the spp_names df to get scientific name, taxon info, etc.
  left_join(., spp_names, by = "sp_code")

delta_sp_df %>% 
  filter(sp_code == "UV") %>% 
dplyr::select(-delta_continual) %>% 
  pivot_longer(cols = control:continual, names_to = "treatment", values_to = "dry_gm2") %>% 
  group_by(treatment, exp_dates, sp_code) %>% 
  summarize(mean_biomass = mean(dry_gm2, na.rm = TRUE),
            sample_n = length(dry_gm2),
            se_biomass = sd(dry_gm2, na.rm = TRUE)/sqrt(sample_n)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = treatment, values_from = c(mean_biomass, se_biomass, sample_n)) %>%
  drop_na(sp_code) %>% 
  group_by(exp_dates, sp_code) %>% 
  # log response ratio, degrees of freedom, tscore, margin error with 95% confidence interval
  mutate(# log response ratio
    lrr_continual = log2(mean_biomass_continual/mean_biomass_control),
    # degrees of freedom
    df_continual = sample_n_continual - 1,
    # tscore
    tscore_continual = qt(p = 0.5/2, df = df_continual, lower.tail = FALSE),
    # margin error
    me_continual = tscore_continual*se_biomass_continual
  ) %>% 
  ungroup() %>% 
  View()

# continual
lrr_df_continual <- delta_sp_df %>% 
  # dplyr::select(site, exp_dates, sp_code, dry_gm2) %>%
  dplyr::select(-delta_continual) %>% 
  pivot_longer(cols = control:continual, names_to = "treatment", values_to = "dry_gm2") %>% 
  group_by(treatment, exp_dates, sp_code) %>% 
  summarize(mean_biomass = mean(dry_gm2, na.rm = TRUE),
            sample_n = length(dry_gm2),
            se_biomass = sd(dry_gm2, na.rm = TRUE)/sqrt(sample_n)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = treatment, values_from = c(mean_biomass, se_biomass, sample_n)) %>%
  drop_na(sp_code) %>% 
  group_by(exp_dates, sp_code) %>% 
  # log response ratio, degrees of freedom, tscore, margin error with 95% confidence interval
  mutate(# log response ratio
    lrr_continual = log2(mean_biomass_continual/mean_biomass_control),
    # degrees of freedom
    df_continual = sample_n_continual - 1,
    # tscore
    tscore_continual = qt(p = 0.5/2, df = df_continual, lower.tail = FALSE),
    # margin error
    me_continual = tscore_continual*se_biomass_continual
  ) %>% 
  ungroup() %>% 
  # attach the spp_names df to get scientific name, taxon info, etc.
  left_join(., spp_names, by = "sp_code") %>% 
  mutate(across(where(is.numeric), ~na_if(., Inf)), 
    across(where(is.numeric), ~na_if(., -Inf)),
    across(where(is.numeric), ~na_if(., NaN)))

lrr_df_continual_comp2yrs <- delta_sp_df %>% 
  # dplyr::select(site, exp_dates, sp_code, dry_gm2) %>%
  dplyr::select(-delta_continual) %>% 
  pivot_longer(cols = control:continual, names_to = "treatment", values_to = "dry_gm2") %>% 
  drop_na(comp_2yrs) %>% 
  group_by(treatment, comp_2yrs, sp_code) %>% 
  summarize(mean_biomass = mean(dry_gm2, na.rm = TRUE),
            sample_n = length(dry_gm2),
            se_biomass = sd(dry_gm2, na.rm = TRUE)/sqrt(sample_n)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = treatment, values_from = c(mean_biomass, se_biomass, sample_n)) %>%
  drop_na(sp_code) %>% 
  group_by(comp_2yrs, sp_code) %>% 
  # log response ratio, degrees of freedom, tscore, margin error with 95% confidence interval
  mutate(# log response ratio
    lrr_continual = log2(mean_biomass_continual/mean_biomass_control),
    # degrees of freedom
    df_continual = sample_n_continual - 1,
    # tscore
    tscore_continual = qt(p = 0.5/2, df = df_continual, lower.tail = FALSE),
    # margin error
    me_continual = tscore_continual*se_biomass_continual
  ) %>% 
  ungroup() %>% 
  # attach the spp_names df to get scientific name, taxon info, etc.
  left_join(., spp_names, by = "sp_code") %>% 
  mutate(across(where(is.numeric), ~na_if(., Inf)), 
    across(where(is.numeric), ~na_if(., -Inf)),
    across(where(is.numeric), ~na_if(., NaN)))
```

## b. plots

### i. algae

```{r}
algae_2018 <- c("EGME", "TALE", "CYOS", "PTCA", "SAMU", "CC", "R", "DL", "CO", "GS", "RAT", "EC", "POLA")

algae_simper <- c("PTCA", "CYOS", "DL", "CC", "EC", "R", "CO")

lrr_understory_annual <- lrr_df_annual %>% 
  filter(sp_code %in% algae_2018) %>% 
  mutate(sp_code = fct_relevel(sp_code, "EGME", "TALE", "CYOS", "PTCA", "SAMU", "CC", "R", "DL", "CO", "GS", "RAT", "EC", "POLA")) %>%
  ggplot() +
  geom_hline(yintercept = 0, lty = 2, color = "grey") +
  geom_point(aes(x = sp_code, y = lrr_annual), size = 5) +
  geom_linerange(aes(x = sp_code, y = lrr_annual, ymin = lrr_annual - me_annual, ymax = lrr_annual + me_annual), size = 1) +
  labs(x = "Species", y = "Log response ratio",
       title = "Understory algae: annual") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 20),
        strip.text = element_text(size = 16),
        plot.title = element_text(size = 20), 
        panel.grid = element_blank()) +
  facet_wrap(~exp_dates) 
lrr_understory_annual
# ggsave(here::here("figures/fg-recovery", paste("lrr_understory_annual_", todays_date, ".jpg", sep = "")), lrr_understory_annual, width = 8, height = 6)

lrr_understory_continual <- lrr_df_continual %>% 
  filter(sp_code %in% algae_simper) %>% 
  # mutate(sp_code = fct_relevel(sp_code, "EGME", "TALE", "CYOS", "PTCA", "SAMU", "CC", "R", "DL", "CO", "GS", "RAT", "EC", "POLA")) %>%
  filter(group == "algae") %>% 
  ggplot() +
  geom_hline(yintercept = 0, lty = 2, color = "grey") +
  geom_point(aes(x = reorder(sp_code, -lrr_continual), y = lrr_continual), size = 5) +
  geom_linerange(aes(x = sp_code, y = lrr_continual, ymin = lrr_continual - me_continual, ymax = lrr_continual + me_continual), size = 1) +
  labs(x = "Species", y = "Log response ratio",
       title = "Understory algae: continual") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 20),
        strip.text = element_text(size = 16),
        plot.title = element_text(size = 20), 
        panel.grid = element_blank()) +
  facet_wrap(~exp_dates) 
lrr_understory_continual
# ggsave(here::here("figures/fg-recovery", paste("lrr_understory_continual_", todays_date, ".jpg", sep = "")), lrr_understory_continual, width = 12, height = 6)

lrr_df_continual_comp2yrs %>% 
  #filter(sp_code == "CYOS") %>% 
  filter(sp_code %in% algae_simper) %>% 
  ggplot() +
  geom_hline(yintercept = 0, lty = 2, color = "grey") +
  geom_point(aes(x = scientific_name, y = lrr_continual), size = 5) +
  geom_linerange(aes(x = scientific_name, y = lrr_continual, ymin = lrr_continual - me_continual, ymax = lrr_continual + me_continual), size = 1) +
  labs(x = "Species", y = "Log response ratio",
       title = "Understory algae: continual") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 20),
        strip.text = element_text(size = 16),
        plot.title = element_text(size = 20), 
        panel.grid = element_blank()) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 30)) +
  facet_wrap(~comp_2yrs, scales = "free")
  ggsave(here::here("figures/fg-recovery", paste("lrr_understory_continual_spp_during", todays_date, ".jpg", sep = "")), width = 25, height = 25)
```

### ii. epilithic inverts
```{r}
epi_inv_2018 <- c("TEAU", "URLO", "MUCA", "DIOR", "ANSP", "CUPI", "CUSP", "STMO")

lrr_epi_inv_annual <- lrr_df_annual %>% 
  filter(sp_code %in% epi_inv_2018) %>% 
  mutate(sp_code = fct_relevel(sp_code, "TEAU", "URLO", "MUCA", "DIOR", "ANSP", "CUPI", "CUSP", "STMO")) %>%
  ggplot() +
  geom_hline(yintercept = 0, lty = 2, color = "grey") +
  geom_point(aes(x = sp_code, y = lrr_annual), size = 5) +
  geom_linerange(aes(x = sp_code, y = lrr_annual, ymin = lrr_annual - me_annual, ymax = lrr_annual + me_annual), size = 1) +
  labs(x = "Species", y = "Log response ratio",
       title = "Epilithic inverts: annual") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 20),
        strip.text = element_text(size = 16),
        plot.title = element_text(size = 20), 
        panel.grid = element_blank()) +
  facet_wrap(~exp_dates) 
lrr_epi_inv_annual
# ggsave(here::here("figures/fg-recovery", paste("lrr_epi_inv_annual", todays_date, ".jpg", sep = "")), lrr_epi_inv_annual, width = 8, height = 6)

lrr_epi_inv_continual <- lrr_df_continual %>% 
  filter(sp_code %in% c("MUCA", "ANSP", "TEAU", "STMO", "CRGI", "URLO", "CUSP")) %>% 
  mutate(sp_code = fct_relevel(sp_code, "TEAU", "URLO", "MUCA", "DIOR", "ANSP", "CUPI", "CUSP", "STMO")) %>%
  ggplot() +
  geom_hline(yintercept = 0, lty = 2, color = "grey") +
  geom_point(aes(x = sp_code, y = lrr_continual), size = 5) +
  geom_linerange(aes(x = sp_code, y = lrr_continual, ymin = lrr_continual - me_continual, ymax = lrr_continual + me_continual), size = 1) +
  labs(x = "Species", y = "Log response ratio",
       title = "Epilithic inverts: continual") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 20),
        strip.text = element_text(size = 16),
        plot.title = element_text(size = 20), 
        panel.grid = element_blank()) +
  facet_wrap(~exp_dates) 
lrr_epi_inv_continual
# ggsave(here::here("figures/fg-recovery", paste("lrr_epi_inv_continual", todays_date, ".jpg", sep = "")), lrr_epi_inv_continual, width = 8, height = 6)
```

### iii. endolithic inverts

```{r}
end_inv_2018 <- c("CHOV", "PACA")

lrr_end_inv_annual <- lrr_df_annual %>% 
  filter(sp_code %in% end_inv_2018) %>% 
  mutate(sp_code = fct_relevel(sp_code, "CHOV", "PACA")) %>%
  ggplot() +
  geom_hline(yintercept = 0, lty = 2, color = "grey") +
  geom_point(aes(x = sp_code, y = lrr_annual), size = 5) +
  # geom_linerange(aes(x = sp_code, y = lrr_annual, ymin = lrr_annual - me_annual, ymax = lrr_annual + me_annual), size = 1) +
  labs(x = "Species", y = "Log response ratio",
       title = "Endolithic inverts: annual") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 20),
        strip.text = element_text(size = 16),
        plot.title = element_text(size = 20), 
        panel.grid = element_blank()) +
  facet_wrap(~exp_dates) 
lrr_end_inv_annual
# ggsave(here::here("figures/fg-recovery", paste("lrr_end_inv_annual", todays_date, ".jpg", sep = "")), lrr_end_inv_annual, width = 8, height = 6)

lrr_end_inv_continual <- lrr_df_continual %>% 
  filter(sp_code %in% end_inv_2018) %>% 
  mutate(sp_code = fct_relevel(sp_code, "CHOV", "PACA")) %>%
  ggplot() +
  geom_hline(yintercept = 0, lty = 2, color = "grey") +
  geom_point(aes(x = sp_code, y = lrr_continual), size = 5) +
  # geom_linerange(aes(x = sp_code, y = lrr_continual, ymin = lrr_continual - me_continual, ymax = lrr_continual + me_continual), size = 1) +
  labs(x = "Species", y = "Log response ratio",
       title = "Endolithic inverts: continual") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 16),
        axis.title = element_text(size = 20),
        strip.text = element_text(size = 16),
        plot.title = element_text(size = 20), 
        panel.grid = element_blank()) +
  facet_wrap(~exp_dates) 
lrr_end_inv_continual
# ggsave(here::here("figures/fg-recovery", paste("lrr_end_inv_continual", todays_date, ".jpg", sep = "")), lrr_end_inv_continual, width = 8, height = 6)
```


# 11. algae vs inverts

```{r}
left_join(delta_algae_continual, delta_invert_continual, by = "sample_ID") %>% 
  left_join(., delta_clam_continual, by = "sample_ID") %>% 
  mutate(sum_inverts = continual_inverts + continual_clams) %>% 
  filter(exp_dates == "during") %>% 
  ggplot(aes(x = continual_algae, y = continual_inverts)) +
  geom_point(aes(fill = site.x, shape = site.x), size = 3, alpha = 0.9) +
  geom_smooth(method = "lm", se = FALSE) +
  scale_shape_manual(values = shape_palette_site) +
  scale_fill_manual(values = color_palette_site) +
  # scale_y_continuous(limits = c(0, 7000)) +
  theme_bw() + 
  theme(axis.title = element_text(size = 16),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 14), 
        legend.position = "none", 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = expression(algae~biomass~(g/m^{"2"})),
       y = expression(epilithic~invertebrate~biomass~(g/m^{"2"})))
```







