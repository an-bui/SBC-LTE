---
title: "shape of recovery"
author: "An Bui"
date: "6/1/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Model selection for delta frond density

Using function from the Thiault script below. Made edits to not print out results in the quartz viewer.

```{r}
ProgressiveChangeBACIPS<-function(control, impact, time.true, time.model) 
{
	### STEP 2 - Calculate the delta at each sampling date
	delta <- impact - control
	
	# Plot delta against time.true
	# dev.new(width=10, height=5)
	# par(mfrow=c(1,2))
	plot(delta~time.true, type="n")
	time.model.of.impact=max(which(time.model==0))
	rect(time.model.of.impact, min(delta)-100, max(time.model)+10, max(delta)+100, col = "grey")
	points(delta~time.true, pch=24, bg="white", cex=2)
	
	### STEP 3 - Fit and compete models
	## Create a 'period' variable: if the time model == 0, assign "before"
	## otherwise, assign "after"
	## this is the only predictor in the aov() call below
	period <- ifelse(time.model == 0, "Before", "After")
	
	## Fit a step model
	# analysis of variance: comparing means
	step.Model<-aov(delta ~ period)

	## Fit a linear model
	# linear model: delta as a function of time.model
	# 0s in "before", sequence of numbers in "after"
	linear.Model<-lm(delta ~ time.model)
	
	## Fit an asymptotic model
	# Create an asymptotic function
	myASYfun<-function(delta, time.model)
	{
		funAsy<-function(parS, time.model)	(parS$M * time.model) / (parS$L + time.model) + parS$B
		residFun<-function(p, observed, time.model) observed + funAsy(p,time.model)
		parStart <- list(M=mean(delta[time.model.of.impact:length(time.true)]), B=mean(delta[1:time.model.of.impact]), L=1)
		nls_ASY_out <- nls.lm(par=parStart, fn= residFun, observed=delta, time.model=time.model, control = nls.lm.control(maxfev = integer(), maxiter = 1000))
		foAsy<-delta~(M * time.model) / (L + time.model) + B
		startPar<-c(-coef(nls_ASY_out)[1], coef(nls_ASY_out)[2], coef(nls_ASY_out)[3])
		asyFit<-nls2(foAsy, start=startPar, algorithm="brute-force") # nls2 enables to calculate AICc
		asyFit
	}
	# Fit the asymptotic model
	asymptotic.Model<-myASYfun(delta=delta,time.model=time.model)
	
	
	## Fit a sigmoid model
	## Create a sigmoid function
	mySIGfun<-function(delta, time.model)
	{
		funSIG<-function(parS, time.model)	(parS$M * (time.model/parS$L)^parS$K) / (1 + (time.model/parS$L) ^ parS$K) + parS$B
		residFun<-function(p, observed, time.model) observed + funSIG(p,time.model)
		parStart <- list(M=mean(delta[time.model.of.impact:length(time.true)]), B=mean(delta[1:time.model.of.impact]), L=mean(time.model), K=5)
		nls_SIG_out <- nls.lm(par=parStart, fn= residFun, observed=delta, time.model=time.model, control = nls.lm.control(maxfev = integer(), maxiter = 1000))
		foSIG<-delta~(M * (time.model/L) ^ K) / (1 + (time.model/L) ^ K) + B
		startPar<-c(-coef(nls_SIG_out)[1],-coef(nls_SIG_out)[2],coef(nls_SIG_out)[3],coef(nls_SIG_out)[4])
		sigFit<-nls2(foSIG, start=startPar, algorithm="brute-force") # nls2 enables to calculate AICc
		sigFit
	}
	# Fit the sigmoid model
	sigmoid.Model<-mySIGfun(delta=delta,time.model=time.model)


	## Compete models
	# Perform AIC tests
	AIC.test<-AIC(step.Model, linear.Model, asymptotic.Model, sigmoid.Model)
	AICc.test<-as.data.frame(cbind(AIC.test[,1], c(AICc(step.Model), AICc(linear.Model), AICc(asymptotic.Model), AICc(sigmoid.Model))))
	rownames(AICc.test)<-rownames(AIC.test)
	names(AICc.test)<-names(AIC.test)
	
	# Calculate AICc weight and selected the best model
	for(i in 1:dim(AICc.test)[1])
	{
		AICc.test$diff[i]<-AICc.test$AIC[i]-min(AICc.test$AIC)
	}
	AICc.test$RL<-exp(-0.5* AICc.test$diff)
	RL_sum<-sum(AICc.test$RL)
	AICc.test$aicWeights<-(AICc.test$RL/RL_sum)*100
	w<-AICc.test$aicWeights
	names(w)<-rownames(AICc.test)
	
	# Display raw AIC values
	print(AICc.test)

	# Display AICc weights
	# print(w)
	barplot(w, col="white", ylab="Relative likelihood (%)", cex.names = 0.9, names.arg =c("Step","Linear","Asymptotic","Sigmoid"))
	best.Model<-which(w==max(w))
	
	model.formula <- if(best.Model==1) {
	  step.Model
	} else if(best.Model==2) {
	  linear.Model
	} else if(best.Model==3) {
	  asymptotic.Model
	} else if(best.Model==4) {
	  sigmoid.Model
	}
	
	message <- if(best.Model==1) {
	  "Step"
	} else if(best.Model==2) {
	  "Linear"
	} else if(best.Model==3) {
	  "Asymptotic"
	} else if(best.Model==4) {
	  "Sigmoid"
	}
	
	likelihood <- if(best.Model==1) {
	  paste(round(w[1],1), "%", sep="")
	} else if(best.Model==2) {
	  paste(round(w[2],1), "%", sep="")
	} else if(best.Model==3) {
	  paste(round(w[3],1), "%", sep="")
	} else if(best.Model==4) {
	  paste(round(w[4],1), "%", sep="")
	}
	  
	### STEP 4 - Derive inference based on the best model (i.e., with the higher AICc weight)
	if(best.Model==1) {writeLines(paste("\n\nSTEP MODEL SELECTED - Likelihood = ", round(w[1],1), "%\n\n", sep=""))
		print(summary(step.Model))}
	if(best.Model==2) {writeLines(paste("\n\nLINEAR MODEL SELECTED - Likelihood = ", round(w[2],1), "%\n\n", sep=""))
		print(summary(linear.Model))}
	if(best.Model==3) {writeLines(paste("\n\nASYMPTOTIC MODEL SELECTED - Likelihood = ", round(w[3],1), "%\n\n", sep=""))
		print(asymptotic.Model)}
	if(best.Model==4) {writeLines(paste("\n\nSIGMOID MODEL SELECTED - Likelihood = ", round(w[4],1), "%\n\n", sep=""))
		print(sigmoid.Model)}
	
	return(c(message = message,
	         likelihood = likelihood,
	         aicc.test.results = AICc.test, 
	         step.model.summary = summary(step.Model), 
	         linear.model.summary = summary(linear.Model), 
	         asy.model.summary = asymptotic.Model, 
	         sigmoid.model.summary = sigmoid.Model))
}

```

Function to add a column in the biomass data frame for each site called `time.model` that has the timesteps labelled the way the function wants them.

```{r}
time.model.fxn.new <- function(site, treatment, season_choice) {
  # select a data frame based on site and treatment
  df <- if(treatment == "annual") {
    delta_annual
  } else if(treatment == "continual") {
    delta_continual
  } else {
    warning("Check your arguments! You might be missing site, treatment, or season.")
  }
  
  season_choice <- if(season_choice == "all") {
    c("winter", "spring", "summer", "fall")
  } else if(season_choice == "summer") {
    c("summer")
  } else if (season_choice == "fall") {
    c("fall")
  } else if (season_choice == "winter") {
    c("winter")
  } else if (season_choice == "spring") {
    c("spring")
  } else {
    warning("Check your arguments! You might be missing site, treatment, or season.")
    return(NA)
  }
  
  df %>% 
  filter(site == {{ site }}) %>% 
  dplyr::select(site, year, month, date, control, 7, exp_dates, contains("delta_"), time_since_end) %>% 
  mutate(exp_dates = fct_relevel(exp_dates, c("after", "during"))) %>% 
  arrange(exp_dates) %>% 
  # assign everything a "time step number" using the row numbers...
  rownames_to_column("time.model") %>% 
  # only keep the time step numbers for the "after dates"
  # make everything else 0 (i.e. everything else is before the "after")
  mutate(time.model = case_when(
    exp_dates == "during" ~ 0,
    TRUE ~ as.numeric(as.numeric(time.model))
  )) %>% 
  # rearrange the sampling dates to be in logical order
  mutate(exp_dates = fct_relevel(exp_dates, c("during", "after"))) %>% 
  arrange(exp_dates) 
}

biomass.pcbacips <- function(df) {
  ProgressiveChangeBACIPS(
    control = pull(df, 6), # control column
    impact = pull(df, 7), # treatment column
    time.true = pull(df, 5), # date column
    time.model = pull(df, 1) # time.model column
  )
}
```

### Figures

For reference.
```{r}
delta_annual_plot
delta_continual_plot
```


### Arroyo Quemado

**Notes to self**: maybe the ProgressiveChangeBACIPS is useful for figuring out what is happening in removal plots post-experiment-end relative to during the experiment. For example, it's useful to know when the change is a step change as opposed to a linear change. However, the linear model approximation is not great - that might be due to the model formulation, but probably not. 

```{r}
aque_biomass_annual <- time.model.fxn.new("aque", "annual", "all")
aque_biomass_annual_summer <- time.model.fxn.new("aque", "annual", "summer")
aque_biomass_annual_fall <- time.model.fxn.new("aque", "annual", "fall")

aque_biomass_continual <- time.model.fxn.new("aque", "continual", "all")
aque_biomass_continual_summer <- time.model.fxn.new("aque", "continual", "summer")
aque_biomass_continual_fall <- time.model.fxn.new("aque", "continual", "fall")

aque_annual_bacips_results <- biomass.pcbacips(aque_biomass_annual)

# STEP MODEL SELECTED - Likelihood = 62.2%

control_bio <- aque_biomass_annual$control
annual_bio <- aque_biomass_annual$annual
delta_bio <- annual_bio - control_bio
TukeyHSD(aov(delta_bio ~ aque_biomass_annual$exp_dates))

aque_continual_bacips_results <- biomass.pcbacips(aque_biomass_continual)

# LINEAR MODEL SELECTED - Likelihood = 82.1%

aque_bacips_plot <- delta_continual %>% 
  filter(site == "aque" & exp_dates == "after") %>% 
  ggplot(aes(x = time_since_end, y = delta_continual)) +
  geom_hline(yintercept = 0, lty = 2, alpha = 0.3) +
  geom_point(shape = aque_shape, fill = aque_col, size = 4) +
  geom_function(fun = function(x) -249.35+(15.8*x), size = 2) +
  labs(x = "Time since end of removal (years)", y = "\U0394 giant kelp biomass",
       title = aque_full) +
  theme_bw() + 
  theme(axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        legend.text = element_text(size = 16), 
        legend.position = "none") 
aque_bacips_plot 
  

aque_annual_bacips_results_summer <- biomass.pcbacips(aque_biomass_annual_summer)
# STEP MODEL SELECTED - Likelihood = 62.3%

aque_continual_bacips_results_summer <- biomass.pcbacips(aque_biomass_continual_summer)
# LINEAR MODEL SELECTED - Likelihood = 54.3%

aque_annual_bacips_results_fall <- biomass.pcbacips(aque_biomass_annual_fall)
# STEP MODEL SELECTED - Likelihood = 45.9%

aque_continual_bacips_results_fall <- biomass.pcbacips(aque_biomass_continual_fall)
# LINEAR MODEL SELECTED - Likelihood = 71.9%
```



### Naples

```{r}
napl_biomass_annual <- time.model.fxn.new("napl", "annual", "all")
napl_biomass_annual_summer <- time.model.fxn.new("napl", "annual", "summer")
napl_biomass_annual_fall <- time.model.fxn.new("napl", "annual", "fall")

napl_biomass_continual <- time.model.fxn.new("napl", "continual", "all")
napl_biomass_continual_summer <- time.model.fxn.new("napl", "continual", "summer")
napl_biomass_continual_fall <- time.model.fxn.new("napl", "continual", "fall")

napl_annual_bacips_results <- biomass.pcbacips(napl_biomass_annual)

# LINEAR MODEL SELECTED - Likelihood = 47.8%

napl_continual_bacips_results <- biomass.pcbacips(napl_biomass_continual)

# LINEAR MODEL SELECTED - Likelihood = 54.6%

napl_bacips_plot <- delta_continual %>% 
  filter(site == "napl" & exp_dates == "after") %>% 
  ggplot(aes(x = time_since_end, y = delta_continual)) +
  geom_hline(yintercept = 0, lty = 2, alpha = 0.3) +
  geom_point(shape = napl_shape, fill = napl_col, size = 4) +
  geom_function(fun = function(x) -196.417+(11.9*x), size = 2) +
  labs(x = "Time since end of removal (years)", y = "\U0394 giant kelp biomass",
       title = napl_full) +
  theme_bw() + 
  theme(axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        legend.text = element_text(size = 16), 
        legend.position = "none") 
napl_bacips_plot 

napl_annual_bacips_results_summer <- biomass.pcbacips(napl_biomass_annual_summer)

# STEP MODEL SELECTED - Likelihood = 60.6%

napl_continual_bacips_results_summer <- biomass.pcbacips(napl_biomass_continual_summer)
# LINEAR MODEL SELECTED - Likelihood = 67.5%

napl_annual_bacips_results_fall <- biomass.pcbacips(napl_biomass_annual_fall)
# LINEAR MODEL SELECTED - Likelihood = 50.1%

napl_continual_bacips_results_fall <- biomass.pcbacips(napl_biomass_continual_fall)
# LINEAR MODEL SELECTED - Likelihood = 76.3%
```

### Isla Vista

```{r}
ivee_biomass_annual <- time.model.fxn.new("ivee", "annual", "all")
ivee_biomass_annual_summer <- time.model.fxn.new("ivee", "annual", "summer")
ivee_biomass_annual_fall <- time.model.fxn.new("ivee", "annual", "fall")

ivee_annual_bacips_results <- biomass.pcbacips(ivee_biomass_annual)
# STEP MODEL SELECTED - Likelihood = 92.5%

ivee_annual_bacips_results_summer <- biomass.pcbacips(ivee_biomass_annual_summer)

# STEP MODEL SELECTED - Likelihood = 60.6%

ivee_annual_bacips_results_fall <- biomass.pcbacips(ivee_biomass_annual_fall)

# STEP MODEL SELECTED - Likelihood = 63.2%
```

### Mohawk

```{r}
mohk_biomass_annual <- time.model.fxn.new("mohk", "annual", "all")
mohk_biomass_annual_summer <- time.model.fxn.new("mohk", "annual", "summer")
mohk_biomass_annual_fall <- time.model.fxn.new("mohk", "annual", "fall")

mohk_biomass_continual <- time.model.fxn.new("mohk", "continual", "all")
mohk_biomass_continual_summer <- time.model.fxn.new("mohk", "continual", "summer")
mohk_biomass_continual_fall <- time.model.fxn.new("mohk", "continual", "fall")

mohk_annual_bacips_results <- biomass.pcbacips(mohk_biomass_annual)
# INEAR MODEL SELECTED - Likelihood = 48%

mohk_continual_bacips_results <- biomass.pcbacips(mohk_biomass_continual)

# LINEAR MODEL SELECTED - Likelihood = 79.9%

mohk_bacips_plot <- delta_continual %>% 
  filter(site == "mohk" & exp_dates == "after") %>% 
  ggplot(aes(x = time_since_end, y = delta_continual)) +
  geom_hline(yintercept = 0, lty = 2, alpha = 0.3) +
  geom_point(shape = mohk_shape, fill = mohk_col, size = 4) +
  geom_function(fun = function(x) -824.75+(54.85*x), size = 2) +
  labs(x = "Time since end of removal (years)", y = "\U0394 giant kelp biomass",
       title = mohk_full) +
  theme_bw() + 
  theme(axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        legend.text = element_text(size = 16), 
        legend.position = "none") 
mohk_bacips_plot 

mohk_annual_bacips_results_summer <- biomass.pcbacips(mohk_biomass_annual_summer)

# LINEAR MODEL SELECTED - Likelihood = 62.3%

mohk_continual_bacips_results_summer <- biomass.pcbacips(mohk_biomass_continual_summer)
# LINEAR MODEL SELECTED - Likelihood = 88.9%

mohk_annual_bacips_results_fall <- biomass.pcbacips(mohk_biomass_annual_fall)
# STEP MODEL SELECTED - Likelihood = 51%

mohk_continual_bacips_results_fall <- biomass.pcbacips(mohk_biomass_continual_fall)
# LINEAR MODEL SELECTED - Likelihood = 81.6%
```

### Carpinteria

```{r}
carp_biomass_annual <- time.model.fxn.new("carp", "annual", "all")
carp_biomass_annual_summer <- time.model.fxn.new("carp", "annual", "summer")
carp_biomass_annual_fall <- time.model.fxn.new("carp", "annual", "fall")

carp_biomass_continual <- time.model.fxn.new("carp", "continual", "all")
carp_biomass_continual_summer <- time.model.fxn.new("carp", "continual", "summer")
carp_biomass_continual_fall <- time.model.fxn.new("carp", "continual", "fall")

carp_annual_bacips_results <- biomass.pcbacips(carp_biomass_annual)

# LINEAR MODEL SELECTED - Likelihood = 52.9%

carp_continual_bacips_results <- biomass.pcbacips(carp_biomass_continual)

# STEP MODEL SELECTED - Likelihood = 58.3%

TukeyHSD(aov(delta_continual ~ exp_dates, data = carp_biomass_continual))

carp_bacips_plot <- delta_continual %>% 
  filter(site == "carp" & exp_dates == "after") %>% 
  ggplot(aes(x = time_since_end, y = delta_continual)) +
  geom_hline(yintercept = 0, lty = 2, alpha = 0.3) +
  geom_point(shape = carp_shape, fill = carp_col, size = 4) +
  geom_function(fun = function(x) 0, size = 2) +
  labs(x = "Time since end of removal (years)", y = "\U0394 giant kelp biomass",
       title = carp_full) + 
  theme_bw() + 
  theme(axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        legend.text = element_text(size = 16), 
        legend.position = "none") 
carp_bacips_plot 

carp_annual_bacips_results_summer <- biomass.pcbacips(carp_biomass_annual_summer)

# STEP MODEL SELECTED - Likelihood = 48.5%

carp_continual_bacips_results_summer <- biomass.pcbacips(carp_biomass_continual_summer)
# STEP MODEL SELECTED - Likelihood = 50.3%

carp_annual_bacips_results_fall <- biomass.pcbacips(carp_biomass_annual_fall)
# STEP MODEL SELECTED - Likelihood = 50.2%

carp_continual_bacips_results_fall <- biomass.pcbacips(carp_biomass_continual_fall)
# STEP MODEL SELECTED - Likelihood = 50.3%



```

### segmented regression

#### annual

```{r}
aque_lm <- lm(delta_annual ~ time.model, data = aque_biomass_annual %>% filter(time.model > 0))
summary(aque_lm)
aque_seg_lm <- segmented(aque_lm)
summary(aque_seg_lm)
AIC(aque_lm, aque_seg_lm)
# very different, plot
aque_fit <- fitted(aque_seg_lm) %>% 
  enframe() %>% 
  rename(time.model = "name") %>% 
  mutate(time.model = as.numeric(time.model))
aque_seg_plot <- aque_biomass_annual %>% 
  left_join(., aque_fit, by = "time.model") %>% 
  ggplot(aes(x = time_since_end, y = delta_annual)) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(aes(col = exp_dates)) +
  geom_smooth(aes(col = exp_dates), method = "lm") +
  geom_line(aes(y = value), size = 1, lty = 2, col = "blue") +
  theme_bw() +
  theme(legend.position = "none",
        axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10)) +
  labs(x = "Time since end of experiment", y = "\U0394 biomass (treatment - control)",
       title = "\U0394 annual - AQUE") 
aque_seg_plot
# test for significant differences in slope between both segments
davies.test(aque_lm, seg.Z = ~time.model, k = 15)
# slopes in both segments are significantly different

napl_lm <- lm(delta_annual ~ time.model, data = napl_biomass_annual %>% filter(time.model > 0))
summary(napl_lm)
napl_seg_lm <- segmented(napl_lm)
AIC(napl_lm, napl_seg_lm)
# not very different, don't plot

ivee_lm <- lm(delta_annual ~ time.model, data = ivee_biomass_annual %>% filter(time.model > 0))
summary(ivee_lm)
ivee_seg_lm <- segmented(ivee_lm)
AIC(ivee_lm, ivee_seg_lm)
# seg is worse, don't plot

mohk_lm <- lm(delta_annual ~ time.model, data = mohk_biomass_annual %>% filter(time.model > 0))
summary(mohk_lm)
mohk_seg_lm <- segmented(mohk_lm)
AIC(mohk_lm, mohk_seg_lm)
# seg better, plot
mohk_fit <- fitted(mohk_seg_lm) %>% 
  enframe() %>% 
  rename(time.model = "name") %>% 
  mutate(time.model = as.numeric(time.model))
mohk_seg_plot <- mohk_biomass_annual %>% 
  left_join(., mohk_fit, by = "time.model") %>% 
  ggplot(aes(x = time_since_end, y = delta_annual)) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(aes(col = exp_dates)) +
  geom_smooth(aes(col = exp_dates), method = "lm") +
  geom_line(aes(y = value), size = 1, lty = 2, col = "blue") +
  theme_bw() +
  theme(legend.position = "none",
        axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10)) +
  labs(x = "Time since end of experiment", y = "\U0394 biomass (treatment - control)",
       title = "\U0394 annual - MOHK") 
mohk_seg_plot
# test for significant differences in slope between both segments
davies.test(mohk_lm, seg.Z = ~time.model, k = 15)
# slopes in both segments are not significantly different???????

carp_lm <- lm(delta_annual ~ time.model, data = carp_biomass_annual %>% filter(time.model > 0))
summary(carp_lm)
carp_seg_lm <- segmented(carp_lm)
AIC(carp_lm, carp_seg_lm)
# seg is better, plot
carp_fit <- fitted(carp_seg_lm) %>% 
  enframe() %>% 
  rename(time.model = "name") %>% 
  mutate(time.model = as.numeric(time.model))
carp_seg_plot <- carp_biomass_annual %>% 
  left_join(., carp_fit, by = "time.model") %>% 
  ggplot(aes(x = time_since_end, y = delta_annual)) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(aes(col = exp_dates)) +
  geom_smooth(aes(col = exp_dates), method = "lm") +
  geom_line(aes(y = value), size = 1, lty = 2, col = "blue") +
  theme_bw() +
  theme(legend.position = "none",
        axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10)) +
  labs(x = "Time since end of experiment", y = "\U0394 biomass (treatment - control)",
       title = "\U0394 annual - CARP") 
carp_seg_plot
# test for significant differences in slope between both segments
davies.test(carp_lm, seg.Z = ~time.model, k = 15)
# slopes in both segments are not significantly different???????
```

#### continual

```{r}
aque_lm <- lm(delta_continual ~ time.model, data = aque_biomass_continual %>% filter(time.model > 0))
summary(aque_lm)
aque_seg_lm <- segmented(aque_lm)
summary(aque_seg_lm)
AIC(aque_lm, aque_seg_lm)
# seg somewhat better, plot
aque_fit <- fitted(aque_seg_lm) %>% 
  enframe() %>% 
  rename(time.model = "name") %>% 
  mutate(time.model = as.numeric(time.model))
aque_seg_plot <- aque_biomass_continual %>% 
  left_join(., aque_fit, by = "time.model") %>% 
  ggplot(aes(x = time_since_end, y = delta_continual)) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(aes(col = exp_dates)) +
  geom_smooth(aes(col = exp_dates), method = "lm") +
  geom_line(aes(y = value), size = 1, lty = 2, col = "blue") +
  theme_bw() +
  theme(legend.position = "none",
        axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10)) +
  labs(x = "Time since end of experiment", y = "\U0394 biomass (treatment - control)",
       title = "\U0394 continual - AQUE")  
aque_seg_plot
# test for significant differences in slope between both segments
davies.test(aque_lm, seg.Z = ~time.model, k = 15)
# slopes in both segments are not significantly different

napl_lm <- lm(delta_continual ~ time.model, data = napl_biomass_continual %>% filter(time.model > 0))
summary(napl_lm)
napl_seg_lm <- segmented(napl_lm)
AIC(napl_lm, napl_seg_lm)
# seg is much better, plot
napl_fit <- fitted(napl_seg_lm) %>% 
  enframe() %>% 
  rename(time.model = "name") %>% 
  mutate(time.model = as.numeric(time.model))
napl_seg_plot <- napl_biomass_continual %>% 
  left_join(., napl_fit, by = "time.model") %>% 
  ggplot(aes(x = time_since_end, y = delta_continual)) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(aes(col = exp_dates)) +
  geom_smooth(aes(col = exp_dates), method = "lm") +
  geom_line(aes(y = value), size = 1, lty = 2, col = "blue") +
  theme_bw() +
  theme(legend.position = "none",
        axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10)) +
  labs(x = "Time since end of experiment", y = "\U0394 biomass (treatment - control)",
       title = "\U0394 continual - NAPL")   
napl_seg_plot
# test for significant differences in slope between both segments
davies.test(napl_lm, seg.Z = ~time.model, k = 15)
# significantly different slopes

mohk_lm <- lm(delta_continual ~ time.model, data = mohk_biomass_continual %>% filter(time.model > 0))
summary(mohk_lm)
mohk_seg_lm <- segmented(mohk_lm)
AIC(mohk_lm, mohk_seg_lm)
# seg is not better, skip

carp_lm <- lm(delta_continual ~ time.model, data = carp_biomass_continual %>% filter(time.model > 0))
summary(carp_lm)
carp_seg_lm <- segmented(carp_lm)
AIC(carp_lm, carp_seg_lm)
# seg is better, plot
carp_fit <- fitted(carp_seg_lm) %>% 
  enframe() %>% 
  rename(time.model = "name") %>% 
  mutate(time.model = as.numeric(time.model))
carp_seg_plot <- carp_biomass_continual %>% 
  left_join(., carp_fit, by = "time.model") %>% 
  ggplot(aes(x = time_since_end, y = delta_continual)) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(aes(col = exp_dates)) +
  geom_smooth(aes(col = exp_dates), method = "lm") +
  geom_line(aes(y = value), size = 1, lty = 2, col = "blue") +
  theme_bw() +
  theme(legend.position = "none",
        axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10)) +
  labs(x = "Time since end of experiment", y = "\U0394 biomass (treatment - control)",
       title = "\U0394 continual - CARP")  

carp_seg_plot
# test for significant differences in slope between both segments
davies.test(carp_lm, seg.Z = ~time.model, k = 15)
# significantly different slopes
```

### one sample t-test

As a reminder, the question is: are deltas in the "after" period significantly different from 0?

```{r}
aque_ttest <- t.test(delta_annual ~ 1, data = aque_biomass_annual %>% filter(exp_dates == "after"), alternative = "two.sided")
aque_ttest
# yes, mean = 101.68 - overshoot

napl_ttest <- t.test(delta_annual ~ 1, data = napl_biomass_annual %>% filter(exp_dates == "after"), alternative = "two.sided")
napl_ttest
# yes, mean = -72.29 - undershoot

ivee_ttest <- t.test(delta_annual ~ 1, data = ivee_biomass_annual %>% filter(exp_dates == "after"), alternative = "two.sided")
ivee_ttest
# yes, mean = 69.81 - overshoot

mohk_ttest <- t.test(delta_annual ~ 1, data = mohk_biomass_annual %>% filter(exp_dates == "after"), alternative = "less")
mohk_ttest
# no, mean = -166.79 - not significantly different from 0

carp_ttest <- t.test(delta_annual ~ 1, data = carp_biomass_annual %>% filter(exp_dates == "after"), alternative = "two.sided")
carp_ttest
# no, mean = 45.18 - not significantly different from 0
```



### Summary tables

#### All seasons
```{r}
aque_annual_slope <- aque_annual_bacips_results$linear.model.summary.coefficients[2, 1]
napl_annual_slope <- napl_annual_bacips_results$linear.model.summary.coefficients[2, 1]
ivee_annual_slope <- ivee_annual_bacips_results$linear.model.summary.coefficients[2, 1]
mohk_annual_slope <- mohk_annual_bacips_results$linear.model.summary.coefficients[2, 1]
carp_annual_slope <- carp_annual_bacips_results$linear.model.summary.coefficients[2, 1]

sites_annual_slope <- setNames(c(aque_annual_slope,
                                 napl_annual_slope,
                                 ivee_annual_slope,
                                 mohk_annual_slope,
                                 carp_annual_slope), LTE_sites) 

aque_annual_slope_pval <- aque_annual_bacips_results$linear.model.summary.coefficients[2, 4]
napl_annual_slope_pval <- napl_annual_bacips_results$linear.model.summary.coefficients[2, 4]
ivee_annual_slope_pval <- ivee_annual_bacips_results$linear.model.summary.coefficients[2, 4]
mohk_annual_slope_pval <- mohk_annual_bacips_results$linear.model.summary.coefficients[2, 4]
carp_annual_slope_pval <- carp_annual_bacips_results$linear.model.summary.coefficients[2, 4]

sites_annual_slope_pval <- setNames(c(aque_annual_slope_pval,
                                      napl_annual_slope_pval,
                                      ivee_annual_slope_pval,
                                      mohk_annual_slope_pval,
                                      carp_annual_slope_pval), LTE_sites)

aque_annual_model <- aque_annual_bacips_results$message
napl_annual_model <- napl_annual_bacips_results$message
ivee_annual_model <- ivee_annual_bacips_results$message
mohk_annual_model <- mohk_annual_bacips_results$message
carp_annual_model <- carp_annual_bacips_results$message

sites_annual_message <- c(aque_annual_model,
                          napl_annual_model,
                          ivee_annual_model,
                          mohk_annual_model,
                          carp_annual_model)

aque_annual_model_likelihood <- aque_annual_bacips_results$likelihood
napl_annual_model_likelihood <- napl_annual_bacips_results$likelihood
ivee_annual_model_likelihood <- ivee_annual_bacips_results$likelihood
mohk_annual_model_likelihood <- mohk_annual_bacips_results$likelihood
carp_annual_model_likelihood <- carp_annual_bacips_results$likelihood

sites_annual_model_likelihood <- c(aque_annual_model_likelihood,
                                   napl_annual_model_likelihood,
                                   ivee_annual_model_likelihood,
                                   mohk_annual_model_likelihood,
                                   carp_annual_model_likelihood)

aque_continual_slope <- aque_continual_bacips_results$linear.model.summary.coefficients[2, 1]
napl_continual_slope <- napl_continual_bacips_results$linear.model.summary.coefficients[2, 1]
mohk_continual_slope <- mohk_continual_bacips_results$linear.model.summary.coefficients[2, 1]
carp_continual_slope <- carp_continual_bacips_results$linear.model.summary.coefficients[2, 1]

sites_continual_slope <- setNames(c(aque_continual_slope,
                                    napl_continual_slope,
                                    mohk_continual_slope,
                                    carp_continual_slope), c("aque", "napl", "mohk", "carp"))

aque_continual_slope_pval <- aque_continual_bacips_results$linear.model.summary.coefficients[2, 4]
napl_continual_slope_pval <- napl_continual_bacips_results$linear.model.summary.coefficients[2, 4]
mohk_continual_slope_pval <- mohk_continual_bacips_results$linear.model.summary.coefficients[2, 4]
carp_continual_slope_pval <- carp_continual_bacips_results$linear.model.summary.coefficients[2, 4]

sites_continual_slope_pval <- setNames(c(aque_continual_slope_pval,
                                         napl_continual_slope_pval,
                                         mohk_continual_slope_pval,
                                         carp_continual_slope_pval), c("aque", "napl", "mohk", "carp"))


aque_continual_model <- aque_continual_bacips_results$message
napl_continual_model <- napl_continual_bacips_results$message
mohk_continual_model <- mohk_continual_bacips_results$message
carp_continual_model <- carp_continual_bacips_results$message

sites_continual_message <- setNames(c(aque_continual_model,
                                      napl_continual_model,
                                      mohk_continual_model,
                                      carp_continual_model), c("aque", "napl", "mohk", "carp"))

aque_continual_model_likelihood <- aque_continual_bacips_results$likelihood
napl_continual_model_likelihood <- napl_continual_bacips_results$likelihood
mohk_continual_model_likelihood <- mohk_continual_bacips_results$likelihood
carp_continual_model_likelihood <- carp_continual_bacips_results$likelihood

sites_continual_model_likelihood <- c(aque_continual_model_likelihood,
                                   napl_continual_model_likelihood,
                                   mohk_continual_model_likelihood,
                                   carp_continual_model_likelihood)
```

#### slopes of linear model

```{r}
sites_annual_slope_summary <- enframe(sites_annual_slope) %>% 
  rename(site = name, est_slope = value) %>% 
  cbind(sites_annual_slope_pval) %>% 
  rename(pval = sites_annual_slope_pval) %>% 
  cbind(sites_annual_message) %>% 
  rename(model_sel = sites_annual_message) %>% 
  cbind(sites_annual_model_likelihood) %>% 
  rename(likelihood = sites_annual_model_likelihood) %>% 
  cbind(sites_full) %>% 
  dplyr::select(sites_full, est_slope, pval, model_sel, likelihood) %>% 
  mutate(across(c(est_slope, pval), ~ round(., digits = 3))) %>% 
  gt() %>% 
  cols_label(
    sites_full = "Site",
    est_slope = "Linear slope \n (estimated)",
    pval = "p-value",
    model_sel = "Selected model",
    likelihood = "Likelihood"
  ) %>% 
  tab_header(
    title = "Annual removal slopes: all seasons"
  ) 

sites_annual_slope_summary %>% 
  gtsave(paste("annual_removal_slopes-", todays_date, ".png", sep = ""), path = here::here("tables"))

sites_continual_slope_summary <- enframe(sites_continual_slope) %>% 
  rename(site = name, est_slope = value) %>% 
  cbind(sites_continual_slope_pval) %>% 
  rename(pval = sites_continual_slope_pval) %>% 
  cbind(sites_continual_message) %>% 
  rename(model_sel = sites_continual_message) %>% 
  cbind(sites_continual_model_likelihood) %>% 
  rename(likelihood = sites_continual_model_likelihood) %>% 
  cbind(sites_continual_full) %>% 
  dplyr::select(sites_continual_full, est_slope, pval, model_sel, likelihood) %>% 
  mutate(across(c(est_slope, pval), ~ round(., digits = 3))) %>% 
  gt() %>% 
  cols_label(
    sites_continual_full = "Site",
    est_slope = "Linear slope \n (estimated)",
    pval = "p-value",
    model_sel = "Selected model",
    likelihood = "Likelihood"
  ) %>% 
  tab_header(
    title = "Continual removal slopes: all seasons"
  ) 

sites_continual_slope_summary %>% 
  gtsave(paste("continual_removal_slopes-", todays_date, ".png", sep = ""), path = here::here("tables"))
```

#### models selected
```{r}
sites_annual_summary <- enframe(sites_annual_slope) %>% 
  rename(site = name, est_slope = value) %>% 
  cbind(sites_annual_slope_pval) %>% 
  rename(pval = sites_annual_slope_pval) %>% 
  cbind(sites_annual_message) %>% 
  rename(model_sel = sites_annual_message) %>% 
  cbind(sites_annual_model_likelihood) %>% 
  rename(likelihood = sites_annual_model_likelihood) %>% 
  cbind(sites_full) %>% 
  dplyr::select(sites_full, model_sel, likelihood) %>%  
  gt() %>% 
  cols_label(
    sites_full = "Site",
    model_sel = "Selected model",
    likelihood = "Likelihood"
  ) %>% 
  tab_header(
    title = "Annual removal model selections: all seasons"
  ) 

sites_annual_summary %>% 
  gtsave(paste("annual_removal_models-", todays_date, ".png", sep = ""), path = here::here("tables"))

sites_continual_summary <- enframe(sites_continual_slope) %>% 
  rename(site = name, est_slope = value) %>% 
  cbind(sites_continual_slope_pval) %>% 
  rename(pval = sites_continual_slope_pval) %>% 
  cbind(sites_continual_message) %>% 
  rename(model_sel = sites_continual_message) %>% 
  cbind(sites_continual_model_likelihood) %>% 
  rename(likelihood = sites_continual_model_likelihood) %>% 
  cbind(sites_continual_full) %>% 
  dplyr::select(sites_continual_full, model_sel, likelihood) %>% 
  gt() %>% 
  cols_label(
    sites_continual_full = "Site",
    model_sel = "Selected model",
    likelihood = "Likelihood"
  ) %>% 
  tab_header(
    title = "Continual removal model selections: all seasons"
  ) 

sites_continual_summary %>% 
  gtsave(paste("continual_removal_models-", todays_date, ".png", sep = ""), path = here::here("tables"))
```


#### Summer only

```{r}
aque_annual_slope <- aque_annual_bacips_results_summer$linear.model.summary.coefficients[2, 1]
napl_annual_slope <- napl_annual_bacips_results_summer$linear.model.summary.coefficients[2, 1]
ivee_annual_slope <- ivee_annual_bacips_results_summer$linear.model.summary.coefficients[2, 1]
mohk_annual_slope <- mohk_annual_bacips_results_summer$linear.model.summary.coefficients[2, 1]
carp_annual_slope <- carp_annual_bacips_results_summer$linear.model.summary.coefficients[2, 1]

sites_annual_slope <- setNames(c(aque_annual_slope,
                                 napl_annual_slope,
                                 ivee_annual_slope,
                                 mohk_annual_slope,
                                 carp_annual_slope), LTE_sites) 

aque_annual_slope_pval <- aque_annual_bacips_results_summer$linear.model.summary.coefficients[2, 4]
napl_annual_slope_pval <- napl_annual_bacips_results_summer$linear.model.summary.coefficients[2, 4]
ivee_annual_slope_pval <- ivee_annual_bacips_results_summer$linear.model.summary.coefficients[2, 4]
mohk_annual_slope_pval <- mohk_annual_bacips_results_summer$linear.model.summary.coefficients[2, 4]
carp_annual_slope_pval <- carp_annual_bacips_results_summer$linear.model.summary.coefficients[2, 4]

sites_annual_slope_pval <- setNames(c(aque_annual_slope_pval,
                                      napl_annual_slope_pval,
                                      ivee_annual_slope_pval,
                                      mohk_annual_slope_pval,
                                      carp_annual_slope_pval), LTE_sites)

aque_annual_model <- aque_annual_bacips_results_summer$message
napl_annual_model <- napl_annual_bacips_results_summer$message
ivee_annual_model <- ivee_annual_bacips_results_summer$message
mohk_annual_model <- mohk_annual_bacips_results_summer$message
carp_annual_model <- carp_annual_bacips_results_summer$message

sites_annual_message <- c(aque_annual_model,
                          napl_annual_model,
                          ivee_annual_model,
                          mohk_annual_model,
                          carp_annual_model)

aque_annual_model_likelihood <- aque_annual_bacips_results_summer$likelihood
napl_annual_model_likelihood <- napl_annual_bacips_results_summer$likelihood
ivee_annual_model_likelihood <- ivee_annual_bacips_results_summer$likelihood
mohk_annual_model_likelihood <- mohk_annual_bacips_results_summer$likelihood
carp_annual_model_likelihood <- carp_annual_bacips_results_summer$likelihood

sites_annual_model_likelihood <- c(aque_annual_model_likelihood,
                                   napl_annual_model_likelihood,
                                   ivee_annual_model_likelihood,
                                   mohk_annual_model_likelihood,
                                   carp_annual_model_likelihood)

aque_continual_slope <- aque_continual_bacips_results_summer$linear.model.summary.coefficients[2, 1]
napl_continual_slope <- napl_continual_bacips_results_summer$linear.model.summary.coefficients[2, 1]
mohk_continual_slope <- mohk_continual_bacips_results_summer$linear.model.summary.coefficients[2, 1]
carp_continual_slope <- carp_continual_bacips_results_summer$linear.model.summary.coefficients[2, 1]

sites_continual_slope <- setNames(c(aque_continual_slope,
                                    napl_continual_slope,
                                    mohk_continual_slope,
                                    carp_continual_slope), c("aque", "napl", "mohk", "carp"))

aque_continual_slope_pval <- aque_continual_bacips_results_summer$linear.model.summary.coefficients[2, 4]
napl_continual_slope_pval <- napl_continual_bacips_results_summer$linear.model.summary.coefficients[2, 4]
mohk_continual_slope_pval <- mohk_continual_bacips_results_summer$linear.model.summary.coefficients[2, 4]
carp_continual_slope_pval <- carp_continual_bacips_results_summer$linear.model.summary.coefficients[2, 4]

sites_continual_slope_pval <- setNames(c(aque_continual_slope_pval,
                                         napl_continual_slope_pval,
                                         mohk_continual_slope_pval,
                                         carp_continual_slope_pval), c("aque", "napl", "mohk", "carp"))


aque_continual_model <- aque_continual_bacips_results_summer$message
napl_continual_model <- napl_continual_bacips_results_summer$message
mohk_continual_model <- mohk_continual_bacips_results_summer$message
carp_continual_model <- carp_continual_bacips_results_summer$message

sites_continual_message <- setNames(c(aque_continual_model,
                                      napl_continual_model,
                                      mohk_continual_model,
                                      carp_continual_model), c("aque", "napl", "mohk", "carp"))

aque_continual_model_likelihood <- aque_continual_bacips_results_summer$likelihood
napl_continual_model_likelihood <- napl_continual_bacips_results_summer$likelihood
mohk_continual_model_likelihood <- mohk_continual_bacips_results_summer$likelihood
carp_continual_model_likelihood <- carp_continual_bacips_results_summer$likelihood

sites_continual_model_likelihood <- c(aque_continual_model_likelihood,
                                   napl_continual_model_likelihood,
                                   mohk_continual_model_likelihood,
                                   carp_continual_model_likelihood)
```

```{r}
sites_annual_slope_summary <- enframe(sites_annual_slope) %>% 
  rename(site = name, est_slope = value) %>% 
  cbind(sites_annual_slope_pval) %>% 
  rename(pval = sites_annual_slope_pval) %>% 
  cbind(sites_annual_message) %>% 
  rename(model_sel = sites_annual_message) %>% 
  cbind(sites_annual_model_likelihood) %>% 
  rename(likelihood = sites_annual_model_likelihood) %>% 
  cbind(sites_full) %>% 
  select(sites_full, est_slope, pval, model_sel, likelihood) %>% 
  mutate(across(c(est_slope, pval), ~ round(., digits = 3))) %>% 
  gt() %>% 
  cols_label(
    sites_full = "Site",
    est_slope = "Linear slope \n (estimated)",
    pval = "p-value",
    model_sel = "Selected model",
    likelihood = "Likelihood"
  ) %>% 
  tab_header(
    title = "Annual removal slopes: summer"
  ) 

sites_annual_slope_summary %>% 
  gtsave(paste("annual_removal_slopes-summer-", todays_date, ".png", sep = ""), path = here::here("tables"))

sites_continual_slope_summary <- enframe(sites_continual_slope) %>% 
  rename(site = name, est_slope = value) %>% 
  cbind(sites_continual_slope_pval) %>% 
  rename(pval = sites_continual_slope_pval) %>% 
  cbind(sites_continual_message) %>% 
  rename(model_sel = sites_continual_message) %>% 
  cbind(sites_continual_model_likelihood) %>% 
  rename(likelihood = sites_continual_model_likelihood) %>% 
  cbind(sites_continual_full) %>% 
  select(sites_continual_full, est_slope, pval, model_sel, likelihood) %>% 
  mutate(across(c(est_slope, pval), ~ round(., digits = 3))) %>% 
  gt() %>% 
  cols_label(
    sites_continual_full = "Site",
    est_slope = "Linear slope \n (estimated)",
    pval = "p-value",
    model_sel = "Selected model",
    likelihood = "Likelihood"
  ) %>% 
  tab_header(
    title = "Continual removal slopes: summer"
  ) 

sites_continual_slope_summary %>% 
  gtsave(paste("continual_removal_slopes_summer-", todays_date, ".png", sep = ""), path = here::here("tables"))

```

#### Fall only

```{r}
aque_annual_slope <- aque_annual_bacips_results_fall$linear.model.summary.coefficients[2, 1]
napl_annual_slope <- napl_annual_bacips_results_fall$linear.model.summary.coefficients[2, 1]
ivee_annual_slope <- ivee_annual_bacips_results_fall$linear.model.summary.coefficients[2, 1]
mohk_annual_slope <- mohk_annual_bacips_results_fall$linear.model.summary.coefficients[2, 1]
carp_annual_slope <- carp_annual_bacips_results_fall$linear.model.summary.coefficients[2, 1]

sites_annual_slope <- setNames(c(aque_annual_slope,
                                 napl_annual_slope,
                                 ivee_annual_slope,
                                 mohk_annual_slope,
                                 carp_annual_slope), LTE_sites) 

aque_annual_slope_pval <- aque_annual_bacips_results_fall$linear.model.summary.coefficients[2, 4]
napl_annual_slope_pval <- napl_annual_bacips_results_fall$linear.model.summary.coefficients[2, 4]
ivee_annual_slope_pval <- ivee_annual_bacips_results_fall$linear.model.summary.coefficients[2, 4]
mohk_annual_slope_pval <- mohk_annual_bacips_results_fall$linear.model.summary.coefficients[2, 4]
carp_annual_slope_pval <- carp_annual_bacips_results_fall$linear.model.summary.coefficients[2, 4]

sites_annual_slope_pval <- setNames(c(aque_annual_slope_pval,
                                      napl_annual_slope_pval,
                                      ivee_annual_slope_pval,
                                      mohk_annual_slope_pval,
                                      carp_annual_slope_pval), LTE_sites)

aque_annual_model <- aque_annual_bacips_results_fall$message
napl_annual_model <- napl_annual_bacips_results_fall$message
ivee_annual_model <- ivee_annual_bacips_results_fall$message
mohk_annual_model <- mohk_annual_bacips_results_fall$message
carp_annual_model <- carp_annual_bacips_results_fall$message

sites_annual_message <- c(aque_annual_model,
                          napl_annual_model,
                          ivee_annual_model,
                          mohk_annual_model,
                          carp_annual_model)

aque_annual_model_likelihood <- aque_annual_bacips_results_fall$likelihood
napl_annual_model_likelihood <- napl_annual_bacips_results_fall$likelihood
ivee_annual_model_likelihood <- ivee_annual_bacips_results_fall$likelihood
mohk_annual_model_likelihood <- mohk_annual_bacips_results_fall$likelihood
carp_annual_model_likelihood <- carp_annual_bacips_results_fall$likelihood

sites_annual_model_likelihood <- c(aque_annual_model_likelihood,
                                   napl_annual_model_likelihood,
                                   ivee_annual_model_likelihood,
                                   mohk_annual_model_likelihood,
                                   carp_annual_model_likelihood)

aque_continual_slope <- aque_continual_bacips_results_fall$linear.model.summary.coefficients[2, 1]
napl_continual_slope <- napl_continual_bacips_results_fall$linear.model.summary.coefficients[2, 1]
mohk_continual_slope <- mohk_continual_bacips_results_fall$linear.model.summary.coefficients[2, 1]
carp_continual_slope <- carp_continual_bacips_results_fall$linear.model.summary.coefficients[2, 1]

sites_continual_slope <- setNames(c(aque_continual_slope,
                                    napl_continual_slope,
                                    mohk_continual_slope,
                                    carp_continual_slope), c("aque", "napl", "mohk", "carp"))

aque_continual_slope_pval <- aque_continual_bacips_results_fall$linear.model.summary.coefficients[2, 4]
napl_continual_slope_pval <- napl_continual_bacips_results_fall$linear.model.summary.coefficients[2, 4]
mohk_continual_slope_pval <- mohk_continual_bacips_results_fall$linear.model.summary.coefficients[2, 4]
carp_continual_slope_pval <- carp_continual_bacips_results_fall$linear.model.summary.coefficients[2, 4]

sites_continual_slope_pval <- setNames(c(aque_continual_slope_pval,
                                         napl_continual_slope_pval,
                                         mohk_continual_slope_pval,
                                         carp_continual_slope_pval), c("aque", "napl", "mohk", "carp"))


aque_continual_model <- aque_continual_bacips_results_fall$message
napl_continual_model <- napl_continual_bacips_results_fall$message
mohk_continual_model <- mohk_continual_bacips_results_fall$message
carp_continual_model <- carp_continual_bacips_results_fall$message

sites_continual_message <- setNames(c(aque_continual_model,
                                      napl_continual_model,
                                      mohk_continual_model,
                                      carp_continual_model), c("aque", "napl", "mohk", "carp"))

aque_continual_model_likelihood <- aque_continual_bacips_results_fall$likelihood
napl_continual_model_likelihood <- napl_continual_bacips_results_fall$likelihood
mohk_continual_model_likelihood <- mohk_continual_bacips_results_fall$likelihood
carp_continual_model_likelihood <- carp_continual_bacips_results_fall$likelihood

sites_continual_model_likelihood <- c(aque_continual_model_likelihood,
                                   napl_continual_model_likelihood,
                                   mohk_continual_model_likelihood,
                                   carp_continual_model_likelihood)
```

```{r}
sites_annual_slope_summary <- enframe(sites_annual_slope) %>% 
  rename(site = name, est_slope = value) %>% 
  cbind(sites_annual_slope_pval) %>% 
  rename(pval = sites_annual_slope_pval) %>% 
  cbind(sites_annual_message) %>% 
  rename(model_sel = sites_annual_message) %>% 
  cbind(sites_annual_model_likelihood) %>% 
  rename(likelihood = sites_annual_model_likelihood) %>% 
  cbind(sites_full) %>% 
  select(sites_full, est_slope, pval, model_sel, likelihood) %>% 
  mutate(across(c(est_slope, pval), ~ round(., digits = 3))) %>% 
  gt() %>% 
  cols_label(
    sites_full = "Site",
    est_slope = "Linear slope \n (estimated)",
    pval = "p-value",
    model_sel = "Selected model",
    likelihood = "Likelihood"
  ) %>% 
  tab_header(
    title = "Annual removal slopes: fall"
  ) 

sites_annual_slope_summary %>% 
  gtsave(paste("annual_removal_slopes-fall-", todays_date, ".png", sep = ""), path = here::here("tables"))

sites_continual_slope_summary <- enframe(sites_continual_slope) %>% 
  rename(site = name, est_slope = value) %>% 
  cbind(sites_continual_slope_pval) %>% 
  rename(pval = sites_continual_slope_pval) %>% 
  cbind(sites_continual_message) %>% 
  rename(model_sel = sites_continual_message) %>% 
  cbind(sites_continual_model_likelihood) %>% 
  rename(likelihood = sites_continual_model_likelihood) %>% 
  cbind(sites_continual_full) %>% 
  select(sites_continual_full, est_slope, pval, model_sel, likelihood) %>% 
  mutate(across(c(est_slope, pval), ~ round(., digits = 3))) %>% 
  gt() %>% 
  cols_label(
    sites_continual_full = "Site",
    est_slope = "Linear slope \n (estimated)",
    pval = "p-value",
    model_sel = "Selected model",
    likelihood = "Likelihood"
  ) %>% 
  tab_header(
    title = "Continual removal slopes: fall"
  ) 

sites_continual_slope_summary %>% 
  gtsave(paste("continual_removal_slopes_fall-", todays_date, ".png", sep = ""), path = here::here("tables"))

```

#### model selection
```{r}
model_selection_summary_table <- cbind(
  model = list("Step", "Linear", "Asymptotic", "Sigmoid"),
  deg.free = aque_continual_bacips_results$aicc.test.results.df,
  aic.val = round(aque_continual_bacips_results$aicc.test.results.AIC, 3),
  aic.diff = round(aque_continual_bacips_results$aicc.test.results.diff, 3),
  aic.rl = round(aque_continual_bacips_results$aicc.test.results.RL, 3),
  aic.weights = round(aque_continual_bacips_results$aicc.test.results.aicWeights, 3)
) %>% 
  as.data.frame() %>% 
  mutate(site = aque_full) %>% 
  rbind(
    cbind(
      model = list("Step", "Linear", "Asymptotic", "Sigmoid"),
      deg.free = napl_continual_bacips_results$aicc.test.results.df,
      aic.val = round(napl_continual_bacips_results$aicc.test.results.AIC, 3),
      aic.diff = round(napl_continual_bacips_results$aicc.test.results.diff, 3),
      aic.rl = round(napl_continual_bacips_results$aicc.test.results.RL, 3),
      aic.weights = round(napl_continual_bacips_results$aicc.test.results.aicWeights, 3)
    ) %>% 
      as.data.frame() %>% 
      mutate(site = napl_full) 
  ) %>% 
  rbind(
    cbind(
      model = list("Step", "Linear", "Asymptotic", "Sigmoid"),
      deg.free = mohk_continual_bacips_results$aicc.test.results.df,
      aic.val = round(mohk_continual_bacips_results$aicc.test.results.AIC, 3),
      aic.diff = round(mohk_continual_bacips_results$aicc.test.results.diff, 3),
      aic.rl = round(mohk_continual_bacips_results$aicc.test.results.RL, 3),
      aic.weights = round(mohk_continual_bacips_results$aicc.test.results.aicWeights, 3)
    ) %>% 
      as.data.frame() %>% 
      mutate(site = mohk_full) 
  ) %>% 
  rbind(
    cbind(
      model = list("Step", "Linear", "Asymptotic", "Sigmoid"),
      deg.free = carp_continual_bacips_results$aicc.test.results.df,
      aic.val = round(carp_continual_bacips_results$aicc.test.results.AIC, 3),
      aic.diff = round(carp_continual_bacips_results$aicc.test.results.diff, 3),
      aic.rl = round(carp_continual_bacips_results$aicc.test.results.RL, 3),
      aic.weights = round(carp_continual_bacips_results$aicc.test.results.aicWeights, 3)
    ) %>% 
      as.data.frame() %>% 
      mutate(site = carp_full) 
  ) %>% 
  gt(groupname_col = "site") %>% 
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(rows = aic.diff < 0.0001)
  ) %>% 
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_row_groups()
  ) %>% 
  cols_label(model = "Model",
             deg.free = "Degrees of freedom",
             aic.val = "AIC",
             aic.diff = "\U0394 AIC",
             aic.rl = "Relative likelihood",
             aic.weights = "AIC weight")
model_selection_summary_table

# file name: continual_removal_model_selection-2022-07-05
```

### Summary figures
```{r}
bacips_plots <- (aque_bacips_plot + napl_bacips_plot) /
                (mohk_bacips_plot + carp_bacips_plot) +
    plot_annotation(tag_levels = "A") &
    theme(plot.tag = element_text(size = 20))
bacips_plots
ggsave(here::here("figures", paste("bacips_plots-", todays_date, ".jpg", sep = "")), plot = bacips_plots, height = 8, width = 12, dpi = 150)
```

