---
title: "prelim trajectories"
author: "An Bui"
date: "4/19/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
source(here::here("code", "00-set_up.R"))
```

# Tuesday 20 April 2021

## First pass

Going to try out the trajectories at Naples as a test first. The `percov` data frame is from `00-set_up.R` with some cleaning done over there.  

In this chunk, we're filtering out observations, calculating the mean percent cover per transect, and making things wider for putting into `metaMDS`. Each row in the data frame is a transect for one sampling date. Because it's a subset of the data, some species never show up at Naples; therefore, there's a bit of extra stuff to take out any species with 0 observations at the site. This probably isn't going to be an issue with the whole dataset.  

We're also making a metadata data frame, for plotting later. It has the sample ID, date, site, treatment, and the start/during/after categories.
```{r}
napl_traj_df <- percov %>% 
  # filter for Naples observations, algae only
  filter(site == "NAPL" & group == "algae") %>% 
  # calculate mean and sum percent cover across 4 quads (i.e. per transect)
  group_by(sample_ID, scientific_name) %>% 
  summarize(mean_pc = mean(percent_cover),
            sum_pc = sum(percent_cover)) %>% 
  ungroup() %>% 
  # filter out species with 0 observations
  filter(sum_pc > 0) %>% 
  select(-sum_pc) %>% 
  # get into wide form
  pivot_wider(names_from = "scientific_name", values_from = "mean_pc") %>% 
  # make the sample_ID column row names
  column_to_rownames("sample_ID") %>% 
  # replace NA with 0
  replace(is.na(.), 0)
  
napl_traj_meta <- percov %>% 
  # filter for Naples observations, algae only
  filter(site == "NAPL" & group == "algae") %>% 
  select(sample_ID, date, site, treatment, exp_dates) %>% 
  # only keep unique descriptors
  unique()
```

Going to try a few ordinations - presence/absence (Raup-Crick, appropriate for disentangling variation in composition from variation in alpha diversity) and abundance (Bray-Curtis, though I'm not sure this is the right metric because it's not raw count data. Blah!).

```{r}
napl_rc_dist <- vegdist(napl_traj_df, "raup")
napl_rc_MDS <- metaMDS(napl_rc_dist, "raup")

napl_bray_dist <- vegdist(napl_traj_df, "bray")
napl_bray <- metaMDS(napl_bray_dist)
```

Now, going to put the outputs into data frames to plot.

```{r}
napl_rc_plotdf <- scores(napl_rc_MDS, display = "sites") %>%
    as_tibble() %>% 
    bind_cols(napl_traj_meta, .)

napl_bray_plotdf <- scores(napl_bray, display = "sites") %>% 
  as_tibble() %>% 
  bind_cols(napl_traj_meta, .)

napl_rc_plot_contin <- ggplot(napl_rc_plotdf %>% filter(exp_dates %in% c("start", "after") & treatment == "CONTINUAL"), aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() + 
  geom_segment(aes(xend = c(tail(NMDS1, n = -1), NA), 
                     yend = c(tail(NMDS2, n = -1), NA)),
                 arrow = arrow(length = unit(0.4, "cm"), type = "closed"),
                 size = 0.5, color = "grey") +
  geom_point(aes(color = exp_dates), size = 5) +
  scale_x_continuous(limits = c(-0.3, 0.37)) +
  scale_y_continuous(limits = c(-0.3, 0.4)) +
  theme(panel.background = element_rect("white"),
        panel.border = element_rect("grey85", fill = NA),
        legend.background = element_rect("white"),
        legend.position = "none") +
  labs(title = "Continual removal")
napl_rc_plot_contin

napl_rc_plot_annu <- ggplot(napl_rc_plotdf %>% filter(exp_dates %in% c("start", "after") & treatment == "ANNUAL"), aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() + 
  geom_segment(aes(xend = c(tail(NMDS1, n = -1), NA), 
                     yend = c(tail(NMDS2, n = -1), NA)),
                 arrow = arrow(length = unit(0.4, "cm"), type = "closed"),
                 size = 0.5, color = "grey") +
  geom_point(aes(color = exp_dates), size = 5) +
  scale_x_continuous(limits = c(-0.3, 0.37)) +
  scale_y_continuous(limits = c(-0.3, 0.4)) +
  theme(panel.background = element_rect("white"),
        panel.border = element_rect("grey85", fill = NA),
        legend.background = element_rect("white"),
        legend.position = "bottom") +
  labs(title = "Annual removal")
napl_rc_plot_annu

napl_rc_plot_control <- ggplot(napl_rc_plotdf %>% filter(exp_dates %in% c("start", "after") & treatment == "CONTROL"), aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() + 
  geom_segment(aes(xend = c(tail(NMDS1, n = -1), NA), 
                     yend = c(tail(NMDS2, n = -1), NA)),
                 arrow = arrow(length = unit(0.4, "cm"), type = "closed"),
                 size = 0.5, color = "grey") +
  geom_point(aes(color = exp_dates), size = 5) +
  scale_x_continuous(limits = c(-0.3, 0.37)) +
  scale_y_continuous(limits = c(-0.3, 0.4)) +
  theme(panel.background = element_rect("white"),
        panel.border = element_rect("grey85", fill = NA),
        legend.background = element_rect("white"),
        legend.position = "none") +
  labs(title = "Control")
napl_rc_plot_control

napl_rc_plot_grid <- napl_rc_plot_contin + napl_rc_plot_annu + napl_rc_plot_control

# ggsave(here::here("figures/trajectories/prelim-trajectories", "NAPL-traj-2021-04-20.jpg"), napl_rc_plot_grid, dpi = 200, height = 7, width = 15)
```

They are the same!!!!!! lolllll!!!  

Some permanova/betadisper stuff here. Had to filter out "after" observations, so there's a bunch of that.

```{r}
napl_after_df <- napl_traj_df %>% 
  rownames_to_column("sample_ID") %>% 
  filter(sample_ID %in% napl_after_sampleIDs) %>% 
  column_to_rownames("sample_ID")

napl_after_meta <- napl_traj_meta %>% 
  filter(sample_ID %in% napl_after_sampleIDs)

napl_traj_permanova_rc <- adonis(napl_after_df ~ treatment, napl_after_meta, method = "raup")

napl_traj_permanova_rc_df <- napl_traj_permanova_rc$aov.tab$Df[1]
napl_traj_permanova_rc_ss <- round(napl_traj_permanova_rc$aov.tab$SumsOfSqs[1], 2)
napl_traj_permanova_rc_fstat <- round(napl_traj_permanova_rc$aov.tab$F.Model[1], 2)
napl_traj_permanova_rc_p <- round(napl_traj_permanova_rc$aov.tab$'Pr(>F)'[1], 4)

napl_traj_permanova_caption <- paste("PerMANOVA, F(",
                                    napl_traj_permanova_rc_df, ", ",
                                    napl_traj_permanova_rc_ss, ") = ",
                                    napl_traj_permanova_rc_fstat, ", p = ",
                                    napl_traj_permanova_rc_p,
                                    sep = "")

# no significant difference in centroids between experiment dates

exp_dates_group <- napl_traj_meta %>% 
  select(sample_ID, exp_dates) %>% 
  deframe()

treatment_group <- napl_traj_meta %>% 
  select(sample_ID, treatment) %>% 
  deframe()

napl_rc_bd <- betadisper(napl_rc_dist, exp_dates_group)
anova(napl_rc_bd)
# significant difference in dispersion between experiment dates
```

# Wednesday 21 April 2021

Ok, well, yesterday was kind of a bummer. Still not 100% sure if I should be using Raup-Crick or Jaccard, so just gonna do the same thing except with Jaccard for Naples.

```{r}
# calculating jaccard distance matrix
napl_jacc_dist <- vegdist(napl_traj_df, "jaccard")

# doing NMDS
napl_jacc_MDS <- metaMDS(napl_rc_dist, "jaccard")

# extracting coordinates from jaccard MDS
napl_jacc_plotdf <- scores(napl_jacc_MDS, display = "sites") %>%
    as_tibble() %>% 
    bind_cols(napl_traj_meta, .)

# plotting
napl_jacc_plot_contin <- ggplot(napl_jacc_plotdf %>% filter(exp_dates %in% c("start", "after") & treatment == "CONTINUAL"), aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() + 
  geom_segment(aes(xend = c(tail(NMDS1, n = -1), NA), 
                     yend = c(tail(NMDS2, n = -1), NA)),
                 arrow = arrow(length = unit(0.4, "cm"), type = "closed"),
                 size = 0.5, color = "grey") +
  geom_point(aes(color = exp_dates), size = 5) +
  scale_x_continuous(limits = c(-0.3, 0.37)) +
  scale_y_continuous(limits = c(-0.3, 0.4)) +
  theme(panel.background = element_rect("white"),
        panel.border = element_rect("grey85", fill = NA),
        legend.background = element_rect("white"),
        legend.position = "none") +
  labs(title = "Continual removal")
napl_jacc_plot_contin

napl_jacc_plot_annu <- ggplot(napl_jacc_plotdf %>% filter(exp_dates %in% c("start", "after") & treatment == "ANNUAL"), aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() + 
  geom_segment(aes(xend = c(tail(NMDS1, n = -1), NA), 
                     yend = c(tail(NMDS2, n = -1), NA)),
                 arrow = arrow(length = unit(0.4, "cm"), type = "closed"),
                 size = 0.5, color = "grey") +
  geom_point(aes(color = exp_dates), size = 5) +
  scale_x_continuous(limits = c(-0.3, 0.37)) +
  scale_y_continuous(limits = c(-0.3, 0.4)) +
  theme(panel.background = element_rect("white"),
        panel.border = element_rect("grey85", fill = NA),
        legend.background = element_rect("white")) +
  labs(title = "Annual removal")
napl_jacc_plot_annu

napl_jacc_plot_contr <- ggplot(napl_jacc_plotdf %>% filter(exp_dates %in% c("start", "after") & treatment == "CONTROL"), aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() + 
  geom_segment(aes(xend = c(tail(NMDS1, n = -1), NA), 
                     yend = c(tail(NMDS2, n = -1), NA)),
                 arrow = arrow(length = unit(0.4, "cm"), type = "closed"),
                 size = 0.5, color = "grey") +
  geom_point(aes(color = exp_dates), size = 5) +
  scale_x_continuous(limits = c(-0.3, 0.37)) +
  scale_y_continuous(limits = c(-0.3, 0.4)) +
  theme(panel.background = element_rect("white"),
        panel.border = element_rect("grey85", fill = NA),
        legend.background = element_rect("white"),
        legend.position = "none") +
  labs(title = "Control")
napl_jacc_plot_contr

jacc_plot_grid <- napl_jacc_plot_contin + napl_jacc_plot_annu + napl_jacc_plot_contr

# ggsave(here::here("figures/trajectories/prelim-trajectories", "NAPL-traj-jacc-2021-04-21.jpg"), jacc_plot_grid, dpi = 200, height = 7, width = 15)

```

Welp, they're the same.  

I know in my heart I should start looking at the biomass stuff but man I don't want to. So... I guess I'm going to look at all the sites instead lol. Sorry not sorry.

```{r}
traj_df <- percov %>% 
  # filter for algae only
  filter(group == "algae") %>% 
  # calculate mean and sum percent cover across 4 quads (i.e. per transect)
  group_by(sample_ID, scientific_name) %>% 
  summarize(mean_pc = mean(percent_cover),
            sum_pc = sum(percent_cover)) %>% 
  ungroup() %>% 
  # filter out species with 0 observations
  filter(sum_pc > 0) %>% 
  select(-sum_pc) %>% 
  # get into wide form
  pivot_wider(names_from = "scientific_name", values_from = "mean_pc") %>% 
  # make the sample_ID column row names
  column_to_rownames("sample_ID") %>% 
  # replace NA with 0
  replace(is.na(.), 0)

traj_meta <- percov %>% 
  # filter for algae only
  filter(group == "algae") %>% 
  select(sample_ID, date, site, treatment, exp_dates) %>% 
  unite("date_site", date, site, remove = FALSE) %>% 
  # only keep unique descriptors
  unique()
```

Now to try the ordinations again.

```{r}
rc_dist <- vegdist(traj_df, "raup")
rc_mds <- metaMDS(all_rc_dist, "raup")
```

And then prep to plot, and plotting.

```{r}
rc_plotdf <- scores(rc_mds, display = "sites") %>%
    as_tibble() %>% 
    bind_cols(traj_meta, .)

rc_plot_contin <- ggplot(rc_plotdf %>% filter(exp_dates %in% c("start", "after") & treatment == "CONTINUAL"), aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() + 
  geom_segment(aes(xend = c(tail(NMDS1, n = -1), NA), 
                   yend = c(tail(NMDS2, n = -1), NA),
                   color = site),
               arrow = arrow(length = unit(0.3, "cm"), type = "closed"),
               size = 0.5) +
  scale_x_continuous(limits = c(-0.4, 0.5)) +
  scale_y_continuous(limits = c(-0.35, 0.23)) +
  theme(panel.background = element_rect("white"),
        panel.border = element_rect("grey85", fill = NA),
        legend.background = element_rect("white")) +
  labs(title = "Continual removal")
rc_plot_contin

rc_plot_annu <- ggplot(rc_plotdf %>% filter(exp_dates %in% c("start", "after") & treatment == "ANNUAL"), aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() + 
  geom_segment(aes(xend = c(tail(NMDS1, n = -1), NA), 
                   yend = c(tail(NMDS2, n = -1), NA),
                   color = site),
               arrow = arrow(length = unit(0.3, "cm"), type = "closed"),
               size = 0.5) +
  scale_x_continuous(limits = c(-0.5, 0.5)) +
  scale_y_continuous(limits = c(-0.35, 0.3)) +
  theme(panel.background = element_rect("white"),
        panel.border = element_rect("grey85", fill = NA),
        legend.background = element_rect("white")) +
  labs(title = "Annual removal")
rc_plot_annu

rc_plot_contr <- ggplot(rc_plotdf %>% filter(exp_dates %in% c("start", "after") & treatment == "CONTROL"), aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() + 
  geom_segment(aes(xend = c(tail(NMDS1, n = -1), NA), 
                   yend = c(tail(NMDS2, n = -1), NA),
                   color = site),
               arrow = arrow(length = unit(0.3, "cm"), type = "closed"),
               size = 0.5) +
  scale_x_continuous(limits = c(-0.5, 0.5)) +
  scale_y_continuous(limits = c(-0.35, 0.3)) +
  theme(panel.background = element_rect("white"),
        panel.border = element_rect("grey85", fill = NA),
        legend.background = element_rect("white")) +
  labs(title = "Control")
rc_plot_contr
```

Ok, I messed around with this but idk what I'm actually doing lol. Part of the issue is that I'm not sure if I need to change the `exp_date` thing around so that "start" isn't in its own group. Going to think more on this tomorrow...

```{r}
rc_traj_permanova <- adonis(traj_df ~ treatment*date_site, traj_meta, method = "raup")

rc_traj_permanova_df <- rc_traj_permanova$aov.tab$Df[1]
rc_traj_permanova_ss <- round(rc_traj_permanova$aov.tab$SumsOfSqs[1], 2)
rc_traj_permanova_fstat <- round(rc_traj_permanova$aov.tab$F.Model[1], 2)
rc_traj_permanova_p <- round(rc_traj_permanova$aov.tab$'Pr(>F)'[1], 4)

rc_traj_permanova_caption <- paste("PerMANOVA, F(",
                                    rc_traj_permanova_df, ", ",
                                    rc_traj_permanova_ss, ") = ",
                                    rc_traj_permanova_fstat, ", p = ",
                                    rc_traj_permanova_p,
                                    sep = "")

exp_dates_all <- traj_meta %>% 
  select(sample_ID, date_site) %>% 
  deframe()

rc_traj_bd <- betadisper(rc_dist, exp_dates_all)
anova(rc_traj_bd)
```
Output of `adonis` function:  

Call:  
adonis(formula = traj_df ~ treatment * exp_dates, data = traj_meta,      method = "raup")   

Permutation: free  
Number of permutations: 999  

Terms added sequentially (first to last)  

                     Df SumsOfSqs   MeanSqs F.Model       R2 Pr(>F)    
treatment             2    0.0579  0.028942  0.8859  0.00215  0.501  
exp_dates             2    0.4422  0.221088  6.7679  0.01642  0.028 *
treatment:exp_dates   4   -0.0044 -0.001103 -0.0338 -0.00016  0.698  
Residuals           809   26.4278  0.032667          0.98159         
Total               817   26.9234                    1.00000         
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Results from ANOVA of dispersion:
Analysis of Variance Table  

Response: Distances  
           Df  Sum Sq Mean Sq F value    Pr(>F)     
Groups      2  1.2899 0.64497  35.491 1.664e-15 ***
Residuals 815 14.8109 0.01817                      
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Not sure this is right because the "start" category only has one community. 

# Monday 31 May 2021

Hello darkness my old friend. Ok, so trying to make those trajectory plots, but now with:  
  1) continual and annual removal plotted on top of each other,  
  2) control plots without trajectory but just grey circles (???) 
  
So this is the attempt for that, for Naples with Jaccard. Doing the NMDS again because I just want the after dates.
  
```{r}
napl_jacc_after <- metaMDS(napl_after_df, "jacc")

# extracting coordinates from jaccard MDS
napl_jacc_plotdf <- scores(napl_jacc_MDS, display = "sites") %>%
    as_tibble() %>% 
    bind_cols(napl_traj_meta, .)

all_napl_jacc <- scores(napl_jacc_after, display = "sites") %>% 
  as_tibble() %>% 
  bind_cols(napl_after_meta, .)

napl_jacc_plot_all <- ggplot() +
  coord_fixed() + 
  # continual
  geom_segment(data = all_napl_jacc %>% filter(treatment == "CONTINUAL"), 
               aes(x = NMDS1, y = NMDS2, 
                   xend = c(tail(NMDS1, n = -1), NA), 
                   yend = c(tail(NMDS2, n = -1), NA)),
               arrow = arrow(length = unit(0.3, "cm"), type = "closed"),
               size = 0.4, color = "grey", alpha = 0.9) +
  geom_point(data = all_napl_jacc %>% filter(treatment == "CONTINUAL"),
             aes(x = NMDS1, y = NMDS2, 
                 color = "Continual removal", shape = "Continual removal"), 
             size = 4) +
  
  # annual
  geom_segment(data = all_napl_jacc %>% filter(treatment == "ANNUAL"), 
               aes(x = NMDS1, y = NMDS2, 
                   xend = c(tail(NMDS1, n = -1), NA), 
                   yend = c(tail(NMDS2, n = -1), NA)),
               arrow = arrow(length = unit(0.3, "cm"), type = "closed"),
               size = 0.4, color = "grey", alpha = 0.9) +
  geom_point(data = all_napl_jacc %>% filter(treatment == "ANNUAL"),
             aes(x = NMDS1, y = NMDS2, 
                 color = "Annual removal", shape = "Annual removal"), size = 4) +
  
  # control
  geom_point(data = all_napl_jacc %>% filter(treatment == "CONTROL"),
             aes(x = NMDS1, y = NMDS2, 
                 color = "Control", shape = "Control"), size = 3, alpha = 0.5) +
  
  # legend
  scale_color_manual(name = NULL,
                     breaks = c("Annual removal", "Continual removal", "Control"),
                     values = c("Annual removal" = annual_col,
                                "Continual removal" = continual_col,
                                "Control" = "#000000")) +
  scale_shape_manual(name = NULL,
                     breaks = c("Annual removal", "Continual removal", "Control"),
                     values = c("Annual removal" = annual_shape,
                                "Continual removal" = continual_shape,
                                "Control" = 21)) +
  
  # scale_x_continuous(limits = c(-0.3, 0.37)) +
  # scale_y_continuous(limits = c(-0.3, 0.4)) +
  theme(panel.background = element_rect("white"),
        panel.border = element_rect("grey85", fill = NA),
        legend.background = element_rect("white")) +
  labs(title = "NAPL")
napl_jacc_plot_all
```

Doing with all sites now.
```{r}
all_traj_df <- percov %>% 
  # filter for algae only
  filter(group == "algae") %>% 
  # calculate mean and sum percent cover across 4 quads (i.e. per transect)
  group_by(sample_ID, scientific_name) %>% 
  summarize(mean_pc = mean(percent_cover),
            sum_pc = sum(percent_cover)) %>% 
  ungroup() %>% 
  # filter out species with 0 observations
  filter(sum_pc > 0) %>% 
  select(-sum_pc) %>% 
  # get into wide form
  pivot_wider(names_from = "scientific_name", values_from = "mean_pc") %>% 
  # make the sample_ID column row names
  column_to_rownames("sample_ID") %>% 
  # replace NA with 0
  replace(is.na(.), 0)

all_traj_meta <- percov %>% 
  # filter for algae only
  filter(group == "algae") %>% 
  select(sample_ID, date, site, treatment, exp_dates) %>% 
  # only keep unique descriptors
  unique()

all_after_df <- all_traj_df %>% 
  rownames_to_column("sample_ID") %>% 
  filter(sample_ID %in% all_after_sampleIDs) %>% 
  column_to_rownames("sample_ID")

all_after_meta <- all_traj_meta %>% 
  filter(sample_ID %in% all_after_sampleIDs)

all_jacc_MDS <- metaMDS(all_after_df, "jacc")

# extracting coordinates from jaccard MDS
all_jacc_plotdf <- scores(all_jacc_MDS, display = "sites") %>%
    as_tibble() %>% 
    bind_cols(all_after_meta, .)

all_plot_fxn <- function(site_choice) {
  ggplot() +
    coord_fixed() + 
    # continual
    geom_segment(data = all_jacc_plotdf %>% filter(site == site_choice & treatment == "CONTINUAL"), 
                 aes(x = NMDS1, y = NMDS2, 
                     xend = c(tail(NMDS1, n = -1), NA), 
                     yend = c(tail(NMDS2, n = -1), NA)),
                 arrow = arrow(length = unit(0.3, "cm")),
                 size = 0.4, color = "grey", alpha = 0.9) +
    geom_point(data = all_jacc_plotdf %>% filter(site == site_choice & treatment == "CONTINUAL"),
               aes(x = NMDS1, y = NMDS2, 
                   color = "Continual removal", shape = "Continual removal"), 
               size = 4) +
    
    # annual
    geom_segment(data = all_jacc_plotdf %>% filter(site == site_choice & treatment == "ANNUAL"), 
                 aes(x = NMDS1, y = NMDS2, 
                     xend = c(tail(NMDS1, n = -1), NA), 
                     yend = c(tail(NMDS2, n = -1), NA)),
                 arrow = arrow(length = unit(0.3, "cm")),
                 size = 0.4, color = "grey", alpha = 0.9) +
    geom_point(data = all_jacc_plotdf %>% filter(site == site_choice & treatment == "ANNUAL"),
               aes(x = NMDS1, y = NMDS2, 
                   color = "Annual removal", shape = "Annual removal"), size = 4) +
    
    # control
    geom_point(data = all_jacc_plotdf %>% filter(site == site_choice & treatment == "CONTROL"),
               aes(x = NMDS1, y = NMDS2, 
                   color = "Control", shape = "Control"), size = 3, alpha = 0.5) +
    
    # legend
    scale_color_manual(name = NULL,
                       breaks = c("Annual removal", "Continual removal", "Control"),
                       values = c("Annual removal" = annual_col,
                                  "Continual removal" = continual_col,
                                  "Control" = "#000000")) +
    scale_shape_manual(name = NULL,
                       breaks = c("Annual removal", "Continual removal", "Control"),
                       values = c("Annual removal" = annual_shape,
                                  "Continual removal" = continual_shape,
                                  "Control" = 21)) +
    
    scale_x_continuous(limits = c(-0.4, 0.65)) +
    scale_y_continuous(limits = c(-0.5, 0.45)) +
    theme(panel.background = element_rect("white"),
          panel.border = element_rect("grey85", fill = NA),
          legend.background = element_rect("white")) +
    labs(title = site_choice)
}

aque_plot <- all_plot_fxn("AQUE") + theme(legend.position = "none")
carp_plot <- all_plot_fxn("CARP") + theme(legend.position = "bottom")
mohk_plot <- all_plot_fxn("MOHK") + theme(legend.position = "none")
ivee_plot <-   ggplot() +
    coord_fixed() + 
    # annual
    geom_segment(data = all_jacc_plotdf %>% filter(site == "IVEE" & treatment == "ANNUAL"), 
                 aes(x = NMDS1, y = NMDS2, 
                     xend = c(tail(NMDS1, n = -1), NA), 
                     yend = c(tail(NMDS2, n = -1), NA)),
                 arrow = arrow(length = unit(0.3, "cm")),
                 size = 0.4, color = "grey", alpha = 0.9) +
    geom_point(data = all_jacc_plotdf %>% filter(site == "IVEE" & treatment == "ANNUAL"),
               aes(x = NMDS1, y = NMDS2, 
                   color = "Annual removal", shape = "Annual removal"), size = 4) +
    
    # control
    geom_point(data = all_jacc_plotdf %>% filter(site == "IVEE" & treatment == "CONTROL"),
               aes(x = NMDS1, y = NMDS2, 
                   color = "Control", shape = "Control"), size = 3, alpha = 0.5) +
    
    # legend
    scale_color_manual(name = NULL,
                       breaks = c("Annual removal", "Control"),
                       values = c("Annual removal" = annual_col,
                                  "Control" = "#000000")) +
    scale_shape_manual(name = NULL,
                       breaks = c("Annual removal", "Control"),
                       values = c("Annual removal" = annual_shape,
                                  "Control" = 21)) +
    
    scale_x_continuous(limits = c(-0.4, 0.65)) +
    scale_y_continuous(limits = c(-0.5, 0.45)) +
    theme(panel.background = element_rect("white"),
          panel.border = element_rect("grey85", fill = NA),
          legend.position = "none") +
    labs(title = "IVEE")
napl_plot <- all_plot_fxn("NAPL") + theme(legend.position = "none")

plots_together <- (aque_plot + mohk_plot + napl_plot) / 
                  (ivee_plot + carp_plot + plot_spacer()) +
  plot_layout(nrow = 2, widths = c(1, 1, 1, 1, 1, 1), heights = c(1, 1, 1, 1, 1, 1)) 
plots_together
ggsave(here::here("figures", "traj-raup.jpg"), plots_together, width = 8, height = 6, dpi = 200)
```

```{r}
all_traj_permanova_jacc <- adonis(all_after_df ~ treatment, all_after_meta, method = "jacc")

all_traj_permanova_jacc_df <- all_traj_permanova_jacc$aov.tab$Df[1]
all_traj_permanova_jacc_ss <- round(all_traj_permanova_jacc$aov.tab$SumsOfSqs[1], 2)
all_traj_permanova_jacc_fstat <- round(all_traj_permanova_jacc$aov.tab$F.Model[1], 2)
all_traj_permanova_jacc_p <- round(all_traj_permanova_jacc$aov.tab$'Pr(>F)'[1], 4)

all_traj_permanova_caption <- paste("PerMANOVA, F(",
                                    all_traj_permanova_jacc_df, ", ",
                                    all_traj_permanova_jacc_ss, ") = ",
                                    all_traj_permanova_jacc_fstat, ", p = ",
                                    all_traj_permanova_jacc_p,
                                    sep = "")

# no significant difference in centroids between experiment dates

# pairwise posthoc test for adonis
library(pairwiseAdonis)
pair.mod <- pairwise.adonis(all_after_df,
                            all_after_meta$treatment,
                            sim.method = "jacc")

treatment_group <- all_traj_meta %>% 
  select(sample_ID, treatment) %>% 
  deframe()

all_jacc_dist <- vegdist(all_after_df, "jacc")
all_jacc_bd <- betadisper(all_jacc_dist, treatment_group)
anova(jacc_jacc_bd)
# significant difference in dispersion between experiment dates
```

# Tuesday 1 June 2021

Well, today is a new day for crying. Anyway, time to try some trajectory analysis with the `ecotraj` package. Notes: installing using the code given on the Github repo didn't work which freaked me out. Apparently that happens when the main branch is renamed? In any case, this is what worked: `remotes::install_github("emf-creaf/ecotraj@main")`. Going to follow along with this vignette: https://mran.microsoft.com/snapshot/2018-06-01/web/packages/vegclust/vignettes/CTA.html.    

Also, another layer of what-the-fuck-is-happening is that `vegclust` is the original package by de Caceres et al. but the community trajectory stuff was moved to `ecotraj` when vegclust version 2.0.0 was released. So did a bit of hunting around that, but I think we're ready to rumble.  

## Tutorial stuff

The first thing in the tutorial was to make a dummy matrix, then put it through `dist()`, which is in the base package, but wondering if it could be done with `vegdist()` too?.

```{r}
#Description of sites and surveys
sites = c(1,1,1,1,2,2,2,2,3,3,3,3)
surveys=c(1,2,3,4,1,2,3,4,1,2,3,4)

#Raw data table
xy<-matrix(0, nrow=12, ncol=2)
xy[2,2]<-1
xy[3,2]<-2
xy[4,2]<-3
xy[5:6,2] <- xy[1:2,2]
xy[7,2]<-1.5
xy[8,2]<-2.0
xy[5:6,1] <- 0.25
xy[7,1]<-0.5
xy[8,1]<-1.0
xy[9:10,1] <- xy[5:6,1]+0.25
xy[11,1] <- 1.0
xy[12,1] <-1.5
xy[9:10,2] <- xy[5:6,2]
xy[11:12,2]<-c(1.25,1.0)
cbind(sites,surveys,xy)
```

Ok just to be FUCKING CLEAR the data should be structured like, sites, surveys within those sites (because with a trajectory type framework you're going to have repeated measures), and then each row is the species count for that survey at that site.  

So with LTE data, the "sites" would probably be site_treatment (e.g. NAPL_ANNUAL, MOHK_CONTROL), and "surveys" would be the dates surveyed? Maybe they can't be dates though.

```{r}
#Distance matrix
d = dist(xy)
d
d_vegdist <- vegdist(d, method = "euclidean")
```

As it turns out, yes you can use `vegdist()`.  

The trajectories can be visualized using `trajectoryPCoA()`, but again wondering how to get that from `vegan` or just pull the output for `ggplot` use. The outputs of `trajectoryPCoA()` apparently returns the result of calling `cmdscale()` from base, which is the metric multidimensional scaling function.
```{r}
# trajectoryPCOA(distance matrix, site vector, survey vector, traj.colors matches with number of sites)
trajectoryPCoA(d, sites, surveys, traj.colors = c("black","red", "blue"), lwd = 2)
legend("topleft", col=c("black","red", "blue"), 
       legend=c("Trajectory 1", "Trajectory 2", "Trajectory 3"), bty="n", lty=1, lwd = 2)
```

So I think the surveys do have to be numbered. [Note: they do not have to be numbered.]  

So now we've got that settled, we can calculate trajectory lengths, the lengths of segments and path lengths of trajectories, using `trajectoryLengths()`.

```{r}
# get trajectory lengths
trajectoryLengths(d, sites = sites, surveys = surveys)
```

The output is a data frame with columns corresponding to each survey + trajectory length, and each row is the segment length from one survey to the next at a particular site. So, each row is a site, and each column is a segment length between one survey to the next, and the last column is the sum of all those segment lengths.

`trajectoryAngles()` gives the angle between each pair of segments.

```{r}
trajectoryAngles(d, sites, surveys)
```

The output is also a data frame, with rows corresponding to sites, and columns corresponding to the segments between which angles are calculated (e.g. S1-S2, S2-S3), with mean, sd, and rho for each.  

`trajectoryDirectionality()` gives you the direction of a trajectory, which allows you to determine the degree to which trajectories follow a straight pathway. *Note:* this is descriptive _only_. It does not allow any stats.
```{r}
trajectoryDirectionality(d, sites, surveys)
```

## Trying out with NAPL

### Species

Ok so going to try this just for NAPL, as per tradition with things arranged by date:

```{r}
napl_CTA_df <- percov %>% 
  # filter for Naples observations, algae only
  filter(site == "NAPL" & group == "algae" & exp_dates == "after") %>% 
  # calculate mean and sum percent cover across 4 quads (i.e. per transect)
  group_by(sample_ID, scientific_name) %>% 
  summarize(mean_pc = mean(percent_cover),
            sum_pc = sum(percent_cover)) %>% 
  ungroup() %>% 
  # filter out species with 0 observations
  filter(sum_pc > 0) %>% 
  select(-sum_pc) %>% 
  # match with the metadata to sort things
  full_join(napl_after_meta, ., by = "sample_ID") %>% 
  # arrange by treatment, then sampling date
  arrange(treatment, date) %>% 
  # get into wide form
  pivot_wider(names_from = "scientific_name", values_from = "mean_pc") %>% 
  # replace NA with 0
  replace(is.na(.), 0) %>% 
  # make into a site x species matrix
  column_to_rownames("sample_ID") %>% 
  select(-(1:4))
  
napl_CTA_meta <- percov %>% 
  # filter for Naples observations, algae only
  filter(site == "NAPL" & group == "algae" & exp_dates == "after") %>% 
  select(sample_ID, date, site, treatment) %>% 
  # only keep unique descriptors
  unique() %>% 
  # arrange by treatment and ate
  arrange(treatment, date)

# make the distance matrix with a log transform before (not sure if needed)
napl_after_dist <- vegdist(napl_CTA_df, method = "manhattan")

# get sites
napl_sites <- napl_CTA_meta %>% 
  pull(treatment)

# get surveys
napl_surveys <- napl_CTA_meta %>% 
  pull(date)

trajectoryPCoA(napl_after_dist, sites = napl_sites, surveys = napl_surveys, traj.colors = c("black","red", "blue"), lwd = 2)
legend("topright", col=c("black","red", "blue"), 
       legend=c("Annual", "Continual", "Control"), bty="n", lty=1, lwd = 2)
```

Trajectory lengths and angles:
```{r}
napl_traj_lengths <- trajectoryLengths(napl_after_dist, sites = napl_sites, surveys = napl_surveys)

napl_traj_angles <- trajectoryAngles(napl_after_dist, napl_sites, napl_surveys)

napl_traj_dire <- trajectoryDirectionality(napl_after_dist, napl_sites, napl_surveys)

napl_traj_conv <- trajectoryConvergence(napl_after_dist, napl_sites, napl_surveys, symmetric = TRUE)
# the function performs the Mann-Whitney trend test. Values of the statistic (‘tau’) larger than 0 correspond to trajectories that are diverging, whereas values lower than 0 correspond to trajectories that are converging

napl_traj_lengths
napl_traj_angles
napl_traj_dire 
napl_traj_conv
```

### Groups

Ok woof. Nothing on nothing. Going to try with functional groups now:
```{r}
# get into a matrix
fg_sum <- percov %>% 
  filter(group == "algae") %>% 
  # join with traits (without the taxonomic information in the trait data frame)
  mutate(scientific_name = str_replace(scientific_name, " ", "_")) %>% 
  full_join(., traits %>% select(-(1:5)), by = "scientific_name") %>% 
  group_by(sample_ID, growth_form) %>% 
  summarize(mean_pc = mean(percent_cover),
            sum_pc = sum(percent_cover)) %>% 
  ungroup() %>% 
  filter(sum_pc > 0)

fg_matrix <- fg_sum %>% 
  dplyr::select(sample_ID, growth_form, mean_pc) %>% 
  pivot_wider(names_from = "growth_form", values_from = "mean_pc") %>% 
  # replace all NA values with 0
  replace(is.na(.), 0) %>% 
  # remove empty rows
  dplyr::mutate(row_sums = dplyr::select(., 2:length(.)) %>% rowSums(na.rm = TRUE)) %>% 
  filter(row_sums > 0) %>% 
  dplyr::select(-row_sums) %>% 
  column_to_rownames("sample_ID")
```

```{r}
napl_CTA_traits_df <- fg_matrix %>% 
  rownames_to_column("sample_ID") %>% 
  # only include after sample_IDs
  filter(sample_ID %in% napl_after_sampleIDs) %>% 
  # match with the metadata to sort things
  full_join(napl_after_meta, ., by = "sample_ID") %>% 
  # arrange by treatment, then sampling date
  arrange(treatment, date) %>% 
  # replace NA with 0
  replace(is.na(.), 0) %>% 
  # make into a site x species matrix
  column_to_rownames("sample_ID") %>% 
  select(-(1:4))

# use `napl_CTA_meta`
```

```{r}
# make the distance matrix with a log transform before (not sure if needed)
napl_after_traits_dist <- vegdist(napl_CTA_traits_df, method = "manhattan")

trajectoryPCoA(napl_after_traits_dist, sites = napl_sites, surveys = napl_surveys, traj.colors = c("black","red", "blue"), lwd = 2)
legend("bottomright", col=c("black","red", "blue"), 
       legend=c("Annual", "Continual", "Control"), bty="n", lty=1, lwd = 2)
```

```{r}
napl_traj_traits_lengths <- trajectoryLengths(napl_after_traits_dist, sites = napl_sites, surveys = napl_surveys)

napl_traj_traits_angles <- trajectoryAngles(napl_after_traits_dist, napl_sites, napl_surveys)

napl_traj_traits_dire <- trajectoryDirectionality(napl_after_traits_dist, napl_sites, napl_surveys)

napl_traj_traits_conv <- trajectoryConvergence(napl_after_traits_dist, napl_sites, napl_surveys, symmetric = TRUE)
# the function performs the Mann-Whitney trend test. Values of the statistic (‘tau’) larger than 0 correspond to trajectories that are diverging, whereas values lower than 0 correspond to trajectories that are converging

napl_traj_traits_lengths
napl_traj_traits_angles
napl_traj_traits_dire 
napl_traj_traits_conv
```

Nothing!!!! With traits!!!!!!!!!!!!!!

## All sites

Apparently today is all about fucking around and finding out.

```{r}
all_CTA_df <- percov %>% 
  # filter for algae only
  filter(group == "algae" & exp_dates == "after") %>% 
  # calculate mean and sum percent cover across 4 quads (i.e. per transect)
  group_by(sample_ID, scientific_name) %>% 
  summarize(mean_pc = mean(percent_cover),
            sum_pc = sum(percent_cover)) %>% 
  ungroup() %>% 
  # filter out species with 0 observations
  filter(sum_pc > 0) %>% 
  select(-sum_pc) %>% 
  # match with the metadata to sort things
  full_join(all_after_meta, ., by = "sample_ID") %>% 
  # arrange by treatment, then sampling date
  arrange(treatment, date) %>% 
  # get into wide form
  pivot_wider(names_from = "scientific_name", values_from = "mean_pc") %>% 
  # replace NA with 0
  replace(is.na(.), 0) %>% 
  # make into a site x species matrix
  column_to_rownames("sample_ID") %>% 
  select(-(1:4))

all_CTA_meta <- percov %>% 
  # filter for algae only
  filter(group == "algae" & exp_dates == "after") %>% 
  select(sample_ID, date, site, treatment) %>% 
  # only keep unique descriptors
  unique() %>% 
  # arrange by treatment and date
  arrange(site, treatment, date) %>% 
  # unite site + treatment
  unite("site_treatment", site, treatment, sep = "_", remove = FALSE)

# make the distance matrix with a log transform before (not sure if needed)
all_after_dist <- vegdist(all_CTA_df, method = "euclidean")

# get sites
all_CTA_sites <- all_CTA_meta %>% 
  pull(site_treatment)

# get surveys
all_CTA_surveys <- all_CTA_meta %>% 
  pull(date)

trajectoryPCoA(all_after_dist, sites = all_CTA_sites, surveys = all_CTA_surveys, traj.colors = c("black","red", "blue"), lwd = 2)
legend("topright", col=c("black","red", "blue"), 
       legend=c("Annual", "Continual", "Control"), bty="n", lty=1, lwd = 2)
```

```{r}
all_traj_lengths <- trajectoryLengths(all_after_dist, sites = all_CTA_sites, surveys = all_CTA_surveys)

all_traj_angles <- trajectoryAngles(all_after_dist, all_CTA_sites, all_CTA_surveys)

all_traj_dire <- trajectoryDirectionality(all_after_dist, all_CTA_sites, all_CTA_surveys)

all_traj_conv <- trajectoryConvergence(all_after_dist, all_CTA_sites, all_CTA_surveys, symmetric = TRUE)
# the function performs the Mann-Whitney trend test. Values of the statistic (‘tau’) larger than 0 correspond to trajectories that are diverging, whereas values lower than 0 correspond to trajectories that are converging

all_traj_lengths
all_traj_angles
all_traj_dire 
all_traj_conv
```

```{r}
all_traj_lengths_df <- all_traj_lengths %>% 
  rownames_to_column("site_treatment") %>% 
  separate(site_treatment, into = c("site", "treatment"), sep = "_") %>% 
  select(-(S12:Trajectory)) %>% 
  mutate(trajectory = rowSums(across(where(is.numeric)))) %>% 
  select(site:S11) %>% 
  pivot_longer(cols = S1:S11, names_to = "segment", values_to = "segment_length") %>% 
  mutate_at(c("treatment"), str_to_lower)

ggplot(data = all_traj_lengths_df, aes(x = treatment, y = segment_length)) +
  geom_boxplot(aes(color = treatment), size = 0.8) +
  geom_jitter(aes(color = treatment, shape = treatment), size = 2, alpha = 0.8) +
  scale_color_manual(values = c(annual_col, continual_col, control_col)) +
  scale_shape_manual(values = c(annual_shape, continual_shape, control_shape)) +
  theme_bw() +
  theme(legend.position = "none") +
  labs(x = "Treatment", 
       y = "Segment length",
       title = "Segment lengths")

ggsave(here::here("figures", "sl_spp-euc.jpg"), width = 6, height = 4, dpi = 200)


sl_spp_aov <- aov(segment_length ~ treatment, data = all_traj_lengths_df)

summary(sl_spp_aov)

all_traj_angles_df <- all_traj_angles %>% 
  rownames_to_column("site_treatment") %>% 
  separate(site_treatment, into = c("site", "treatment"), sep = "_") %>% 
  select(-(13:20)) %>% 
  pivot_longer(cols = 3:12, names_to = "segments", values_to = "angles") %>% 
  mutate_at(c("treatment"), str_to_lower) %>% 
  mutate(segments = fct_relevel(segments, "S1-S2", "S2-S3", "S3-S4", "S4-S5", "S5-S6", "S6-S7", "S7-S8", "S8-S9", "S9-S10", "S10-S11"))

ggplot(data = all_traj_angles_df, aes(x = treatment, y = angles)) +
  geom_boxplot(aes(color = treatment), size = 0.8) +
  geom_jitter(aes(color = treatment, shape = treatment), size = 2, alpha = 0.8) +
  scale_color_manual(values = c(annual_col, continual_col, control_col)) +
  scale_shape_manual(values = c(annual_shape, continual_shape, control_shape)) +
  theme_bw() +
  theme(legend.position = "none") +
  labs(x = "Treatment", 
       y = "Angles between segments",
       title = "Angles between segments")

ggsave(here::here("figures", "angles_spp-euc.jpg"), width = 6, height = 4, dpi = 200)
```

## Biomass of single species

Ok well I am done feeling sorry for myself so going to look at biomass of high abundance species. Bleh! Using the `percov` data frame from the source script.

```{r}
ca_percov <- percov %>% 
  filter(sp_code %in% common_algae)

PTCA_percov <- percov %>% 
  filter(scientific_name == "Pterygophora californica")
```

# Wednesday 2 June 2021

Time continues to pass and I continue to despair. Wondering if it's actually worth it to try the FD stuff with only one real trait? It's not that informative. Would be worth calculating species diversity, though. So, maybe goals for today are:  
  1. timeseries for most abundant algal species and  
  2. species diversity for after plots  
  
## Timeseries

### Pterygophora californica

As it turns out, _P. californica_ is coded as "PH" in the percent cover data set and "PTCA" in the biomass data set. HOW MANY SPECIES ARE LIKE THIS. This is reflected in the `common_algae` vector in the source script. `PTCA_percov` from the `percov` df.

```{r}
delta_ca_biomass <- biomass %>% 
  filter(group == "algae" & exp_dates == "after" & scientific_name != "Macrocystis pyrifera") %>% 
  # calculate total dry mass per survey
  group_by(site, year, month, treatment, date, scientific_name) %>% 
  summarize(total_biomass = sum(dry_gm2)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = treatment, values_from = total_biomass) %>% 
  mutate(delta_annual = CONTROL - ANNUAL,
         delta_continual = CONTROL - CONTINUAL) %>% 
  # create a sample_ID for each sampling date at each site
  unite("sample_ID", site, date, remove = FALSE) %>% 
  pivot_longer(ANNUAL:delta_continual, names_to = "treatments", values_to = "biomass") %>% 
  filter(treatments %in% c("delta_annual", "delta_continual") & biomass != "NA")

ggplot(data = delta_ca_biomass %>% filter(treatments == "delta_annual"), aes(x = date, y = biomass, color = treatments)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  geom_point() + 
  geom_smooth()

delta_annual_spp <- ggplot(data = delta_ca_biomass %>% filter(treatments == "delta_annual" & scientific_name %in% c("Egregia menziesii", "Stephanocystis osmundacea", "Pterygophora californica", "Sargassum muticum", "Sargassum horneri")), 
             aes(x = date, y = biomass, color = scientific_name)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  geom_point() +
  geom_smooth(method = "lm") +
  scale_color_manual(values = cal_palette("kelp1")) +
  labs(x = "Sampling date",
       y = expression(Delta~"Biomass (dry g/"~m^2~") (control - removal)"),
       title = "Annual") +
  theme_bw() +
  theme(legend.position = "none") +
  guides(col = guide_legend(nrow = 8, byrow = TRUE))

delta_continual_spp <- ggplot(data = delta_ca_biomass %>% filter(treatments == "delta_continual"), 
             aes(x = date, y = biomass, color = scientific_name)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  geom_point() +
  geom_smooth(method = "lm") +
  scale_color_manual(values = cal_palette("kelp1", n = 57, type = "continuous")) +
  labs(x = "Sampling date",
       y = expression(Delta~"Biomass (dry g/"~m^2~") (control - removal)"),
       title = "Continual") +
  theme_bw() +
  theme(legend.position = "none")

plots_together <- delta_annual_spp + delta_continual_spp 

plot_ly(
  data = delta_ca_biomass %>% filter(treatments == "delta_continual"), 
  x = ~date, y = ~biomass, 
  color = ~scientific_name, colors = c(cal_palette(name = "kelp1", type = "continuous"))
) %>% 
  add_trace(mode = "markers+lines", type = "scatter") %>% 
  layout(xaxis = list(title = "Date", nticks = 8), 
         yaxis = list(title = "Biomass"),
         legend = list(title = list(text = '<b> Scientific name </b>')))

plot_ly(
  data = delta_ca_biomass %>% filter(treatments == "delta_annual"), 
  x = ~date, y = ~biomass, 
  color = ~scientific_name, colors = c(cal_palette(name = "kelp1", type = "continuous"))
) %>% 
  add_trace(mode = "markers+lines", type = "scatter") %>% 
  layout(xaxis = list(title = "Date", nticks = 8), 
         yaxis = list(title = "Biomass"),
         legend = list(title = list(text = '<b> Scientific name </b>')))

ggplot(data = delta_ca_biomass %>% filter(scientific_name %in% c("Egregia menziesii", "Stephanocystis osmundacea", "Pterygophora californica", "Sargassum muticum", "Sargassum horneri")), 
             aes(x = date, y = biomass, color = scientific_name)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  geom_point() +
  geom_smooth() +
  scale_color_manual(values = cal_palette("kelp1")) +
  labs(x = "Sampling date",
       y = expression(Delta~"Biomass (dry g/"~m^2~") (control - annual)")) +
  theme_bw() +
  theme(legend.position = "bottom") +
  guides(col = guide_legend(nrow = 2, byrow = TRUE)) +
  facet_wrap(~treatments)

# ggsave(here::here("figures", "spp.jpg"), width = 9, height = 5, dpi = 150)

```

Ok, not a lot to show for myself at 6:38 PM but in my defense I spent a FUCKING long time trying to figure out how to use an if else statement with filter for a function. It didn't work but it was at least 4 hours of the most useless rabbit hole.  

Note for future self: what you want to do is make a timeseries figure for delta annual and delta continual for functional groups. Fingers fucking crossed there's something there.

# Thursday 3 June 2021

Can I do this in the 15 minutes before I'm supposed to start watching lecture.

```{r}
fg_biomass_sum <- biomass %>% 
  filter(group == "algae" & exp_dates == "after") %>% 
  # join with traits (without the taxonomic information in the trait data frame)
  mutate(scientific_name = str_replace(scientific_name, " ", "_")) %>% 
  full_join(., traits %>% select(-(1:5)), by = "scientific_name") %>% 
  filter(scientific_name %!in% c("Macrocystis_pyrifera")) %>% 
  # calculate total dry mass per survey
  group_by(site, year, month, treatment, date, growth_form) %>% 
  summarize(total_biomass = sum(dry_gm2)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = treatment, values_from = total_biomass) %>% 
  mutate(delta_annual = CONTROL - ANNUAL,
         delta_continual = CONTROL - CONTINUAL) %>% 
  # create a sample_ID for each sampling date at each site
  unite("sample_ID", site, date, remove = FALSE) %>% 
  pivot_longer(ANNUAL:delta_continual, names_to = "treatments", values_to = "biomass") %>% 
  filter(treatments %in% c("delta_annual", "delta_continual") & 
           biomass != "NA")

delta_biomass_fg_annual <- ggplot(data = fg_biomass_sum %>% filter(treatments == "delta_annual"), 
             aes(x = date, y = biomass, color = growth_form)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  geom_point() +
  geom_smooth() +
  scale_color_manual(values = cal_palette("kelp1", n = 9, type = "continuous")) +
  theme_bw() +
  theme(legend.position = "bottom") +
  labs(x = "Sampling date",
       y = expression(Delta~"biomass (dry g/"~m^2~") (control - removal)"),
       title = "Annual") +
  guides(col = guide_legend(nrow = 3, byrow = TRUE)) 

delta_biomass_fg_continual <- ggplot(data = fg_biomass_sum %>% filter(treatments == "delta_continual"), 
             aes(x = date, y = biomass, color = growth_form)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  geom_point() +
  geom_smooth() +
  scale_color_manual(values = cal_palette("kelp1", n = 9, type = "continuous")) +
  theme_bw() +
  theme(legend.position = "bottom") +
  labs(x = "Sampling date",
       y = expression(Delta~"biomass (dry g/"~m^2~") (control - removal)"),
       title = "Continual") +
  guides(col = guide_legend(nrow = 3, byrow = TRUE)) 

plots_together <- delta_biomass_fg_annual + delta_biomass_fg_continual &
  plot_layout(guides = "collect") & theme(legend.position = "bottom")

ggplot(data = fg_biomass_sum, aes(x = date, y = biomass, color = growth_form)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  geom_point() +
  geom_smooth(method = "lm") +
  scale_color_manual(values = cal_palette("kelp1", n = 9, type = "continuous")) +
  theme_bw() +
  theme(legend.position = "bottom") +
  labs(x = "Sampling date",
       y = expression(Delta~"biomass (dry g/"~m^2~") (control - removal)")) +
  guides(col = guide_legend(nrow = 3, byrow = TRUE)) +
  facet_wrap(~treatments)

# ggsave(here::here("figures", "delta_fg.jpg"), width = 8, height = 5, dpi = 150)
```

Fuck!!! They are different!!! Thank christ. Anyway, what happens when I do trajectory stuff, but with the biomass data?

```{r}
traj_biomass_df <- biomass %>% 
  # filter for algae only
  filter(group == "algae" & scientific_name != "Macrocystis pyrifera") %>% 
  # calculate mean and sum percent cover across 4 quads (i.e. per transect)
  group_by(sample_ID, scientific_name) %>% 
  summarize(total_biomass = sum(dry_gm2)) %>% 
  ungroup() %>% 
  # filter out species with 0 observations
  filter(total_biomass > 0) %>% 
  # get into wide form
  pivot_wider(names_from = "scientific_name", values_from = "total_biomass") %>% 
  # make the sample_ID column row names
  column_to_rownames("sample_ID") %>% 
  # replace NA with 0
  replace(is.na(.), 0)

traj_biomass_meta <- biomass %>% 
  # filter for algae only
  filter(group == "algae") %>% 
  select(sample_ID, date, site, treatment, exp_dates) %>% 
  unite("date_site", date, site, remove = FALSE) %>% 
  # only keep unique descriptors
  unique()

all_after_biomass_df <- traj_biomass_df %>% 
  rownames_to_column("sample_ID") %>% 
  filter(sample_ID %in% all_after_sampleIDs) %>% 
  column_to_rownames("sample_ID")

all_after_biomass_meta <- traj_biomass_meta %>% 
  filter(sample_ID %in% all_after_sampleIDs)

all_biomass_MDS <- metaMDS(all_after_biomass_df, distance = "raup")

# extracting coordinates from jaccard MDS
all_biomass_plotdf <- scores(all_biomass_MDS, display = "sites") %>%
    as_tibble() %>% 
    bind_cols(all_after_biomass_meta, .)

all_biomass_plot_fxn <- function(site_choice) {
  ggplot() +
    coord_fixed() + 
    # continual
    geom_segment(data = all_biomass_plotdf %>% filter(site == site_choice & treatment == "CONTINUAL"), 
                 aes(x = NMDS1, y = NMDS2, 
                     xend = c(tail(NMDS1, n = -1), NA), 
                     yend = c(tail(NMDS2, n = -1), NA)),
                 arrow = arrow(length = unit(0.3, "cm")),
                 size = 0.4, color = "grey", alpha = 0.9) +
    geom_point(data = all_biomass_plotdf %>% filter(site == site_choice & treatment == "CONTINUAL"),
               aes(x = NMDS1, y = NMDS2, 
                   color = "Continual removal", shape = "Continual removal"), 
               size = 4) +
    
    # annual
    geom_segment(data = all_biomass_plotdf %>% filter(site == site_choice & treatment == "ANNUAL"), 
                 aes(x = NMDS1, y = NMDS2, 
                     xend = c(tail(NMDS1, n = -1), NA), 
                     yend = c(tail(NMDS2, n = -1), NA)),
                 arrow = arrow(length = unit(0.3, "cm")),
                 size = 0.4, color = "grey", alpha = 0.9) +
    geom_point(data = all_biomass_plotdf %>% filter(site == site_choice & treatment == "ANNUAL"),
               aes(x = NMDS1, y = NMDS2, 
                   color = "Annual removal", shape = "Annual removal"), size = 4) +
    
    # control
    geom_point(data = all_biomass_plotdf %>% filter(site == site_choice & treatment == "CONTROL"),
               aes(x = NMDS1, y = NMDS2, 
                   color = "Control", shape = "Control"), size = 3, alpha = 0.5) +
    
    # legend
    scale_color_manual(name = NULL,
                       breaks = c("Annual removal", "Continual removal", "Control"),
                       values = c("Annual removal" = annual_col,
                                  "Continual removal" = continual_col,
                                  "Control" = "#000000")) +
    scale_shape_manual(name = NULL,
                       breaks = c("Annual removal", "Continual removal", "Control"),
                       values = c("Annual removal" = annual_shape,
                                  "Continual removal" = continual_shape,
                                  "Control" = control_shape)) +
    
    scale_x_continuous(limits = c(-1.1, 1.75)) +
    scale_y_continuous(limits = c(-1.1, 1.2)) +
    theme(panel.background = element_rect("white"),
          panel.border = element_rect("grey85", fill = NA),
          legend.background = element_rect("white")) +
    labs(title = site_choice)
}

aque_biomass_plot <- all_biomass_plot_fxn("AQUE") + theme(legend.position = "none")
carp_biomass_plot <- all_biomass_plot_fxn("CARP") + theme(legend.position = "bottom")
mohk_biomass_plot <- all_biomass_plot_fxn("MOHK") + theme(legend.position = "none")
ivee_biomass_plot <-   ggplot() +
    coord_fixed() + 
    # annual
    geom_segment(data = all_biomass_plotdf %>% filter(site == "IVEE" & treatment == "ANNUAL"), 
                 aes(x = NMDS1, y = NMDS2, 
                     xend = c(tail(NMDS1, n = -1), NA), 
                     yend = c(tail(NMDS2, n = -1), NA)),
                 arrow = arrow(length = unit(0.3, "cm")),
                 size = 0.4, color = "grey", alpha = 0.9) +
    geom_point(data = all_biomass_plotdf %>% filter(site == "IVEE" & treatment == "ANNUAL"),
               aes(x = NMDS1, y = NMDS2, 
                   color = "Annual removal", shape = "Annual removal"), size = 4) +
    
    # control
    geom_point(data = all_plotdf %>% filter(site == "IVEE" & treatment == "CONTROL"),
               aes(x = NMDS1, y = NMDS2, 
                   color = "Control", shape = "Control"), size = 3, alpha = 0.5) +
    
    # legend
    scale_color_manual(name = NULL,
                       breaks = c("Annual removal", "Control"),
                       values = c("Annual removal" = annual_col,
                                  "Control" = "#000000")) +
    scale_shape_manual(name = NULL,
                       breaks = c("Annual removal", "Control"),
                       values = c("Annual removal" = annual_shape,
                                  "Control" = 21)) +
    
    scale_x_continuous(limits = c(-1.1, 1.75)) +
    scale_y_continuous(limits = c(-1.1, 1.2)) +
    theme(panel.background = element_rect("white"),
          panel.border = element_rect("grey85", fill = NA),
          legend.position = "none") +
    labs(title = "IVEE")
napl_biomass_plot <- all_plot_fxn("NAPL") + theme(legend.position = "none")

plots_together <- (aque_biomass_plot + mohk_biomass_plot + napl_biomass_plot) / 
                  (ivee_biomass_plot + carp_biomass_plot + plot_spacer()) +
  plot_layout(nrow = 2, widths = c(1, 1, 1, 1, 1, 1), heights = c(1, 1, 1, 1, 1, 1)) 
plots_together
```

# Monday 7 June 2021

Am I going to die? anyway.

## Species richness
```{r}
spp_rich <- specnumber(traj_biomass_df) %>% 
  enframe() %>% 
  full_join(., traj_biomass_meta, by = c("name" = "sample_ID")) %>% 
  select(-name) %>% 
  rename(spp_rich = value) %>% 
  pivot_wider(names_from = treatment, values_from = spp_rich) %>% 
  mutate(delta_annual = CONTROL - ANNUAL,
         delta_continual = CONTROL - CONTINUAL) %>% 
  pivot_longer(ANNUAL:delta_continual, names_to = "treatments", values_to = "spp_rich") %>% 
  filter(treatments %in% c("delta_annual", "delta_continual") &
           spp_rich != "NA" &
           exp_dates == "after")

delta_annual_spp_rich <- ggplot(data = spp_rich %>% filter(treatments == "delta_annual"), 
             aes(x = date, y = spp_rich)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  geom_point(shape = annual_shape) +
  geom_smooth(color = "#54662C", method = "lm") +
  labs(x = "Sampling date",
       y = expression(Delta~"species richness (control - removal)"),
       title = "Annual") +
  theme_bw() +
  # theme(legend.position = "none") +
  guides(col = guide_legend(nrow = 8, byrow = TRUE))

delta_continual_spp_rich <- ggplot(data = spp_rich %>% filter(treatments == "delta_continual"), 
             aes(x = date, y = spp_rich)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  geom_point(shape = continual_shape) +
  geom_smooth(color = continual_col, method = "lm") +
  scale_color_manual(values = cal_palette("kelp1", n = 57, type = "continuous")) +
  labs(x = "Sampling date",
       y = expression(Delta~"species richness (control - removal)"),
       title = "Continual") +
  theme_bw() +
  theme(legend.position = "none")

plots_together <- delta_annual_spp_rich + delta_continual_spp_rich

# ggsave(here::here("figures", "spp_rich.jpg"), plots_together, width = 8, height = 4, dpi = 150)
```





