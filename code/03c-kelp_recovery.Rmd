---
title: "kelp frond recovery"
author: "An Bui"
date: "1/23/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 0. set up
```{r}
source(here::here("code", "00-set_up.R"))
```

# 1. Kelp biomass

## Data frame

`kelp_fronds` is created in the set up script - each row is a part of a transect with a unique `sample_ID`. Observations with `-99999` have also been filtered out.

## More wrangling

Data frames:  
- `delta_fronds`: calculates difference in frond density between control and removal plots (removal - control)  
- `control_fronds`: kelp fronds from control plots only  
- `total_fronds`: kelp fronds from treatment + control plots
- `delta_biomass`: calculates difference in biomass between control and removal plots (removal - control)  
- `total_biomass`: biomass from treatment + control plots

```{r}
delta_fronds <- kelp_fronds %>% 
  group_by(site, year, month, season, treatment, date) %>% 
  summarize(total_fronds = sum(fronds)) %>% 
  ungroup() %>% 
  # make a new column for after dates
  mutate(after_dates = case_when(
    site == "aque" & treatment == "annual" ~ aque_after_date_annual,
    site == "aque" & treatment == "continual" ~ aque_after_date_continual,
    site == "aque" & treatment == "control" ~ aque_after_date_annual,
    site == "napl" & treatment == "annual" ~ napl_after_date_annual,
    site == "napl" & treatment == "continual" ~ napl_after_date_continual,
    site == "napl" & treatment == "control" ~ napl_after_date_annual,
    site == "ivee" & treatment == "annual" ~ ivee_after_date_annual,
    site == "mohk" & treatment == "annual" ~ mohk_after_date_annual,
    site == "mohk" & treatment == "continual" ~ mohk_after_date_continual,
    site == "mohk" & treatment == "control" ~ mohk_after_date_annual,
    site == "carp" & treatment == "annual" ~ carp_after_date_annual,
    site == "carp" & treatment == "continual" ~ carp_after_date_continual,
    site == "carp" & treatment == "control" ~ carp_after_date_annual
  )) %>% 
  # make a new column for during and after and set factor levels
  mutate(exp_dates = case_when(
    site == "aque" & date > napl_after_date_annual ~ "after",
    site == "napl" & date > mohk_after_date_annual ~ "after",
    site == "ivee" & date > ivee_after_date_annual ~ "after",
    site == "mohk" & date > mohk_after_date_annual ~ "after",
    site == "carp" & date > carp_after_date_annual ~ "after",
    TRUE ~ "during"
  ),
  exp_dates = fct_relevel(exp_dates, c("during", "after")))  %>% 
  filter(total_fronds > -1) %>% 
  pivot_wider(names_from = treatment, values_from = total_fronds) %>% 
  mutate(delta_annual = annual - control,
         delta_continual = continual - control) 

# just control
control_fronds <- kelp_fronds %>% 
  filter(treatment == "control") %>% 
  group_by(site, year, month, season, date) %>% 
  summarize(total_fronds = sum(fronds)) %>% 
  ungroup() %>% 
  # make a new column for during and after and set factor levels
  mutate(exp_dates = case_when(
    site == "aque" & date > napl_after_date_annual ~ "after",
    site == "napl" & date > mohk_after_date_annual ~ "after",
    site == "ivee" & date > ivee_after_date_annual ~ "after",
    site == "mohk" & date > mohk_after_date_annual ~ "after",
    site == "carp" & date > carp_after_date_annual ~ "after",
    TRUE ~ "during"
  ),
  exp_dates = fct_relevel(exp_dates, c("during", "after")))  %>% 
  filter(total_fronds > -1)

# total fronds
total_fronds <- kelp_fronds %>% 
  group_by(site, year, month, treatment, season, date) %>% 
  summarize(total_fronds = sum(fronds)) %>% 
  ungroup() %>% 
  # make a new column for after dates
  mutate(after_dates = case_when(
    site == "aque" & treatment == "annual" ~ aque_after_date_annual,
    site == "aque" & treatment == "continual" ~ aque_after_date_continual,
    site == "aque" & treatment == "control" ~ aque_after_date_annual,
    site == "napl" & treatment == "annual" ~ napl_after_date_annual,
    site == "napl" & treatment == "continual" ~ napl_after_date_continual,
    site == "napl" & treatment == "control" ~ napl_after_date_annual,
    site == "ivee" & treatment == "annual" ~ ivee_after_date_annual,
    site == "mohk" & treatment == "annual" ~ mohk_after_date_annual,
    site == "mohk" & treatment == "continual" ~ mohk_after_date_continual,
    site == "mohk" & treatment == "control" ~ mohk_after_date_annual,
    site == "carp" & treatment == "annual" ~ carp_after_date_annual,
    site == "carp" & treatment == "continual" ~ carp_after_date_continual,
    site == "carp" & treatment == "control" ~ carp_after_date_annual
  )) %>% 
  # make a new column for during and after and set factor levels
  mutate(exp_dates = case_when(
    site == "aque" & date > napl_after_date_annual ~ "after",
    site == "napl" & date > mohk_after_date_annual ~ "after",
    site == "ivee" & date > ivee_after_date_annual ~ "after",
    site == "mohk" & date > mohk_after_date_annual ~ "after",
    site == "carp" & date > carp_after_date_annual ~ "after",
    TRUE ~ "during"
  ),
  exp_dates = fct_relevel(exp_dates, c("during", "after")))  %>% 
  filter(total_fronds > -1) 

# delta biomass
delta_biomass <- biomass %>% 
  group_by(site, year, month, season, treatment, date, sp_code) %>% 
  summarize(total_wm_gm2 = sum(wm_gm2)) %>% 
  ungroup() %>% 
  # make a new column for after dates
  mutate(after_dates = case_when(
    site == "aque" & treatment == "annual" ~ aque_after_date_annual,
    site == "aque" & treatment == "continual" ~ aque_after_date_continual,
    site == "aque" & treatment == "control" ~ aque_after_date_annual,
    site == "napl" & treatment == "annual" ~ napl_after_date_annual,
    site == "napl" & treatment == "continual" ~ napl_after_date_continual,
    site == "napl" & treatment == "control" ~ napl_after_date_annual,
    site == "ivee" & treatment == "annual" ~ ivee_after_date_annual,
    site == "mohk" & treatment == "annual" ~ mohk_after_date_annual,
    site == "mohk" & treatment == "continual" ~ mohk_after_date_continual,
    site == "mohk" & treatment == "control" ~ mohk_after_date_annual,
    site == "carp" & treatment == "annual" ~ carp_after_date_annual,
    site == "carp" & treatment == "continual" ~ carp_after_date_continual,
    site == "carp" & treatment == "control" ~ carp_after_date_annual
  )) %>% 
  # make a new column for during and after and set factor levels
  mutate(exp_dates = case_when(
    site == "aque" & date > napl_after_date_annual ~ "after",
    site == "napl" & date > mohk_after_date_annual ~ "after",
    site == "ivee" & date > ivee_after_date_annual ~ "after",
    site == "mohk" & date > mohk_after_date_annual ~ "after",
    site == "carp" & date > carp_after_date_annual ~ "after",
    TRUE ~ "during"
  ),
  exp_dates = fct_relevel(exp_dates, c("during", "after"))) %>% 
  pivot_wider(names_from = treatment, values_from = total_wm_gm2) %>% 
  mutate(delta_annual = annual - control,
         delta_continual = continual - control) %>% 
  filter(sp_code == "MAPY")

# total biomass
total_biomass <- biomass %>% 
  group_by(site, year, month, treatment, season, date, sp_code) %>% 
  summarize(total_wm_gm2 = sum(wm_gm2)) %>% 
  ungroup() %>% 
  # make a new column for after dates
  mutate(after_dates = case_when(
    site == "aque" & treatment == "annual" ~ aque_after_date_annual,
    site == "aque" & treatment == "continual" ~ aque_after_date_continual,
    site == "aque" & treatment == "control" ~ aque_after_date_annual,
    site == "napl" & treatment == "annual" ~ napl_after_date_annual,
    site == "napl" & treatment == "continual" ~ napl_after_date_continual,
    site == "napl" & treatment == "control" ~ napl_after_date_annual,
    site == "ivee" & treatment == "annual" ~ ivee_after_date_annual,
    site == "mohk" & treatment == "annual" ~ mohk_after_date_annual,
    site == "mohk" & treatment == "continual" ~ mohk_after_date_continual,
    site == "mohk" & treatment == "control" ~ mohk_after_date_annual,
    site == "carp" & treatment == "annual" ~ carp_after_date_annual,
    site == "carp" & treatment == "continual" ~ carp_after_date_continual,
    site == "carp" & treatment == "control" ~ carp_after_date_annual
  )) %>% 
  # make a new column for during and after and set factor levels
  mutate(exp_dates = case_when(
    site == "aque" & date > napl_after_date_annual ~ "after",
    site == "napl" & date > mohk_after_date_annual ~ "after",
    site == "ivee" & date > ivee_after_date_annual ~ "after",
    site == "mohk" & date > mohk_after_date_annual ~ "after",
    site == "carp" & date > carp_after_date_annual ~ "after",
    TRUE ~ "during"
  ),
  exp_dates = fct_relevel(exp_dates, c("during", "after"))) %>% 
  filter(sp_code == "MAPY") %>% 
  drop_na(total_wm_gm2)
```

## Plotting

### Before/after comparison

This creates plots where the mean kelp frond density is plotted for the "before" and "after" time points ("before" = during the experiment, and "after" = after the experiment ended). 

#### Frond density
```{r}
comparison_frond_fxn <- function(site_choice) {
  plot_title <- if(site_choice == "aque") {
    aque_full
  } else if(site_choice == "napl") {
    napl_full
  } else if(site_choice == "carp") {
    carp_full
  } else if(site_choice == "ivee") {
    ivee_full
  } else if(site_choice == "mohk") {
    mohk_full
  }
  
  total_fronds %>% 
    filter(site == site_choice) %>% 
    ggplot(aes(x = exp_dates, y = total_fronds, col = treatment, shape = treatment)) +
    # stat summary for point and SE for mean frond density during and after with line
    stat_summary(aes(group = treatment), fun = mean, geom = "line", size = 1, alpha = 0.8) +
    stat_summary(fun = mean, geom = "point", size = 4) +
    stat_summary(fun.data = mean_se, geom = "errorbar", alpha = 0.8, width = 0.2) +
    scale_color_manual(values = color_palette) +
    scale_shape_manual(values = shape_palette) +
    theme_bw() +
    theme(plot.title = element_text(size = 20)) +
    labs(x = " ",
         y = "Mean frond density",
         title = plot_title) 
}

aque_comparison_frond <- comparison_frond_fxn("aque")
mohk_comparison_frond <- comparison_frond_fxn("mohk")
carp_comparison_frond <- comparison_frond_fxn("carp")
ivee_comparison_frond <- total_fronds %>% 
    filter(site == "ivee") %>% 
    ggplot(aes(x = exp_dates, y = total_fronds, col = treatment, shape = treatment)) +
    stat_summary(aes(group = treatment), fun = mean, geom = "line", size = 1, alpha = 0.8) +
    stat_summary(fun = mean, geom = "point", size = 4) +
    stat_summary(fun.data = mean_se, geom = "errorbar", alpha = 0.8, width = 0.2) +
    scale_color_manual(values = color_palette) +
    scale_shape_manual(values = shape_palette) +
    theme_bw() +
    theme(plot.title = element_text(size = 20)) +
    labs(x = " ",
         y = "Mean frond density",
         title = ivee_full)
napl_comparison_frond <- comparison_frond_fxn("napl")

aque_comparison_frond
mohk_comparison_frond
carp_comparison_frond
ivee_comparison_frond
napl_comparison_frond
```

#### Kelp biomass
```{r}
comparison_biomass_fxn <- function(site_choice) {
  plot_title <- if(site_choice == "aque") {
    aque_full
  } else if(site_choice == "napl") {
    napl_full
  } else if(site_choice == "carp") {
    carp_full
  } else if(site_choice == "ivee") {
    ivee_full
  } else if(site_choice == "mohk") {
    mohk_full
  }
  
  total_biomass %>% 
    filter(site == site_choice) %>% 
    ggplot(aes(x = exp_dates, y = total_wm_gm2, col = treatment, shape = treatment)) +
    stat_summary(aes(group = treatment), fun = mean, geom = "line", size = 1, alpha = 0.8, na.rm = TRUE) +
    stat_summary(fun = mean, geom = "point", size = 4, na.rm = TRUE) +
    
    stat_summary(fun.data = mean_se, geom = "errorbar", alpha = 0.8, width = 0.2, na.rm = TRUE) +
    scale_color_manual(values = color_palette) +
    scale_shape_manual(values = shape_palette) +
    theme_bw() +
    theme(plot.title = element_text(size = 20)) +
    labs(x = " ",
         y = "Mean kelp biomass (wm g/m2)",
         title = plot_title)
}

aque_comparison_biomass <- comparison_biomass_fxn("aque")
napl_comparison_biomass <- comparison_biomass_fxn("napl")
ivee_comparison_biomass <- total_biomass %>% 
    filter(site == "ivee") %>% 
    ggplot(aes(x = exp_dates, y = total_wm_gm2, col = treatment, shape = treatment)) +
    stat_summary(aes(group = treatment), fun = mean, geom = "line", size = 1, alpha = 0.8, na.rm = TRUE) +
    stat_summary(fun = mean, geom = "point", size = 4, na.rm = TRUE) +
    
    stat_summary(fun.data = mean_se, geom = "errorbar", alpha = 0.8, width = 0.2, na.rm = TRUE) +
    scale_color_manual(values = color_palette) +
    scale_shape_manual(values = shape_palette) +
    theme_bw() +
    theme(plot.title = element_text(size = 20)) +
    labs(x = " ",
         y = "Mean kelp biomass (wm g/m2)",
         title = ivee_full)
mohk_comparison_biomass <- comparison_biomass_fxn("mohk")
carp_comparison_biomass <- comparison_biomass_fxn("carp")

aque_comparison_biomass
napl_comparison_biomass
ivee_comparison_biomass
mohk_comparison_biomass
carp_comparison_biomass
```

### best model for kelp frond density
```{r}
summary(aov(data = total_fronds,
    formula = total_fronds ~ treatment + site))

TukeyHSD(aov(data = total_fronds,
    formula = total_fronds ~ site + treatment + site*treatment))

model.dredge <- dredge(
  lm(total_fronds ~ site + treatment + site*treatment, data = total_fronds, na.action = na.pass)
)

model.sel(model.dredge) %>% 
  gt() %>% 
  tab_header(title = "all model subsets",
             subtitle = "total_fronds ~ site + treatment + site*treatment") 
# %>% 
#   gtsave("tab_1.png", expand = 10,
#          path = here::here("tables", "kelp_frond_model.png"))
```

### best model for kelp biomass

```{r}
summary(aov(data = total_biomass,
    formula = total_wm_gm2 ~ site + treatment + site*treatment))

TukeyHSD(aov(data = total_biomass,
    formula = total_wm_gm2 ~ site + treatment + site*treatment))

model.dredge <- dredge(
  lm(total_wm_gm2 ~ site + treatment + site*treatment, data = total_biomass, na.action = na.pass)
)

model.sel(model.dredge) %>% 
  gt() %>% 
  tab_header(title = "all model subsets",
             subtitle = "total_biomass ~ site + treatment + site*treatment") 
```

### Total kelp frond timeseries

This creates a plot where kelp frond density timeseries are plotted for each LTE site with control in open circles, annual in green circles, and continual in blue triangles. There is a `ggsave()` command at the end - **remember to change the date in the file name before saving**.

```{r}
total_frond_timeseries_fxn <- function(site_choice) {
  after_date <- if(site_choice == "aque") {
    aque_after_date_continual
  } else if(site_choice == "napl") {
    napl_after_date_continual
  } else if(site_choice == "carp") {
    carp_after_date_continual
  } else if(site_choice == "ivee") {
    ivee_after_date_continual
  } else if(site_choice == "mohk") {
    mohk_after_date_continual
  }
  
  plot_title <- if(site_choice == "aque") {
    aque_full
  } else if(site_choice == "napl") {
    napl_full
  } else if(site_choice == "carp") {
    carp_full
  } else if(site_choice == "ivee") {
    ivee_full
  } else if(site_choice == "mohk") {
    mohk_full
  }
  
  rect_ymax <- total_fronds %>% filter(site == site_choice) %>% pull(total_fronds) %>% max()
  
  df <- total_fronds %>% filter(site == site_choice)
  
  ggplot(data = df,
         aes(x = date, y = total_fronds, color = treatment, shape = treatment)) +
    scale_x_date(limits = c(aque_start_date, as.Date("2022-02-02"))) +
    geom_hline(yintercept = 0, color = "grey") +
    annotate("rect", xmin = after_date, xmax = as.Date("2022-02-02"),
           ymin = -1, ymax = rect_ymax*1.05,
           alpha = 0.2) +
    geom_point(size = 3) +
    geom_line(size = 1) +
    scale_color_manual(values = color_palette) +
    scale_shape_manual(values = shape_palette)  +
    theme_bw() + 
    labs(title = plot_title,
         x = " ",
         y = " ")
}

aque_total_frond_timeseries <- total_frond_timeseries_fxn("aque")
mohk_total_frond_timeseries <- total_frond_timeseries_fxn("mohk")
carp_total_frond_timeseries <- total_frond_timeseries_fxn("carp")
ivee_total_frond_timeseries <- ggplot(data = total_fronds %>% filter(site == "ivee"),
         aes(x = date, y = total_fronds, color = treatment, shape = treatment)) +
    scale_x_date(limits = c(aque_start_date, as.Date("2022-02-02"))) +
    geom_hline(yintercept = 0, color = "grey") +
    annotate("rect", xmin = ivee_after_date, xmax = as.Date("2022-02-02"),
           ymin = -1, ymax = (total_fronds %>% filter(site == "ivee") %>% pull(total_fronds) %>% max())*1.05,
           alpha = 0.2) +
    geom_point(size = 3) +
    geom_line(size = 1) +
    scale_color_manual(values = c("control" = control_col, "annual" = annual_col)) +
    scale_shape_manual(values = c("control" = control_shape, "annual" = annual_shape))  +
    theme_bw() + 
    labs(title = ivee_full,
         x = " ",
         y = " ")
napl_total_frond_timeseries <- total_frond_timeseries_fxn("napl")

aque_total_frond_timeseries
mohk_total_frond_timeseries
ivee_total_frond_timeseries
napl_total_frond_timeseries
carp_total_frond_timeseries

# y-axis label for patchwork side eye emoji
yaxislabel <- ggplot(data.frame(l = "kelp frond density", x = 1, y = 1)) +
      geom_text(aes(x, y, label = l), angle = 90) + 
      theme_void() +
      coord_cartesian(clip = "off")

plots_together <- yaxislabel + (aque_total_frond_timeseries / mohk_total_frond_timeseries / napl_total_frond_timeseries / ivee_total_frond_timeseries / carp_total_frond_timeseries) +
  plot_layout(guides = "collect", widths = c(1, 25)) &
  theme(legend.position = "bottom")

plots_together

# ggsave(here::here("figures", "kelp_total_frond_ts-20211012.jpg"), plots_together, height = 9, width = 5, dpi = 200)
```

#### Total frond timeseries for report

```{r}
aque_total_frond_timeseries_labs <- aque_total_frond_timeseries + 
  labs(x = "Sampling date", y = "Total kelp fronds",
       title = "Total kelp fronds") +
  theme(legend.position = "none")
mohk_total_frond_timeseries_labs <- mohk_total_frond_timeseries + 
  labs(x = "Sampling date", y = "Total kelp fronds",
       title = "Total kelp fronds") +
  theme(legend.position = "none")
ivee_total_frond_timeseries_labs <- ivee_total_frond_timeseries + 
  labs(x = "Sampling date", y = "Total kelp fronds",
       title = "Total kelp fronds") +
  theme(legend.position = "none")
napl_total_frond_timeseries_labs <- napl_total_frond_timeseries + 
  labs(x = "Sampling date", y = "Total kelp fronds",
       title = "Total kelp fronds") +
  theme(legend.position = "none")
carp_total_frond_timeseries_labs <- carp_total_frond_timeseries + 
  labs(x = "Sampling date", y = "Total kelp fronds",
       title = "Total kelp fronds") +
  theme(legend.position = "none")
```

### Total kelp biomass timeseries

```{r}
total_biomass_timeseries_fxn <- function(site_choice) {
  after_date <- if(site_choice == "aque") {
    aque_after_date_continual
  } else if(site_choice == "napl") {
    napl_after_date_continual
  } else if(site_choice == "carp") {
    carp_after_date_continual
  } else if(site_choice == "ivee") {
    ivee_after_date_continual
  } else if(site_choice == "mohk") {
    mohk_after_date_continual
  }
  
  plot_title <- if(site_choice == "aque") {
    aque_full
  } else if(site_choice == "napl") {
    napl_full
  } else if(site_choice == "carp") {
    carp_full
  } else if(site_choice == "ivee") {
    ivee_full
  } else if(site_choice == "mohk") {
    mohk_full
  }
  
  rect_ymax <- total_biomass %>% filter(site == site_choice) %>% pull(total_wm_gm2) %>% max()
  
  df <- total_biomass %>% filter(site == site_choice)
  
  ggplot(data = df,
         aes(x = date, y = total_wm_gm2, color = treatment, shape = treatment)) +
    scale_x_date(limits = c(aque_start_date, as.Date("2022-02-02"))) +
    geom_hline(yintercept = 0, color = "grey") +
    annotate("rect", xmin = after_date, xmax = as.Date("2022-02-02"),
           ymin = -1, ymax = rect_ymax*1.05,
           alpha = 0.2) +
    geom_point(size = 3) +
    geom_line(size = 1) +
    scale_color_manual(values = color_palette) +
    scale_shape_manual(values = shape_palette)  +
    theme_bw() + 
    theme(legend.position = "none") +
    labs(title = plot_title,
         x = "Sampling date",
         y = "Total kelp biomass (wm g/m2)")
}

aque_total_biomass_timeseries <- total_biomass_timeseries_fxn("aque")
napl_total_biomass_timeseries <- total_biomass_timeseries_fxn("napl")
ivee_total_biomass_timeseries <- ggplot(data = total_biomass %>% 
                                          filter(site == "ivee"),
                                        aes(x = date, y = total_wm_gm2, color = treatment, shape = treatment)) +
  scale_x_date(limits = c(aque_start_date, as.Date("2022-02-02"))) +
  geom_hline(yintercept = 0, color = "grey") +
  annotate("rect", xmin = ivee_after_date, xmax = as.Date("2022-02-02"),
           ymin = -1, ymax = (total_biomass %>% filter(site == "ivee") %>% pull(total_wm_gm2) %>% max())*1.05,
           alpha = 0.2) +
  geom_point(size = 3) +
  geom_line(size = 1) +
  scale_color_manual(values = c("control" = "grey", "annual" = annual_col, "continual" = continual_col)) +
  scale_shape_manual(values = c("control" = control_shape, "annual" = annual_shape, "continual" = continual_shape))  +
  theme_bw() + 
  theme(legend.position = "none") +
  labs(title = ivee_full,
       x = "Sampling date",
       y = "Total kelp biomass (wm g/m2)")
mohk_total_biomass_timeseries <- total_biomass_timeseries_fxn("mohk")
carp_total_biomass_timeseries <- total_biomass_timeseries_fxn("carp")

aque_total_biomass_timeseries
napl_total_biomass_timeseries
ivee_total_biomass_timeseries
mohk_total_biomass_timeseries
carp_total_biomass_timeseries
```

### Delta kelp frond timeseries

This creates a plot where delta kelp frond density (difference between control and removal density) timeseries are plotted for each LTE site with annual in green circles and continual in blue circles. This was supposed to be a recreation of the plots that Adrian sent a long time ago. There is a `ggsave()` command at the end - **remember to change the date in the file name before saving**.

```{r}
delta_frond_timeseries_fxn <- function(site_choice) {
  after_date <- if(site_choice == "aque") {
    aque_after_date
  } else if(site_choice == "napl") {
    napl_after_date
  } else if(site_choice == "carp") {
    carp_after_date
  } else if(site_choice == "ivee") {
    ivee_after_date
  } else if(site_choice == "mohk") {
    mohk_after_date
  }
  
  delta_continual_max <- delta_fronds %>% filter(site == site_choice) %>% pull(delta_continual) %>% max(na.rm = TRUE)
  delta_continual_min <- delta_fronds %>% filter(site == site_choice) %>% pull(delta_continual) %>% min(na.rm = TRUE)
  delta_annual_max <- delta_fronds %>% filter(site == site_choice) %>% pull(delta_annual) %>% max(na.rm = TRUE)  
  delta_annual_min <- delta_fronds %>% filter(site == site_choice) %>% pull(delta_annual) %>% min(na.rm = TRUE)
  
  rect_ymax <- ifelse(delta_continual_max > delta_annual_max, delta_continual_max, delta_annual_max)
  rect_ymin <- ifelse(delta_continual_min < delta_annual_max, delta_continual_min, delta_annual_max)
  
  ggplot() +
    scale_x_date(limits = c(aque_start_date, as.Date("2022-02-02"))) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
    annotate("rect", xmin = after_date, xmax = as.Date("2022-02-02"),
             ymin = rect_ymin*1.1, ymax = rect_ymax*1.1,
             alpha = 0.2) +
    annotate("text", x = as.Date("2009-04-01"), y = rect_ymax*1.1, label = "removal > control", size = 3) +
  annotate("text", x = as.Date("2009-04-01"), y = rect_ymin*1.1, label = "control > removal", size = 3) +
    geom_point(data = delta_fronds %>% filter(site == site_choice & delta_annual != "NA"), 
               aes(x = date, y = delta_annual, color = "annual"), 
               size = 3, shape = annual_shape) +
    geom_line(data = delta_fronds %>% filter(site == site_choice & delta_annual != "NA"),
              aes(x = date, y = delta_annual, color = "annual"), size = 1) +
    geom_point(data = delta_fronds %>% filter(site == site_choice & delta_continual != "NA"), 
               aes(x = date, y = delta_continual, color = "continual"), 
               size = 3, shape = continual_shape) +
    geom_line(data = delta_fronds %>% filter(site == site_choice & delta_continual != "NA"),
              aes(x = date, y = delta_continual, color = "continual"), size = 1) +
    scale_color_manual(name = NULL,
                       breaks = c("annual", "continual"),
                       values = c("annual" = annual_col, "continual" = continual_col)) +
    theme_bw() + 
    labs(title = site_choice,
         x = " ",
         y = " ")
}

aque_delta_kelp_timeseries <- delta_frond_timeseries_fxn("aque")
mohk_delta_kelp_timeseries <- delta_frond_timeseries_fxn("mohk")
carp_delta_kelp_timeseries <- delta_frond_timeseries_fxn("carp")
ivee_delta_kelp_timeseries <- ggplot() +
  scale_x_date(limits = c(aque_start_date, as.Date("2022-02-02"))) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
      annotate("rect", xmin = ivee_after_date, xmax = as.Date("2022-02-02"),
             ymin = delta_fronds %>% filter(site == "ivee") %>% pull(delta_annual) %>% min()*1.1, 
             ymax = delta_fronds %>% filter(site == "ivee") %>% pull(delta_annual) %>% max()*1.1,
             alpha = 0.2) +
  annotate("text", x = as.Date("2009-04-01"), y = delta_fronds %>% filter(site == "ivee") %>% pull(delta_annual) %>% max()*1.1, label = "removal > control", size = 3) +
  annotate("text", x = as.Date("2009-04-01"), y = delta_fronds %>% filter(site == "ivee") %>% pull(delta_annual) %>% min()*1.1, label = "control > removal", size = 3) +
  geom_point(data = delta_fronds %>% filter(site == "ivee" & delta_annual != "NA"), 
             aes(x = date, y = delta_annual), color = annual_col, size = 3) +
  geom_line(data = delta_fronds %>% filter(site == "ivee" & delta_annual != "NA"),
            aes(x = date, y = delta_annual), color = annual_col, size = 1) +
  theme_bw() + 
  labs(title = "ivee",
       x = "Sampling date",
       y = " ")
napl_delta_kelp_timeseries <- delta_frond_timeseries_fxn("napl")

aque_delta_kelp_timeseries
mohk_delta_kelp_timeseries
ivee_delta_kelp_timeseries
napl_delta_kelp_timeseries
carp_delta_kelp_timeseries

# y-axis label for patchwork side eye emoji
yaxislabel <- ggplot(data.frame(l = "kelp fronds (removal - control)", x = 1, y = 1)) +
      geom_text(aes(x, y, label = l), angle = 90) + 
      theme_void() +
      coord_cartesian(clip = "off")

plots_together <- yaxislabel + (aque_delta_kelp_timeseries / mohk_delta_kelp_timeseries / napl_delta_kelp_timeseries / ivee_delta_kelp_timeseries / carp_delta_kelp_timeseries) +
  plot_layout(guides = "collect", widths = c(1, 25)) &
  theme(legend.position = "bottom")

plots_together

# ggsave(here::here("figures", "kelp_frond_ts-20220201.jpg"), plots_together, height = 9, width = 5, dpi = 200)
```

#### Delta frond timeseries for report

```{r}
aque_delta_kelp_timeseries_labs <- aque_delta_kelp_timeseries +
  labs(x = "Sampling date", y = "\u0394 fronds \n (removal - control)",
       title = "\u0394 fronds (removal - control)")  +
  theme(legend.position = "none")
mohk_delta_kelp_timeseries_labs <- mohk_delta_kelp_timeseries +
  labs(x = "Sampling date", y = "\u0394 fronds \n (removal - control)",
       title = "\u0394 fronds (removal - control)")  +
  theme(legend.position = "none")
ivee_delta_kelp_timeseries_labs <- ivee_delta_kelp_timeseries +
  labs(x = "Sampling date", y = "\u0394 fronds \n (removal - control)",
       title = "\u0394 fronds (removal - control)")  +
  theme(legend.position = "none")
napl_delta_kelp_timeseries_labs <- napl_delta_kelp_timeseries +
  labs(x = "Sampling date", y = "\u0394 fronds \n (removal - control)",
       title = "\u0394 fronds (removal - control)")  +
  theme(legend.position = "none")
carp_delta_kelp_timeseries_labs <- carp_delta_kelp_timeseries +
  labs(x = "Sampling date", y = "\u0394 fronds \n (removal - control)",
       title = "\u0394 fronds (removal - control)") +
  theme(legend.position = "none")
```

### Delta biomass timeseries

```{r}
delta_biomass_timeseries_fxn <- function(site_choice) {
  after_date <- if(site_choice == "aque") {
    aque_after_date
  } else if(site_choice == "napl") {
    napl_after_date
  } else if(site_choice == "carp") {
    carp_after_date
  } else if(site_choice == "ivee") {
    ivee_after_date
  } else if(site_choice == "mohk") {
    mohk_after_date
  }
  
  delta_continual_max <- delta_biomass %>% filter(site == site_choice) %>% pull(delta_continual) %>% max(na.rm = TRUE)
  delta_continual_min <- delta_biomass %>% filter(site == site_choice) %>% pull(delta_continual) %>% min(na.rm = TRUE)
  delta_annual_max <- delta_biomass %>% filter(site == site_choice) %>% pull(delta_annual) %>% max(na.rm = TRUE)  
  delta_annual_min <- delta_biomass %>% filter(site == site_choice) %>% pull(delta_annual) %>% min(na.rm = TRUE)
  
  rect_ymax <- ifelse(delta_continual_max > delta_annual_max, delta_continual_max, delta_annual_max)
  rect_ymin <- ifelse(delta_continual_min < delta_annual_max, delta_continual_min, delta_annual_max)
  
  ggplot() +
    scale_x_date(limits = c(aque_start_date, as.Date("2022-02-02"))) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
    annotate("rect", xmin = after_date, xmax = as.Date("2022-02-02"),
             ymin = rect_ymin*1.1, ymax = rect_ymax*1.1,
             alpha = 0.2) +
    annotate("text", x = as.Date("2009-04-01"), y = rect_ymax*1.1, label = "removal > control", size = 3) +
  annotate("text", x = as.Date("2009-04-01"), y = rect_ymin*1.1, label = "control > removal", size = 3) +
    geom_point(data = delta_biomass %>% filter(site == site_choice & delta_annual != "NA"), 
               aes(x = date, y = delta_annual, color = "annual"), 
               size = 3, shape = annual_shape) +
    geom_line(data = delta_biomass %>% filter(site == site_choice & delta_annual != "NA"),
              aes(x = date, y = delta_annual, color = "annual"), size = 1) +
    geom_point(data = delta_biomass %>% filter(site == site_choice & delta_continual != "NA"), 
               aes(x = date, y = delta_continual, color = "continual"), 
               size = 3, shape = continual_shape) +
    geom_line(data = delta_biomass %>% filter(site == site_choice & delta_continual != "NA"),
              aes(x = date, y = delta_continual, color = "continual"), size = 1) +
    scale_color_manual(name = NULL,
                       breaks = c("annual", "continual"),
                       values = c("annual" = annual_col, "continual" = continual_col)) +
    theme_bw() + 
    theme(legend.position = "none") +
    labs(x = "Sampling date",
         y = "\u0394 kelp biomass \n (wm g/m2, removal - control)",
         title = site_choice)
}

aque_delta_biomass_timeseries <- delta_biomass_timeseries_fxn("aque")
napl_delta_biomass_timeseries <- delta_biomass_timeseries_fxn("napl")
ivee_delta_biomass_timeseries <- ggplot() +
  scale_x_date(limits = c(aque_start_date, as.Date("2022-02-02"))) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  annotate("rect", xmin = ivee_after_date, xmax = as.Date("2022-02-02"),
           ymin = delta_biomass %>% filter(site == "ivee") %>% pull(delta_annual) %>% min()*1.1, 
           ymax = delta_biomass %>% filter(site == "ivee") %>% pull(delta_annual) %>% max()*1.1,
           alpha = 0.2) +
  annotate("text", x = as.Date("2009-04-01"), y = delta_biomass %>% filter(site == "ivee") %>% pull(delta_annual) %>% max()*1.1, label = "removal > control", size = 3) +
  annotate("text", x = as.Date("2009-04-01"), y = delta_biomass %>% filter(site == "ivee") %>% pull(delta_annual) %>% min()*1.1, label = "control > removal", size = 3) +
  geom_point(data = delta_biomass %>% filter(site == "ivee" & delta_annual != "NA"), 
             aes(x = date, y = delta_annual, color = "annual"), 
             size = 3, shape = annual_shape) +
  geom_line(data = delta_biomass %>% filter(site == "ivee" & delta_annual != "NA"),
            aes(x = date, y = delta_annual, color = "annual"), size = 1) +
  scale_color_manual(name = NULL,
                     breaks = c("annual"),
                     values = c("annual" = annual_col)) +
  theme_bw() + 
  theme(legend.position = "none") +
  labs(x = "Sampling date",
       y = "\u0394 kelp biomass \n (wm g/m2, removal - control)",
       title = "ivee")
mohk_delta_biomass_timeseries <- delta_biomass_timeseries_fxn("mohk")
carp_delta_biomass_timeseries <- delta_biomass_timeseries_fxn("carp")


aque_delta_biomass_timeseries
napl_delta_biomass_timeseries
ivee_delta_biomass_timeseries
mohk_delta_biomass_timeseries
carp_delta_biomass_timeseries
```

### 2022-02-04 report figures

```{r}
aque_panels <- (aque_comparison_frond / aque_total_frond_timeseries_labs / aque_delta_kelp_timeseries_labs) +
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = "A") &
  theme(plot.tag = element_text(size = 16))

napl_panels <- (napl_comparison_frond / napl_total_frond_timeseries_labs / napl_delta_kelp_timeseries_labs) +
  plot_layout(guides = "collect") 

ivee_panels <- (ivee_comparison_frond / ivee_total_frond_timeseries_labs / ivee_delta_kelp_timeseries_labs) +
  plot_layout(guides = "collect") 

carp_panels <- (carp_comparison_frond / carp_total_frond_timeseries_labs / carp_delta_kelp_timeseries_labs) +
  plot_layout(guides = "collect") 

mohk_panels <- (mohk_comparison_frond / mohk_total_frond_timeseries_labs / mohk_delta_kelp_timeseries_labs) +
  plot_layout(guides = "collect") 

# ggsave(here::here("figures", "panels_aque_2022-02-03.jpg"), aque_panels, height = 10, width = 9, dpi = 300)
# 
# ggsave(here::here("figures", "panels_napl_2022-02-03.jpg"), napl_panels, height = 10, width = 9, dpi = 300)
# 
# ggsave(here::here("figures", "panels_ivee_2022-02-03.jpg"), ivee_panels, height = 10, width = 9, dpi = 300)
# 
# ggsave(here::here("figures", "panels_carp_2022-02-03.jpg"), carp_panels, height = 10, width = 9, dpi = 300)
# 
# ggsave(here::here("figures", "panels_mohk_2022-02-03.jpg"), mohk_panels, height = 10, width = 9, dpi = 300)
```

### 2022-02-11 report figures

```{r}
aque_panels <- (aque_comparison_biomass / aque_total_biomass_timeseries / aque_delta_biomass_timeseries) +
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = "A") &
  theme(plot.tag = element_text(size = 16))

napl_panels <- (napl_comparison_biomass / napl_total_biomass_timeseries / napl_delta_biomass_timeseries) +
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = "A") &
  theme(plot.tag = element_text(size = 16))

ivee_panels <- (ivee_comparison_biomass / ivee_total_biomass_timeseries / ivee_delta_biomass_timeseries) +
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = "A") &
  theme(plot.tag = element_text(size = 16))

carp_panels <- (carp_comparison_biomass / carp_total_biomass_timeseries / carp_delta_biomass_timeseries) +
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = "A") &
  theme(plot.tag = element_text(size = 16))

mohk_panels <- (mohk_comparison_biomass / mohk_total_biomass_timeseries / mohk_delta_biomass_timeseries) +
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = "A") &
  theme(plot.tag = element_text(size = 16))

# ggsave(here::here("figures", "panels_biomass_aque_2022-02-04.jpg"), aque_panels, height = 10, width = 9, dpi = 300)
# 
# ggsave(here::here("figures", "panels_biomass_napl_2022-02-04.jpg"), napl_panels, height = 10, width = 9, dpi = 300)
# 
# ggsave(here::here("figures", "panels_biomass_ivee_2022-02-04.jpg"), ivee_panels, height = 10, width = 9, dpi = 300)
# 
# ggsave(here::here("figures", "panels_biomass_carp_2022-02-04.jpg"), carp_panels, height = 10, width = 9, dpi = 300)
# 
# ggsave(here::here("figures", "panels_biomass_mohk_2022-02-04.jpg"), mohk_panels, height = 10, width = 9, dpi = 300)
```


## Model selection for delta frond density

Using function from the Thiault script below. Made edits to not print out results in the quartz viewer.

```{r}
ProgressiveChangeBACIPS<-function(control, impact, time.true, time.model) 
{
	### STEP 2 - Calculate the delta at each sampling date
	delta <- impact - control
	
	# Plot delta against time.true
	# dev.new(width=10, height=5)
	# par(mfrow=c(1,2))
	plot(delta~time.true, type="n")
	time.model.of.impact=max(which(time.model==0))
	rect(time.model.of.impact, min(delta)-100, max(time.model)+10, max(delta)+100, col = "grey")
	points(delta~time.true, pch=24, bg="white", cex=2)
	
	### STEP 3 - Fit and compete models
	## Create a 'period' variable
	period <- ifelse(time.model==0, "Before","After")
	
	## Fit a step model
	step.Model<-aov(delta ~ period)

	## Fit a linear model
	linear.Model<-lm(delta ~ time.model)
	
	## Fit an asymptotic model
	# Create an asymptotic function
	myASYfun<-function(delta, time.model)
	{
		funAsy<-function(parS, time.model)	(parS$M * time.model) / (parS$L + time.model) + parS$B
		residFun<-function(p, observed, time.model) observed + funAsy(p,time.model)
		parStart <- list(M=mean(delta[time.model.of.impact:length(time.true)]), B=mean(delta[1:time.model.of.impact]), L=1)
		nls_ASY_out <- nls.lm(par=parStart, fn= residFun, observed=delta, time.model=time.model, control = nls.lm.control(maxfev = integer(), maxiter = 1000))
		foAsy<-delta~(M * time.model) / (L + time.model) + B
		startPar<-c(-coef(nls_ASY_out)[1], coef(nls_ASY_out)[2], coef(nls_ASY_out)[3])
		asyFit<-nls2(foAsy, start=startPar, algorithm="brute-force") # nls2 enables to calculate AICc
		asyFit
	}
	# Fit the asymptotic model
	asymptotic.Model<-myASYfun(delta=delta,time.model=time.model)
	
	
	## Fit a sigmoid model
	## Create a sigmoid function
	mySIGfun<-function(delta, time.model)
	{
		funSIG<-function(parS, time.model)	(parS$M * (time.model/parS$L)^parS$K) / (1 + (time.model/parS$L) ^ parS$K) + parS$B
		residFun<-function(p, observed, time.model) observed + funSIG(p,time.model)
		parStart <- list(M=mean(delta[time.model.of.impact:length(time.true)]), B=mean(delta[1:time.model.of.impact]), L=mean(time.model), K=5)
		nls_SIG_out <- nls.lm(par=parStart, fn= residFun, observed=delta, time.model=time.model, control = nls.lm.control(maxfev = integer(), maxiter = 1000))
		foSIG<-delta~(M * (time.model/L) ^ K) / (1 + (time.model/L) ^ K) + B
		startPar<-c(-coef(nls_SIG_out)[1],-coef(nls_SIG_out)[2],coef(nls_SIG_out)[3],coef(nls_SIG_out)[4])
		sigFit<-nls2(foSIG, start=startPar, algorithm="brute-force") # nls2 enables to calculate AICc
		sigFit
	}
	# Fit the sigmoid model
	sigmoid.Model<-mySIGfun(delta=delta,time.model=time.model)


	## Compete models
	# Perform AIC tests
	AIC.test<-AIC(step.Model, linear.Model, asymptotic.Model, sigmoid.Model)
	AICc.test<-as.data.frame(cbind(AIC.test[,1], c(AICc(step.Model), AICc(linear.Model), AICc(asymptotic.Model), AICc(sigmoid.Model))))
	rownames(AICc.test)<-rownames(AIC.test)
	names(AICc.test)<-names(AIC.test)
	
	# Calculate AICc weight and selected the best model
	for(i in 1:dim(AICc.test)[1])
	{
		AICc.test$diff[i]<-AICc.test$AIC[i]-min(AICc.test$AIC)
	}
	AICc.test$RL<-exp(-0.5* AICc.test$diff)
	RL_sum<-sum(AICc.test$RL)
	AICc.test$aicWeights<-(AICc.test$RL/RL_sum)*100
	w<-AICc.test$aicWeights
	names(w)<-rownames(AICc.test)
	
	# Display raw AIC values
	print(AICc.test)

	# Display AICc weights
	# print(w)
	barplot(w, col="white", ylab="Relative likelihood (%)", cex.names = 0.9, names.arg =c("Step","Linear","Asymptotic","Sigmoid"))
	best.Model<-which(w==max(w))

	### STEP 4 - Derive inference based on the best model (i.e., with the higher AICc weight)
	if(best.Model==1) {writeLines(paste("\n\nSTEP MODEL SELECTED - Likelihood = ", round(w[1],1), "%\n\n", sep=""))
		print(summary(step.Model))}
	if(best.Model==2) {writeLines(paste("\n\nLINEAR MODEL SELECTED - Likelihood = ", round(w[2],1), "%\n\n", sep=""))
		print(summary(linear.Model))}
	if(best.Model==3) {writeLines(paste("\n\nASYMPTOTIC MODEL SELECTED - Likelihood = ", round(w[3],1), "%\n\n", sep=""))
		print(asymptotic.Model)}
	if(best.Model==4) {writeLines(paste("\n\nSIGMOID MODEL SELECTED - Likelihood = ", round(w[4],1), "%\n\n", sep=""))
		print(sigmoid.Model)}
	
	return(c(aicc.test.results = AICc.test, 
	         step.model.summary = summary(step.Model), 
	         linear.model.summary = summary(linear.Model), 
	         asy.model.summary = asymptotic.Model, 
	         sigmoid.model.summary = sigmoid.Model))
}

```

Function to add a column in the frond data frame for each site called `time.model` that has the timesteps labelled the way the function wants them.

```{r}
time.model.fxn <- function(site) {
  delta_fronds %>% 
    filter(site == {{ site }}) %>% 
    select(exp_dates, date, annual, continual, control) %>% 
    # rearrange the data frame so that the "after" dates come first
    mutate(exp_dates = fct_relevel(exp_dates, c("after", "start", "during"))) %>% 
    arrange(exp_dates) %>% 
    # assign everything a "time step number" using the row numbers...
    rownames_to_column("time.model") %>% 
    # only keep the time step numbers for the "after dates"
    # make everything else 0 (i.e. everything else is before the "after")
    mutate(time.model = case_when(
      exp_dates == "start" ~ 0,
      exp_dates == "during" ~ 0,
      TRUE ~ as.numeric(as.numeric(time.model))
    )) %>% 
    # rearrage the sampling dates to be in logical order
    mutate(exp_dates = fct_relevel(exp_dates, c("start", "during", "after"))) %>% 
    arrange(exp_dates) 
}

treatment_select <- function(df, treatment_selection) {
  df %>% 
    select(date, {{ treatment_selection }}, control, time.model) %>% 
    na.omit()
}
```

### Mohawk

```{r}
mohk_fronds <- time.model.fxn("mohk")

mohk_annual <- treatment_select(mohk_fronds, annual)

mohk_continual <- treatment_select(mohk_fronds, continual)

mohk_annual_bacips_results <- ProgressiveChangeBACIPS(
  control = pull(mohk_annual, control),
  impact = pull(mohk_annual, annual),
  time.true = pull(mohk_annual, date),
  time.model = pull(mohk_annual, time.model)
)

# LINEAR MODEL SELECTED - Likelihood = 79.5%

mohk_continual_bacips_results <- ProgressiveChangeBACIPS(
  control = pull(mohk_continual, control),
  impact = pull(mohk_continual, continual),
  time.true = pull(mohk_continual, date),
  time.model = pull(mohk_continual, time.model)
)

# LINEAR MODEL SELECTED - Likelihood = 65.6%

mohk_delta_kelp_timeseries_labs
```

### Arroyo Quemado

```{r}
aque_fronds <- time.model.fxn("aque")

aque_annual <- treatment_select(aque_fronds, annual)

aque_continual <- treatment_select(aque_fronds, continual)

aque_annual_bacips_results <- ProgressiveChangeBACIPS(
  control = pull(aque_annual, control),
  impact = pull(aque_annual, annual),
  time.true = pull(aque_annual, date),
  time.model = pull(aque_annual, time.model)
)

# LINEAR MODEL SELECTED - Likelihood = 62.9%

aque_continual_bacips_results <- ProgressiveChangeBACIPS(
  control = pull(aque_continual, control),
  impact = pull(aque_continual, continual),
  time.true = pull(aque_continual, date),
  time.model = pull(aque_continual, time.model)
)

# LINEAR MODEL SELECTED - Likelihood = 66.1%

aque_delta_kelp_timeseries_labs
```

### Isla Vista

```{r}
ivee_fronds <- time.model.fxn("ivee")

ivee_annual <- treatment_select(ivee_fronds, annual)
  
ivee_annual_bacips_results <- ProgressiveChangeBACIPS(
  control = pull(ivee_annual, control),
  impact = pull(ivee_annual, annual),
  time.true = pull(ivee_annual, date),
  time.model = pull(ivee_annual, time.model)
)

# LINEAR MODEL SELECTED - Likelihood = 52.4%

ivee_delta_kelp_timeseries_labs
```

### carpinteria

```{r}
carp_fronds <- time.model.fxn("carp")

carp_annual <- treatment_select(carp_fronds, annual)

carp_continual <- treatment_select(carp_fronds, continual)
  
carp_annual_bacips_results <- ProgressiveChangeBACIPS(
  control = pull(carp_annual, control),
  impact = pull(carp_annual, annual),
  time.true = pull(carp_annual, date),
  time.model = pull(carp_annual, time.model)
)

# STEP MODEL SELECTED - Likelihood = 85.1%

carp_continual_bacips_results <- ProgressiveChangeBACIPS(
  control = pull(carp_continual, control),
  impact = pull(carp_continual, continual),
  time.true = pull(carp_continual, date),
  time.model = pull(carp_continual, time.model)
)

# ASYMPTOTIC MODEL SELECTED - Likelihood = 99.5%

carp_delta_kelp_timeseries_labs
```

### naples

```{r}
napl_fronds <- time.model.fxn("napl")

napl_annual <- treatment_select(napl_fronds, annual)

napl_continual <- treatment_select(napl_fronds, continual)

napl_annual_bacips_results <- ProgressiveChangeBACIPS(
  control = pull(napl_annual, control),
  impact = pull(napl_annual, annual),
  time.true = pull(napl_annual, date),
  time.model = pull(napl_annual, time.model)
)

# STEP MODEL SELECTED - Likelihood = 74.1%

napl_continual_bacips_results <- ProgressiveChangeBACIPS(
  control = pull(napl_continual, control),
  impact = pull(napl_continual, continual),
  time.true = pull(napl_continual, date),
  time.model = pull(napl_continual, time.model)
)

# SIGMOID MODEL SELECTED - Likelihood = 71.6%

napl_delta_kelp_timeseries_labs
```

### All sites

#### test

Testing out code to get total fronds for each sampling date across sites starting with 2 sites: aque and napl. Each observation in the output should have a sampling year, total fronds in the annual, total fronds in the continual, and total fronds in the control.

```{r}
test_annual <- delta_fronds %>% 
  filter(site == "aque" | site == "napl") %>% 
  arrange(year, site) %>% 
  group_by(year, season) %>% 
  mutate(total_annual_all = sum(annual, na.rm = TRUE),
         total_continual_all = sum(continual, na.rm = TRUE),
         total_control_all = sum(control, na.rm = TRUE)) %>% 
  ungroup() %>% 
  select(year, month, exp_dates, total_annual_all:total_control_all) %>% 
  unique() %>% 
  mutate(delta_annual_all = total_annual_all - total_control_all,
         delta_continual_all = total_continual_all - total_control_all)

ggplot(test_annual, aes(x = year)) +
  geom_line(aes(y = delta_annual_all), col = annual_col) +
  geom_point(aes(y = delta_annual_all), col = annual_col, shape = annual_shape) +
  geom_line(aes(y = delta_continual_all), col = continual_col) +
  geom_point(aes(y = delta_continual_all), col = continual_col, shape = continual_shape) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  theme_classic() +
  labs(x = "Year", y = "delta kelp fronds (removal - control)")
```

## Biomass by season figure

x-axis: time from winter to fall  
y-axis: kelp biomass  
lines: colored by sampling date and year  

Going to try with aque first:
```{r}
aque_test <- total_biomass %>% 
  filter(site == "aque" & year %in% c(2014, 2015, 2016, 2017)) %>% 
  unite("color", treatment, year, sep = "_", remove = FALSE) %>% 
  # group_by(color) %>% 
  ggplot(aes(x = season, y = total_wm_gm2, group = color)) +
  geom_point(aes(color = color)) +
  geom_line(aes(color = color)) +
  # geom_text(aes(label = year)) +
  facet_wrap(~treatment)


aque_test
```

Ok great. Going to do the rest now:

```{r}
total_biomass %>% 
  filter(site == "aque") %>% 
  unite("color", treatment, year, sep = "_", remove = FALSE) %>% 
  mutate(season = fct_relevel(season, c("spring", "summer", "fall", "winter"))) %>% 
  ggplot(aes(x = season, y = total_wm_gm2, group = color)) +
  geom_point(aes(color = year)) +
  geom_line(aes(color = year)) +
  # theme(legend.position = "none") +
  # geom_text(aes(label = year)) +
  facet_wrap(~treatment, nrow = 5, ncol = 3) +
  labs(x = "Season", y = "Total biomass (wet g/m2)",
       title = aque_full)
```

## Fall biomass figure

x-axis: time  
y-axis: biomass  
only including fall sampling dates

```{r}
kelp_biomass_fall <- total_biomass %>% 
  filter(season == "fall") %>% 
  ggplot(aes(x = date, y = total_wm_gm2)) +
  geom_line(aes(color = treatment), size = 1) +
  geom_point(aes(color = treatment, shape = treatment), size = 3) +
  scale_color_manual(values = color_palette) +
  scale_shape_manual(values = shape_palette) +
  theme_bw() +
  facet_wrap(~site) +
  labs(x = "Sampling date", y = "Total biomass (wet mass/gm2)",
       title = "Fall biomass")

kelp_biomass_summer <- total_biomass %>% 
  filter(season == "summer") %>% 
  ggplot(aes(x = date, y = total_wm_gm2)) +
  geom_line(aes(color = treatment), size = 1) +
  geom_point(aes(color = treatment, shape = treatment), size = 3) +
  scale_color_manual(values = color_palette) +
  scale_shape_manual(values = shape_palette) +
  theme_bw() +
  facet_wrap(~site) +
    labs(x = "Sampling date", y = "Total biomass (wet mass/gm2)",
       title = "Summer biomass")

kelp_biomass_fall
kelp_biomass_summer
```






