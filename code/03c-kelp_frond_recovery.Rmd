---
title: "kelp frond recovery"
author: "An Bui"
date: "1/23/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 0. set up
```{r}
source(here::here("code", "00-set_up.R"))
```

# 1. Kelp biomass

## Data frame

`kelp_fronds` is created in the set up script - each row is a part of a transect with a unique `sample_ID`. Observations with `-99999` have also been filtered out.

## More wrangling

Data frames:  
- `delta_fronds`: calculates difference in frond density between control and removal plots (removal - control)  
- `control_fronds`: kelp fronds from control plots only  
- `total_fronds`: kelp fronds from treatment + control plots

```{r}
delta_fronds <- kelp_fronds %>% 
  group_by(site, year, month, season, treatment, date) %>% 
  summarize(total_fronds = sum(fronds)) %>% 
  ungroup() %>% 
  # add new column with start/during/after because not preserved by group_by
  mutate(exp_dates = case_when(
    site == "NAPL" & date == napl_start_date ~ "start",
    site == "NAPL" & date > napl_after_date ~ "after",
    site == "MOHK" & date == mohk_start_date ~ "start",
    site == "MOHK" & date > mohk_after_date ~ "after",
    site == "AQUE" & date == aque_start_date ~ "start",
    site == "AQUE" & date > aque_after_date ~ "after",
    site == "CARP" & date == carp_start_date ~ "start",
    site == "CARP" & date > carp_after_date ~ "after",
    site == "IVEE" & date == ivee_start_date ~ "start",
    site == "IVEE" & date > ivee_after_date ~ "after",
    TRUE ~ "during"
  ),
  exp_dates = factor(exp_dates, levels = c("start", "during", "after"))) %>% 
  filter(total_fronds > -1) %>% 
  pivot_wider(names_from = treatment, values_from = total_fronds) %>% 
  mutate(delta_annual = ANNUAL - CONTROL,
         delta_continual = CONTINUAL - CONTROL) 

# just control
control_fronds <- kelp_fronds %>% 
  filter(treatment == "CONTROL") %>% 
  group_by(site, year, month, season, date) %>% 
  summarize(total_fronds = sum(fronds)) %>% 
  ungroup() %>% 
  # add new column with start/during/after
  mutate(exp_dates = case_when(
    site == "NAPL" & date == napl_start_date ~ "start",
    site == "NAPL" & date > napl_after_date ~ "after",
    site == "MOHK" & date == mohk_start_date ~ "start",
    site == "MOHK" & date > mohk_after_date ~ "after",
    site == "AQUE" & date == aque_start_date ~ "start",
    site == "AQUE" & date > aque_after_date ~ "after",
    site == "CARP" & date == carp_start_date ~ "start",
    site == "CARP" & date > carp_after_date ~ "after",
    site == "IVEE" & date == ivee_start_date ~ "start",
    site == "IVEE" & date > ivee_after_date ~ "after",
    TRUE ~ "during"
  ),
  exp_dates = factor(exp_dates, levels = c("start", "during", "after"))) %>% 
  filter(total_fronds > -1)

# total fronds
total_fronds <- kelp_fronds %>% 
  group_by(site, year, month, treatment, season, date) %>% 
  summarize(total_fronds = sum(fronds)) %>% 
  ungroup() %>% 
  # add new column with start/during/after
  mutate(exp_dates = case_when(
    site == "NAPL" & date == napl_start_date ~ "start",
    site == "NAPL" & date > napl_after_date ~ "after",
    site == "MOHK" & date == mohk_start_date ~ "start",
    site == "MOHK" & date > mohk_after_date ~ "after",
    site == "AQUE" & date == aque_start_date ~ "start",
    site == "AQUE" & date > aque_after_date ~ "after",
    site == "CARP" & date == carp_start_date ~ "start",
    site == "CARP" & date > carp_after_date ~ "after",
    site == "IVEE" & date == ivee_start_date ~ "start",
    site == "IVEE" & date > ivee_after_date ~ "after",
    TRUE ~ "during"
  ),
  exp_dates = factor(exp_dates, levels = c("start", "during", "after"))) %>% 
  filter(total_fronds > -1) 
```

## Plotting

### Before/after comparison

This creates plots where the mean kelp frond density is plotted for the "before" and "after" time points ("before" = during the experiment, and "after" = after the experiment ended). 

```{r}
comparison_frond_fxn <- function(site_choice) {
  total_fronds %>% 
    filter(site == site_choice) %>% 
    mutate(bef_aft = case_when(
      exp_dates == "start" ~ "before",
      exp_dates == "during" ~ "before",
      exp_dates == "after" ~ "after"
    )) %>%
    mutate(bef_aft = fct_relevel(bef_aft, "before", "after")) %>% 
    ggplot(aes(x = bef_aft, y = total_fronds, col = treatment, shape = treatment)) +
    stat_summary(aes(group = treatment), fun = mean, geom = "line", size = 1, alpha = 0.8) +
    stat_summary(fun = mean, geom = "point", size = 4) +
    
    stat_summary(fun.data = mean_se, geom = "errorbar", alpha = 0.8, width = 0.2) +
    scale_color_manual(values = c("ANNUAL" = annual_col, "CONTINUAL" = continual_col, "CONTROL" = "grey")) +
    scale_shape_manual(values = c("ANNUAL" = annual_shape, "CONTINUAL" = continual_shape, "CONTROL" = control_shape)) +
    theme_bw() +
    theme(plot.title = element_text(size = 20)) +
    labs(x = " ",
         y = "Mean frond density",
         title = site_choice)
}

aque_comparison_frond <- comparison_frond_fxn("AQUE")
mohk_comparison_frond <- comparison_frond_fxn("MOHK")
carp_comparison_frond <- comparison_frond_fxn("CARP")
ivee_comparison_frond <- total_fronds %>% 
    filter(site == "IVEE") %>% 
    mutate(bef_aft = case_when(
      exp_dates == "start" ~ "before",
      exp_dates == "during" ~ "before",
      exp_dates == "after" ~ "after"
    )) %>%
    mutate(bef_aft = fct_relevel(bef_aft, "before", "after")) %>% 
    ggplot(aes(x = bef_aft, y = total_fronds, col = treatment, shape = treatment)) +
    stat_summary(aes(group = treatment), fun = mean, geom = "line", size = 1, alpha = 0.8) +
    stat_summary(fun = mean, geom = "point", size = 4) +
    
    stat_summary(fun.data = mean_se, geom = "errorbar", alpha = 0.8, width = 0.2) +
    scale_color_manual(values = c("ANNUAL" = annual_col, "CONTROL" = "grey")) +
    scale_shape_manual(values = c("ANNUAL" = annual_shape, "CONTROL" = control_shape)) +
    theme_bw() +
    theme(plot.title = element_text(size = 20)) +
    labs(x = " ",
         y = "Mean frond density",
         title = "IVEE")
napl_comparison_frond <- comparison_frond_fxn("NAPL")

aque_comparison_frond
mohk_comparison_frond
carp_comparison_frond
ivee_comparison_frond
napl_comparison_frond
```


### Total kelp frond timeseries

This creates a plot where kelp frond density timeseries are plotted for each LTE site with control in open circles, annual in green circles, and continual in blue triangles. There is a `ggsave()` command at the end - **remember to change the date in the file name before saving**.

```{r}
total_frond_timeseries_fxn <- function(site_choice) {
  after_date <- if(site_choice == "AQUE") {
    aque_after_date
  } else if(site_choice == "NAPL") {
    napl_after_date
  } else if(site_choice == "CARP") {
    carp_after_date
  } else if(site_choice == "IVEE") {
    ivee_after_date
  } else if(site_choice == "MOHK") {
    mohk_after_date
  }
  
  rect_ymax <- total_fronds %>% filter(site == site_choice) %>% pull(total_fronds) %>% max()
  
  ggplot(data = total_fronds %>% filter(site == site_choice),
         aes(x = date, y = total_fronds, color = treatment, shape = treatment)) +
    scale_x_date(limits = c(aque_start_date, as.Date("2022-02-02"))) +
    geom_hline(yintercept = 0, color = "grey") +
    annotate("rect", xmin = after_date, xmax = as.Date("2022-02-02"),
           ymin = -1, ymax = rect_ymax*1.05,
           alpha = 0.2) +
    geom_point(size = 3) +
    geom_line(size = 1) +
    scale_color_manual(values = c("CONTROL" = "grey", "ANNUAL" = annual_col, "CONTINUAL" = continual_col)) +
    scale_shape_manual(values = c("CONTROL" = control_shape, "ANNUAL" = annual_shape, "CONTINUAL" = continual_shape))  +
    theme_bw() + 
    labs(title = site_choice,
         x = " ",
         y = " ")
}

aque_total_frond_timeseries <- total_frond_timeseries_fxn("AQUE")
mohk_total_frond_timeseries <- total_frond_timeseries_fxn("MOHK")
carp_total_frond_timeseries <- total_frond_timeseries_fxn("CARP")
ivee_total_frond_timeseries <- ggplot(data = total_fronds %>% filter(site == "IVEE"),
         aes(x = date, y = total_fronds, color = treatment, shape = treatment)) +
    scale_x_date(limits = c(aque_start_date, as.Date("2022-02-02"))) +
    geom_hline(yintercept = 0, color = "grey") +
    annotate("rect", xmin = ivee_after_date, xmax = as.Date("2022-02-02"),
           ymin = -1, ymax = (total_fronds %>% filter(site == "IVEE") %>% pull(total_fronds) %>% max())*1.05,
           alpha = 0.2) +
    geom_point(size = 3) +
    geom_line(size = 1) +
    scale_color_manual(values = c("CONTROL" = control_col, "ANNUAL" = annual_col)) +
    scale_shape_manual(values = c("CONTROL" = control_shape, "ANNUAL" = annual_shape))  +
    theme_bw() + 
    labs(title = "IVEE",
         x = " ",
         y = " ")
napl_total_frond_timeseries <- total_frond_timeseries_fxn("NAPL")

aque_total_frond_timeseries
mohk_total_frond_timeseries
ivee_total_frond_timeseries
napl_total_frond_timeseries
carp_total_frond_timeseries

# y-axis label for patchwork side eye emoji
yaxislabel <- ggplot(data.frame(l = "kelp frond density", x = 1, y = 1)) +
      geom_text(aes(x, y, label = l), angle = 90) + 
      theme_void() +
      coord_cartesian(clip = "off")

plots_together <- yaxislabel + (aque_total_frond_timeseries / mohk_total_frond_timeseries / napl_total_frond_timeseries / ivee_total_frond_timeseries / carp_total_frond_timeseries) +
  plot_layout(guides = "collect", widths = c(1, 25)) &
  theme(legend.position = "bottom")

plots_together

# ggsave(here::here("figures", "kelp_total_frond_ts-20211012.jpg"), plots_together, height = 9, width = 5, dpi = 200)
```

#### Total frond timeseries for report

```{r}
aque_total_frond_timeseries_labs <- aque_total_frond_timeseries + 
  labs(x = "Sampling date", y = "Total kelp fronds",
       title = "Total kelp fronds") +
  theme(legend.position = "none")
mohk_total_frond_timeseries_labs <- mohk_total_frond_timeseries + 
  labs(x = "Sampling date", y = "Total kelp fronds",
       title = "Total kelp fronds") +
  theme(legend.position = "none")
ivee_total_frond_timeseries_labs <- ivee_total_frond_timeseries + 
  labs(x = "Sampling date", y = "Total kelp fronds",
       title = "Total kelp fronds") +
  theme(legend.position = "none")
napl_total_frond_timeseries_labs <- napl_total_frond_timeseries + 
  labs(x = "Sampling date", y = "Total kelp fronds",
       title = "Total kelp fronds") +
  theme(legend.position = "none")
carp_total_frond_timeseries_labs <- carp_total_frond_timeseries + 
  labs(x = "Sampling date", y = "Total kelp fronds",
       title = "Total kelp fronds") +
  theme(legend.position = "none")
```

### Delta kelp frond timeseries

This creates a plot where delta kelp frond density (difference between control and removal density) timeseries are plotted for each LTE site with annual in green circles and continual in blue circles. This was supposed to be a recreation of the plots that Adrian sent a long time ago. There is a `ggsave()` command at the end - **remember to change the date in the file name before saving**.

```{r}
delta_frond_timeseries_fxn <- function(site_choice) {
  after_date <- if(site_choice == "AQUE") {
    aque_after_date
  } else if(site_choice == "NAPL") {
    napl_after_date
  } else if(site_choice == "CARP") {
    carp_after_date
  } else if(site_choice == "IVEE") {
    ivee_after_date
  } else if(site_choice == "MOHK") {
    mohk_after_date
  }
  
  delta_continual_max <- delta_fronds %>% filter(site == site_choice) %>% pull(delta_continual) %>% max(na.rm = TRUE)
  delta_continual_min <- delta_fronds %>% filter(site == site_choice) %>% pull(delta_continual) %>% min(na.rm = TRUE)
  delta_annual_max <- delta_fronds %>% filter(site == site_choice) %>% pull(delta_annual) %>% max(na.rm = TRUE)  
  delta_annual_min <- delta_fronds %>% filter(site == site_choice) %>% pull(delta_annual) %>% min(na.rm = TRUE)
  
  rect_ymax <- ifelse(delta_continual_max > delta_annual_max, delta_continual_max, delta_annual_max)
  rect_ymin <- ifelse(delta_continual_min < delta_annual_max, delta_continual_min, delta_annual_max)
  
  ggplot() +
    scale_x_date(limits = c(aque_start_date, as.Date("2022-02-02"))) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
    annotate("rect", xmin = after_date, xmax = as.Date("2022-02-02"),
             ymin = rect_ymin*1.1, ymax = rect_ymax*1.1,
             alpha = 0.2) +
    annotate("text", x = as.Date("2009-04-01"), y = rect_ymax*1.1, label = "removal > control", size = 3) +
  annotate("text", x = as.Date("2009-04-01"), y = rect_ymin*1.1, label = "control > removal", size = 3) +
    geom_point(data = delta_fronds %>% filter(site == site_choice & delta_annual != "NA"), 
               aes(x = date, y = delta_annual, color = "Annual"), 
               size = 3, shape = annual_shape) +
    geom_line(data = delta_fronds %>% filter(site == site_choice & delta_annual != "NA"),
              aes(x = date, y = delta_annual, color = "Annual"), size = 1) +
    geom_point(data = delta_fronds %>% filter(site == site_choice & delta_continual != "NA"), 
               aes(x = date, y = delta_continual, color = "Continual"), 
               size = 3, shape = continual_shape) +
    geom_line(data = delta_fronds %>% filter(site == site_choice & delta_continual != "NA"),
              aes(x = date, y = delta_continual, color = "Continual"), size = 1) +
    scale_color_manual(name = NULL,
                       breaks = c("Annual", "Continual"),
                       values = c("Annual" = annual_col, "Continual" = continual_col)) +
    theme_bw() + 
    labs(title = site_choice,
         x = " ",
         y = " ")
}

aque_delta_kelp_timeseries <- delta_frond_timeseries_fxn("AQUE")
mohk_delta_kelp_timeseries <- delta_frond_timeseries_fxn("MOHK")
carp_delta_kelp_timeseries <- delta_frond_timeseries_fxn("CARP")
ivee_delta_kelp_timeseries <- ggplot() +
  scale_x_date(limits = c(aque_start_date, as.Date("2022-02-02"))) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
      annotate("rect", xmin = ivee_after_date, xmax = as.Date("2022-02-02"),
             ymin = delta_fronds %>% filter(site == "IVEE") %>% pull(delta_annual) %>% min()*1.1, 
             ymax = delta_fronds %>% filter(site == "IVEE") %>% pull(delta_annual) %>% max()*1.1,
             alpha = 0.2) +
  annotate("text", x = as.Date("2009-04-01"), y = delta_fronds %>% filter(site == "IVEE") %>% pull(delta_annual) %>% max()*1.1, label = "removal > control", size = 3) +
  annotate("text", x = as.Date("2009-04-01"), y = delta_fronds %>% filter(site == "IVEE") %>% pull(delta_annual) %>% min()*1.1, label = "control > removal", size = 3) +
  geom_point(data = delta_fronds %>% filter(site == "IVEE" & delta_annual != "NA"), 
             aes(x = date, y = delta_annual), color = annual_col, size = 3) +
  geom_line(data = delta_fronds %>% filter(site == "IVEE" & delta_annual != "NA"),
            aes(x = date, y = delta_annual), color = annual_col, size = 1) +
  theme_bw() + 
  labs(title = "IVEE",
       x = "Sampling date",
       y = " ")
napl_delta_kelp_timeseries <- delta_frond_timeseries_fxn("NAPL")

aque_delta_kelp_timeseries
mohk_delta_kelp_timeseries
ivee_delta_kelp_timeseries
napl_delta_kelp_timeseries
carp_delta_kelp_timeseries

# y-axis label for patchwork side eye emoji
yaxislabel <- ggplot(data.frame(l = "kelp fronds (removal - control)", x = 1, y = 1)) +
      geom_text(aes(x, y, label = l), angle = 90) + 
      theme_void() +
      coord_cartesian(clip = "off")

plots_together <- yaxislabel + (aque_delta_kelp_timeseries / mohk_delta_kelp_timeseries / napl_delta_kelp_timeseries / ivee_delta_kelp_timeseries / carp_delta_kelp_timeseries) +
  plot_layout(guides = "collect", widths = c(1, 25)) &
  theme(legend.position = "bottom")

plots_together

# ggsave(here::here("figures", "kelp_frond_ts-20220201.jpg"), plots_together, height = 9, width = 5, dpi = 200)
```

#### Delta frond timeseries for report

```{r}
aque_delta_kelp_timeseries_labs <- aque_delta_kelp_timeseries +
  labs(x = "Sampling date", y = "\u0394 fronds \n (removal - control)",
       title = "\u0394 fronds (removal - control)")  +
  theme(legend.position = "none")
mohk_delta_kelp_timeseries_labs <- mohk_delta_kelp_timeseries +
  labs(x = "Sampling date", y = "\u0394 fronds \n (removal - control)",
       title = "\u0394 fronds (removal - control)")  +
  theme(legend.position = "none")
ivee_delta_kelp_timeseries_labs <- ivee_delta_kelp_timeseries +
  labs(x = "Sampling date", y = "\u0394 fronds \n (removal - control)",
       title = "\u0394 fronds (removal - control)")  +
  theme(legend.position = "none")
napl_delta_kelp_timeseries_labs <- napl_delta_kelp_timeseries +
  labs(x = "Sampling date", y = "\u0394 fronds \n (removal - control)",
       title = "\u0394 fronds (removal - control)")  +
  theme(legend.position = "none")
carp_delta_kelp_timeseries_labs <- carp_delta_kelp_timeseries +
  labs(x = "Sampling date", y = "\u0394 fronds \n (removal - control)",
       title = "\u0394 fronds (removal - control)") +
  theme(legend.position = "none")
```

### 2022-02-04 report figures

```{r}
aque_panels <- (aque_comparison_frond / aque_total_frond_timeseries_labs / aque_delta_kelp_timeseries_labs) +
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = "A") &
  theme(plot.tag = element_text(size = 16))

napl_panels <- (napl_comparison_frond / napl_total_frond_timeseries_labs / napl_delta_kelp_timeseries_labs) +
  plot_layout(guides = "collect") 

ivee_panels <- (ivee_comparison_frond / ivee_total_frond_timeseries_labs / ivee_delta_kelp_timeseries_labs) +
  plot_layout(guides = "collect") 

carp_panels <- (carp_comparison_frond / carp_total_frond_timeseries_labs / carp_delta_kelp_timeseries_labs) +
  plot_layout(guides = "collect") 

mohk_panels <- (mohk_comparison_frond / mohk_total_frond_timeseries_labs / mohk_delta_kelp_timeseries_labs) +
  plot_layout(guides = "collect") 

# ggsave(here::here("figures", "panels_aque_2022-02-03.jpg"), aque_panels, height = 10, width = 9, dpi = 300)
# 
# ggsave(here::here("figures", "panels_napl_2022-02-03.jpg"), napl_panels, height = 10, width = 9, dpi = 300)
# 
# ggsave(here::here("figures", "panels_ivee_2022-02-03.jpg"), ivee_panels, height = 10, width = 9, dpi = 300)
# 
# ggsave(here::here("figures", "panels_carp_2022-02-03.jpg"), carp_panels, height = 10, width = 9, dpi = 300)
# 
# ggsave(here::here("figures", "panels_mohk_2022-02-03.jpg"), mohk_panels, height = 10, width = 9, dpi = 300)
```


## Model selection for delta frond density

Using function from the Thiault script below. Made edits to not print out results in the quartz viewer.

```{r}
ProgressiveChangeBACIPS<-function(control, impact, time.true, time.model) 
{
	### STEP 2 - Calculate the delta at each sampling date
	delta <- impact - control
	
	# Plot delta against time.true
	# dev.new(width=10, height=5)
	# par(mfrow=c(1,2))
	plot(delta~time.true, type="n")
	time.model.of.impact=max(which(time.model==0))
	rect(time.model.of.impact, min(delta)-100, max(time.model)+10, max(delta)+100, col = "grey")
	points(delta~time.true, pch=24, bg="white", cex=2)
	
	### STEP 3 - Fit and compete models
	## Create a 'period' variable
	period <- ifelse(time.model==0, "Before","After")
	
	## Fit a step model
	step.Model<-aov(delta ~ period)

	## Fit a linear model
	linear.Model<-lm(delta ~ time.model)
	
	## Fit an asymptotic model
	# Create an asymptotic function
	myASYfun<-function(delta, time.model)
	{
		funAsy<-function(parS, time.model)	(parS$M * time.model) / (parS$L + time.model) + parS$B
		residFun<-function(p, observed, time.model) observed + funAsy(p,time.model)
		parStart <- list(M=mean(delta[time.model.of.impact:length(time.true)]), B=mean(delta[1:time.model.of.impact]), L=1)
		nls_ASY_out <- nls.lm(par=parStart, fn= residFun, observed=delta, time.model=time.model, control = nls.lm.control(maxfev = integer(), maxiter = 1000))
		foAsy<-delta~(M * time.model) / (L + time.model) + B
		startPar<-c(-coef(nls_ASY_out)[1], coef(nls_ASY_out)[2], coef(nls_ASY_out)[3])
		asyFit<-nls2(foAsy, start=startPar, algorithm="brute-force") # nls2 enables to calculate AICc
		asyFit
	}
	# Fit the asymptotic model
	asymptotic.Model<-myASYfun(delta=delta,time.model=time.model)
	
	
	## Fit a sigmoid model
	## Create a sigmoid function
	mySIGfun<-function(delta, time.model)
	{
		funSIG<-function(parS, time.model)	(parS$M * (time.model/parS$L)^parS$K) / (1 + (time.model/parS$L) ^ parS$K) + parS$B
		residFun<-function(p, observed, time.model) observed + funSIG(p,time.model)
		parStart <- list(M=mean(delta[time.model.of.impact:length(time.true)]), B=mean(delta[1:time.model.of.impact]), L=mean(time.model), K=5)
		nls_SIG_out <- nls.lm(par=parStart, fn= residFun, observed=delta, time.model=time.model, control = nls.lm.control(maxfev = integer(), maxiter = 1000))
		foSIG<-delta~(M * (time.model/L) ^ K) / (1 + (time.model/L) ^ K) + B
		startPar<-c(-coef(nls_SIG_out)[1],-coef(nls_SIG_out)[2],coef(nls_SIG_out)[3],coef(nls_SIG_out)[4])
		sigFit<-nls2(foSIG, start=startPar, algorithm="brute-force") # nls2 enables to calculate AICc
		sigFit
	}
	# Fit the sigmoid model
	sigmoid.Model<-mySIGfun(delta=delta,time.model=time.model)


	## Compete models
	# Perform AIC tests
	AIC.test<-AIC(step.Model, linear.Model, asymptotic.Model, sigmoid.Model)
	AICc.test<-as.data.frame(cbind(AIC.test[,1], c(AICc(step.Model), AICc(linear.Model), AICc(asymptotic.Model), AICc(sigmoid.Model))))
	rownames(AICc.test)<-rownames(AIC.test)
	names(AICc.test)<-names(AIC.test)
	
	# Calculate AICc weight and selected the best model
	for(i in 1:dim(AICc.test)[1])
	{
		AICc.test$diff[i]<-AICc.test$AIC[i]-min(AICc.test$AIC)
	}
	AICc.test$RL<-exp(-0.5* AICc.test$diff)
	RL_sum<-sum(AICc.test$RL)
	AICc.test$aicWeights<-(AICc.test$RL/RL_sum)*100
	w<-AICc.test$aicWeights
	names(w)<-rownames(AICc.test)
	
	# Display raw AIC values
	print(AICc.test)

	# Display AICc weights
	# print(w)
	barplot(w, col="white", ylab="Relative likelihood (%)", cex.names = 0.9, names.arg =c("Step","Linear","Asymptotic","Sigmoid"))
	best.Model<-which(w==max(w))

	### STEP 4 - Derive inference based on the best model (i.e., with the higher AICc weight)
	if(best.Model==1) {writeLines(paste("\n\nSTEP MODEL SELECTED - Likelihood = ", round(w[1],1), "%\n\n", sep=""))
		print(summary(step.Model))}
	if(best.Model==2) {writeLines(paste("\n\nLINEAR MODEL SELECTED - Likelihood = ", round(w[2],1), "%\n\n", sep=""))
		print(summary(linear.Model))}
	if(best.Model==3) {writeLines(paste("\n\nASYMPTOTIC MODEL SELECTED - Likelihood = ", round(w[3],1), "%\n\n", sep=""))
		print(asymptotic.Model)}
	if(best.Model==4) {writeLines(paste("\n\nSIGMOID MODEL SELECTED - Likelihood = ", round(w[4],1), "%\n\n", sep=""))
		print(sigmoid.Model)}
	
	return(c(aicc.test.results = AICc.test, 
	         step.model.summary = summary(step.Model), 
	         linear.model.summary = summary(linear.Model), 
	         asy.model.summary = asymptotic.Model, 
	         sigmoid.model.summary = sigmoid.Model))
}

```

Function to add a column in the frond data frame for each site called `time.model` that has the timesteps labelled the way the function wants them.

```{r}
time.model.fxn <- function(site) {
  delta_fronds %>% 
    filter(site == {{ site }}) %>% 
    select(exp_dates, date, ANNUAL, CONTINUAL, CONTROL) %>% 
    # rearrange the data frame so that the "after" dates come first
    mutate(exp_dates = fct_relevel(exp_dates, c("after", "start", "during"))) %>% 
    arrange(exp_dates) %>% 
    # assign everything a "time step number" using the row numbers...
    rownames_to_column("time.model") %>% 
    # only keep the time step numbers for the "after dates"
    # make everything else 0 (i.e. everything else is before the "after")
    mutate(time.model = case_when(
      exp_dates == "start" ~ 0,
      exp_dates == "during" ~ 0,
      TRUE ~ as.numeric(as.numeric(time.model))
    )) %>% 
    # rearrage the sampling dates to be in logical order
    mutate(exp_dates = fct_relevel(exp_dates, c("start", "during", "after"))) %>% 
    arrange(exp_dates) 
}

treatment_select <- function(df, treatment_selection) {
  df %>% 
    select(date, {{ treatment_selection }}, CONTROL, time.model) %>% 
    na.omit()
}
```

### Mohawk

```{r}
mohk_fronds <- time.model.fxn("MOHK")

mohk_annual <- treatment_select(mohk_fronds, ANNUAL)

mohk_continual <- treatment_select(mohk_fronds, CONTINUAL)

mohk_annual_bacips_results <- ProgressiveChangeBACIPS(control = pull(mohk_annual, CONTROL),
                        impact = pull(mohk_annual, ANNUAL),
                        time.true = pull(mohk_annual, date),
                        time.model = pull(mohk_annual, time.model))

# LINEAR MODEL SELECTED - Likelihood = 79.5%

mohk_continual_bacips_results <- ProgressiveChangeBACIPS(control = pull(mohk_continual, CONTROL),
                        impact = pull(mohk_continual, CONTINUAL),
                        time.true = pull(mohk_continual, date),
                        time.model = pull(mohk_continual, time.model))

# LINEAR MODEL SELECTED - Likelihood = 65.6%

mohk_delta_kelp_timeseries_labs
```

### Arroyo Quemado

```{r}
aque_fronds <- time.model.fxn("AQUE")

aque_annual <- treatment_select(aque_fronds, ANNUAL)

aque_continual <- treatment_select(aque_fronds, CONTINUAL)

aque_annual_bacips_results <- ProgressiveChangeBACIPS(control = pull(aque_annual, CONTROL),
                        impact = pull(aque_annual, ANNUAL),
                        time.true = pull(aque_annual, date),
                        time.model = pull(aque_annual, time.model))

# LINEAR MODEL SELECTED - Likelihood = 62.9%

aque_continual_bacips_results <- ProgressiveChangeBACIPS(control = pull(aque_continual, CONTROL),
                        impact = pull(aque_continual, CONTINUAL),
                        time.true = pull(aque_continual, date),
                        time.model = pull(aque_continual, time.model))

# LINEAR MODEL SELECTED - Likelihood = 66.1%

aque_delta_kelp_timeseries_labs
```

### Isla Vista

```{r}
ivee_fronds <- time.model.fxn("IVEE")

ivee_annual <- treatment_select(ivee_fronds, ANNUAL)
  
ivee_annual_bacips_results <- ProgressiveChangeBACIPS(control = pull(ivee_annual, CONTROL),
                        impact = pull(ivee_annual, ANNUAL),
                        time.true = pull(ivee_annual, date),
                        time.model = pull(ivee_annual, time.model))

# LINEAR MODEL SELECTED - Likelihood = 52.4%

ivee_delta_kelp_timeseries_labs
```

### Carpinteria

```{r}
carp_fronds <- time.model.fxn("CARP")

carp_annual <- treatment_select(carp_fronds, ANNUAL)

carp_continual <- treatment_select(carp_fronds, CONTINUAL)
  
carp_annual_bacips_results <- ProgressiveChangeBACIPS(control = pull(carp_annual, CONTROL),
                        impact = pull(carp_annual, ANNUAL),
                        time.true = pull(carp_annual, date),
                        time.model = pull(carp_annual, time.model))

# STEP MODEL SELECTED - Likelihood = 85.1%

carp_continual_bacips_results <- ProgressiveChangeBACIPS(control = pull(carp_continual, CONTROL),
                        impact = pull(carp_continual, CONTINUAL),
                        time.true = pull(carp_continual, date),
                        time.model = pull(carp_continual, time.model))

# ASYMPTOTIC MODEL SELECTED - Likelihood = 99.5%

carp_delta_kelp_timeseries_labs
```

### Naples

```{r}
napl_fronds <- time.model.fxn("NAPL")

napl_annual <- treatment_select(napl_fronds, ANNUAL)

napl_continual <- treatment_select(napl_fronds, CONTINUAL)
  
napl_annual_bacips_results <- ProgressiveChangeBACIPS(control = pull(napl_annual, CONTROL),
                        impact = pull(napl_annual, ANNUAL),
                        time.true = pull(napl_annual, date),
                        time.model = pull(napl_annual, time.model))

# STEP MODEL SELECTED - Likelihood = 74.1%

napl_continual_bacips_results <- ProgressiveChangeBACIPS(control = pull(napl_continual, CONTROL),
                        impact = pull(napl_continual, CONTINUAL),
                        time.true = pull(napl_continual, date),
                        time.model = pull(napl_continual, time.model))

# SIGMOID MODEL SELECTED - Likelihood = 71.6%

napl_delta_kelp_timeseries_labs
```

### All sites

#### test

Testing out code to get total fronds for each sampling date across sites starting with 2 sites: AQUE and NAPL. Each observation in the output should have a sampling year, total fronds in the annual, total fronds in the continual, and total fronds in the control.

```{r}
test_annual <- delta_fronds %>% 
  filter(site == "AQUE" | site == "NAPL") %>% 
  arrange(year, site) %>% 
  group_by(year, season) %>% 
  mutate(total_annual_all = sum(ANNUAL, na.rm = TRUE),
         total_continual_all = sum(CONTINUAL, na.rm = TRUE),
         total_control_all = sum(CONTROL, na.rm = TRUE)) %>% 
  ungroup() %>% 
  select(year, month, exp_dates, total_annual_all:total_control_all) %>% 
  unique() %>% 
  mutate(delta_annual_all = total_annual_all - total_control_all,
         delta_continual_all = total_continual_all - total_control_all)

ggplot(test_annual, aes(x = year)) +
  geom_line(aes(y = delta_annual_all), col = annual_col) +
  geom_point(aes(y = delta_annual_all), col = annual_col, shape = annual_shape) +
  geom_line(aes(y = delta_continual_all), col = continual_col) +
  geom_point(aes(y = delta_continual_all), col = continual_col, shape = continual_shape) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  theme_classic() +
  labs(x = "Year", y = "delta kelp fronds (removal - control)")
```



