---
title: "exam figures"
author: "An Bui"
date: "5/28/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
source(here::here("code", "00-set_up.R"))

library(patchwork)
```

# 1. Kelp biomass

## Cleaning
```{r}
kelp_fronds <- read_csv(here::here("data", "LTE_Kelp_All_Years_20200605.csv")) %>% 
  clean_names() %>% 
  # create a sample_ID for each sampling date at each treatment at each site
  unite("sample_ID", site, treatment, date, remove = FALSE) %>% 
  # change to lower case
  mutate_at(c("group", "mobility", "growth_morph"), str_to_lower) %>% 
  # make a new column designating "start", "during" and "after" removal
  mutate(exp_dates = case_when(
    site == "NAPL" & sample_ID %in% napl_start_dates ~ "start",
    site == "NAPL" & date > napl_after_date ~ "after",
    site == "MOHK" & sample_ID %in% mohk_start_dates ~ "start",
    site == "MOHK" & date > mohk_after_date ~ "after",
    site == "AQUE" & sample_ID %in% aque_start_dates ~ "start",
    site == "AQUE" & date > aque_after_date ~ "after",
    site == "CARP" & sample_ID %in% carp_start_dates ~ "start",
    site == "CARP" & date > carp_after_date ~ "after",
    site == "IVEE" & sample_ID %in% ivee_start_dates ~ "start",
    site == "IVEE" & date > ivee_after_date ~ "after",
    TRUE ~ "during"
  ),
  exp_dates = factor(exp_dates, levels = c("start", "during", "after"))) %>% 
  select(1:14)

# get difference in fronds between control and removal plots
delta_fronds <- kelp_fronds %>% 
  group_by(site, year, month, treatment, date) %>% 
  summarize(total_fronds = sum(fronds)) %>% 
  ungroup() %>% 
  # add new column with start/during/after
  mutate(exp_dates = case_when(
    site == "NAPL" & date == napl_start_date ~ "start",
    site == "NAPL" & date > napl_after_date ~ "after",
    site == "MOHK" & date == mohk_start_date ~ "start",
    site == "MOHK" & date > mohk_after_date ~ "after",
    site == "AQUE" & date == aque_start_date ~ "start",
    site == "AQUE" & date > aque_after_date ~ "after",
    site == "CARP" & date == carp_start_date ~ "start",
    site == "CARP" & date > carp_after_date ~ "after",
    site == "IVEE" & date == ivee_start_date ~ "start",
    site == "IVEE" & date > ivee_after_date ~ "after",
    TRUE ~ "during"
  ),
  exp_dates = factor(exp_dates, levels = c("start", "during", "after"))) %>% 
  filter(total_fronds > 0) %>% 
  pivot_wider(names_from = treatment, values_from = total_fronds) %>% 
  mutate(delta_annual = CONTROL - ANNUAL,
         delta_continual = CONTROL - CONTINUAL) 

# just control
control_fronds <- kelp_fronds %>% 
  filter(treatment == "CONTROL") %>% 
  group_by(site, year, month, date) %>% 
  summarize(total_fronds = sum(fronds)) %>% 
  ungroup() %>% 
  # add new column with start/during/after
  mutate(exp_dates = case_when(
    site == "NAPL" & date == napl_start_date ~ "start",
    site == "NAPL" & date > napl_after_date ~ "after",
    site == "MOHK" & date == mohk_start_date ~ "start",
    site == "MOHK" & date > mohk_after_date ~ "after",
    site == "AQUE" & date == aque_start_date ~ "start",
    site == "AQUE" & date > aque_after_date ~ "after",
    site == "CARP" & date == carp_start_date ~ "start",
    site == "CARP" & date > carp_after_date ~ "after",
    site == "IVEE" & date == ivee_start_date ~ "start",
    site == "IVEE" & date > ivee_after_date ~ "after",
    TRUE ~ "during"
  ),
  exp_dates = factor(exp_dates, levels = c("start", "during", "after"))) %>% 
  filter(total_fronds > 0)
```

## Testing plots
```{r}
ggplot() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  geom_point(data = delta_fronds %>% filter(site == "AQUE" & delta_AC != "NA"), 
             aes(x = date, y = delta_AC, color = "Annual")) +
  geom_line(data = delta_fronds %>% filter(site == "AQUE" & delta_AC != "NA"),
            aes(x = date, y = delta_AC, color = "Annual")) +
  geom_point(data = delta_fronds %>% filter(site == "AQUE" & delta_CC != "NA"), 
             aes(x = date, y = delta_CC, color = "Continual")) +
  geom_line(data = delta_fronds %>% filter(site == "AQUE" & delta_CC != "NA"),
            aes(x = date, y = delta_CC, color = "Continual")) +
  geom_vline(xintercept = aque_after_date, aes(color = "End"), show.legend = NA) +
  scale_color_manual(name = NULL,
                     breaks = c("Annual", "Continual", "End"),
                     values = c("Annual" = "green", "Continual" = "blue", "End" = "red")) +
  theme_bw() + 
  labs(title = "AQUE kelp biomass", 
       x = "Sampling date",
       y = expression(Delta~"kelp fronds"~"(removal - control)"))
```

## Plotting timeseries
```{r}
kelp_timeseries_fxn <- function(site_choice) {
  after_date <- if(site_choice == "AQUE") {
    aque_after_date
  } else if(site_choice == "NAPL") {
    napl_after_date
  } else if(site_choice == "CARP") {
    carp_after_date
  } else if(site_choice == "IVEE") {
    ivee_after_date
  } else if(site_choice == "MOHK") {
    mohk_after_date
  }
  
  ggplot() +
    scale_x_date(limits = c(aque_start_date, as.Date("2020-06-01"))) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
    geom_point(data = delta_fronds %>% filter(site == site_choice & delta_annual != "NA"), 
               aes(x = date, y = delta_annual, color = "Annual")) +
    geom_line(data = delta_fronds %>% filter(site == site_choice & delta_annual != "NA"),
              aes(x = date, y = delta_annual, color = "Annual")) +
    geom_point(data = delta_fronds %>% filter(site == site_choice & delta_continual != "NA"), 
               aes(x = date, y = delta_continual, color = "Continual")) +
    geom_line(data = delta_fronds %>% filter(site == site_choice & delta_continual != "NA"),
              aes(x = date, y = delta_continual, color = "Continual")) +
    geom_vline(xintercept = after_date, show.legend = NA) +
    scale_color_manual(name = NULL,
                       breaks = c("Annual", "Continual"),
                       values = c("Annual" = "green", "Continual" = "blue")) +
    theme_bw() + 
    labs(title = site_choice,
         x = " ",
         y = " ")
}

aque_kelp_timeseries <- kelp_timeseries_fxn("AQUE")
mohk_kelp_timeseries <- kelp_timeseries_fxn("MOHK")
ivee_kelp_timeseries <- ggplot() +
  scale_x_date(limits = c(aque_start_date, as.Date("2020-06-01"))) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  geom_point(data = delta_fronds %>% filter(site == "IVEE" & delta_annual != "NA"), 
             aes(x = date, y = delta_annual), color = "green") +
  geom_line(data = delta_fronds %>% filter(site == "IVEE" & delta_annual != "NA"),
            aes(x = date, y = delta_annual), color = "green") +
  geom_vline(xintercept = ivee_after_date, show.legend = NA) +
  theme_bw() + 
  labs(title = "IVEE",
       x = "Sampling date",
       y = " ")
napl_kelp_timeseries <- kelp_timeseries_fxn("NAPL")

aque_kelp_timeseries
mohk_kelp_timeseries
ivee_kelp_timeseries
napl_kelp_timeseries

# y-axis label for patchwork side eye emoji
yaxislabel <- ggplot(data.frame(l = "kelp fronds (control - removal)", x = 1, y = 1)) +
      geom_text(aes(x, y, label = l), angle = 90) + 
      theme_void() +
      coord_cartesian(clip = "off")

plots_together <- yaxislabel + (aque_kelp_timeseries / mohk_kelp_timeseries / napl_kelp_timeseries / ivee_kelp_timeseries) +
  plot_layout(guides = "collect", widths = c(1, 25)) &
  theme(legend.position = "bottom")

plots_together

# ggsave(here::here("figures", "kelp_frond_ts.jpg"), plots_together, height = 9, width = 5, dpi = 200)
```

## Plotting control only
```{r}
control_fronds_plot <- ggplot(control_fronds, aes(x = date, y = total_fronds)) +
  geom_line(aes(color = site), alpha = 0.8) +
  geom_point(aes(fill = site, shape = site), size = 3) +
  scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  scale_color_manual(values = c(AQUE_col, CARP_col, IVEE_col, MOHK_col, NAPL_col)) +
  scale_fill_manual(values = c(AQUE_col, CARP_col, IVEE_col, MOHK_col, NAPL_col)) +
  theme_bw() +
  labs(x = "Sampling date",
       y = "Total fronds",
       title = "Kelp fronds") 

control_fronds_plot
```


# 2. Urchin biomass
```{r}
urchin_density <- read_csv(here::here("data", "LTE_Quad_Swath_All_Years_20200605.csv")) %>% 
  clean_names() %>% 
  # create a sample_ID for each sampling date at each treatment at each site
  unite("sample_ID", site, treatment, date, remove = FALSE) %>% 
  # change to lower case
  mutate_at(c("group", "mobility", "growth_morph"), str_to_lower) %>% 
  # make a new column designating "start", "during" and "after" removal
  mutate(exp_dates = case_when(
    site == "NAPL" & sample_ID %in% napl_start_dates ~ "start",
    site == "NAPL" & date > napl_after_date ~ "after",
    site == "MOHK" & sample_ID %in% mohk_start_dates ~ "start",
    site == "MOHK" & date > mohk_after_date ~ "after",
    site == "AQUE" & sample_ID %in% aque_start_dates ~ "start",
    site == "AQUE" & date > aque_after_date ~ "after",
    site == "CARP" & sample_ID %in% carp_start_dates ~ "start",
    site == "CARP" & date > carp_after_date ~ "after",
    site == "IVEE" & sample_ID %in% ivee_start_dates ~ "start",
    site == "IVEE" & date > ivee_after_date ~ "after",
    TRUE ~ "during"
  ),
  exp_dates = factor(exp_dates, levels = c("start", "during", "after"))) %>% 
  select(1:14) %>% 
  filter(sp_code %in% c("SPL", "SPS", "SFL", "SFS") & treatment == "CONTROL")

urchin_summary <- urchin_density %>% 
  group_by(sample_ID, site, date, scientific_name, sp_code) %>% 
  summarize(total_urchins = sum(count)) %>% 
  filter(total_urchins > 0) 

control_urchins_plot <- ggplot(urchin_summary %>% filter(sp_code == "SPL"), aes(x = date, y = total_urchins)) + 
  geom_line(aes(color = site), alpha = 0.8) +
  geom_point(aes(fill = site, shape = site), size = 3) +
  scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  scale_color_manual(values = c(AQUE_col, CARP_col, IVEE_col, MOHK_col, NAPL_col)) +
  scale_fill_manual(values = c(AQUE_col, CARP_col, IVEE_col, MOHK_col, NAPL_col)) +
  theme_bw() +
  labs(title = "Purple urchin density",
       x = "Sampling date",
       y = "Urchin count per transect") +
  theme(legend.position = "none")
```

# 3. Detrital biomass
```{r}
detritus <- read_csv(here::here("data", "LTE_Detritus_Biomass_All_Years_20200605.csv")) %>% 
  clean_names() %>% 
  # create a sample_ID for each sampling date at each treatment at each site
  unite("sample_ID", site, treatment, date, remove = FALSE) %>% 
  # change to lower case
  mutate_at(c("group", "mobility", "growth_morph"), str_to_lower) %>% 
  # make a new column designating "start", "during" and "after" removal
  mutate(exp_dates = case_when(
    site == "NAPL" & sample_ID %in% napl_start_dates ~ "start",
    site == "NAPL" & date > napl_after_date ~ "after",
    site == "MOHK" & sample_ID %in% mohk_start_dates ~ "start",
    site == "MOHK" & date > mohk_after_date ~ "after",
    site == "AQUE" & sample_ID %in% aque_start_dates ~ "start",
    site == "AQUE" & date > aque_after_date ~ "after",
    site == "CARP" & sample_ID %in% carp_start_dates ~ "start",
    site == "CARP" & date > carp_after_date ~ "after",
    site == "IVEE" & sample_ID %in% ivee_start_dates ~ "start",
    site == "IVEE" & date > ivee_after_date ~ "after",
    TRUE ~ "during"
  ),
  exp_dates = factor(exp_dates, levels = c("start", "during", "after"))) %>% 
  select(1:14) %>% 
  filter(treatment == "CONTROL")

detritus_summary <- detritus %>% 
  group_by(sample_ID, site, date, sp_code) %>% 
  summarize(total_detritus = sum(wet_wt)) %>% 
  filter(total_detritus > 0) 

control_detritus_plot <- ggplot(detritus_summary, aes(x = date, y = total_detritus)) + 
  geom_line(aes(color = site), alpha = 0.8) +
  geom_point(aes(fill = site, shape = site), size = 3) +
  scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  scale_color_manual(values = c(AQUE_col, CARP_col, IVEE_col, MOHK_col, NAPL_col)) +
  scale_fill_manual(values = c(AQUE_col, CARP_col, IVEE_col, MOHK_col, NAPL_col)) +
  theme_bw() +
  labs(title = "Detritus wet weight",
       x = "Sampling date",
       y = "Total detritus (g)") +
  theme(legend.position = "none")

control_detritus_plot

kelp_urchins_detritus <- (control_fronds_plot / control_urchins_plot / control_detritus_plot) +
  plot_layout(guides = "collect")

kelp_urchins_detritus
ggsave(here::here("figures", "kelp_urchins_detritus.jpg"), kelp_urchins_detritus, height = 10, width = 8, dpi = 200)
```


# 4. Understory algal biomass

```{r}
# get difference in fronds between control and removal plots
delta_algae <- biomass %>% 
  filter(group == "algae" & sp_code == "CYOS") %>% 
  # calculate total dry mass by each survey
  group_by(site, group_mobility, year, month, treatment, date) %>% 
  summarize(total_biomass = sum(dry_gm2)) %>% 
  ungroup() %>% 
  # add new column with start/during/after
  mutate(exp_dates = case_when(
    site == "NAPL" & date == napl_start_date ~ "start",
    site == "NAPL" & date > napl_after_date ~ "after",
    site == "MOHK" & date == mohk_start_date ~ "start",
    site == "MOHK" & date > mohk_after_date ~ "after",
    site == "AQUE" & date == aque_start_date ~ "start",
    site == "AQUE" & date > aque_after_date ~ "after",
    site == "CARP" & date == carp_start_date ~ "start",
    site == "CARP" & date > carp_after_date ~ "after",
    site == "IVEE" & date == ivee_start_date ~ "start",
    site == "IVEE" & date > ivee_after_date ~ "after",
    TRUE ~ "during"
  ),
  exp_dates = factor(exp_dates, levels = c("start", "during", "after"))) %>% 
  pivot_wider(names_from = treatment, values_from = total_biomass) %>% 
  mutate(delta_annual = CONTROL - ANNUAL,
         delta_continual = CONTROL - CONTINUAL) %>% 
  # create a sample_ID for each sampling date at each site
  unite("sample_ID", site, date, remove = FALSE) %>% 
  filter(exp_dates == "after")

algae_timeseries_fxn <- function(site_choice) {
  after_date <- if(site_choice == "AQUE") {
    aque_after_date
  } else if(site_choice == "NAPL") {
    napl_after_date
  } else if(site_choice == "CARP") {
    carp_after_date
  } else if(site_choice == "IVEE") {
    ivee_after_date
  } else if(site_choice == "MOHK") {
    mohk_after_date
  }
  
  ggplot() +
    scale_x_date(limits = c(after_date, as.Date("2020-06-01"))) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
    # annual
    geom_point(data = delta_algae %>% filter(site == site_choice & delta_annual != "NA"), 
               aes(x = date, y = delta_annual, 
                   color = "Annual removal", shape = "Annual removal"), size = 3) +
    geom_line(data = delta_algae %>% filter(site == site_choice & delta_annual != "NA"),
              aes(x = date, y = delta_annual, color = "Annual removal")) +
    # continual
    geom_point(data = delta_algae %>% filter(site == site_choice & delta_continual != "NA"), 
               aes(x = date, y = delta_continual, 
                   color = "Continual removal", shape = "Continual removal"), size = 3) +
    geom_line(data = delta_algae %>% filter(site == site_choice & delta_continual != "NA"),
              aes(x = date, y = delta_continual, color = "Continual removal")) +
    geom_vline(xintercept = after_date, show.legend = NA) +
    scale_color_manual(name = NULL,
                       breaks = c("Annual removal", "Continual removal"),
                       values = c("Annual removal" = annual_col, "Continual removal" = continual_col)) +
    scale_shape_manual(name = NULL,
                       breaks = c("Annual removal", "Continual removal"),
                       values = c("Annual removal" = 19, "Continual removal" = 17)) +
    theme_bw() + 
    labs(title = site_choice,
         x = " ",
         y = " ")
}

aque_algae_timeseries <- algae_timeseries_fxn("AQUE")
mohk_algae_timeseries <- algae_timeseries_fxn("MOHK")
ivee_algae_timeseries <- ggplot(delta_algae %>% filter(site == "IVEE" & delta_annual != "NA"), aes(x = date, y = delta_annual)) +
  scale_x_date(limits = c(ivee_after_date, as.Date("2020-06-01"))) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  geom_point(shape = annual_shape, size = 3, color = annual_col) +
  geom_line(color = annual_col) +
  geom_vline(xintercept = ivee_after_date, show.legend = NA) +
  theme_bw() + 
  labs(title = "IVEE",
       x = "Sampling date",
       y = " ")
napl_algae_timeseries <- algae_timeseries_fxn("NAPL")
carp_algae_timeseries <- algae_timeseries_fxn("CARP")

# y-axis label for patchwork side eye emoji
yaxislabel <- ggplot(data.frame(l = "algal biomass (control - removal)", x = 1, y = 1)) +
      geom_text(aes(x, y, label = l), angle = 90) + 
      theme_void() +
      coord_cartesian(clip = "off")

plots_together <- yaxislabel + (aque_algae_timeseries / mohk_algae_timeseries / napl_algae_timeseries / carp_algae_timeseries / ivee_algae_timeseries) +
  plot_layout(guides = "collect", widths = c(1, 25)) &
  theme(legend.position = "bottom")

plots_together

ggsave(here::here("figures", "algae_biomass_ts-CYOS-after.jpg"), plots_together, height = 9, width = 8, dpi = 200)

delta_annual_timeseries <- ggplot(delta_algae %>% filter(delta_annual != "NA"), 
                                  aes(x = date, y = delta_annual)) +
  scale_x_date(limits = c(ivee_after_date, as.Date("2020-06-01"))) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  
  geom_point(shape = annual_shape, size = 2) +
  # geom_line() +
  geom_vline(xintercept = ivee_after_date, show.legend = NA) +
  geom_smooth(method = "lm", color = annual_col, size = 3) +
  theme_bw() + 
  theme(legend.position = "bottom") +
  labs(title = "Annual",
       x = "Sampling date",
       y = expression(Delta~"Biomass (dry g/"~m^2~") (control - annual)"))

delta_continual_timeseries <- ggplot(delta_algae %>% filter(delta_continual != "NA"), 
                                  aes(x = date, y = delta_continual)) +
  scale_x_date(limits = c(ivee_after_date, as.Date("2020-06-01"))) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  
  geom_point(shape = continual_shape, size = 2) +
  # geom_line() +
  geom_smooth(method = "lm", size = 3, color = continual_col) +
  geom_vline(xintercept = ivee_after_date, show.legend = NA) +
  # scale_color_manual(values = c(AQUE_col, CARP_col, MOHK_col, NAPL_col)) +
  theme_bw() + 
  theme(legend.position = "none") +
  labs(title = "Continual",
       x = "Sampling date",
       y = expression(Delta~"Biomass (dry g/"~m^2~") (control - annual)"))

plots_together <- (delta_annual_timeseries + delta_continual_timeseries)
plots_together

# ggsave(here::here("figures", "delta_biomass.jpg"), plots_together, width = 8, height = 4, dpi = 150)
  
```


