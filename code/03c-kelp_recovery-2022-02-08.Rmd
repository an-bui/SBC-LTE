---
title: "Progressive Change BACIPS"
author: "An Bui"
date: "2/8/2022"
output: pdf_document
---

```{r setup, include=FALSE}
library(formatR)
knitr::opts_chunk$set(echo = TRUE, tidy.opts = list(width.cutoff = 70), tidy = TRUE, warning = FALSE)
```

# 1. Data 

## a. Libraries
```{r message = FALSE}
library(tidyverse) # cleaning
library(here) # directory navigation
library(lubridate) # handling dates
library(janitor) # cleaning up columns

# dependencies for function
library(minpack.lm) # Fitting non-linear models
library(nls2) # Fitting non-linear models
library(AICcmodavg) # calculate second order AIC (AICc)
```

## b. Dates for end of the experiment

```{r}
############################################
# a. Naples (NAPL) 
############################################

# date of last removal
napl_after_date <- as_date("2016-02-09") 

napl_after_date_annual <- as_date("2017-02-14")

napl_after_date_continual <- as_date("2016-05-17")

############################################
# b. Mohawk (MOHK)
############################################

# date of last removal
mohk_after_date <- as_date("2017-02-13")

mohk_after_date_annual <- as_date("2019-02-12")

mohk_after_date_continual <- as_date("2018-05-15")

############################################
# c. Arroyo Quemado (AQUE)
############################################

# date of last removal
aque_after_date <- as_date("2017-03-02")

aque_after_date_annual <- as_date("2018-02-28")

aque_after_date_continual <- as_date("2017-05-18")

############################################
# d. Carpinteria (CARP)
############################################

# date of last removal
carp_after_date <- as_date("2017-02-15")

carp_after_date_annual <- as_date("2018-02-20")

carp_after_date_continual <- as_date("2017-05-19")

############################################
# e. Isla Vista (IVEE)
############################################

# date of last removal
ivee_after_date <- as_date("2016-02-18")

ivee_after_date_annual <- as_date("2017-02-09")
```

## b. Biomass data

This is data you sent me on the 2nd of February, which is why it has that time appended to the end of the file name to distinguish it from other versions that I pulled down from the online repository.

```{r message = FALSE}
kelp_biomass <- read_csv(here::here("data", "LTE_All_Species_Biomass_at_transect_20220208.csv")) %>% 
  clean_names() %>% 
  # ANOB is incorrectly coded as having "SESSILE" mobility
  mutate(mobility = replace(mobility, sp_code == "ANOB", "MOBILE")) %>% 
  # replace all -99999 values with NA
  mutate(dry_gm2 = replace(dry_gm2, dry_gm2 < 0, NA),
         wm_gm2 = replace(wm_gm2, wm_gm2 < 0, NA)) %>% 
  # create a sample_ID for each sampling date at each treatment at each site
  unite("sample_ID", site, treatment, date, remove = FALSE) %>% 
  # change to lower case
  mutate_at(c("group", "mobility", "growth_morph", "treatment", "site"), str_to_lower) %>% 
  filter(sp_code == "MAPY") %>% 
  select(-sp_code) 
```

# 2. Function

Taken from Thiault et al., with modifications so that plots do not print out in quartz viewer.

```{r}
ProgressiveChangeBACIPS<-function(control, impact, time.true, time.model) 
{
	### STEP 2 - Calculate the delta at each sampling date
	delta <- impact - control
	
	# Plot delta against time.true
	# dev.new(width=10, height=5)
	# par(mfrow=c(1,2))
	plot(delta~time.true, type="n")
	time.model.of.impact=max(which(time.model==0))
	rect(time.model.of.impact, min(delta)-100, max(time.model)+10, max(delta)+100, col = "grey")
	points(delta~time.true, pch=24, bg="white", cex=2)
	
	### STEP 3 - Fit and compete models
	## Create a 'period' variable
	period <- ifelse(time.model==0, "Before","After")
	
	## Fit a step model
	step.Model<-aov(delta ~ period)

	## Fit a linear model
	linear.Model<-lm(delta ~ time.model)
	
	## Fit an asymptotic model
	# Create an asymptotic function
	myASYfun<-function(delta, time.model)
	{
		funAsy<-function(parS, time.model)	(parS$M * time.model) / (parS$L + time.model) + parS$B
		residFun<-function(p, observed, time.model) observed + funAsy(p,time.model)
		parStart <- list(M=mean(delta[time.model.of.impact:length(time.true)]), B=mean(delta[1:time.model.of.impact]), L=1)
		nls_ASY_out <- nls.lm(par=parStart, fn= residFun, observed=delta, time.model=time.model, control = nls.lm.control(maxfev = integer(), maxiter = 1000))
		foAsy<-delta~(M * time.model) / (L + time.model) + B
		startPar<-c(-coef(nls_ASY_out)[1], coef(nls_ASY_out)[2], coef(nls_ASY_out)[3])
		asyFit<-nls2(foAsy, start=startPar, algorithm="brute-force") # nls2 enables to calculate AICc
		asyFit
	}
	# Fit the asymptotic model
	asymptotic.Model<-myASYfun(delta=delta,time.model=time.model)
	
	
	## Fit a sigmoid model
	## Create a sigmoid function
	mySIGfun<-function(delta, time.model)
	{
		funSIG<-function(parS, time.model)	(parS$M * (time.model/parS$L)^parS$K) / (1 + (time.model/parS$L) ^ parS$K) + parS$B
		residFun<-function(p, observed, time.model) observed + funSIG(p,time.model)
		parStart <- list(M=mean(delta[time.model.of.impact:length(time.true)]), B=mean(delta[1:time.model.of.impact]), L=mean(time.model), K=5)
		nls_SIG_out <- nls.lm(par=parStart, fn= residFun, observed=delta, time.model=time.model, control = nls.lm.control(maxfev = integer(), maxiter = 1000))
		foSIG<-delta~(M * (time.model/L) ^ K) / (1 + (time.model/L) ^ K) + B
		startPar<-c(-coef(nls_SIG_out)[1],-coef(nls_SIG_out)[2],coef(nls_SIG_out)[3],coef(nls_SIG_out)[4])
		sigFit<-nls2(foSIG, start=startPar, algorithm="brute-force") # nls2 enables to calculate AICc
		sigFit
	}
	# Fit the sigmoid model
	sigmoid.Model<-mySIGfun(delta=delta,time.model=time.model)


	## Compete models
	# Perform AIC tests
	AIC.test<-AIC(step.Model, linear.Model, asymptotic.Model, sigmoid.Model)
	AICc.test<-as.data.frame(cbind(AIC.test[,1], c(AICc(step.Model), AICc(linear.Model), AICc(asymptotic.Model), AICc(sigmoid.Model))))
	rownames(AICc.test)<-rownames(AIC.test)
	names(AICc.test)<-names(AIC.test)
	
	# Calculate AICc weight and selected the best model
	for(i in 1:dim(AICc.test)[1])
	{
		AICc.test$diff[i]<-AICc.test$AIC[i]-min(AICc.test$AIC)
	}
	AICc.test$RL<-exp(-0.5* AICc.test$diff)
	RL_sum<-sum(AICc.test$RL)
	AICc.test$aicWeights<-(AICc.test$RL/RL_sum)*100
	w<-AICc.test$aicWeights
	names(w)<-rownames(AICc.test)
	
	# Display raw AIC values
	print(AICc.test)

	# Display AICc weights
	# print(w)
	barplot(w, col="white", ylab="Relative likelihood (%)", cex.names = 0.9, names.arg =c("Step","Linear","Asymptotic","Sigmoid"))
	best.Model<-which(w==max(w))

	### STEP 4 - Derive inference based on the best model (i.e., with the higher AICc weight)
	if(best.Model==1) {writeLines(paste("\n\nSTEP MODEL SELECTED - Likelihood = ", round(w[1],1), "%\n\n", sep=""))
		print(summary(step.Model))}
	if(best.Model==2) {writeLines(paste("\n\nLINEAR MODEL SELECTED - Likelihood = ", round(w[2],1), "%\n\n", sep=""))
		print(summary(linear.Model))}
	if(best.Model==3) {writeLines(paste("\n\nASYMPTOTIC MODEL SELECTED - Likelihood = ", round(w[3],1), "%\n\n", sep=""))
		print(asymptotic.Model)}
	if(best.Model==4) {writeLines(paste("\n\nSIGMOID MODEL SELECTED - Likelihood = ", round(w[4],1), "%\n\n", sep=""))
		print(sigmoid.Model)}
	
	return(c(aicc.test.results = AICc.test, 
	         step.model.summary = summary(step.Model), 
	         linear.model.summary = summary(linear.Model), 
	         asy.model.summary = asymptotic.Model, 
	         sigmoid.model.summary = sigmoid.Model))
}

```

# 3. Analysis

`time.model.fxn.new`: Function to create a data frame where there are columns for the actual time (i.e. sampling date), the `time.model` (0 for "before" and a sequence of numbers starting at 1 for "after"), kelp biomass in the control, and kelp biomass in the annual or continual treatment depending on the argument supplied.  

This is more or less the original function from the paper, but with some edits to 1) print the results in the console instead of the quartz viewer, and 2) print the results for all 4 models instead of the one selected by AIC.  

`biomass.pcbacips`: Function to pull columns out of the intermediate data frame created by `time.model.fxn.new` to do Progressive Change BACIPS.

```{r}
time.model.fxn.new <- function(site, treatment) {
  # select an after date based on site and treatment
  treatment_after_date <- if(site == "aque" & treatment == "annual") {
    aque_after_date_annual
  } else if(site == "aque" & treatment == "continual") {
    aque_after_date_continual
  } else if(site == "napl" & treatment == "annual") {
    napl_after_date_annual
  } else if(site == "napl" & treatment == "continual") {
    napl_after_date_continual
  } else if(site == "ivee" & treatment == "annual") {
    ivee_after_date_annual
  } else if(site == "mohk" & treatment == "annual") {
    mohk_after_date_annual
  } else if(site == "mohk" & treatment == "continual") {
    mohk_after_date_continual
  } else if(site == "carp" & treatment == "annual") {
    carp_after_date_annual
  } else if(site == "carp" & treatment == "continual") {
    carp_after_date_continual
  } 
  
  kelp_biomass %>% 
    select(site, year, month, treatment, date, wm_gm2) %>% 
    filter(site == {{ site }} & treatment %in% c({{ treatment }}, "control")) %>% 
    pivot_wider(names_from = "treatment", values_from = "wm_gm2") %>% 
    drop_na() %>% 
    mutate(exp_dates = case_when(
      date > treatment_after_date ~ "after",
      TRUE ~ "during"
    )) %>% 
    mutate(exp_dates = fct_relevel(exp_dates, c("after", "during"))) %>% 
    arrange(exp_dates) %>% 
    # assign everything a "time step number" using the row numbers...
    rownames_to_column("time.model") %>% 
    # only keep the time step numbers for the "after dates"
    # make everything else 0 (i.e. everything else is before the "after")
    mutate(time.model = case_when(
      exp_dates == "during" ~ 0,
      TRUE ~ as.numeric(as.numeric(time.model))
    )) %>% 
    # rearrange the sampling dates to be in logical order
    mutate(exp_dates = fct_relevel(exp_dates, c("during", "after"))) %>% 
    arrange(exp_dates)
}

biomass.pcbacips <- function(df) {
  ProgressiveChangeBACIPS(
    control = pull(df, 6), # control column
    impact = pull(df, 7), # treatment column
    time.true = pull(df, 5), # date column
    time.model = pull(df, 1) # time.model column
  )
}
```

### Arroyo Quemado

```{r}
aque_biomass_annual <- time.model.fxn.new("aque", "annual")

aque_biomass_continual <- time.model.fxn.new("aque", "continual")

aque_annual_bacips_results <- biomass.pcbacips(aque_biomass_annual)

# STEP MODEL SELECTED - Likelihood = 72%

aque_continual_bacips_results <- biomass.pcbacips(aque_biomass_continual)

# LINEAR MODEL SELECTED - Likelihood = 55.7%
```

### Naples

```{r}
napl_biomass_annual <- time.model.fxn.new("napl", "annual")

napl_biomass_continual <- time.model.fxn.new("napl", "continual")

napl_annual_bacips_results <- biomass.pcbacips(napl_biomass_annual)

# STEP MODEL SELECTED - Likelihood = 47.4%

napl_continual_bacips_results <- biomass.pcbacips(napl_biomass_continual)

# LINEAR MODEL SELECTED - Likelihood = 68.6%
```

### Isla Vista

```{r}
ivee_biomass_annual <- time.model.fxn.new("ivee", "annual")

ivee_annual_bacips_results <- biomass.pcbacips(ivee_biomass_annual)

# STEP MODEL SELECTED - Likelihood = 87.3%
```

### Mohawk

```{r}
mohk_biomass_annual <- time.model.fxn.new("mohk", "annual")

mohk_biomass_continual <- time.model.fxn.new("mohk", "continual")

mohk_annual_bacips_results <- biomass.pcbacips(mohk_biomass_annual)

# LINEAR MODEL SELECTED - Likelihood = 64%

mohk_continual_bacips_results <- biomass.pcbacips(mohk_biomass_continual)

# LINEAR MODEL SELECTED - Likelihood = 86.3%
```

### Carpinteria

```{r}
carp_biomass_annual <- time.model.fxn.new("carp", "annual")

carp_biomass_continual <- time.model.fxn.new("carp", "continual")

carp_annual_bacips_results <- biomass.pcbacips(carp_biomass_annual)

# LINEAR MODEL SELECTED - Likelihood = 49.9%

carp_continual_bacips_results <- biomass.pcbacips(carp_biomass_continual)

# STEP MODEL SELECTED - Likelihood = 62.3%
```
