---
title: "kelp frond recovery"
author: "An Bui"
date: "1/23/2022"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 0. set up

```{r}
source(here::here("code", "00-set_up.R"))
```

# 1. Data frames

-   `delta_annual`: annual removal and control plots
-   `delta_continual`: continual removal and control plots

```{r}
delta_annual <- biomass %>% 
  filter(sp_code == "MAPY" & treatment %in% c("control", "annual")) %>% 
  dplyr::select(-sp_code) %>% 
  dplyr::select(site, year, month, treatment, date, dry_gm2) %>% 
  pivot_wider(names_from = treatment, values_from = dry_gm2) %>% 
  mutate(delta_annual = annual - control) %>%  
  mutate(exp_dates = case_when(
    # after for continual removal:
    site == "aque" & date >= aque_after_date_annual ~ "after",
    site == "napl" & date >= napl_after_date_annual ~ "after",
    site == "ivee" & date >= ivee_after_date_annual ~ "after", 
    site == "mohk" & date >= mohk_after_date_annual ~ "after",
    site == "carp" & date >= carp_after_date_annual ~ "after",
    # everything else is "during" the experiment
    TRUE ~ "during"
  ),
  exp_dates = fct_relevel(exp_dates, c("during", "after"))) %>% 
  time_since_columns_annual() %>% 
  kelp_year_column() %>% 
  comparison_column_annual() 

delta_continual <- biomass %>% 
  filter(sp_code == "MAPY" & treatment %in% c("control", "continual")) %>% 
  dplyr::select(-sp_code) %>% 
  dplyr::select(site, year, month, treatment, date, dry_gm2) %>% 
  pivot_wider(names_from = treatment, values_from = dry_gm2) %>% 
  mutate(delta_continual = continual - control) %>%  
  # take out years where continual removal hadn't happened yet
  drop_na(delta_continual) %>% 
  mutate(exp_dates = case_when(
    # after for continual removal:
    site == "aque" & date >= aque_after_date_continual ~ "after",
    site == "napl" & date >= napl_after_date_continual ~ "after",
    site == "mohk" & date >= mohk_after_date_continual ~ "after",
    site == "carp" & date >= carp_after_date_continual ~ "after",
    # everything else is "during" the experiment
    TRUE ~ "during"
  ),
  exp_dates = fct_relevel(exp_dates, c("during", "after"))) %>% 
  time_since_columns_continual() %>% 
  kelp_year_column() %>% 
  comparison_column_continual() %>% 
  left_join(., enframe(sites_full), by = c("site" = "name")) %>% 
  rename("site_full" = value) %>% 
  mutate(site_full = fct_relevel(site_full, "Arroyo Quemado", "Naples", "Mohawk", "Carpinteria"))
```

Delta annual and continual plots for kelp by section:

```{r}
# total biomass
kelp_biomass_section <- biomass_section %>% 
  filter(sp_code == "MAPY") %>% 
  dplyr::select(-sp_code) %>% 
  # make a new column for after dates
  after_dates_column() %>% 
  # make a new column for during and after and set factor levels
  exp_dates_column()

# delta biomass
delta_biomass_section <- kelp_biomass_section %>% 
  dplyr::select(site, year, month, treatment, date, quad, side, exp_dates, dry_gm2) %>% 
  pivot_wider(names_from = treatment, values_from = dry_gm2) %>% 
  mutate(delta_annual = annual - control,
         delta_continual = continual - control) 

delta_annual_section <- delta_biomass_section %>% 
  dplyr::select(site, year, month, date, quad, side, control, annual, delta_annual) %>% 
  drop_na(delta_annual) %>% 
  mutate(exp_dates = case_when(
    # after for annual removal:
    site == "aque" & date >= aque_after_date_annual ~ "after",
    site == "napl" & date >= napl_after_date_annual ~ "after",
    site == "ivee" & date >= ivee_after_date_annual ~ "after",
    site == "mohk" & date >= mohk_after_date_annual ~ "after",
    site == "carp" & date >= carp_after_date_annual ~ "after",
    # everything else is "during" the experiment
    TRUE ~ "during"
  ),
  exp_dates = fct_relevel(exp_dates, c("during", "after"))) %>% 
  time_since_columns_annual() %>% 
  kelp_year_column() %>% 
  comparison_column_annual()

delta_continual_section <- delta_biomass_section %>% 
  dplyr::select(site, year, month, date, quad, side, control, continual, delta_continual) %>% 
  # take out years where continual removal hadn't happened yet
  drop_na(delta_continual) %>% 
  mutate(exp_dates = case_when(
    # after for annual removal:
    site == "aque" & date >= aque_after_date_continual ~ "after",
    site == "napl" & date >= napl_after_date_continual ~ "after",
    site == "mohk" & date >= mohk_after_date_continual ~ "after",
    site == "carp" & date >= carp_after_date_continual ~ "after",
    # everything else is "during" the experiment
    TRUE ~ "during"
  ),
  exp_dates = fct_relevel(exp_dates, c("during", "after"))) %>% 
  time_since_columns_continual() %>% 
  kelp_year_column() %>% 
  comparison_column_continual()
```

# 2. Basic plots

## a. deltas

```{r}
delta_annual_plot <- ggplot(delta_annual, aes(x = time_since_end, y = delta_annual)) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(aes(col = exp_dates)) +
  geom_smooth(method = "lm", aes(col = exp_dates)) +
  theme_bw() + 
  theme(legend.position = "none",
        axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10)) +
  labs(x = "Time since end of experiment", y = "\U0394 biomass (treatment - control)",
       title = "\U0394 annual") +
  facet_wrap(~site_full, ncol = 1, scales = "free_y")

delta_continual_plot <- ggplot(delta_continual, aes(x = time_since_end, y = delta_continual)) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(aes(col = exp_dates)) +
  geom_smooth(method = "lm", aes(col = exp_dates)) +
  theme_bw() + 
  theme(legend.position = "none",
        axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10)) +
  labs(x = "Time since end of experiment", y = "\U0394 biomass (treatment - control)",
       title = "\U0394 continual") +
  facet_wrap(~site_full, ncol = 1, scales = "free_y")

delta_annual_plot
delta_continual_plot
```

## b. raw biomass

```{r}
ggplot(delta_continual) +
  geom_line(aes(x = time_since_end, y = control, col = site), alpha = 0.5, size = 2.5) +
  # control
  geom_point(aes(x = time_since_end, y = control, shape = site), size = 1.5, alpha = 0.5, fill = "#FFFFFF") +
  # continual
  geom_line(aes(x = time_since_end, y = continual, col = site), size = 2.5) +
  geom_point(aes(x = time_since_end, y = continual, shape = site, col = site), size = 1.5, fill = "#FFFFFF") +
  scale_shape_manual(values = shape_palette_site) +
  scale_color_manual(values = color_palette_site) +
  scale_fill_manual(values = color_palette_site) +
  theme_bw() + 
  theme(axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        legend.text = element_text(size = 16), 
        legend.position = "none", 
        plot.margin = margin(0, 0, 0, 0),
        strip.background = element_rect(fill = "white", color = "white"),
        strip.text = element_text(size = 20, hjust = 0),
        panel.grid.minor = element_line(color = "white")) +
  labs(x = "Time since end of experiment (years)", 
       y = expression(Giant~kelp~biomass~(dry~g/m^{"2"}))) +
  facet_wrap(~site_full, scales = "free_y") 

# average raw biomass after 3.7 years
delta_continual %>% 
  filter(comp_2yrs == "after" & quarter == "Q3") %>% 
  summarize(mean_cont = mean(continual),
            se_cont = se(continual),
            mean_control = mean(control),
            se_control = se(control))
```

## c. ms fig: raw biomass

```{r}
delta_continual_sites_raw <- delta_continual %>% 
  mutate(strip = case_when(
    site == "aque" ~ paste("A. ", site_full, sep = ""),
    site == "napl" ~ paste("B. ", site_full),
    site == "mohk" ~ paste("C. ", site_full),
    site == "carp" ~ paste("D. ", site_full)
  )) %>% 
  ggplot() +
  geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_line(aes(x = time_since_end, y = control, col = site), alpha = 0.5, size = 2.5) +
  # control
  geom_point(aes(x = time_since_end, y = control, shape = site), size = 1.5, alpha = 0.5, fill = "#FFFFFF") +
  # continual
  geom_line(aes(x = time_since_end, y = continual, col = site), size = 2.5) +
  geom_point(aes(x = time_since_end, y = continual, shape = site, col = site), size = 1.5, fill = "#FFFFFF") +
  scale_shape_manual(values = shape_palette_site) +
  scale_color_manual(values = color_palette_site) +
  scale_fill_manual(values = color_palette_site) +
  theme_bw() + 
  scale_x_continuous(breaks = seq(-8, 6, by = 1), minor_breaks = NULL) +
  theme(axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        legend.text = element_text(size = 16), 
        legend.position = "none", 
        strip.background = element_rect(fill = "white", color = "white"),
        strip.text = element_text(size = 20, hjust = 0),
        panel.grid.minor = element_line(color = "white")) +
  labs(x = "Time since end of experiment (years)", 
       y = expression(Giant~kelp~biomass~(dry~g/m^{"2"}))) +
  facet_wrap(~strip, scales = "free_y")

delta_continual_sites_raw

ggsave(here::here("figures", paste("delta_continual_sites_raw-", todays_date, ".jpg", sep = "")), plot = delta_continual_sites_raw, height = 8, width = 16, dpi = 150)
```


# 3. Start-during-after

## a. site 2 year comparison

### i. visualization

```{r}
ggplot(delta_continual %>% drop_na(comp_2yrs), aes(x = comp_2yrs, y = delta_continual)) +
  geom_hline(yintercept = 0, lty = 2, alpha = 0.3) +
  geom_jitter(width = 0.2, alpha = 0.4) +
  stat_summary(aes(group = site), fun = mean, geom = "line") +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +
  stat_summary(aes(col = site), fun = mean, geom = "point", size = 6) +
  scale_color_manual(values = color_palette_site) +
  theme_bw() +
  theme(legend.position = "none",
        axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10)) +
  labs(x = "Time period", y = "\U0394 biomass (treatment - control)",
       title = "continual removal, 2 year comparison") +
  facet_wrap(~site_full)
```

### ii. anova

```{r}
# anova with random effect
kelp_anova <- lmer(delta_continual ~ comp_2yrs + (1|site), data = delta_continual %>% drop_na(comp_2yrs))
# summary with p value
summary(kelp_anova)
em <- emmeans(kelp_anova, pairwise ~ comp_2yrs)
# least squares comparison
difflsmeans(kelp_anova, test.effs = "Group", ddf = "Kenward-Roger")
# extract predicted values
kelp_anova_df <- ggpredict(kelp_anova, terms = "comp_2yrs", type = "fixed")

# plot
sda_kelp_biomass <- ggplot(kelp_anova_df) +
  # horizontal line at 0
  geom_hline(yintercept = 0, lty = 2, alpha = 0.3) +
  # points and error bars
  geom_point(aes(x = x, y = predicted), size = 6) +
  geom_errorbar(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error), width = 0.2) +
  # path between time periods
  geom_line(aes(x = x, y = predicted, group = 1)) +
  # add in post-hoc comparisons
  annotate("text", x = 1, y = 180, label = "a", size = 14) +
  annotate("text", x = 2, y = 180, label = "a", size = 14) +
  annotate("text", x = 3, y = 180, label = "b", size = 14) +
  # aesthetics
  theme_bw() +
  theme(axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        legend.text = element_text(size = 16), 
        legend.title = element_text(size = 16),
        plot.margin = margin(0, 0, 0, 0),
        panel.grid.minor = element_line(color = "white")) +
  labs(x = "Time period", 
       y = expression(Predicted~"\U0394"~kelp~biomass~(dry~g/m^{"2"})))
sda_kelp_biomass
```

## b. site 3 year comparison

```{r}
ggplot(delta_continual %>% drop_na(comp_3yrs), aes(x = comp_3yrs, y = delta_continual)) +
  geom_hline(yintercept = 0, lty = 2, alpha = 0.3) +
  geom_jitter(width = 0.2, alpha = 0.4) +
  stat_summary(aes(group = site), fun = mean, geom = "line") +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +
  stat_summary(aes(col = site), fun = mean, geom = "point", size = 6) +
  scale_color_manual(values = color_palette_site) +
  theme_bw() +
  theme(legend.position = "none",
        axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10)) +
  labs(x = "Time period", y = "\U0394 biomass (treatment - control)",
       title = "continual removal, 3 year comparison") +
  facet_wrap(~site_full)
```

# 4. during-after

Only "during" and "after" as bins.

```{r}
ggplot(delta_continual, aes(x = exp_dates, y = delta_continual)) +
  geom_hline(yintercept = 0) +
  stat_summary(geom = "point", fun = mean) +
  stat_summary(geom = "errorbar", fun.data = "mean_se")

ggplot() +
  geom_hline(yintercept = 0) +
  stat_summary(data = delta_continual, aes(x = exp_dates, y = continual), geom = "point", fun = mean) +
  stat_summary(data = delta_continual, aes(x = exp_dates, y = continual), geom = "errorbar", fun.data = "mean_se") +
  stat_summary(data = delta_continual, aes(x = exp_dates, y = control), geom = "point", fun = mean, color = "blue") +
  stat_summary(data = delta_continual, aes(x = exp_dates, y = control), geom = "errorbar", fun.data = "mean_se", color = "blue")
```

# 5. annual kelp biomass

## a. line by season

```{r}
biomass_by_season_annual <- delta_annual %>% 
  season_column() %>% 
  filter(exp_dates == "during" & site != "ivee") %>% 
  ggplot(aes(x = season, y = annual)) +
  stat_summary(aes(group = site, color = site), fun.data = mean_se, geom = "errorbar", alpha = 0.5, width = 0.2) +
  stat_summary(aes(group = site, color = site), fun = mean, geom = "line", size = 1.5) +
  # geom_point(aes(color = site)) +
  scale_color_manual(values = color_palette_site_annual) +
  theme_bw() +
  labs(x = "Season", 
       y = expression(Mean~kelp~biomass~(dry~g/m^{"2"})),
       color = "Site") +
  theme(legend.position = c(0.1, 0.8),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        panel.grid.minor.y = element_line(color = "white"))
biomass_by_season_annual

annual_kelp_summary <- delta_annual %>% 
  season_column() %>% 
  filter(exp_dates == "during") %>% 
  group_by(season) %>% 
  summarize(mean_kelp = mean(annual),
            se_kelp = se(annual))

biomass_by_season_annual_v2 <- delta_annual %>% 
  season_column() %>% 
  filter(exp_dates == "during" & site != "ivee") %>% 
  ggplot(aes(x = season, y = annual)) +
  stat_summary(aes(group = 1), fun.data = mean_se, geom = "errorbar", width = 0.2, size = 1) +
  stat_summary(aes(group = 1), fun = mean, geom = "line", size = 1.5) +
  # geom_jitter(aes(x = season, y = annual, color = site)) +
  # scale_color_manual(values = color_palette_site_annual) +
  theme_bw() +
  labs(x = "Season", 
       y = expression(Mean~kelp~biomass~(dry~g/m^{"2"})),
       color = "Site") +
  theme(legend.position = c(0.1, 0.8),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        panel.grid.minor.y = element_line(color = "white"))
biomass_by_season_annual_v2

ggsave(here::here("figures", paste("fig1_summary_", todays_date, ".jpg", sep = "")), height = 12, width = 8, dpi = 150)

biomass_by_season_annual_boxplot <- delta_annual %>% 
  season_column() %>% 
  filter(exp_dates == "during") %>% 
  ggplot(aes(x = season, y = annual)) +
  geom_boxplot() +
  geom_jitter() +
  # scale_color_manual(values = color_palette_site_annual) +
  theme_bw() +
  labs(x = "Season", 
       y = expression(Kelp~biomass~(dry~g/m^{"2"})),
       color = "Site") +
  theme(legend.position = c(0.1, 0.8),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        panel.grid.minor.y = element_line(color = "white"))
biomass_by_season_annual_boxplot

delta_annual %>%
  # filter(site == "ivee") %>%
  mutate(season = case_when(
    quarter == "Q2" ~ "spring",
    quarter == "Q3" ~ "summer",
    quarter == "Q4" ~ "fall",
    quarter == "Q1" ~ "winter"
  )) %>%
  mutate(season = fct_relevel(season, "spring", "summer", "fall", "winter")) %>%
  filter(exp_dates == "during") %>%
  mutate(quarter = fct_relevel(quarter, "Q2", "Q3", "Q4", "Q1")) %>%
  mutate(kelp_year = as.factor(kelp_year)) %>%
  ggplot(aes(x = season, y = annual)) +
  # stat_summary(aes(color = kelp_year, group = kelp_year), fun.data = mean_se, geom = "errorbar", alpha = 0.5, width = 0.2) +
  # geom_point(aes(shape = site, color = kelp_year), size = 2) +
  stat_summary(aes(group = 1), fun.data = mean_se, geom = "errorbar", width = 0.2, size = 1) +
  stat_summary(aes(group = 1), fun = mean, geom = "line", size = 1.5) +
  stat_summary(aes(color = kelp_year, group = kelp_year), fun = mean, geom = "point", size = 2, alpha = 0.9) +
  scale_color_manual(values = c("#BBD1FA", "#A2B9E4", "#89A1CE", "#7089B8",
                                "#5771A2", "#3E598C", "#254176", "#0D2A61", "darkblue", "navy", "black")) +
  theme_bw() +
  labs(x = "Season",
       y = expression(Mean~kelp~biomass~(dry~g/m^{"2"}))) +
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 16),
        panel.grid = element_blank()) 
  # facet_wrap(~site, ncol = 1, scales = "free_y")

ggsave(here::here("figures", paste("fig1_all-sites_", todays_date, ".jpg", sep = "")), height = 12, width = 8, dpi = 150)
```

## b. histogram

```{r}
df <- delta_annual %>% 
  # assign seasons to quarters
  season_column() %>% 
  # filter spring and fall during experimental removal
  filter(season %in% c("spring", "fall")) %>% 
  filter(exp_dates == "during") %>% 
  # deal with multiple sampling points in a season by taking mean
  group_by(site, year, kelp_year, season) %>% 
  summarize(mean_kelp = mean(annual),
            se_kelp = se(annual)) %>% 
  ungroup() %>% 
  # create ID column with site and year
  unite("site_year", site, year, sep = "_", remove = FALSE) %>% 
  pivot_wider(names_from = season, values_from = c(mean_kelp, se_kelp)) %>% 
  # calculate difference between fall and spring biomass
  mutate(diff = mean_kelp_fall - mean_kelp_spring) %>% 
  filter(site != "ivee") %>% 
  mutate(site = fct_relevel(site, c("aque", "napl", "mohk", "carp")))

# color by kelp year
hist <- ggplot(data = df) +
  geom_histogram(aes(x = diff, fill = kelp_year), binwidth = 100, color = "black") +
  scale_fill_manual(values = c("kelp_2008-2009" = "#BBD1FA", 
                               "kelp_2009-2010" = "#A2B9E4", 
                               "kelp_2010-2011" = "#89A1CE", 
                               "kelp_2011-2012" = "#7089B8",
                               "kelp_2012-2013" = "#5771A2", 
                               "kelp_2013-2014" = "#3E598C", 
                               "kelp_2014-2015" = "#254176", 
                               "kelp_2015-2016" = "#0D2A61", 
                               "kelp_2016-2017" = "darkblue", 
                               "kelp_2017-2018" = "navy")) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 9.5), breaks = seq(0, 9, 3)) +
  theme_bw() +
  # facet_wrap(~kelp_year)
  labs(x = expression("\U0394"~kelp~biomass~(fall~-~spring)~(dry~g/m^{"2"})), 
       y = "Frequency",
       fill = "Kelp year") +
  theme(legend.position = c(0.8, 0.7),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12), 
        panel.grid.minor.y = element_line(color = "white"))
hist
```

# 6. linear models

## a. annual removal

### i. seasonal data

```{r}
annual_after <- delta_annual %>% 
  filter(exp_dates == "after")
linear_model <- lm(delta_annual ~ time_since_end + site + time_since_end*site, data = annual_after, na.action = na.pass)
dredge(linear_model) %>% 
  model.sel() %>% 
  gt()

linear_model_sel <- lme(delta_annual ~ time_since_end, random = ~ 1|site, data = delta_annual %>% filter(exp_dates == "after"), na.action = na.pass)
summary(linear_model_sel)
linear_model_sel %>% 
  tbl_regression() %>% 
  bold_p(t = 0.05)

linear_model_sel <- lmer(delta_annual ~ time_since_end + (1|site), data = annual_after, na.action = na.pass)
plot(simulateResiduals(linear_model_sel))
linear_model_during_seasonal <- lmer(delta_annual ~ time_since_end + (1|site), data = delta_annual %>% filter(exp_dates == "during"), na.action = na.pass)
summary(linear_model_during_seasonal)
plot(simulateResiduals(linear_model_during_seasonal))


# ggeffects
predicted <- ggpredict(linear_model_sel, terms = ~ time_since_end)
predicted_during <- ggpredict(linear_model_during_seasonal, terms = ~ time_since_end)
# emmeans
grid <- ref_grid(linear_model_sel, cov.keep = c("time_since_end"))
emm <- emmeans(grid, spec = c("time_since_end"), level = 0.95) %>% 
  data.frame(.)

ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  # facet_wrap(~fct_relevel(site_full, "Arroyo Quemado (AQUE)", "Naples (NAPL)", "Isla Vista (IVEE)", "Mohawk (MOHK)", "Carpinteria (CARP)"), ncol = 1, scales = "free_y") +
  geom_point(data = delta_annual, aes(x = time_since_end, y = delta_annual, color = exp_dates, shape = site)) +
  scale_color_manual(values = c("during" = "grey", "after" = "black"), guide = "none") +
  # during
  geom_ribbon(data = predicted_during, aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high), alpha = 0.5) +
  geom_line(data = predicted_during, aes(x = x, y = predicted)) +
  # after
  geom_ribbon(data = predicted, aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high), alpha = 0.5) +
  geom_line(data = predicted, aes(x = x, y = predicted)) +
  scale_x_continuous(breaks = seq(-11, 5, by = 1), minor_breaks = NULL) +
  scale_y_continuous(breaks = seq(-1500, 1500, by = 500)) +
  theme_bw() + 
  theme(axis.title = element_text(size = 16),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.position = c(0.94, .18)) +
  labs(x = "Time since end of experiment", y = "\U0394 biomass (treatment - control)",
       title = "Kelp (annual removal)", caption = "ggpredict")

ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  # facet_wrap(~fct_relevel(site_full, "Arroyo Quemado (AQUE)", "Naples (NAPL)", "Isla Vista (IVEE)", "Mohawk (MOHK)", "Carpinteria (CARP)"), ncol = 1, scales = "free_y") +
  geom_point(data = delta_annual, aes(x = time_since_end, y = delta_annual, color = exp_dates)) +
  scale_color_manual(values = c("during" = "grey", "after" = "black"), guide = "none") +
  geom_ribbon(data = emm, aes(x = time_since_end, y = emmean, ymin = lower.CL, ymax = upper.CL), alpha = 0.5) +
  geom_line(data = emm, aes(x = time_since_end, y = emmean)) + 
  theme_bw() + 
  theme(legend.position = "none",
        axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10)) +
  labs(x = "Time since end of experiment", y = "\U0394 biomass (treatment - control)",
       title = "\U0394 annual", caption = "emmeans")
```

### ii. "annualized" data

```{r}
annual_means <- delta_annual %>% 
  group_by(site, kelp_year) %>% 
  mutate(mean_delta = mean(delta_annual), 
         mean_tse = mean(time_since_end),
         se_delta = se(delta_annual)) %>% 
  dplyr::select(site, site_full, kelp_year, mean_delta, mean_tse, exp_dates, se_delta) %>% 
  unique() %>% 
  full_join(., site_quality, by = "site")

annual_after_means <- annual_means %>% 
  filter(exp_dates == "after")

linear_model <- lmer(mean_delta ~ mean_tse + (1|site), data = annual_after_means, na.action = na.pass)
linear_model2 <- lm(mean_delta ~ mean_tse, data = annual_after_means)
dredge(linear_model) %>% 
  model.sel() %>% 
  gt()
linear_model_sel <- lmer(mean_delta ~ mean_tse + (1|site), data = annual_after_means, na.action = na.pass)
summary(lme(mean_delta ~ mean_tse, random = ~ 1|site, data = annual_means %>% filter(exp_dates == "after")))
linear_model_during <- lmer(mean_delta ~ mean_tse + (1|site), data = annual_means %>% filter(exp_dates == "during"))
summary(linear_model_during)
summary(linear_model_sel)
plot(simulateResiduals(linear_model_sel))
check_model(linear_model_sel)
# ggeffects
predicted <- ggpredict(linear_model_sel, terms = ~ mean_tse + (1|site), type = "random") %>% 
  rename("site" = group) %>% 
  left_join(., enframe(sites_full), by = c("site" = "name")) %>% 
  rename("site_full" = value)
  # rename("site" = group) %>% 
  # left_join(., enframe(sites_full), by = c("site" = "name")) %>% 
  # rename("site_full" = value)

predicted_during <- ggpredict(linear_model_during, terms = ~ mean_tse + (1|site), type = "random") %>% 
  rename("site" = group) %>% 
  left_join(., enframe(sites_full), by = c("site" = "name")) %>% 
  rename("site_full" = value)
# emmeans
grid <- ref_grid(linear_model_sel, cov.keep = c("mean_tse"))
emm <- emmeans(grid, spec = c("mean_tse"), level = 0.95) %>% 
  data.frame(.) 

ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  # facet_wrap(~fct_relevel(site_full, "Arroyo Quemado (AQUE)", "Naples (NAPL)", "Isla Vista (IVEE)", "Mohawk (MOHK)", "Carpinteria (CARP)"), ncol = 1, scales = "free_y") +
  # raw data: means and error bars
  geom_point(data = annual_means, aes(x = mean_tse, y = mean_delta, shape = site), size = 2) +
  geom_errorbar(data = annual_means, aes(x = mean_tse, y = mean_delta, ymin = mean_delta - se_delta, ymax = mean_delta + se_delta)) +
  # geom_smooth(data = annual_means, aes(x = mean_tse, y = mean_delta, color = exp_dates), method = "lm") +
  geom_ribbon(data = predicted_during, aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high, fill = site), alpha = 0.5) +
  geom_line(data = predicted_during, aes(x = x, y = predicted, color = site)) +
  # predicted values: after period
  geom_ribbon(data = predicted, aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high, fill = site), alpha = 0.5) +
  geom_line(data = predicted, aes(x = x, y = predicted, color = site)) +
  # theme
  theme_bw() + 
  theme(legend.position = c(0.94, .18),
        axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10)) +
  labs(x = "Time since end of experiment", y = "\U0394 biomass (treatment - control)",
       title = "\U0394 annual - annualized data", caption = "ggpredict")

ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  # facet_wrap(~fct_relevel(site_full, "Arroyo Quemado (AQUE)", "Naples (NAPL)", "Isla Vista (IVEE)", "Mohawk (MOHK)", "Carpinteria (CARP)"), ncol = 1, scales = "free_y") +
  geom_point(data = annual_means, aes(x = mean_tse, y = mean_delta, color = exp_dates, shape = site)) +
  geom_errorbar(data = annual_means, aes(x = mean_tse, y = mean_delta, ymin = mean_delta - se_delta, ymax = mean_delta + se_delta, color = exp_dates)) +
  scale_color_manual(values = c("during" = "grey", "after" = "black"), guide = "none") +
  scale_color_manual(values = c("during" = "grey", "after" = "black"), guide = "none") +
  geom_ribbon(data = emm, aes(x = mean_tse, y = emmean, ymin = lower.CL, ymax = upper.CL), alpha = 0.5) +
  geom_line(data = emm, aes(x = mean_tse, y = emmean)) +
  theme_bw() + 
  theme(legend.position = "none",
        axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10)) +
  labs(x = "Time since end of experiment", y = "\U0394 biomass (treatment - control)",
       title = "\U0394 annual - annualized data", 
       caption = "emmeans")
```

### iii. "annualized" data for site quality

```{r}
annual_means <- delta_annual %>% 
  group_by(site, kelp_year) %>% 
  mutate(mean_delta = mean(delta_annual), 
         mean_tse = mean(time_since_end),
         se_delta = se(delta_annual)) %>% 
  dplyr::select(site, site_full, kelp_year, mean_delta, mean_tse, exp_dates, se_delta) %>% 
  unique() %>% 
  full_join(., site_quality, by = "site")

annual_after_means <- annual_means %>% 
  filter(exp_dates == "after")

linear_model <- lm(mean_delta ~ mean_tse + quality + mean_tse*quality, data = annual_after_means, na.action = na.pass)
dredge(linear_model) %>% 
  model.sel() %>% 
  gt()
linear_model_sel <- lm(mean_delta ~ mean_tse + quality + mean_tse*quality, data = annual_after_means, na.action = na.pass)
summary(linear_model_sel)
plot(simulateResiduals(linear_model_sel))
# ggeffects
predicted <- ggpredict(linear_model_sel, terms = ~ mean_tse + quality + mean_tse*quality, type = "fixed") %>% 
  rename("quality" = group) 
# emmeans
grid <- ref_grid(linear_model_sel, cov.keep = c("mean_tse", "quality"))
emm <- emmeans(grid, spec = c("mean_tse", "quality"), level = 0.95) %>% 
  data.frame(.)

annual_kelp_sitequality_ggpredict <- ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  # raw data: means and error bars
  facet_wrap(~quality, nrow = 1) +
  geom_point(data = annual_means, aes(x = mean_tse, y = mean_delta, color = exp_dates, shape = site)) +
  # geom_errorbar(data = annual_means, aes(x = mean_tse, y = mean_delta, ymin = mean_delta - se_delta, ymax = mean_delta + se_delta, color = exp_dates)) +
  scale_color_manual(values = c("during" = "grey", "after" = "black"), guide = "none") +
  # predicted values
  geom_ribbon(data = predicted, aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high, fill = quality), alpha = 0.5, show.legend = FALSE) +
  geom_line(data = predicted, aes(x = x, y = predicted)) +
  # theme
  theme_bw() + 
  theme(axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10)) +
  labs(x = "Time since end of experiment", y = "\U0394 biomass (treatment - control)",
       title = "Kelp biomass", caption = "ggpredict")

annual_kelp_sitequality_emmeans <-ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  facet_wrap(~quality, nrow = 1) +
  geom_point(data = annual_means, aes(x = mean_tse, y = mean_delta, color = exp_dates, shape = site)) +
  scale_color_manual(values = c("during" = "grey", "after" = "black"), guide = "none") +
  geom_ribbon(data = emm, aes(x = mean_tse, y = emmean, ymin = lower.CL, ymax = upper.CL, fill = quality), alpha = 0.5, show.legend = FALSE) +
  geom_line(data = emm, aes(x = mean_tse, y = emmean, col = quality)) +
  theme_bw() + 
  theme(axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10)) +
  labs(x = "Time since end of experiment", y = "\U0394 biomass (treatment - control)",
       title = "\U0394 annual - annualized data", 
       caption = "emmeans")
```

### iv. "annualized" data for the section

```{r}
annual_means_section <- delta_annual_section %>% 
  group_by(site, quad, side, kelp_year) %>% 
  mutate(mean_delta = mean(delta_annual), 
         mean_tse = mean(time_since_end),
         se_delta = se(delta_annual)) %>% 
  dplyr::select(site, site_full, quad, side, kelp_year, mean_delta, mean_tse, exp_dates, se_delta) %>% 
  unique() %>% 
  unite(quad_side, "quad", "side", remove = FALSE) %>% 
  full_join(., site_quality, by = "site")

annual_after_means_section <- annual_means_section %>% 
  filter(exp_dates == "after")

linear_model_section <- lmer(mean_delta ~ mean_tse + site + mean_tse*site + (1|quad_side), data = annual_after_means_section, na.action = na.pass)
dredge(linear_model_section) %>% 
  model.sel() %>% 
  gt()
linear_model_sel_section <- lmer(mean_delta ~ mean_tse + site + mean_tse*site + (1|quad_side), data = annual_after_means_section, na.action = na.pass)
summary(linear_model_sel_section)
plot(simulateResiduals(linear_model_sel_section))
# ggeffects
predicted_section <- ggpredict(linear_model_sel_section, terms = ~ mean_tse + site, type = "fixed") %>% 
  rename("site" = group) %>% 
  left_join(., enframe(sites_full), by = c("site" = "name")) %>% 
  rename("site_full" = value)
# emmeans
grid_section <- ref_grid(linear_model_sel_section, cov.keep = c("mean_tse", "site"))
emm_section <- emmeans(grid_section, spec = c("mean_tse", "site"), level = 0.95) %>% 
  data.frame(.) %>%
  left_join(., enframe(sites_full), by = c("site" = "name")) %>% 
  rename("site_full" = value)

ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  # facet_wrap(~fct_relevel(site_full, "Arroyo Quemado (AQUE)", "Naples (NAPL)", "Isla Vista (IVEE)", "Mohawk (MOHK)", "Carpinteria (CARP)"), ncol = 1) +
  # raw data: means and error bars
  geom_point(data = annual_means_section, aes(x = mean_tse, y = mean_delta, color = exp_dates)) +
  geom_smooth(data = annual_means_section, aes(x = mean_tse, y = mean_delta, aes(color = exp_dates)))
  geom_errorbar(data = annual_means_section, aes(x = mean_tse, y = mean_delta, ymin = mean_delta - se_delta, ymax = mean_delta + se_delta, color = exp_dates)) +
  scale_color_manual(values = c("during" = "grey", "after" = "black"), guide = "none") +
  # predicted values
  geom_ribbon(data = predicted_section, aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high, fill = site), alpha = 0.5) +
  geom_line(data = predicted_section, aes(x = x, y = predicted)) +
  # theme
  theme_bw() + 
  theme(legend.position = "none",
        axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10)) +
  labs(x = "Time since end of experiment", y = "\U0394 biomass (treatment - control)",
       title = "\U0394 annual - annualized data", caption = "ggpredict")

ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  facet_wrap(~fct_relevel(site_full, "Arroyo Quemado (AQUE)", "Naples (NAPL)", "Isla Vista (IVEE)", "Mohawk (MOHK)", "Carpinteria (CARP)"), ncol = 1, scales = "free_y") +
  geom_point(data = annual_means_section, aes(x = mean_tse, y = mean_delta, color = exp_dates)) +
  scale_color_manual(values = c("during" = "grey", "after" = "black"), guide = "none") +
  geom_ribbon(data = emm_section, aes(x = mean_tse, y = emmean, ymin = lower.CL, ymax = upper.CL, fill = site), alpha = 0.5) +
  geom_line(data = emm_section, aes(x = mean_tse, y = emmean, col = site)) +
  theme_bw() + 
  theme(legend.position = "none",
        axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10)) +
  labs(x = "Time since end of experiment", y = "\U0394 biomass (treatment - control)",
       title = "\U0394 annual - annualized data", 
       subtitle = "transect section", 
       caption = "emmeans")

### site quality by section
linear_model_section <- lmer(mean_delta ~ mean_tse + quality + mean_tse*quality + (1|quad_side), data = annual_after_means_section, na.action = na.pass)
dredge(linear_model_section) %>% 
  model.sel() %>% 
  gt()
linear_model_sel_section <- lmer(mean_delta ~ mean_tse + quality + mean_tse*quality + (1|quad_side), data = annual_after_means_section, na.action = na.pass)
summary(linear_model_sel_section)
plot(simulateResiduals(linear_model_sel_section))
# ggeffects
predicted_section <- ggpredict(linear_model_sel_section, terms = ~ mean_tse + quality + mean_tse*quality, type = "fixed") %>% 
  rename("quality" = group) 
# emmeans
grid_section <- ref_grid(linear_model_sel_section, cov.keep = c("mean_tse", "quality"))
emm_section <- emmeans(grid_section, spec = c("mean_tse", "quality"), level = 0.95) %>% 
  data.frame(.) 

ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  facet_wrap(~quality, nrow = 1) +
  # raw data: means and error bars
  geom_point(data = annual_means_section, aes(x = mean_tse, y = mean_delta, color = exp_dates)) +
  geom_errorbar(data = annual_means_section, aes(x = mean_tse, y = mean_delta, ymin = mean_delta - se_delta, ymax = mean_delta + se_delta, color = exp_dates)) +
  scale_color_manual(values = c("during" = "grey", "after" = "black"), guide = "none") +
  # predicted values
  geom_ribbon(data = predicted_section, aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high, fill = quality), alpha = 0.5) +
  geom_line(data = predicted_section, aes(x = x, y = predicted)) +
  # theme
  theme_bw() + 
  theme(legend.position = "none",
        axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10)) +
  labs(x = "Time since end of experiment", y = "\U0394 biomass (treatment - control)",
       title = "\U0394 annual - annualized data", caption = "ggpredict")

ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  facet_wrap(~ quality, ncol = 1) +
  geom_point(data = annual_means_section, aes(x = mean_tse, y = mean_delta, color = exp_dates)) +
  scale_color_manual(values = c("during" = "grey", "after" = "black"), guide = "none") +
  geom_ribbon(data = emm_section, aes(x = mean_tse, y = emmean, ymin = lower.CL, ymax = upper.CL, fill = quality), alpha = 0.5) +
  geom_line(data = emm_section, aes(x = mean_tse, y = emmean, col = quality)) +
  theme_bw() + 
  theme(legend.position = "none",
        axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10)) +
  labs(x = "Time since end of experiment", y = "\U0394 biomass (treatment - control)",
       title = "\U0394 annual - annualized data", 
       subtitle = "transect section", 
       caption = "emmeans")
```

## b. continual removal

### i. seasonal data

#### during removal

```{r}
# lmer
linear_model_kelp_during_lmer <- lmer(
  delta_continual ~ time_since_end + (1|site),
  data = delta_continual %>% filter(exp_dates == "during"), 
  na.action = na.pass)
linear_model_kelp_during_glmmTMB <- glmmTMB(
  delta_continual ~ time_since_end + (1|site), 
  data = delta_continual %>% filter(exp_dates == "during"), 
  na.action = na.pass, 
  family = gaussian)

# diagnostics
plot(linear_model_kelp_during_lmer)
plot(simulateResiduals(linear_model_kelp_during_lmer))
check_model(linear_model_kelp_during_lmer)

plot(simulateResiduals(linear_model_kelp_during_glmmTMB))
check_model(linear_model_kelp_during_glmmTMB)

# summaries
summary(linear_model_kelp_during_lmer)
summary(linear_model_kelp_during_glmmTMB)
kelp_during <- linear_model_kelp_during_lmer %>% 
  tbl_regression() %>% 
  bold_p(t = 0.05)
kelp_during

# ggeffects predictions
predicted_kelp_during_overall <- ggpredict(linear_model_kelp_during_lmer, terms = ~ time_since_end, type = "fixed")
predicted_kelp_during_aque <- ggpredict(linear_model_kelp_during_lmer, terms = ~ time_since_end, type = "random", condition = c(site = "aque"))
predicted_kelp_during_napl <- ggpredict(linear_model_kelp_during_lmer, terms = ~ time_since_end, type = "random", condition = c(site = "napl"))
predicted_kelp_during_mohk <- ggpredict(linear_model_kelp_during_lmer, terms = ~ time_since_end, type = "random", condition = c(site = "mohk"))
predicted_kelp_during_carp <- ggpredict(linear_model_kelp_during_lmer, terms = ~ time_since_end, type = "random", condition = c(site = "carp"))
```

#### recovery period

```{r}
# basic filtering
continual_after <- delta_continual %>% 
  filter(exp_dates == "after")

# lmer
linear_model_kelp_lmer <- lmer(delta_continual ~ time_since_end + (1|site), 
                         data = continual_after, na.action = na.pass)

# diagnostics
plot(simulateResiduals(linear_model_kelp_lmer))
check_model(linear_model_kelp_lmer)

# summary
MuMIn::r.squaredGLMM(linear_model_kelp_lmer)
summary(linear_model_kelp_lmer)
kelp_after <- linear_model_kelp_lmer %>% 
  tbl_regression() %>% 
  bold_p(t = 0.05)
kelp_after

kelp_tables <- tbl_merge(tbls = list(kelp_during, kelp_after), 
                         tab_spanner = c("**Removal**", "**Recovery**"))

# random intercept
linear_model_kelp_lmer_ri <- lmer(delta_continual ~ time_since_end + (1|site), 
                         data = continual_after, na.action = na.pass)

# diagnostics
plot(simulateResiduals(linear_model_kelp_lmer_ri))

# competing models
# compare random slope to random intercept
AICc(linear_model_kelp_lmer, linear_model_kelp_lmer_ri)

# model summary tables
kelp_tbl <- linear_model_kelp_lmer_ri %>% 
  tbl_regression() %>% 
  bold_p(t = 0.05)

# ggeffects
predicted_kelp_after_overall <- ggpredict(linear_model_kelp_lmer, terms = "time_since_end", type = "fixed")
# predicted line crosses 0 at 3.97
ggpredict(linear_model_kelp_lmer, terms = "time_since_end [3.97:4.0 by = 0.01]", type = "fixed")
# lower bound crosses 0 at 2.6
ggpredict(linear_model_kelp_lmer, terms = "time_since_end [2.60:2.63 by = 0.001]", type = "fixed")
# upper bound crosses 0 at 6.4
ggpredict(linear_model_kelp_lmer, terms = "time_since_end [6.44:6.45 by = 0.001]", type = "fixed")

# aque
predicted_kelp_after_aque <- ggpredict(linear_model_kelp_lmer, terms = ~ time_since_end, type = "random", condition = c(site = "aque"))
ggpredict(linear_model_kelp_lmer, terms = "time_since_end [3.7:3.8 by = 0.001]", type = "random", condition = c(site = "aque"))

# napl
predicted_kelp_after_napl <- ggpredict(linear_model_kelp_lmer, terms = ~ time_since_end, type = "random", condition = c(site = "napl"))
ggpredict(linear_model_kelp_lmer, terms = "time_since_end [3.3:3.5 by = 0.001]", type = "random", condition = c(site = "napl"))

# mohk
predicted_kelp_after_mohk <- ggpredict(linear_model_kelp_lmer, terms = ~ time_since_end, type = "random", condition = c(site = "mohk"))
ggpredict(linear_model_kelp_lmer, terms = "time_since_end [5.37:5.41 by = 0.01]", type = "random", condition = c(site = "mohk"))

# carp
predicted_kelp_after_carp <- ggpredict(linear_model_kelp_lmer, terms = ~ time_since_end, type = "random", condition = c(site = "carp"))
ggpredict(linear_model_kelp_lmer, terms = "time_since_end [3.3:3.4 by = 0.01]", type = "random", condition = c(site = "carp"))

overall <- ggplot() +
  geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_line(data = delta_continual, 
            aes(x = time_since_end, y = delta_continual, col = site), size = 2.5, alpha = 0.6) +
  geom_point(data = delta_continual,
             aes(x = time_since_end, y = delta_continual, shape = site, col = site), size = 1.5, alpha = 0.9, fill = "#FFFFFF") +
  scale_shape_manual(values = shape_palette_site) +
  scale_color_manual(values = color_palette_site) +
  # new_scale("color") + 
  # overall
  geom_line(data = predicted_kelp_after_overall, aes(x = x, y = predicted), size = 2, alpha = 0.7) +
  geom_ribbon(data = predicted_kelp_after_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.2) +
  geom_line(data = predicted_kelp_during_overall, aes(x = x, y = predicted), size = 2, alpha = 0.7) +
  geom_ribbon(data = predicted_kelp_during_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.2) +
  # scale_x_continuous(breaks = seq(-8, 5, by = 1), minor_breaks = NULL) +
  scale_y_continuous(breaks = seq(-1500, 1000, by = 1000), limits = c(-1800, 900)) +
  theme_bw() + 
  theme(axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        legend.text = element_text(size = 16), 
        legend.position = "none", 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of removal", y = "\U0394 giant kelp biomass (treatment - control)")

aque <- ggplot() +
  geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(data = delta_continual %>% filter(site == "aque"), aes(x = time_since_end, y = delta_continual), shape = aque_shape, fill = aque_col, size = 3, alpha = 0.9) +
  # during
  geom_line(data = predicted_kelp_during_aque, aes(x = x, y = predicted), size = 2, alpha = 0.7) +
  geom_ribbon(data = predicted_kelp_during_aque, aes(x = x, ymin = conf.low, ymax = conf.high), alpha = 0.2) +
  # after
  geom_line(data = predicted_kelp_after_aque, aes(x = x, y = predicted), size = 2, alpha = 0.7) +
  geom_ribbon(data = predicted_kelp_after_aque, aes(x = x, ymin = conf.low, ymax = conf.high), alpha = 0.2) +
  scale_x_continuous(breaks = seq(-8, 5, by = 1), minor_breaks = NULL) +
  # scale_y_continuous(breaks = seq(-1500, 1000, by = 1000), limits = c(-1800, 1000)) +
  # geom_text(aes(x = -6.6, y = 600), label = "aque", size = 8) +
  theme_bw() + 
  theme(axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 16)) +
  labs(x = "Time since end of removal", 
       y = "\U0394 giant kelp biomass",
       title = aque_full)

napl <- ggplot() +
  geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(data = delta_continual %>% filter(site == "napl"), aes(x = time_since_end, y = delta_continual), shape = napl_shape, fill = napl_col, size = 3, alpha = 0.9) +
  # during
  geom_line(data = predicted_kelp_during_napl, aes(x = x, y = predicted), size = 2, alpha = 0.7) +
  geom_ribbon(data = predicted_kelp_during_napl, aes(x = x, ymin = conf.low, ymax = conf.high), alpha = 0.2) +
  # after
  geom_line(data = predicted_kelp_after_napl, aes(x = x, y = predicted), size = 2, alpha = 0.7) +
  geom_ribbon(data = predicted_kelp_after_napl, aes(x = x, ymin = conf.low, ymax = conf.high), alpha = 0.2) +
  scale_x_continuous(breaks = seq(-8, 5, by = 1), minor_breaks = NULL) +
  # scale_y_continuous(breaks = seq(-1500, 1500, by = 1000), limits = c(-1800, 1500)) +
  # geom_text(aes(x = -6.8, y = 700), label = "napl", size = 8) +
  theme_bw() + 
  theme(axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 16)) +
  labs(x = "Time since end of removal", 
       y = "\U0394 giant kelp biomass",
       title = napl_full)

mohk <- ggplot() +
  geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(data = delta_continual %>% filter(site == "mohk"), aes(x = time_since_end, y = delta_continual), shape = mohk_shape, fill = mohk_col, size = 3, alpha = 0.9) +
  # during
  geom_line(data = predicted_kelp_during_mohk, aes(x = x, y = predicted), size = 2, alpha = 0.7) +
  geom_ribbon(data = predicted_kelp_during_mohk, aes(x = x, ymin = conf.low, ymax = conf.high), alpha = 0.2) +
  # after
  geom_line(data = predicted_kelp_after_mohk, aes(x = x, y = predicted), size = 2, alpha = 0.7) +
  geom_ribbon(data = predicted_kelp_after_mohk, aes(x = x, ymin = conf.low, ymax = conf.high), alpha = 0.2) +
  scale_x_continuous(breaks = seq(-8, 5, by = 1), minor_breaks = NULL) +
  # scale_y_continuous(breaks = seq(-1500, 1500, by = 1000), limits = c(-1800, 1500)) +
  # geom_text(aes(x = -6.6, y = 900), label = "mohk", size = 8) +
  theme_bw() + 
  theme(axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 16)) +
  labs(x = "Time since end of removal", 
       y = "\U0394 giant kelp biomass",
       title = mohk_full)

carp <- ggplot() +
  geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(data = delta_continual %>% filter(site == "carp"), aes(x = time_since_end, y = delta_continual), shape = carp_shape, fill = carp_col, size = 3, alpha = 0.9) +
  # during
  geom_line(data = predicted_kelp_during_carp, aes(x = x, y = predicted), size = 2, alpha = 0.7) +
  geom_ribbon(data = predicted_kelp_during_carp, aes(x = x, ymin = conf.low, ymax = conf.high), alpha = 0.2) +
  # after
  geom_line(data = predicted_kelp_after_carp, aes(x = x, y = predicted), size = 2, alpha = 0.7) +
  geom_ribbon(data = predicted_kelp_after_carp, aes(x = x, ymin = conf.low, ymax = conf.high), alpha = 0.2) +
  scale_x_continuous(breaks = seq(-8, 5, by = 1), minor_breaks = NULL) +
  # scale_y_continuous(breaks = seq(-1500, 1500, by = 1000), limits = c(-1800, 1500)) +
  # geom_text(aes(x = -6.8, y = 1000), label = "carp", size = 8) +
  theme_bw() + 
  theme(axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 16)) +
  labs(x = "Time since end of removal", 
       y = "\U0394 giant kelp biomass",
       title = carp_full)

# y-axis label for patchwork side eye emoji
yaxislabel <- ggplot(data.frame(l = "\U0394 biomass (treatment - control)", x = 1, y = 1)) +
  geom_text(aes(x, y, label = l), angle = 90) + 
  theme_void() +
  theme(plot.margin = margin(0, 0, 0, 0)) +
  coord_cartesian(clip = "off")

plots_together <- (aque | napl) / (overall + (mohk/carp)) + 
  plot_layout(ncol = 1, heights = c(0.5, 1)) +
  plot_annotation(tag_levels = "A") &
    theme(plot.tag = element_text(size = 20))


plots_together <- (plot_spacer() / overall / plot_spacer()) | (aque/napl/mohk/carp) 

plots_together_sites <- (aque + napl) / (mohk + carp) +
  plot_annotation(tag_levels = "A") &
    theme(plot.tag = element_text(size = 30))
plots_together_sites

  
plots_together
ggsave(here::here("figures", paste("delta_continual-", todays_date, ".jpg", sep = "")), plot = plots_together, height = 8, width = 16, dpi = 150)
ggsave(here::here("figures", paste("delta_continual_sites-", todays_date, ".jpg", sep = "")), plot = plots_together_sites, height = 8, width = 16, dpi = 150)
```

#### fall biomass calculation
```{r}
delta_continual %>% 
  filter(quarter == "Q3" & exp_dates == "after") %>% 
  summarize(mean = mean(continual),
            sd = sd(continual),
            se = se(continual))
```


### ii. site quality

```{r}
linear_model_kelp_lmer <- lmer(delta_continual ~ time_since_end + quality + time_since_end*quality + (1|site), 
                         data = continual_after, na.action = na.pass)
plot(simulateResiduals(linear_model_kelp_lmer))
summary(linear_model_kelp_lmer)
linear_model_kelp_lmer %>% 
  tbl_regression() %>% 
  bold_p(t = 0.05)

AICc(linear_model_kelp_lme, linear_model_kelp_lmer)


linear_model_kelp_during_lmer <- lmer(delta_continual ~ time_since_end + quality + time_since_end*quality + (1|site), 
                                     data = delta_continual %>% filter(exp_dates == "during"), na.action = na.pass)
plot(simulateResiduals(linear_model_kelp_during_lmer))


# ggeffects
# after
predicted_kelp_after_quality <- ggpredict(linear_model_kelp_lmer, terms = ~ time_since_end + quality + time_since_end*quality, type = "fixed") %>% 
  rename("quality" = group)
predicted_kelp_after_overall <- ggpredict(linear_model_kelp_lmer, terms = ~ time_since_end, type = "fixed")

# during
predicted_kelp_during_quality <- ggpredict(linear_model_kelp_during_lmer, terms = ~ time_since_end + quality + time_since_end*quality, type = "fixed") %>% 
  rename("quality" = group)
predicted_kelp_during_overall <- ggpredict(linear_model_kelp_during_lmer, terms = ~ time_since_end, type = "fixed")

overall <- ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(data = delta_continual, 
             aes(x = time_since_end, y = delta_continual, fill = site, shape = site), size = 3, alpha = 0.9) +
  scale_shape_manual(values = shape_palette_site) +
  scale_fill_manual(values = color_palette_site) +
  # new_scale("color") + 
  # overall
  geom_line(data = predicted_kelp_after_overall, aes(x = x, y = predicted), size = 2) +
  geom_ribbon(data = predicted_kelp_after_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.4) +
  geom_line(data = predicted_kelp_during_overall, aes(x = x, y = predicted), size = 2) +
  geom_ribbon(data = predicted_kelp_during_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.4) +
  scale_x_continuous(breaks = seq(-8, 5, by = 1), minor_breaks = NULL) +
  scale_y_continuous(breaks = seq(-1500, 1000, by = 1000), limits = c(-1800, 1000)) +
  theme_bw() + 
  theme(axis.title = element_text(size = 16),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 14), 
        legend.position = c(0.15, 0.87), 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of experiment", y = "\U0394 kelp biomass (treatment - control)")

high <- ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(data = delta_continual %>% filter(quality == "high"), aes(x = time_since_end, y = delta_continual), shape = mohk_shape, fill = mohk_col, size = 3, alpha = 0.9) +
  # during
  geom_line(data = predicted_kelp_during_quality %>% filter(quality == "high"), aes(x = x, y = predicted), size = 2) +
  geom_ribbon(data = predicted_kelp_during_quality %>% filter(quality == "high"), aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.5) +
  # after
  geom_line(data = predicted_kelp_after_quality %>% filter(quality == "high"), aes(x = x, y = predicted), size = 2) +
  geom_ribbon(data = predicted_kelp_after_quality %>% filter(quality == "high"), aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.5) +
  scale_x_continuous(breaks = seq(-8, 5, by = 1), minor_breaks = NULL) +
  scale_y_continuous(breaks = seq(-1500, 1000, by = 1000), limits = c(-1800, 1000)) +
  geom_text(aes(x = -6.6, y = 1000), label = "high", size = 8) +
  theme_bw() + 
  theme(axis.title = element_text(size = 16),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 14), 
        legend.position = "none", 
        axis.text.x = element_blank(),
        axis.title.x = element_blank(), 
        axis.title.y = element_blank(),
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of experiment", y = "\U0394 kelp biomass (treatment - control)")

medium <- ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(data = delta_continual %>% filter(quality == "medium"), aes(x = time_since_end, y = delta_continual, shape = site, fill = site), size = 3, alpha = 0.9) +
  scale_shape_manual(values = c("aque" = aque_shape, "napl" = napl_shape)) +
  scale_fill_manual(values = c("aque" = aque_col, "napl" = napl_col)) +
  # during
  geom_line(data = predicted_kelp_during_quality %>% filter(quality == "medium"), aes(x = x, y = predicted), size = 2) +
  geom_ribbon(data = predicted_kelp_during_quality %>% filter(quality == "medium"), aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.5) +
  # after
  geom_line(data = predicted_kelp_after_quality %>% filter(quality == "medium"), aes(x = x, y = predicted), size = 2) +
  geom_ribbon(data = predicted_kelp_after_quality %>% filter(quality == "medium"), aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.5) +
  scale_x_continuous(breaks = seq(-8, 5, by = 1), minor_breaks = NULL) +
  scale_y_continuous(breaks = seq(-1500, 1000, by = 1000), limits = c(-1800, 1000)) +
  geom_text(aes(x = -6.6, y = 1000), label = "medium", size = 8) +
  theme_bw() + 
  theme(axis.title = element_text(size = 16),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 14), 
        legend.position = "none", 
        axis.text.x = element_blank(),
        axis.title.x = element_blank(), 
        axis.title.y = element_blank(),
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of experiment", y = "\U0394 kelp biomass (treatment - control)")

low <- ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(data = delta_continual %>% filter(quality == "low"), aes(x = time_since_end, y = delta_continual), shape = carp_shape, fill = carp_col, size = 3, alpha = 0.9) +
  # during
  geom_line(data = predicted_kelp_during_quality %>% filter(quality == "low"), aes(x = x, y = predicted), size = 2) +
  geom_ribbon(data = predicted_kelp_during_quality %>% filter(quality == "low"), aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.5) +
  # after
  geom_line(data = predicted_kelp_after_quality %>% filter(quality == "low"), aes(x = x, y = predicted), size = 2) +
  geom_ribbon(data = predicted_kelp_after_quality %>% filter(quality == "low"), aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.5) +
  scale_x_continuous(breaks = seq(-8, 5, by = 1), minor_breaks = NULL) +
  scale_y_continuous(breaks = seq(-1500, 1000, by = 1000), limits = c(-1800, 1000)) +
  geom_text(aes(x = -6.6, y = 900), label = "low", size = 8) +
  theme_bw() + 
  theme(axis.title = element_text(size = 16),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 14), 
        legend.position = "none", 
        axis.text.x = element_blank(),
        axis.title.y = element_blank(),
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of experiment", y = "\U0394 kelp biomass (treatment - control)")

plots_together <- overall + (high/medium/low)
plots_together
ggsave(here::here("figures", paste("delta_continual_quality-", todays_date, ".jpg", sep = "")), plot = plots_together, height = 8, width = 16, dpi = 150)
```

## c. continual raw biomass

```{r}
linear_model_kelp_raw_lme <- lme(continual ~ time_since_end, 
                        random = ~ 1|site, 
                        data = continual_after, na.action = na.pass)
summary(linear_model_kelp_raw_lme)

linear_model_kelp_raw_lmer <- lmer(continual ~ time_since_end + (1|site), 
                         data = continual_after, na.action = na.pass)

AICc(linear_model_kelp_raw_lme, linear_model_kelp_raw_lmer)
plot(simulateResiduals(linear_model_kelp_lmer))

linear_model_kelp_raw_during_lme <- lme(continual ~ time_since_end, 
                                    random = ~ 1|site, 
                                    data = delta_continual)
summary(linear_model_kelp_raw_during_lme)

linear_model_kelp_raw_during_lmer <- lmer(continual ~ time_since_end + (1|site), 
                                     data = delta_continual %>% filter(exp_dates == "during"), na.action = na.pass)
plot(simulateResiduals(linear_model_kelp_raw_during_lmer))

# after
predicted_kelp_raw_after_site <- ggpredict(linear_model_kelp_raw_lmer, terms = ~ time_since_end + (1|site), type = "random") %>% 
  rename("site" = group)
predicted_kelp_raw_after_overall <- ggpredict(linear_model_kelp_raw_lmer, terms = ~ time_since_end, type = "fixed")

# during
predicted_kelp_raw_during_site <- ggpredict(linear_model_kelp_raw_during_lmer, terms = ~ time_since_end + (1|site), type = "fixed") %>% 
  rename("site" = group)
predicted_kelp_raw_during_overall <- ggpredict(linear_model_kelp_raw_during_lmer, terms = ~ time_since_end, type = "fixed")

overall_raw <- ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  # geom_point(data = delta_continual,
  #            aes(x = time_since_end, y = control, shape = site), size = 3, alpha = 0.4) +
  geom_point(data = delta_continual,
             aes(x = time_since_end, y = continual, fill = site, shape = site), size = 3, alpha = 0.9) +
  scale_shape_manual(values = shape_palette_site) +
  scale_fill_manual(values = color_palette_site) +
  geom_smooth(data = delta_continual,
              aes(x = time_since_end, y = continual, group = exp_dates), 
              method = "lm", 
              color = "#000000", alpha = 0.7, size = 1) +
  # new_scale("color") + 
  # overall
  # geom_line(data = predicted_kelp_raw_after_overall, aes(x = x, y = predicted), size = 2) +
  # geom_ribbon(data = predicted_kelp_raw_after_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.4) +
  # geom_line(data = predicted_kelp_raw_during_overall, aes(x = x, y = predicted), size = 2) +
  # geom_ribbon(data = predicted_kelp_raw_during_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.4) +
  scale_x_continuous(breaks = seq(-8, 5, by = 1), minor_breaks = NULL) +
  # scale_y_continuous(breaks = seq(-1500, 1500, by = 1000), limits = c(-1800, 1500)) +
  theme_bw() + 
  theme(axis.title = element_text(size = 16),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 14), 
        legend.position = "none", 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of experiment", y = "Kelp biomass",
      caption = "high point is MOHK on 2019-11-19")

aque_raw <- delta_continual %>% 
  filter(site == "aque") %>% 
  ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  # geom_point(data = delta_continual,
  #            aes(x = time_since_end, y = control, shape = site), size = 3, alpha = 0.4) +
  geom_point(aes(x = time_since_end, y = continual), 
             shape = aque_shape, fill = aque_col, size = 3, alpha = 0.9) +
  geom_smooth(data = delta_continual,
              aes(x = time_since_end, y = continual, group = exp_dates), 
              method = "lm", 
              color = "#000000", alpha = 0.7, size = 1) +
  # new_scale("color") + 
  # overall
  # geom_line(data = predicted_kelp_raw_after_overall, aes(x = x, y = predicted), size = 2) +
  # geom_ribbon(data = predicted_kelp_raw_after_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.4) +
  # geom_line(data = predicted_kelp_raw_during_overall, aes(x = x, y = predicted), size = 2) +
  # geom_ribbon(data = predicted_kelp_raw_during_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.4) +
  scale_x_continuous(breaks = seq(-8, 5, by = 1), minor_breaks = NULL) +
  # scale_y_continuous(breaks = seq(-1500, 1500, by = 1000), limits = c(-1800, 1500)) +
  geom_text(aes(x = -6.6, y = 350), label = "aque", size = 8) +
  theme_bw() + 
  theme(axis.title = element_text(size = 16),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 14), 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of experiment", y = "Kelp biomass")

napl_raw <- delta_continual %>% 
  filter(site == "napl") %>% 
  ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  # geom_point(data = delta_continual,
  #            aes(x = time_since_end, y = control, shape = site), size = 3, alpha = 0.4) +
  geom_point(aes(x = time_since_end, y = continual), 
             shape = napl_shape, fill = napl_col, size = 3, alpha = 0.9) +
  geom_smooth(data = delta_continual,
              aes(x = time_since_end, y = continual, group = exp_dates), 
              method = "lm", 
              color = "#000000", alpha = 0.7, size = 1) +
  # new_scale("color") + 
  # overall
  # geom_line(data = predicted_kelp_raw_after_overall, aes(x = x, y = predicted), size = 2) +
  # geom_ribbon(data = predicted_kelp_raw_after_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.4) +
  # geom_line(data = predicted_kelp_raw_during_overall, aes(x = x, y = predicted), size = 2) +
  # geom_ribbon(data = predicted_kelp_raw_during_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.4) +
  scale_x_continuous(breaks = seq(-8, 5, by = 1), minor_breaks = NULL) +
  # scale_y_continuous(breaks = seq(-1500, 1500, by = 1000), limits = c(-1800, 1500)) +
  geom_text(aes(x = -6.6, y = 590), label = "napl", size = 8) +
  theme_bw() + 
  theme(axis.title = element_text(size = 16),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 14), 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of experiment", y = "Kelp biomass")

mohk_raw <- delta_continual %>% 
  filter(site == "mohk") %>% 
  ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  # geom_point(data = delta_continual,
  #            aes(x = time_since_end, y = control, shape = site), size = 3, alpha = 0.4) +
  geom_point(aes(x = time_since_end, y = continual), 
             shape = mohk_shape, fill = mohk_col, size = 3, alpha = 0.9) +
  geom_smooth(data = delta_continual,
              aes(x = time_since_end, y = continual, group = exp_dates), 
              method = "lm", 
              color = "#000000", alpha = 0.7, size = 1) +
  # new_scale("color") + 
  # overall
  # geom_line(data = predicted_kelp_raw_after_overall, aes(x = x, y = predicted), size = 2) +
  # geom_ribbon(data = predicted_kelp_raw_after_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.4) +
  # geom_line(data = predicted_kelp_raw_during_overall, aes(x = x, y = predicted), size = 2) +
  # geom_ribbon(data = predicted_kelp_raw_during_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.4) +
  scale_x_continuous(breaks = seq(-8, 5, by = 1), minor_breaks = NULL) +
  # scale_y_continuous(breaks = seq(-1500, 1500, by = 1000), limits = c(-1800, 1500)) +
  geom_text(aes(x = -6.6, y = 1800), label = "mohk", size = 8) +
  theme_bw() + 
  theme(axis.title = element_text(size = 16),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 14), 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of experiment", y = "Kelp biomass")

carp_raw <- delta_continual %>% 
  filter(site == "carp") %>% 
  ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  # geom_point(data = delta_continual,
  #            aes(x = time_since_end, y = control, shape = site), size = 3, alpha = 0.4) +
  geom_point(aes(x = time_since_end, y = continual), 
             shape = carp_shape, fill = carp_col, size = 3, alpha = 0.9) +
  geom_smooth(data = delta_continual,
              aes(x = time_since_end, y = continual, group = exp_dates), 
              method = "lm", 
              color = "#000000", alpha = 0.7, size = 1) +
  # new_scale("color") + 
  # overall
  # geom_line(data = predicted_kelp_raw_after_overall, aes(x = x, y = predicted), size = 2) +
  # geom_ribbon(data = predicted_kelp_raw_after_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.4) +
  # geom_line(data = predicted_kelp_raw_during_overall, aes(x = x, y = predicted), size = 2) +
  # geom_ribbon(data = predicted_kelp_raw_during_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.4) +
  scale_x_continuous(breaks = seq(-8, 5, by = 1), minor_breaks = NULL) +
  # scale_y_continuous(breaks = seq(-1500, 1500, by = 1000), limits = c(-1800, 1500)) +
  geom_text(aes(x = -6.6, y = 350), label = "carp", size = 8) +
  theme_bw() + 
  theme(axis.title = element_text(size = 16),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 14), 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of experiment", y = "Kelp biomass")

plots_together <- (aque_raw | napl_raw) / (overall_raw + (mohk_raw/carp_raw)) + 
  plot_layout(ncol = 1, heights = c(0.5, 1)) 


plots_together <- (plot_spacer() / overall / plot_spacer()) | (aque/napl/mohk/carp) 
  
plots_together
# ggsave(here::here("figures", paste("raw_continual-", todays_date, ".jpg", sep = "")), plot = plots_together, height = 8, width = 16, dpi = 150)

```

```{r}
overall_control <- ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(data = delta_continual,
             aes(x = time_since_end, y = control, fill = site, shape = site), size = 3, alpha = 0.9) +
  scale_shape_manual(values = shape_palette_site) +
  scale_fill_manual(values = color_palette_site) +
  geom_smooth(data = delta_continual,
              aes(x = time_since_end, y = control, group = exp_dates), 
              method = "lm", 
              color = "#000000", alpha = 0.7, size = 1) +
  # new_scale("color") + 
  # overall
  # geom_line(data = predicted_kelp_control_after_overall, aes(x = x, y = predicted), size = 2) +
  # geom_ribbon(data = predicted_kelp_control_after_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.4) +
  # geom_line(data = predicted_kelp_control_during_overall, aes(x = x, y = predicted), size = 2) +
  # geom_ribbon(data = predicted_kelp_control_during_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.4) +
  scale_x_continuous(breaks = seq(-8, 5, by = 1), minor_breaks = NULL) +
  # scale_y_continuous(breaks = seq(-1500, 1500, by = 1000), limits = c(-1800, 1500)) +
  theme_bw() + 
  theme(axis.title = element_text(size = 16),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 14), 
        legend.position = "none", 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of experiment", y = "Kelp biomass")

aque_control <- delta_continual %>% 
  filter(site == "aque") %>% 
  ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  # geom_point(data = delta_control,
  #            aes(x = time_since_end, y = control, shape = site), size = 3, alpha = 0.4) +
  geom_point(aes(x = time_since_end, y = control), 
             shape = aque_shape, fill = aque_col, size = 3, alpha = 0.9) +
  geom_smooth(data = delta_continual,
              aes(x = time_since_end, y = control, group = exp_dates), 
              method = "lm", 
              color = "#000000", alpha = 0.7, size = 1) +
  # new_scale("color") + 
  # overall
  # geom_line(data = predicted_kelp_control_after_overall, aes(x = x, y = predicted), size = 2) +
  # geom_ribbon(data = predicted_kelp_control_after_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.4) +
  # geom_line(data = predicted_kelp_control_during_overall, aes(x = x, y = predicted), size = 2) +
  # geom_ribbon(data = predicted_kelp_control_during_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.4) +
  scale_x_continuous(breaks = seq(-8, 5, by = 1), minor_breaks = NULL) +
  # scale_y_continuous(breaks = seq(-1500, 1500, by = 1000), limits = c(-1800, 1500)) +
  geom_text(aes(x = -6.6, y = 350), label = "aque", size = 8) +
  theme_bw() + 
  theme(axis.title = element_text(size = 16),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 14), 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of experiment", y = "Kelp biomass")

napl_control <- delta_continual %>% 
  filter(site == "napl") %>% 
  ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  # geom_point(data = delta_control,
  #            aes(x = time_since_end, y = control, shape = site), size = 3, alpha = 0.4) +
  geom_point(aes(x = time_since_end, y = control), 
             shape = napl_shape, fill = napl_col, size = 3, alpha = 0.9) +
  geom_smooth(data = delta_continual,
              aes(x = time_since_end, y = control, group = exp_dates), 
              method = "lm", 
              color = "#000000", alpha = 0.7, size = 1) +
  # new_scale("color") + 
  # overall
  # geom_line(data = predicted_kelp_control_after_overall, aes(x = x, y = predicted), size = 2) +
  # geom_ribbon(data = predicted_kelp_control_after_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.4) +
  # geom_line(data = predicted_kelp_control_during_overall, aes(x = x, y = predicted), size = 2) +
  # geom_ribbon(data = predicted_kelp_control_during_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.4) +
  scale_x_continuous(breaks = seq(-8, 5, by = 1), minor_breaks = NULL) +
  # scale_y_continuous(breaks = seq(-1500, 1500, by = 1000), limits = c(-1800, 1500)) +
  geom_text(aes(x = -6.6, y = 590), label = "napl", size = 8) +
  theme_bw() + 
  theme(axis.title = element_text(size = 16),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 14), 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of experiment", y = "Kelp biomass")

mohk_control <- delta_continual %>% 
  filter(site == "mohk") %>% 
  ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  # geom_point(data = delta_control,
  #            aes(x = time_since_end, y = control, shape = site), size = 3, alpha = 0.4) +
  geom_point(aes(x = time_since_end, y = control), 
             shape = mohk_shape, fill = mohk_col, size = 3, alpha = 0.9) +
  geom_smooth(data = delta_continual,
              aes(x = time_since_end, y = control, group = exp_dates), 
              method = "lm", 
              color = "#000000", alpha = 0.7, size = 1) +
  # new_scale("color") + 
  # overall
  # geom_line(data = predicted_kelp_control_after_overall, aes(x = x, y = predicted), size = 2) +
  # geom_ribbon(data = predicted_kelp_control_after_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.4) +
  # geom_line(data = predicted_kelp_control_during_overall, aes(x = x, y = predicted), size = 2) +
  # geom_ribbon(data = predicted_kelp_control_during_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.4) +
  scale_x_continuous(breaks = seq(-8, 5, by = 1), minor_breaks = NULL) +
  # scale_y_continuous(breaks = seq(-1500, 1500, by = 1000), limits = c(-1800, 1500)) +
  geom_text(aes(x = -6.6, y = 1800), label = "mohk", size = 8) +
  theme_bw() + 
  theme(axis.title = element_text(size = 16),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 14), 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of experiment", y = "Kelp biomass")

carp_control <- delta_continual %>% 
  filter(site == "carp") %>% 
  ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  # geom_point(data = delta_control,
  #            aes(x = time_since_end, y = control, shape = site), size = 3, alpha = 0.4) +
  geom_point(aes(x = time_since_end, y = control), 
             shape = carp_shape, fill = carp_col, size = 3, alpha = 0.9) +
  geom_smooth(data = delta_continual,
              aes(x = time_since_end, y = control, group = exp_dates), 
              method = "lm", 
              color = "#000000", alpha = 0.7, size = 1) +
  # new_scale("color") + 
  # overall
  # geom_line(data = predicted_kelp_control_after_overall, aes(x = x, y = predicted), size = 2) +
  # geom_ribbon(data = predicted_kelp_control_after_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.4) +
  # geom_line(data = predicted_kelp_control_during_overall, aes(x = x, y = predicted), size = 2) +
  # geom_ribbon(data = predicted_kelp_control_during_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.4) +
  scale_x_continuous(breaks = seq(-8, 5, by = 1), minor_breaks = NULL) +
  # scale_y_continuous(breaks = seq(-1500, 1500, by = 1000), limits = c(-1800, 1500)) +
  geom_text(aes(x = -6.6, y = 350), label = "carp", size = 8) +
  theme_bw() + 
  theme(axis.title = element_text(size = 16),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 14), 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of experiment", y = "Kelp biomass")

plots_together <- (aque_control | napl_control) / (overall_control + (mohk_control/carp_control)) + 
  plot_layout(ncol = 1, heights = c(0.5, 1)) 


plots_together <- (plot_spacer() / overall_control / plot_spacer()) | (aque_control/napl_control/mohk_control/carp_control) 
  
plots_together
ggsave(here::here("figures", paste("raw_control-", todays_date, ".jpg", sep = "")), plot = plots_together, height = 8, width = 16, dpi = 150)
```

# 8. potential manuscript plots

## a. annual removal kelp biomass

```{r}
biomass_by_season_annual_v2
hist

fig2_annual <- biomass_by_season_annual_v2 + hist +
    plot_layout(widths = c(2, 3)) +
  plot_annotation(tag_levels = "A") &
  theme(plot.tag = element_text(size = 24))
fig2_annual

ggsave(here::here("figures", paste("fig2_annual-removal_", todays_date, ".jpg", sep = "")), plot = fig2_annual, height = 8, width = 15, dpi = 150)

biomass_by_season_annual_boxplot
ggsave(here::here("figures", paste("fig1_supp_", todays_date, ".jpg", sep = "")), plot = biomass_by_season_annual_boxplot, height = 8, width = 8, dpi = 150)
```

## b. continual removal kelp biomass

```{r}
overall_ms <- ggplot() +
  geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(data = delta_continual, 
             aes(x = time_since_end, y = delta_continual, fill = site, shape = site), size = 4, alpha = 0.9) +
  scale_shape_manual(values = shape_palette_site, labels = c("aque" = aque_full, "napl" = napl_full, "mohk" = mohk_full, carp = carp_full)) +
  scale_fill_manual(values = color_palette_site, labels = c("aque" = aque_full, "napl" = napl_full, "mohk" = mohk_full, carp = carp_full)) +
  # new_scale("color") + 
  # overall
  geom_line(data = predicted_kelp_after_overall, aes(x = x, y = predicted), size = 2, alpha = 0.7) +
  geom_ribbon(data = predicted_kelp_after_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.2) +
  geom_line(data = predicted_kelp_during_overall, aes(x = x, y = predicted), size = 2, alpha = 0.7) +
  geom_ribbon(data = predicted_kelp_during_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.2) +
  scale_x_continuous(breaks = seq(-8, 6, by = 1), minor_breaks = NULL) +
  scale_y_continuous(breaks = seq(-1500, 1000, by = 1000), limits = c(-1800, 900)) +
  theme_bw() + 
  theme(axis.title = element_text(size = 22),
        axis.text = element_text(size = 20),
        legend.text = element_text(size = 20), 
        legend.title = element_text(size = 20),
        # plot.margin = margin(0, 0, 0, 0),
        legend.position = c(0.12, 0.885)) +
  labs(x = "Time since end of removal (years)", 
       y = expression("\U0394"~giant~kelp~biomass~"(treatment - control, "~dry~g/m^{"2"}~")"), 
       fill = "Site",
       shape = "Site")

overall_ms

fig2 <- sda_kelp_biomass + overall_ms +
  plot_layout(widths = c(2, 3)) +
  plot_annotation(tag_levels = "A") &
  theme(plot.tag = element_text(size = 24))
fig2

fig2_v2 <- overall_ms 
fig2_v2

ggsave(here::here("figures", paste("fig2_", todays_date, ".jpg", sep = "")), plot = overall_ms, height = 8, width = 13, dpi = 150)
```
