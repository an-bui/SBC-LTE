---
title: "understory algae"
author: "An Bui"
date: "5/2/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 0. set up

```{r}
source(here::here("code", "00-set_up.R"))
```

# 1. algae deltas

```{r}
# total biomass
algae_biomass <- biomass %>% 
  filter(new_group == "algae" & sp_code != "MAPY")

# delta biomass
delta_algae_biomass <- biomass %>% 
  filter(new_group == "algae" & sp_code != "MAPY") %>% 
  dplyr::select(site, year, month, treatment, date, dry_gm2) %>% 
  group_by(site, year, month, treatment, date) %>% 
  summarize(total_dry = sum(dry_gm2, na.rm = TRUE)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = treatment, values_from = total_dry) %>% 
  mutate(delta_annual = annual - control,
         delta_continual = continual - control) 

delta_algae_continual <- delta_algae_biomass %>% 
  dplyr::select(site, year, month, date, control, continual, delta_continual) %>% 
  # take out years where continual removal hadn't happened yet
  drop_na(delta_continual) %>% 
  mutate(exp_dates = case_when(
    # after for annual removal:
    site == "aque" & date >= aque_after_date_continual ~ "after",
    site == "napl" & date >= napl_after_date_continual ~ "after",
    site == "mohk" & date >= mohk_after_date_continual ~ "after",
    site == "carp" & date >= carp_after_date_continual ~ "after",
    # everything else is "during" the experiment
    TRUE ~ "during"
  ),
  exp_dates = fct_relevel(exp_dates, c("during", "after"))) %>% 
  time_since_columns_continual() %>% 
  kelp_year_column() %>% 
  comparison_column_continual() %>% 
  # create a new sample ID that is site, year, quarter
  unite("sample_ID", site, date, quarter, remove = FALSE) %>% 
  # create new column that is the column to join with 
  # unite("join_ID", site, date, remove = FALSE) %>% 
  rename("control_algae" = control,
         "continual_algae" = continual,
         "delta_continual_algae" = delta_continual) %>% 
  full_join(., delta_continual %>% dplyr::select(sample_ID, continual, control, delta_continual), by = "sample_ID") %>% 
  left_join(., enframe(sites_full), by = c("site" = "name")) %>% 
  rename("site_full" = value) %>% 
  mutate(site_full = fct_relevel(site_full, "Arroyo Quemado", "Naples", "Mohawk", "Carpinteria"))
```

# 2. algae

## a. annualized delta for site quality

```{r}
algae_annual_means <- delta_algae_annual %>% 
  group_by(site, kelp_year) %>% 
  mutate(mean_delta = mean(delta_annual), 
         mean_tse = mean(time_since_end),
         se_delta = se(delta_annual)) %>% 
  dplyr::select(site, site_full, kelp_year, mean_delta, mean_tse, exp_dates, se_delta) %>% 
  unique() %>% 
  full_join(., site_quality, by = "site")

algae_annual_after_means <- algae_annual_means %>% 
  filter(exp_dates == "after")

linear_model <- lm(mean_delta ~ mean_tse + quality + mean_tse*quality, data = algae_annual_after_means, na.action = na.pass)

linear_model_sel <- lm(mean_delta ~ mean_tse + quality + mean_tse*quality, data = algae_annual_after_means, na.action = na.pass)
summary(linear_model_sel)
plot(simulateResiduals(linear_model_sel))
# ggeffects
predicted <- ggpredict(linear_model_sel, terms = ~ mean_tse + quality + mean_tse*quality, type = "fixed") %>% 
  rename("quality" = group) 
# emmeans
grid <- ref_grid(linear_model_sel, cov.keep = c("mean_tse", "quality"))
emm <- emmeans(grid, spec = c("mean_tse", "quality"), level = 0.95) %>% 
  data.frame(.)

annual_algae_sitequality_ggpredict <- ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  # raw data: means and error bars
  # facet_wrap(~quality, nrow = 1) +
  geom_point(data = algae_annual_means, aes(x = mean_tse, y = mean_delta, color = exp_dates, shape = site)) +
  # geom_errorbar(data = algae_annual_means, aes(x = mean_tse, y = mean_delta, ymin = mean_delta - se_delta, ymax = mean_delta + se_delta, color = exp_dates)) +
  scale_color_manual(values = c("during" = "grey", "after" = "black"), guide = "none") +
  # predicted values
  geom_ribbon(data = predicted, aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high, fill = quality), alpha = 0.5, show.legend = FALSE) +
  geom_line(data = predicted, aes(x = x, y = predicted)) +
  # theme
  theme_bw() + 
  theme(axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10)) +
  labs(x = "Time since end of experiment", y = "\U0394 biomass (treatment - control)",
       title = "Understory algal biomass",
       caption = "ggpredict")

annual_algae_sitequality_emmeans <- ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  facet_wrap(~quality, nrow = 1) +
  geom_point(data = algae_annual_means, aes(x = mean_tse, y = mean_delta, color = exp_dates, shape = site)) +
  scale_color_manual(values = c("during" = "grey", "after" = "black"), guide = "none") +
  # predicted values
  geom_ribbon(data = emm, aes(x = mean_tse, y = emmean, ymin = lower.CL, ymax = upper.CL, fill = quality), alpha = 0.5, show.legend = FALSE) +
  geom_line(data = emm, aes(x = mean_tse, y = emmean, col = quality)) +
  theme_bw() + 
  theme(axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10)) +
  labs(x = "Time since end of experiment", y = "\U0394 biomass (treatment - control)",
       title = "\U0394 annual - annualized data", 
       subtitle = "understory algal biomass", 
       caption = "emmeans")
```

## b. delta algae vs delta kelp
```{r}
cor.test(delta_algae_continual$delta_continual_algae, delta_algae_continual$delta_continual,
         method = "spearman")

delta_algae_vs_kelp <- lm(delta_continual_algae ~ delta_continual, data = delta_algae_continual)
summary(delta_algae_vs_kelp)

# model
delta_algae_vs_kelp_lmer <- lmer(delta_continual_algae ~ delta_continual + (1|year) + (1|site), 
                                data = delta_algae_continual)

# response: algae
# fixed predictor: kelp
# random: site
# ar1 structure

glmm_test <- glmmTMB(delta_continual_algae ~ delta_continual + (1|site) + ar1(year - 1|site),
data = delta_algae_continual %>% mutate(year = as_factor(year)), family = gaussian)
# no convergence?
#   glmmTMB(delta_continual_algae ~ ar1(time_since_start + 0|site), data = delta_algae_continual %>% mutate(time_since_start = as_factor(time_since_start)))
# summary(glmm_test)
plot(simulateResiduals(glmm_test))
MuMIn::r.squaredGLMM(glmm_test)

# summary
summary(delta_algae_vs_kelp_lmer)

# diagnostics (NOT GOOD)
plot(simulateResiduals(delta_algae_vs_kelp_lmer))
check_model(delta_algae_vs_kelp_lmer)
delta_algae_vs_kelp_lmer %>% 
  tbl_regression(intercept = TRUE) %>% 
  bold_p(t = 0.05)
MuMIn::r.squaredGLMM(delta_algae_vs_kelp_lmer)

predicted_delta_algae_vs_kelp <- ggpredict(delta_algae_vs_kelp_lmer, terms = ~ delta_continual, type = "fixed")

delta_algae_continual %>% 
  ggplot(aes(x = delta_continual, y = delta_continual_algae)) +
  geom_hline(aes(yintercept = 0), lty = 2, color = "grey") +
  geom_vline(aes(xintercept = 0), lty = 2, color = "grey") +
  # geom_point(aes(col = comp_3yrs)) +
  # new_scale("color") +
  # stat_summary(aes(group = comp_3yrs), fun = mean, geom = "point", size = 10) +
  # geom_text(aes(label = date)) +
  geom_segment(aes(x = delta_continual, y = delta_continual_algae, 
                   xend = c(tail(delta_continual, n = -1), NA), 
                   yend = c(tail(delta_continual_algae, n = -1), NA), 
                   group = site, color = time_since_end), 
               arrow = arrow(length = unit(0.3, "cm")),
               size = 1) +
  scale_color_gradient2(low = "red", mid = "lightgrey", high = "blue") +
  labs(x = "\U0394 kelp biomass (treatment - control)", 
       y = "\U0394 understory algae biomass (treatment - control)") +
  theme_bw() + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        strip.text = element_text(size = 14),
        strip.background = element_rect(fill = "#FFFFFF")) +
  facet_wrap(~site)



delta_algae_continual %>% 
  ggplot(aes(x = control, y = control_algae)) +
  geom_hline(aes(yintercept = 0), lty = 2, color = "grey") +
  geom_vline(aes(xintercept = 0), lty = 2, color = "grey") +
  # geom_point(aes(col = comp_3yrs)) +
  # new_scale("color") +
  # stat_summary(aes(group = comp_3yrs), fun = mean, geom = "point", size = 10) +
  # geom_text(aes(label = date)) +
  geom_segment(aes(x = control, y = control_algae, 
                   xend = c(tail(control, n = -1), NA), 
                   yend = c(tail(control_algae, n = -1), NA), 
                   group = site, color = time_since_end), 
               arrow = arrow(length = unit(0.3, "cm")),
               size = 1) +
  scale_color_gradient2(low = "red", mid = "lightgrey", high = "blue") +
  labs(x = "kelp biomass",
       y = "understory algae biomass") +
  theme_bw() + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        strip.text = element_text(size = 14),
        strip.background = element_rect(fill = "#FFFFFF")) +
  facet_wrap(~site, scale = "free")

algae_vs_kelp <- delta_algae_continual %>% 
  mutate(exp_dates = case_when(
    exp_dates == "during" ~ "During removal",
    exp_dates == "after" ~ "Post-removal"
  )) %>% 
  ggplot(aes(x = delta_continual, y = delta_continual_algae)) +
  geom_hline(aes(yintercept = 0), lty = 3, color = "grey") +
  geom_vline(aes(xintercept = 0), lty = 3, color = "grey") +
  geom_point(aes(shape = exp_dates, fill = exp_dates), size = 5, shape = 21) + 
  geom_line(data = predicted_delta_algae_vs_kelp, aes(x = x, y = predicted), size = 2) +
  scale_linetype_manual(values = c("During removal" = 2, "Post-removal" = 1)) +
  scale_fill_manual(values = c("During removal" = "#FFFFFF", "Post-removal" = under_col)) +
  scale_x_continuous(breaks = seq(-2000, 2000, by = 1000), minor_breaks = seq(-2000, 2000, by = 500)) +
  labs(x = "\U0394 kelp biomass (treatment - control)",
       y = "\U0394 understory algae biomass (treatment - control)") +
  theme_bw() + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        strip.text = element_text(size = 14),
        legend.position = c(0.9, 0.9),
        legend.text = element_text(size = 18),
        legend.title = element_blank())

algae_vs_kelp_spearman <- delta_algae_continual %>% 
  mutate(exp_dates = case_when(
    exp_dates == "during" ~ "During removal",
    exp_dates == "after" ~ "Post-removal"
  )) %>% 
  ggplot(aes(x = delta_continual, y = delta_continual_algae)) +
  geom_hline(aes(yintercept = 0), lty = 2) +
  geom_vline(aes(xintercept = 0), lty = 2) +
  geom_point(aes(shape = exp_dates, fill = exp_dates), size = 5, shape = 21) +
  stat_cor(method = "spearman", cor.coef.name = "rho") +
  geom_smooth(method = "lm", color = "black", size = 3, se = FALSE) +
  scale_linetype_manual(values = c("During removal" = 2, "Post-removal" = 1)) +
  scale_fill_manual(values = c("During removal" = "#FFFFFF", "Post-removal" = under_col)) +
  scale_x_continuous(breaks = seq(-2000, 2000, by = 1000), minor_breaks = seq(-2000, 2000, by = 500)) +
  labs(x = "\U0394 kelp biomass (treatment - control)",
       y = "\U0394 understory algae biomass (treatment - control)") +
  theme_bw() + 
  theme(axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        legend.position = c(0.83, 0.93),
        legend.text = element_text(size = 18),
        legend.title = element_blank())

delta_algae_continual %>% 
  ggplot(aes(x = continual, y = continual_algae)) +
  geom_hline(aes(yintercept = 0), lty = 3, color = "grey") +
  geom_vline(aes(xintercept = 0), lty = 3, color = "grey") +
  geom_point(aes(shape = exp_dates, fill = exp_dates), size = 5, shape = 21) + 
  scale_fill_manual(values = c("during" = "#FFFFFF", after = under_col)) +
  scale_x_continuous(breaks = seq(-2000, 2000, by = 1000), minor_breaks = seq(-2000, 2000, by = 500)) +
  labs(x = "kelp biomass",
       y = "understory algae biomass") +
  theme_bw() + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        strip.text = element_text(size = 14),
        legend.position = c(0.9, 0.9),
        legend.text = element_text(size = 18),
        legend.title = element_blank())

delta_algae_continual %>% 
  group_by(site, kelp_year) %>% 
  mutate(mean_delta_kelp = mean(delta_continual),
         mean_algae = mean(delta_continual_algae)) %>% 
  ggplot(aes(x = mean_delta_kelp, y = mean_algae)) +
  geom_hline(aes(yintercept = 0), lty = 3, color = "grey") +
  geom_vline(aes(xintercept = 0), lty = 3, color = "grey") +
  geom_point(size = 5, aes(fill = year, shape = site), alpha = 0.8) +
  scale_shape_manual(values = shape_palette_site) +
  geom_line(data = predicted_delta_algae_vs_kelp, aes(x = x, y = predicted), size = 2) +
  labs(x = "\U0394 kelp biomass (treatment - control)",
       y = "\U0394 understory algae biomass (treatment - control)",
       caption = "marginal R2 = 0.028, conditional R2 = 0.519") +
  theme_bw() + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        strip.text = element_text(size = 14),
        legend.position = c(0.9, 0.7),
        legend.text = element_text(size = 18),
        legend.title = element_blank())
```

## c. delta algae as a function of time since end of experiment
```{r}
algae_continual_after <- delta_algae_continual %>% 
  filter(exp_dates == "after") 
  # influential point - remove?
  # filter(sample_ID != "mohk_2017-08-11_Q3")

# model
linear_model_algae_lmer <- lmer(delta_continual_algae ~ time_since_end + (1|site), data = algae_continual_after, na.action = na.pass)

# check
plot(simulateResiduals(linear_model_algae_lmer))
check_model(linear_model_algae_lmer)

# summary
summary(linear_model_algae_lmer)

# R2
MuMIn::r.squaredGLMM(linear_model_algae_lmer)

# table
algae_after <- linear_model_algae_lmer %>% 
  tbl_regression() %>% 
  bold_p(t = 0.05)
algae_after

linear_model_algae_lmer_during <- lmer(delta_continual_algae ~ time_since_end + (1|site), data = delta_algae_continual %>% filter(exp_dates == "during"), na.action = na.pass)

summary(linear_model_algae_lmer_during)

algae_during <- linear_model_algae_lmer_during %>% 
  tbl_regression() %>% 
  bold_p(t = 0.05)
algae_during

algae_tables <- tbl_merge(tbls = list(algae_during, algae_after),
                          tab_spanner = c("**Removal**", "**Recovery**"))

MuMIn::r.squaredGLMM(linear_model_algae_lmer_during)
# ggeffects
predicted_algae_after <- ggpredict(linear_model_algae_lmer, terms = ~ time_since_end, type = "fixed")
predicted_algae_during <- ggpredict(linear_model_algae_lmer_during, terms = ~ time_since_end, type = "fixed")

algae_time <- ggplot() +
  geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(data = delta_algae_continual, 
             aes(x = time_since_end, y = delta_continual_algae, fill = site, shape = site), size = 4, alpha = 0.9) +
  scale_shape_manual(values = shape_palette_site, labels = c("aque" = aque_full, "napl" = napl_full, "mohk" = mohk_full, carp = carp_full)) +
  scale_fill_manual(values = color_palette_site, labels = c("aque" = aque_full, "napl" = napl_full, "mohk" = mohk_full, carp = carp_full)) +
  # new_scale("color") + 
  # overall
  geom_line(data = predicted_algae_after, aes(x = x, y = predicted), size = 2, alpha = 0.7) +
  geom_ribbon(data = predicted_algae_after, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.2) +
  geom_line(data = predicted_algae_during, aes(x = x, y = predicted), size = 2, alpha = 0.7) +
  geom_ribbon(data = predicted_algae_during, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.2) +
  scale_x_continuous(breaks = seq(-8, 6, by = 1), minor_breaks = NULL) +
  # scale_y_continuous(breaks = seq(-250, 750, by = 250), limits = c(-250, 750)) +
  theme_bw() + 
  theme(axis.title = element_text(size = 22),
        axis.text = element_text(size = 20),
        legend.text = element_text(size = 18), 
        legend.title = element_text(size = 18),
        legend.position = c(0.8, 0.82), 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of removal (years)",
       y = "\U0394 understory algae biomass \n (treatment - control)",
       fill = "Site", shape = "Site")

algae_time

raw_algae_time <- ggplot(delta_algae_continual, aes(x = time_since_end, y = control_algae)) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(aes(fill = site, shape = site), size = 3, alpha = 0.9) +
  scale_shape_manual(values = shape_palette_site) +
  scale_fill_manual(values = color_palette_site) +
  # new_scale("color") + 
  # overall
  geom_smooth(aes(group = exp_dates), method = "lm") +
  scale_x_continuous(breaks = seq(-8, 5, by = 1), minor_breaks = NULL) +
  # scale_y_continuous(breaks = seq(-250, 750, by = 250), limits = c(-250, 750)) +
  theme_bw() + 
  theme(axis.title = element_text(size = 16),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 14), 
        # legend.position = c(0.08, 0.9), 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of removal", y = expression(understory~algal~biomass~(g/m^{"2"})))
```

## d. start-during-after

### i. anova

```{r}
# anova with random effect
algae_anova <- lmer(delta_continual_algae ~ comp_2yrs + (1|site), data = delta_algae_continual %>% drop_na(comp_2yrs))
# summary with p value
summary(algae_anova)
anova(algae_anova)
# table
algae_anova %>% 
  tbl_regression() %>% 
  bold_p(t = 0.05)
# least squares comparison
difflsmeans(algae_anova, test.effs = "Group", ddf = "Kenward-Roger")
# extract predicted values
algae_anova_df <- ggpredict(algae_anova, terms = "comp_2yrs", type = "fixed") %>% 
  mutate(x = case_when(
    x == "start" ~ "Start of removal",
    x == "during" ~ "End of removal",
    x == "after" ~ "Recovery period"
  )) %>% 
  mutate(x = fct_relevel(x, "Start of removal", "End of removal", "Recovery period"))

# plot
sda_algae_biomass <- ggplot(algae_anova_df) +
  # horizontal line at 0
  geom_hline(yintercept = 0, lty = 2) +
  # points and error bars
  geom_point(aes(x = x, y = predicted), size = 6) +
  geom_errorbar(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error), width = 0.2) +
  # path between time periods
  geom_line(aes(x = x, y = predicted, group = 1)) +
  # add in post-hoc comparisons
  annotate("text", x = 1, y = 125, label = "a", size = 11) +
  annotate("text", x = 2, y = 125, label = "b", size = 11) +
  annotate("text", x = 3, y = 125, label = "a", size = 11) +
  # aesthetics
  scale_x_discrete(labels = wrap_format(10)) +
  scale_y_continuous(limits = c(-30, 130)) +
  theme_bw() +
  theme(axis.title = element_text(size = 22),
        axis.text = element_text(size = 20),
        legend.text = element_text(size = 20), 
        legend.title = element_text(size = 20),
        # plot.margin = margin(0, 0, 0, 0),
        panel.grid.minor = element_line(color = "white")) +
  labs(x = "Time period", 
       y = expression(Understory~algae~biomass~(dry~g/m^{"2"})))
sda_algae_biomass
```


## e. algae vs kelp timeseries

```{r}
ggplot(data = delta_algae_continual) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(aes(x = time_since_end, y = delta_continual_algae), alpha = 0.7) +
  geom_point(aes(x = time_since_end, y = delta_continual), alpha = 0.7, col = "blue") +
  # predicted values for algae
  geom_line(data = predicted_algae_after, aes(x = x, y = predicted), size = 2, alpha = 0.7) +
  geom_ribbon(data = predicted_algae_after, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.2) +
  geom_line(data = predicted_algae_during, aes(x = x, y = predicted), size = 2, alpha = 0.7) +
  geom_ribbon(data = predicted_algae_during, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.2) +
  # predicted values for kelp
  geom_line(data = predicted_kelp_after_overall, aes(x = x, y = predicted), size = 2, alpha = 0.7, col = "blue") +
  geom_ribbon(data = predicted_kelp_after_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.2, fill = "blue") +
  geom_line(data = predicted_kelp_during_overall, aes(x = x, y = predicted), size = 2, alpha = 0.7, col = "blue") +
  geom_ribbon(data = predicted_kelp_during_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.2, fill = "blue") +
  annotate("text", x = -6.5, y = 600, label = "algae", size = 12) +
  annotate("text", x = -6.5, y = -1500, label = "kelp", size = 12, col = "blue") +
  theme_bw() + 
  theme(axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        legend.text = element_text(size = 16), 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of removal", y = "\U0394 biomass (treatment - control)")
```

## f. raw algae biomass

```{r}
delta_continual_sites_algae_raw <- delta_algae_continual %>% 
  mutate(strip = case_when(
    site == "aque" ~ paste("A. ", site_full, sep = ""),
    site == "napl" ~ paste("B. ", site_full),
    site == "mohk" ~ paste("C. ", site_full),
    site == "carp" ~ paste("D. ", site_full)
  )) %>% 
  ggplot() +
  geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_line(aes(x = time_since_end, y = control_algae, col = site), alpha = 0.5, size = 2.5) +
  # control
  geom_point(aes(x = time_since_end, y = control_algae, shape = site), size = 1.5, alpha = 0.5, fill = "#FFFFFF") +
  # continual
  geom_line(aes(x = time_since_end, y = continual_algae, col = site), size = 2.5) +
  geom_point(aes(x = time_since_end, y = continual_algae, shape = site, col = site), size = 1.5, fill = "#FFFFFF") +
  scale_shape_manual(values = shape_palette_site) +
  scale_color_manual(values = color_palette_site) +
  scale_fill_manual(values = color_palette_site) +
  theme_bw() + 
  scale_x_continuous(breaks = seq(-8, 6, by = 1), minor_breaks = NULL) +
  theme(axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        legend.text = element_text(size = 16), 
        legend.position = "none", 
        strip.background = element_rect(fill = "white", color = "white"),
        strip.text = element_text(size = 20, hjust = 0),
        panel.grid.minor = element_line(color = "white")) +
  labs(x = "Time since end of experiment (years)", 
       y = expression(Understory~algae~biomass~(dry~g/m^{"2"}))) +
  facet_wrap(~strip, scales = "free_y")

delta_continual_sites_algae_raw

ggsave(here::here("figures", paste("delta_continual_sites_algae_raw-", todays_date, ".jpg", sep = "")), plot = delta_continual_sites_algae_raw, height = 8, width = 16, dpi = 150)
```


# 3. sessile invert deltas

```{r}
# total biomass
invert_biomass <- biomass %>% 
  filter(new_group == "epilithic.sessile.invert") %>% 
  # # take out piddocks?
  filter(taxon_family != "Pholadidae")

# delta biomass
delta_invert_biomass <- biomass %>% 
  filter(new_group == "epilithic.sessile.invert") %>% 
  # # take out piddocks?
  filter(taxon_family != "Pholadidae") %>% 
  dplyr::select(site, year, month, treatment, date, dry_gm2) %>% 
  group_by(site, year, month, treatment, date) %>% 
  summarize(total_dry = sum(dry_gm2, na.rm = TRUE)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = treatment, values_from = total_dry) %>% 
  mutate(delta_annual = annual - control,
         delta_continual = continual - control) 

delta_invert_annual <- delta_invert_biomass %>% 
  dplyr::select(site, year, month, date, control, annual, delta_annual) %>% 
  drop_na(delta_annual) %>% 
  mutate(exp_dates = case_when(
    # after for annual removal:
    site == "aque" & date >= aque_after_date_annual ~ "after",
    site == "napl" & date >= napl_after_date_annual ~ "after",
    site == "ivee" & date >= ivee_after_date_annual ~ "after",
    site == "mohk" & date >= mohk_after_date_annual ~ "after",
    site == "carp" & date >= carp_after_date_annual ~ "after",
    # everything else is "during" the experiment
    TRUE ~ "during"
  ),
  exp_dates = fct_relevel(exp_dates, c("during", "after"))) %>% 
   # create a column for quarter
  mutate(quarter = case_when(
    month <= 3 ~ "Q1",
    month <= 6 ~ "Q2",
    month <= 9 ~ "Q3",
    TRUE ~ "Q4"
  )) %>% 
  # calculate time since start of experiment
  mutate(time_yrs = case_when(
    # AQUE, NAPL, MOHK, CARP: control and annual started in 2008
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q1" ~ year + 0.125 - 2008,
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q2" ~ year + 0.375 - 2008,
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q3" ~ year + 0.625 - 2008,
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q4" ~ year + 0.875 - 2008, 
    # IVEE control and annual started in 2011
    site == "ivee" & quarter == "Q1" ~ year + 0.125 - 2011,
    site == "ivee" & quarter == "Q2" ~ year + 0.375 - 2011,
    site == "ivee" & quarter == "Q3" ~ year + 0.625 - 2011,
    site == "ivee" & quarter == "Q4" ~ year + 0.875 - 2011
    )) %>% 
  group_by(site) %>% 
  mutate(time_since_start = time_yrs - min(time_yrs)) %>% 
  ungroup() %>% 
  # calculate time since end of experiment
  group_by(site, exp_dates) %>% 
  # if "after", then simple: the time in years - the minimum time in years
  # if "during", then more complex: take the max time in years and add 0.25, then subtract the time in years
  mutate(time_since_end = case_when(
    exp_dates == "during" ~ -(max(time_yrs) + 0.25 - time_yrs),
    exp_dates == "after" ~ time_yrs - min(time_yrs)
  )) %>% 
  ungroup() %>% 
  left_join(., enframe(sites_full), by = c("site" = "name")) %>% 
  rename(site_full = value) %>% 
  mutate(site_full = fct_relevel(site_full, "Arroyo Quemado (AQUE)", "Naples (NAPL)", "Isla Vista (IVEE)", "Mohawk (MOHK)", "Carpinteria (CARP)")) %>% 
  # create a new column for "kelp year"
  mutate(quarter = fct_relevel(quarter, "Q2", "Q3", "Q4", "Q1")) %>% 
  mutate(kelp_year = case_when(
    quarter %in% c("Q2", "Q3", "Q4") ~ year,
    quarter == "Q1" ~ year - 1
  )) %>% 
  mutate(kelp_year = paste("kelp_", kelp_year, "-", kelp_year + 1, sep = "")) %>% 
  # create a column for the points to compare for "2 year interval"
  mutate(comp_2yrs = case_when(
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2008-2009", "kelp_2009-2010") ~ "start",
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2015-2016", "kelp_2016-2017") ~ "during", 
    site == "ivee" & kelp_year %in% c("kelp_2011-2012", "kelp_2012-2013") ~ "start",
    site == "ivee" & kelp_year %in% c("kelp_2015-2016", "kelp_2016-2017") ~ "during",
    kelp_year %in% c("kelp_2020-2021", "kelp_2021-2022") ~ "after"
  )) %>% 
  mutate(comp_2yrs = fct_relevel(comp_2yrs, "start", "during", "after")) %>% 
  # create a column for the points to compare for "3 year interval"
  mutate(comp_3yrs = case_when(
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2008-2009", "kelp_2009-2010", "kelp_2010-2011") ~ "start",
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2014-2015", "kelp_2015-2016", "kelp_2016-2017") ~ "during", 
    site == "ivee" & kelp_year %in% c("kelp_2011-2012", "kelp_2012-2013", "kelp_2013-2014") ~ "start",
    site == "ivee" & kelp_year %in% c("kelp_2014-2015", "kelp_2015-2016", "kelp_2016-2017") ~ "during",
    kelp_year %in% c("kelp_2019-2020", "kelp_2020-2021", "kelp_2021-2022") ~ "after"
  )) %>% 
  mutate(comp_3yrs = fct_relevel(comp_3yrs, "start", "during", "after"))

delta_invert_continual <- delta_invert_biomass %>% 
  dplyr::select(site, year, month, date, control, continual, delta_continual) %>% 
  # take out years where continual removal hadn't happened yet
  drop_na(delta_continual) %>% 
  mutate(exp_dates = case_when(
    # after for annual removal:
    site == "aque" & date >= aque_after_date_continual ~ "after",
    site == "napl" & date >= napl_after_date_continual ~ "after",
    site == "mohk" & date >= mohk_after_date_continual ~ "after",
    site == "carp" & date >= carp_after_date_continual ~ "after",
    # everything else is "during" the experiment
    TRUE ~ "during"
  ),
  exp_dates = fct_relevel(exp_dates, c("during", "after"))) %>% 
  time_since_columns_continual() %>% 
  kelp_year_column() %>% 
  comparison_column_continual() %>% 
  # create a new sample ID that is site, year, quarter
  unite("sample_ID", site, date, quarter, remove = FALSE) %>% 
  # create new column that is the column to join with 
  # unite("join_ID", site, date, remove = FALSE) %>% 
  rename("control_inverts" = control,
         "continual_inverts" = continual,
         "delta_continual_inverts" = delta_continual) %>% 
  full_join(., delta_continual %>% dplyr::select(sample_ID, continual, control, delta_continual), by = "sample_ID") %>% 
  left_join(., enframe(sites_full), by = c("site" = "name")) %>% 
  rename("site_full" = value) %>% 
  mutate(site_full = fct_relevel(site_full, "Arroyo Quemado", "Naples", "Mohawk", "Carpinteria"))
```

# 4. inverts

## a. annualized data for inverts

```{r}
invert_annual_means <- delta_invert_annual %>% 
  group_by(site, kelp_year) %>% 
  mutate(mean_delta = mean(delta_annual), 
         mean_tse = mean(time_since_end),
         se_delta = se(delta_annual)) %>% 
  dplyr::select(site, site_full, kelp_year, mean_delta, mean_tse, exp_dates, se_delta) %>% 
  unique() %>% 
  full_join(., site_quality, by = "site")

invert_annual_after_means <- invert_annual_means %>% 
  filter(exp_dates == "after")

linear_model <- lm(mean_delta ~ mean_tse + quality + mean_tse*quality, data = invert_annual_after_means, na.action = na.pass)
dredge(linear_model) %>% 
  model.sel() %>% 
  gt()
linear_model_sel <- lm(mean_delta ~ mean_tse + quality + mean_tse*quality, data = invert_annual_after_means, na.action = na.pass)
summary(linear_model_sel)
plot(simulateResiduals(linear_model_sel))
# ggeffects
predicted <- ggpredict(linear_model_sel, terms = ~ mean_tse + quality + mean_tse*quality, type = "fixed") %>% 
  rename("quality" = group) 
# emmeans
grid <- ref_grid(linear_model_sel, cov.keep = c("mean_tse", "quality"))
emm <- emmeans(grid, spec = c("mean_tse", "quality"), level = 0.95) %>% 
  data.frame(.)

annual_invert_sitequality_ggpredict <- ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  # raw data: means and error bars
  # facet_wrap(~quality, nrow = 1) +
  geom_point(data = invert_annual_means, aes(x = mean_tse, y = mean_delta, color = exp_dates, shape = site)) +
  # geom_smooth(data = invert_annual_means, aes(x = mean_tse, y = mean_delta, color = exp_dates), method = "lm") +
  # geom_errorbar(data = algae_annual_means, aes(x = mean_tse, y = mean_delta, ymin = mean_delta - se_delta, ymax = mean_delta + se_delta, color = exp_dates)) +
  scale_color_manual(values = c("during" = "grey", "after" = "black"), guide = "none") +
  # predicted values
  geom_ribbon(data = predicted, aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high, fill = quality), alpha = 0.5, show.legend = FALSE) +
  geom_line(data = predicted, aes(x = x, y = predicted)) +
  facet_wrap(~quality) +
  # theme
  theme_bw() + 
  theme(axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10)) +
  labs(x = "Time since end of experiment", y = "\U0394 biomass (treatment - control)",
       title = "Sessile invert biomass",
       caption = "ggpredict")

annual_algae_sitequality_emmeans <- ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  facet_wrap(~quality, nrow = 1) +
  geom_point(data = invert_annual_means, aes(x = mean_tse, y = mean_delta, color = exp_dates, shape = site)) +
  scale_color_manual(values = c("during" = "grey", "after" = "black"), guide = "none") +
  # predicted values
  geom_ribbon(data = emm, aes(x = mean_tse, y = emmean, ymin = lower.CL, ymax = upper.CL, fill = quality), alpha = 0.5, show.legend = FALSE) +
  geom_line(data = emm, aes(x = mean_tse, y = emmean, col = quality)) +
  theme_bw() + 
  theme(axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10)) +
  labs(x = "Time since end of experiment", y = "\U0394 biomass (treatment - control)",
       title = "\U0394 annual - annualized data", 
       subtitle = "sessile invert biomass", 
       caption = "emmeans")
```

```{r}
plots_together <- (annual_kelp_sitequality_ggpredict / annual_algae_sitequality_ggpredict / annual_invert_sitequality_ggpredict) +
  plot_layout(guides = "collect")
plots_together
```

## b. delta inverts vs delta kelp

```{r}
cor.test(delta_invert_continual$delta_continual_inverts, delta_invert_continual$delta_continual,
         method = "spearman")

delta_invert_vs_kelp <- lm(delta_continual_inverts ~ delta_continual, data = delta_invert_continual)
summary(delta_invert_vs_kelp)

delta_invert_vs_kelp_lmer <- lmer(delta_continual_inverts ~ delta_continual + (1|year) + (1|site), 
                                data = delta_invert_continual)
summary(delta_invert_vs_kelp_lmer)
plot(simulateResiduals(delta_invert_vs_kelp_lmer))
MuMIn::r.squaredGLMM(delta_invert_vs_kelp_lmer)

predicted_delta_invert_vs_kelp <- ggpredict(delta_invert_vs_kelp_lmer, terms = ~ delta_continual, type = "fixed")

delta_invert_continual %>% 
  ggplot(aes(x = delta_continual, y = delta_continual_inverts)) +
  geom_hline(aes(yintercept = 0), lty = 2, color = "grey") +
  geom_vline(aes(xintercept = 0), lty = 2, color = "grey") +
  # geom_point(aes(col = comp_3yrs)) +
  # new_scale("color") +
  # stat_summary(aes(group = comp_3yrs), fun = mean, geom = "point", size = 10) +
  # geom_text(aes(label = date)) +
  geom_segment(aes(x = delta_continual, y = delta_continual_inverts, 
                   xend = c(tail(delta_continual, n = -1), NA), 
                   yend = c(tail(delta_continual_inverts, n = -1), NA), 
                   group = site, color = time_since_end), 
               arrow = arrow(length = unit(0.3, "cm")),
               size = 1) +
  scale_color_gradient2(low = "red", mid = "lightgrey", high = "blue") +
  labs(x = "\U0394 kelp biomass (treatment - control)",
       y = "\U0394 invert biomass (treatment - control)") +
  theme_bw() + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        strip.text = element_text(size = 14),
        strip.background = element_rect(fill = "#FFFFFF")) +
  facet_wrap(~site, scale = "free")

delta_invert_continual %>% 
  ggplot(aes(x = continual, y = continual_inverts)) +
  geom_hline(aes(yintercept = 0), lty = 2, color = "grey") +
  geom_vline(aes(xintercept = 0), lty = 2, color = "grey") +
  # geom_point(aes(col = comp_3yrs)) +
  # new_scale("color") +
  # stat_summary(aes(group = comp_3yrs), fun = mean, geom = "point", size = 10) +
  # geom_text(aes(label = date)) +
  geom_segment(aes(x = continual, y = continual_inverts, 
                   xend = c(tail(continual, n = -1), NA), 
                   yend = c(tail(continual_inverts, n = -1), NA), 
                   group = site, color = time_since_end), 
               arrow = arrow(length = unit(0.3, "cm")),
               size = 1) +
  scale_color_gradient2(low = "red", mid = "lightgrey", high = "blue") +
  labs(x = "kelp biomass",
       y = "invert biomass") +
  theme_bw() + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        strip.text = element_text(size = 14),
        strip.background = element_rect(fill = "#FFFFFF")) +
  facet_wrap(~site, scale = "free")

inverts_vs_kelp <- delta_invert_continual %>% 
  ggplot(aes(x = delta_continual, y = delta_continual_inverts)) +
  geom_hline(aes(yintercept = 0), lty = 3, color = "grey") +
  geom_vline(aes(xintercept = 0), lty = 3, color = "grey") +
  geom_point(aes(shape = exp_dates, fill = exp_dates), size = 5, shape = 25) + 
  geom_line(data = predicted_delta_invert_vs_kelp, aes(x = x, y = predicted), size = 2) +
  scale_linetype_manual(values = c("during" = 2, "after" = 1)) +
  scale_fill_manual(values = c("during" = "#FFFFFF", after = ivee_col)) +
  scale_x_continuous(breaks = seq(-2000, 2000, by = 1000), minor_breaks = seq(-2000, 2000, by = 500)) +
  labs(x = "\U0394 kelp biomass (treatment - control)",
       y = "\U0394 invert biomass (treatment - control)") +
  theme_bw() + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        strip.text = element_text(size = 14),
        legend.position = c(0.9, 0.9),
        legend.text = element_text(size = 18),
        legend.title = element_blank())

inverts_vs_kelp_spearman <- delta_invert_continual %>% 
  mutate(exp_dates = case_when(
    exp_dates == "during" ~ "During removal",
    exp_dates == "after" ~ "Post-removal"
  )) %>% 
  ggplot(aes(x = delta_continual, y = delta_continual_inverts)) +
  stat_cor(method = "spearman", cor.coef.name = "rho") +
  geom_hline(aes(yintercept = 0), lty = 2) +
  geom_vline(aes(xintercept = 0), lty = 2) +
  geom_point(aes(shape = exp_dates, fill = exp_dates), size = 5, shape = 25) + 
  geom_smooth(method = "lm", se = FALSE, color = "black", size = 3) +
  scale_linetype_manual(values = c("During removal" = 2, "Post-removal" = 1)) +
  scale_fill_manual(values = c("During removal" = "#FFFFFF", "Post-removal" = "darkblue")) +
  scale_x_continuous(breaks = seq(-2000, 2000, by = 1000), minor_breaks = seq(-2000, 2000, by = 500)) +
  labs(x = "\U0394 kelp biomass (treatment - control)",
       y = "\U0394 epilithic invertebrate biomass (treatment - control)") +
  theme_bw() + 
  theme(axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        legend.position = c(0.83, 0.93),
        legend.text = element_text(size = 18),
        legend.title = element_blank())

delta_invert_continual %>% 
  ggplot(aes(x = continual, y = continual_inverts)) +
  geom_hline(aes(yintercept = 0), lty = 3, color = "grey") +
  geom_vline(aes(xintercept = 0), lty = 3, color = "grey") +
  geom_point(aes(shape = exp_dates, fill = exp_dates), size = 5, shape = 24) + 
  scale_fill_manual(values = c("during" = "#FFFFFF", after = carp_col)) +
  scale_x_continuous(breaks = seq(-2000, 2000, by = 1000), minor_breaks = seq(-2000, 2000, by = 500)) +
  labs(x = "kelp biomass",
       y = "epilithic invert biomass") +
  theme_bw() + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        strip.text = element_text(size = 14),
        legend.position = c(0.9, 0.9),
        legend.text = element_text(size = 18),
        legend.title = element_blank())

```

## c. delta inverts as a function of time since end

```{r}
invert_continual_after <- delta_invert_continual %>% 
  filter(exp_dates == "after")

# model
linear_model_invert_lmer <- lmer(delta_continual_inverts ~ time_since_end + (1|site), data = invert_continual_after, na.action = na.pass)

# check
plot(simulateResiduals(linear_model_invert_lmer))
summary(linear_model_invert_lmer)

# R2
MuMIn::r.squaredGLMM(linear_model_invert_lmer)

# summary table
epi_invert_after <- linear_model_invert_lmer %>% 
  tbl_regression() %>% 
  bold_p(t = 0.05)
epi_invert_after

# model
linear_model_invert_lmer_during <- lmer(delta_continual_inverts ~ time_since_end + (1|site), data = delta_invert_continual %>% filter(exp_dates == "during"), na.action = na.pass)

# summary
summary(linear_model_invert_lmer_during) 

# R2
MuMIn::r.squaredGLMM(linear_model_invert_lmer_during)

# summary table
epi_invert_during <- linear_model_invert_lmer_during %>% 
  tbl_regression() %>% 
  bold_p(t = 0.05)

epi_invert_tables <- tbl_merge(tbls = list(epi_invert_during, epi_invert_after))

# ggeffects
predicted_invert_after <- ggpredict(linear_model_invert_lmer, terms = ~ time_since_end, type = "fixed")
predicted_invert_during <- ggpredict(linear_model_invert_lmer_during, terms = ~ time_since_end, type = "fixed")

invert_time <- ggplot() +
  geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(data = delta_invert_continual, 
             aes(x = time_since_end, y = delta_continual_inverts, fill = site, shape = site), size = 4, alpha = 0.9) +
  scale_shape_manual(values = shape_palette_site, labels = c("aque" = aque_full, "napl" = napl_full, "mohk" = mohk_full, carp = carp_full)) +
  scale_fill_manual(values = color_palette_site, labels = c("aque" = aque_full, "napl" = napl_full, "mohk" = mohk_full, carp = carp_full)) +
  # new_scale("color") + 
  # overall
  # geom_line(data = predicted_invert_after, aes(x = x, y = predicted), size = 2, alpha = 0.7) +
  # geom_ribbon(data = predicted_invert_after, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.2) +
  geom_line(data = predicted_invert_during, aes(x = x, y = predicted), size = 2, alpha = 0.7) +
  geom_ribbon(data = predicted_invert_during, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.2) +
  scale_x_continuous(breaks = seq(-8, 6, by = 1), minor_breaks = NULL) +
  # scale_y_continuous(breaks = seq(-250, 750, by = 250), limits = c(-250, 750)) +
  theme_bw() + 
  theme(axis.title = element_text(size = 22),
        axis.text = element_text(size = 20),
        legend.text = element_text(size = 20), 
        legend.title = element_text(size = 20),
        legend.position = "none", 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of removal (years)", 
       y = "\U0394 epilithic invert biomass \n (treatment - control)")
invert_time
```

### raw invert biomass
```{r}
delta_continual_sites_inverts_raw <- delta_invert_continual %>% 
  mutate(strip = case_when(
    site == "aque" ~ paste("A. ", site_full, sep = ""),
    site == "napl" ~ paste("B. ", site_full),
    site == "mohk" ~ paste("C. ", site_full),
    site == "carp" ~ paste("D. ", site_full)
  )) %>% 
  ggplot() +
  geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_line(aes(x = time_since_end, y = control_inverts, col = site), alpha = 0.5, size = 2.5) +
  # control
  geom_point(aes(x = time_since_end, y = control_inverts, shape = site), size = 1.5, alpha = 0.5, fill = "#FFFFFF") +
  # continual
  geom_line(aes(x = time_since_end, y = continual_inverts, col = site), size = 2.5) +
  geom_point(aes(x = time_since_end, y = continual_inverts, shape = site, col = site), size = 1.5, fill = "#FFFFFF") +
  scale_shape_manual(values = shape_palette_site) +
  scale_color_manual(values = color_palette_site) +
  scale_fill_manual(values = color_palette_site) +
  theme_bw() + 
  scale_x_continuous(breaks = seq(-8, 6, by = 1), minor_breaks = NULL) +
  theme(axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        legend.text = element_text(size = 16), 
        legend.position = "none", 
        strip.background = element_rect(fill = "white", color = "white"),
        strip.text = element_text(size = 20, hjust = 0),
        panel.grid.minor = element_line(color = "white")) +
  labs(x = "Time since end of experiment (years)", 
       y = expression(Epilithic~invertebrate~biomass~(dry~g/m^{"2"}))) +
  facet_wrap(~strip, scales = "free_y")

delta_continual_sites_inverts_raw

ggsave(here::here("figures", paste("delta_continual_sites_inverts_raw-", todays_date, ".jpg", sep = "")), plot = delta_continual_sites_inverts_raw, height = 8, width = 16, dpi = 150) 

ggplot(delta_invert_continual) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(aes(x = time_since_end, y = control_inverts, fill = site, shape = site), size = 3, alpha = 0.9) +
  scale_shape_manual(values = shape_palette_site) +
  scale_fill_manual(values = color_palette_site) +
  geom_smooth(aes(x = time_since_end, y = control_inverts, group = exp_dates), method = "lm") +
    scale_y_continuous(limits = c(-1, 125)) +
  theme_bw() + 
  theme(axis.title = element_text(size = 16),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 14), 
        legend.position = "none", 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of removal", y = "epilithic invert biomass",
       title = "control plots")
```

### start-during-after

#### i. anova

```{r}
# anova with random effect
invert_anova <- lmer(delta_continual_inverts ~ comp_2yrs + (1|site), data = delta_invert_continual %>% drop_na(comp_2yrs))
# summary with p value
summary(invert_anova)
# least squares comparison
difflsmeans(invert_anova, test.effs = "Group", ddf = "Kenward-Roger")
# extract predicted values
invert_anova_df <- ggpredict(invert_anova, terms = "comp_2yrs", type = "fixed") %>% 
  mutate(x = case_when(
    x == "start" ~ "Start of removal",
    x == "during" ~ "End of removal",
    x == "after" ~ "Recovery period"
  )) %>% 
  mutate(x = fct_relevel(x, "Start of removal", "End of removal", "Recovery period"))

# plot
sda_invert_biomass <- ggplot(invert_anova_df) +
  # horizontal line at 0
  geom_hline(yintercept = 0, lty = 2) +
  # points and error bars
  geom_point(aes(x = x, y = predicted), size = 6) +
  geom_errorbar(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error), width = 0.2) +
  # path between time periods
  geom_line(aes(x = x, y = predicted, group = 1)) +
  # add in post-hoc comparisons
  annotate("text", x = 1, y = 20, label = "a", size = 11) +
  annotate("text", x = 2, y = 20, label = "b", size = 11) +
  annotate("text", x = 3, y = 20, label = "b", size = 11) +
  # aesthetics
  theme_bw() +
  scale_x_discrete(labels = wrap_format(10)) +
  scale_y_continuous(limits = c(-13, 21)) +
  theme(axis.title = element_text(size = 22),
        axis.text = element_text(size = 20),
        legend.text = element_text(size = 20), 
        legend.title = element_text(size = 20),
        plot.margin = margin(0, 0, 0, 0),
        panel.grid.minor = element_line(color = "white")) +
  labs(x = "Time period", 
       y = expression(Epilithic~invert~biomass~(dry~g/m^{"2"})))
sda_invert_biomass
```

### invert vs kelp timeseries

```{r}
ggplot(data = delta_invert_continual) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(aes(x = time_since_end, y = delta_continual_inverts), alpha = 0.7) +
  geom_point(aes(x = time_since_end, y = delta_continual), alpha = 0.7, col = "blue") +
  # predicted values for epi inverts
  geom_line(data = predicted_invert_after, aes(x = x, y = predicted), size = 2, alpha = 0.7) +
  geom_ribbon(data = predicted_invert_after, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.2) +
  geom_line(data = predicted_invert_during, aes(x = x, y = predicted), size = 2, alpha = 0.7) +
  geom_ribbon(data = predicted_invert_during, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.2) +
  # predicted values for kelp
  geom_line(data = predicted_kelp_after_overall, aes(x = x, y = predicted), size = 2, alpha = 0.7, col = "blue") +
  geom_ribbon(data = predicted_kelp_after_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.2, fill = "blue") +
  geom_line(data = predicted_kelp_during_overall, aes(x = x, y = predicted), size = 2, alpha = 0.7, col = "blue") +
  geom_ribbon(data = predicted_kelp_during_overall, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.2, fill = "blue") +
  annotate("text", x = -6, y = 600, label = "inverts", size = 12) +
  annotate("text", x = -6.5, y = -1500, label = "kelp", size = 12, col = "blue") +
  theme_bw() + 
  theme(axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        legend.text = element_text(size = 16), 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of removal", y = "\U0394 biomass (treatment - control)")
```


## d. delta clams

```{r}
# total biomass
clam_biomass <- biomass %>% 
  # take out piddocks?
  filter(taxon_family == "Pholadidae")

# delta biomass
delta_clam_biomass <- clam_biomass %>% 
  dplyr::select(site, year, month, treatment, date, dry_gm2) %>% 
  group_by(site, year, month, treatment, date) %>% 
  summarize(total_dry = sum(dry_gm2)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = treatment, values_from = total_dry) %>% 
  mutate(delta_annual = annual - control,
         delta_continual = continual - control) 

delta_clam_annual <- delta_clam_biomass %>% 
  dplyr::select(site, year, month, date, control, annual, delta_annual) %>% 
  drop_na(delta_annual) %>% 
  mutate(exp_dates = case_when(
    # after for annual removal:
    site == "aque" & date >= aque_after_date_annual ~ "after",
    site == "napl" & date >= napl_after_date_annual ~ "after",
    site == "ivee" & date >= ivee_after_date_annual ~ "after",
    site == "mohk" & date >= mohk_after_date_annual ~ "after",
    site == "carp" & date >= carp_after_date_annual ~ "after",
    # everything else is "during" the experiment
    TRUE ~ "during"
  ),
  exp_dates = fct_relevel(exp_dates, c("during", "after"))) %>% 
   # create a column for quarter
  mutate(quarter = case_when(
    month <= 3 ~ "Q1",
    month <= 6 ~ "Q2",
    month <= 9 ~ "Q3",
    TRUE ~ "Q4"
  )) %>% 
  # calculate time since start of experiment
  mutate(time_yrs = case_when(
    # AQUE, NAPL, MOHK, CARP: control and annual started in 2008
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q1" ~ year + 0.125 - 2008,
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q2" ~ year + 0.375 - 2008,
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q3" ~ year + 0.625 - 2008,
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q4" ~ year + 0.875 - 2008, 
    # IVEE control and annual started in 2011
    site == "ivee" & quarter == "Q1" ~ year + 0.125 - 2011,
    site == "ivee" & quarter == "Q2" ~ year + 0.375 - 2011,
    site == "ivee" & quarter == "Q3" ~ year + 0.625 - 2011,
    site == "ivee" & quarter == "Q4" ~ year + 0.875 - 2011
    )) %>% 
  group_by(site) %>% 
  mutate(time_since_start = time_yrs - min(time_yrs)) %>% 
  ungroup() %>% 
  # calculate time since end of experiment
  group_by(site, exp_dates) %>% 
  # if "after", then simple: the time in years - the minimum time in years
  # if "during", then more complex: take the max time in years and add 0.25, then subtract the time in years
  mutate(time_since_end = case_when(
    exp_dates == "during" ~ -(max(time_yrs) + 0.25 - time_yrs),
    exp_dates == "after" ~ time_yrs - min(time_yrs)
  )) %>% 
  ungroup() %>% 
  left_join(., enframe(sites_full), by = c("site" = "name")) %>% 
  rename(site_full = value) %>% 
  mutate(site_full = fct_relevel(site_full, "Arroyo Quemado (AQUE)", "Naples (NAPL)", "Isla Vista (IVEE)", "Mohawk (MOHK)", "Carpinteria (CARP)")) %>% 
  # create a new column for "kelp year"
  mutate(quarter = fct_relevel(quarter, "Q2", "Q3", "Q4", "Q1")) %>% 
  mutate(kelp_year = case_when(
    quarter %in% c("Q2", "Q3", "Q4") ~ year,
    quarter == "Q1" ~ year - 1
  )) %>% 
  mutate(kelp_year = paste("kelp_", kelp_year, "-", kelp_year + 1, sep = "")) %>% 
  # create a column for the points to compare for "2 year interval"
  mutate(comp_2yrs = case_when(
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2008-2009", "kelp_2009-2010") ~ "start",
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2015-2016", "kelp_2016-2017") ~ "during", 
    site == "ivee" & kelp_year %in% c("kelp_2011-2012", "kelp_2012-2013") ~ "start",
    site == "ivee" & kelp_year %in% c("kelp_2015-2016", "kelp_2016-2017") ~ "during",
    kelp_year %in% c("kelp_2020-2021", "kelp_2021-2022") ~ "after"
  )) %>% 
  mutate(comp_2yrs = fct_relevel(comp_2yrs, "start", "during", "after")) %>% 
  # create a column for the points to compare for "3 year interval"
  mutate(comp_3yrs = case_when(
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2008-2009", "kelp_2009-2010", "kelp_2010-2011") ~ "start",
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2014-2015", "kelp_2015-2016", "kelp_2016-2017") ~ "during", 
    site == "ivee" & kelp_year %in% c("kelp_2011-2012", "kelp_2012-2013", "kelp_2013-2014") ~ "start",
    site == "ivee" & kelp_year %in% c("kelp_2014-2015", "kelp_2015-2016", "kelp_2016-2017") ~ "during",
    kelp_year %in% c("kelp_2019-2020", "kelp_2020-2021", "kelp_2021-2022") ~ "after"
  )) %>% 
  mutate(comp_3yrs = fct_relevel(comp_3yrs, "start", "during", "after"))

delta_clam_continual <- delta_clam_biomass %>% 
  dplyr::select(site, year, month, date, control, continual, delta_continual) %>% 
  # take out years where continual removal hadn't happened yet
  drop_na(delta_continual) %>% 
  mutate(exp_dates = case_when(
    # after for annual removal:
    site == "aque" & date >= aque_after_date_continual ~ "after",
    site == "napl" & date >= napl_after_date_continual ~ "after",
    site == "mohk" & date >= mohk_after_date_continual ~ "after",
    site == "carp" & date >= carp_after_date_continual ~ "after",
    # everything else is "during" the experiment
    TRUE ~ "during"
  ),
  exp_dates = fct_relevel(exp_dates, c("during", "after"))) %>% 
  time_since_columns_continual() %>% 
  kelp_year_column() %>% 
  comparison_column_continual() %>% 
  # create a new sample ID that is site, year, quarter
  unite("sample_ID", site, date, quarter, remove = FALSE) %>% 
  # create new column that is the column to join with 
  # unite("join_ID", site, date, remove = FALSE) %>% 
  rename("control_clams" = control,
         "continual_clams" = continual,
         "delta_continual_clams" = delta_continual) %>% 
  full_join(., delta_continual %>% dplyr::select(sample_ID, continual, control, delta_continual), by = "sample_ID") %>% 
  left_join(., enframe(sites_full), by = c("site" = "name")) %>% 
  rename("site_full" = value) %>% 
  mutate(site_full = fct_relevel(site_full, "Arroyo Quemado", "Naples", "Mohawk", "Carpinteria"))
```

### delta clams as a function of time since end of experiment

```{r}
clam_continual_after <- delta_clam_continual %>% 
  filter(exp_dates == "after")

# model
linear_model_clam_lmer <- lmer(delta_continual_clams ~ time_since_end + (1|site), data = clam_continual_after, na.action = na.pass)

# check
plot(simulateResiduals(linear_model_clam_lmer))

# summary
summary(linear_model_clam_lmer)

# R2
MuMIn::r.squaredGLMM(linear_model_clam_lmer)

# summary table
clam_after <- linear_model_clam_lmer %>% 
  tbl_regression() %>% 
  bold_p(t = 0.05)

# model
linear_model_clam_lmer_during <- lmer(delta_continual_clams ~ time_since_end + (1|site), data = delta_clam_continual %>% filter(exp_dates == "during"), na.action = na.pass)

# check
plot(simulateResiduals(linear_model_clam_lmer_during))

# summmary
summary(linear_model_clam_lmer_during)

# R2
MuMIn::r.squaredGLMM(linear_model_clam_lmer_during)

# summary table
clam_during <- linear_model_clam_lmer_during %>% 
  tbl_regression() %>% 
  bold_p(t = 0.05)

clam_tables <- tbl_merge(tbls = list(clam_during, clam_after))

# ggeffects
predicted_clam_after <- ggpredict(linear_model_clam_lmer, terms = ~ time_since_end, type = "fixed")
predicted_clam_during <- ggpredict(linear_model_clam_lmer_during, terms = ~ time_since_end, type = "fixed")

clam_time <- ggplot() +
  geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(data = delta_clam_continual, 
             aes(x = time_since_end, y = delta_continual_clams, fill = site, shape = site), size = 4, alpha = 0.9) +
  scale_shape_manual(values = shape_palette_site) +
  scale_fill_manual(values = color_palette_site) +
  # new_scale("color") + 
  # overall
  # geom_line(data = predicted_clam_after, aes(x = x, y = predicted), size = 2, alpha = 0.7) +
  # geom_ribbon(data = predicted_clam_after, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.2) +
  # geom_line(data = predicted_clam_during, aes(x = x, y = predicted), size = 2, alpha = 0.7) +
  # geom_ribbon(data = predicted_clam_during, aes(x = x, ymax = conf.high, ymin = conf.low), alpha = 0.2) +
  scale_x_continuous(breaks = seq(-8, 6, by = 1), minor_breaks = NULL) +
  # scale_y_continuous(breaks = seq(-250, 750, by = 250), limits = c(-250, 750)) +
  theme_bw() + 
  theme(axis.title = element_text(size = 22),
        axis.text = element_text(size = 20),
        legend.text = element_text(size = 20), 
        legend.title = element_text(size = 20),
        legend.position = "none", 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of removal (years)", 
       y = "\U0394 endolithic invert biomass \n (treatment - control)")

raw_clam_time <- ggplot(delta_clam_continual) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(aes(x = time_since_end, y = control_clams, fill = site, shape = site), size = 3, alpha = 0.9) +
  scale_shape_manual(values = shape_palette_site) +
  scale_fill_manual(values = color_palette_site) +
  geom_smooth(aes(x = time_since_end, y = continual_clams, group = exp_dates), method = "lm") +
  # scale_y_continuous(limits = c(-1, 125)) +
  theme_bw() + 
  theme(axis.title = element_text(size = 16),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 14), 
        legend.position = "none", 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of removal (years)", 
       y = expression(endolithic~invertebrate~biomass~(g/m^{"2"})))
```

### start-during-after

#### i. anova

```{r}
# anova with random effect
clam_anova <- lmer(delta_continual_clams ~ comp_2yrs + (1|site), data = delta_clam_continual %>% drop_na(comp_2yrs))
# summary with p value
summary(clam_anova)
# extract predicted values
clam_anova_df <- ggpredict(clam_anova, terms = "comp_2yrs", type = "fixed") %>% 
  mutate(x = case_when(
    x == "start" ~ "Start of removal",
    x == "during" ~ "End of removal",
    x == "after" ~ "Recovery period"
  )) %>% 
  mutate(x = fct_relevel(x, "Start of removal", "End of removal", "Recovery period"))

# plot
sda_clam_biomass <- ggplot(clam_anova_df) +
  # horizontal line at 0
  geom_hline(yintercept = 0, lty = 2) +
  # points and error bars
  geom_point(aes(x = x, y = predicted), size = 6) +
  geom_errorbar(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error), width = 0.2) +
  # path between time periods
  geom_line(aes(x = x, y = predicted, group = 1)) +
  # aesthetics
  theme_bw() +
  scale_x_discrete(labels = wrap_format(10)) +
  theme(axis.title = element_text(size = 22),
        axis.text = element_text(size = 20),
        legend.text = element_text(size = 20), 
        legend.title = element_text(size = 20),
        plot.margin = margin(0, 0, 0, 0),
        panel.grid.minor = element_line(color = "white")) +
  labs(x = "Time period", 
       y = expression(Endolithic~invert~biomass~(dry~g/m^{"2"})))
sda_clam_biomass
```

### clams vs kelp

```{r}
delta_clam_vs_kelp_lme <- lme(delta_continual_clams ~ delta_continual, 
                               random = ~ 1|year/site, 
                               data = delta_clam_continual, na.action = na.pass)
summary(delta_clam_vs_kelp_lme)

delta_clam_vs_kelp_lmer <- lmer(delta_continual_clams ~ delta_continual + (1|year) + (1|site), 
                                data = delta_clam_continual)
summary(delta_clam_vs_kelp_lmer)
plot(simulateResiduals(delta_clam_vs_kelp_lmer))
MuMIn::r.squaredGLMM(delta_clam_vs_kelp_lmer)

predicted_delta_clam_vs_kelp <- ggpredict(delta_clam_vs_kelp_lmer, terms = ~ delta_continual, type = "fixed")

delta_clam_continual %>% 
  ggplot(aes(x = delta_continual, y = delta_continual_clams)) +
  geom_hline(aes(yintercept = 0), lty = 2, color = "grey") +
  geom_vline(aes(xintercept = 0), lty = 2, color = "grey") +
  # geom_point(aes(col = comp_3yrs)) +
  # new_scale("color") +
  # stat_summary(aes(group = comp_3yrs), fun = mean, geom = "point", size = 10) +
  # geom_text(aes(label = date)) +
  geom_segment(aes(x = delta_continual, y = delta_continual_clams, 
                   xend = c(tail(delta_continual, n = -1), NA), 
                   yend = c(tail(delta_continual_clams, n = -1), NA), 
                   group = site, color = time_since_end), 
               arrow = arrow(length = unit(0.3, "cm")),
               size = 1) +
  scale_color_gradient2(low = "red", mid = "lightgrey", high = "blue") +
  labs(x = "\U0394 kelp biomass (treatment - control)",
       y = "\U0394 clam biomass (treatment - control)") +
  theme_bw() + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        strip.text = element_text(size = 14),
        strip.background = element_rect(fill = "#FFFFFF")) +
  facet_wrap(~site, scale = "free")

clams_vs_kelp <- delta_clam_continual %>% 
  ggplot(aes(x = delta_continual, y = delta_continual_clams)) +
  geom_hline(aes(yintercept = 0), lty = 3, color = "grey") +
  geom_vline(aes(xintercept = 0), lty = 3, color = "grey") +
  geom_point(aes(shape = exp_dates, fill = exp_dates), size = 5, shape = 23) + 
  geom_line(data = predicted_delta_clam_vs_kelp, aes(x = x, y = predicted), size = 2) +
  scale_linetype_manual(values = c("during" = 2, "after" = 1)) +
  scale_fill_manual(values = c("during" = "#FFFFFF", after = napl_col)) +
  scale_x_continuous(breaks = seq(-2000, 2000, by = 1000), minor_breaks = seq(-2000, 2000, by = 500)) +
  labs(x = "\U0394 kelp biomass (treatment - control)",
       y = "\U0394 endolithic invert biomass (treatment - control)",
       caption = "marginal R2 = 0.004, conditional R2 = 0.349, no significance") +
  theme_bw() + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        strip.text = element_text(size = 14),
        legend.position = c(0.9, 0.9),
        legend.text = element_text(size = 18),
        legend.title = element_blank())
```

### raw clam biomass
```{r}
delta_continual_sites_clams_raw <- delta_clam_continual %>% 
  mutate(strip = case_when(
    site == "aque" ~ paste("A. ", site_full, sep = ""),
    site == "napl" ~ paste("B. ", site_full),
    site == "mohk" ~ paste("C. ", site_full),
    site == "carp" ~ paste("D. ", site_full)
  )) %>% 
  ggplot() +
  geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_line(aes(x = time_since_end, y = control_clams, col = site), alpha = 0.5, size = 2.5) +
  # control
  geom_point(aes(x = time_since_end, y = control_clams, shape = site), size = 1.5, alpha = 0.5, fill = "#FFFFFF") +
  # continual
  geom_line(aes(x = time_since_end, y = continual_clams, col = site), size = 2.5) +
  geom_point(aes(x = time_since_end, y = continual_clams, shape = site, col = site), size = 1.5, fill = "#FFFFFF") +
  scale_shape_manual(values = shape_palette_site) +
  scale_color_manual(values = color_palette_site) +
  scale_fill_manual(values = color_palette_site) +
  theme_bw() + 
  scale_x_continuous(breaks = seq(-8, 6, by = 1), minor_breaks = NULL) +
  theme(axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        legend.text = element_text(size = 16), 
        legend.position = "none", 
        strip.background = element_rect(fill = "white", color = "white"),
        strip.text = element_text(size = 20, hjust = 0),
        panel.grid.minor = element_line(color = "white")) +
  labs(x = "Time since end of experiment (years)", 
       y = expression(Endolithic~invertebrate~biomass~(dry~g/m^{"2"}))) +
  facet_wrap(~strip, scales = "free_y")

delta_continual_sites_clams_raw

ggsave(here::here("figures", paste("delta_continual_sites_clams_raw-", todays_date, ".jpg", sep = "")), plot = delta_continual_sites_clams_raw, height = 8, width = 16, dpi = 150)
```


## e. potential manuscript plots

```{r}
# table
group_summary_tables <- tbl_stack(
  tbls = list(kelp_tables, algae_tables, epi_invert_tables, clam_tables),
  group_header = c("Kelp", "Algae", "Epilithic invertebrates", "Endolithic invertebrates"),
  quiet = TRUE) %>% 
  as_gt()
group_summary_tables

# file name for export: group-summaries_date

# gt::gtsave(group_summary_tables, file = here::here("tables", paste("group-summaries_", todays_date, ".png", sep = "")))

fig3 <- (sda_algae_biomass + algae_time) /
        (sda_invert_biomass + invert_time) /
        (sda_clam_biomass + clam_time) +
  # (sda_algae_biomass / sda_invert_biomass / sda_clam_biomass) | (algae_time / invert_time / clam_time) +
  plot_layout(widths = c(2, 3)) +
  plot_annotation(tag_levels = "A") &
  theme(plot.tag = element_text(size = 30))

fig3

ggsave(here::here("figures", paste("fig3_", todays_date, ".jpg", sep = "")), plot = fig3, height = 17, width = 16, dpi = 150)
```


# 5. delta fish

```{r}
# total biomass
fish_biomass <- biomass %>% 
  filter(new_group == "fish") %>% 
  # make a new column for after dates
  after_dates_column() %>% 
  # make a new column for during and after and set factor levels
  exp_dates_column()

# delta biomass
delta_fish_biomass <- fish_biomass %>% 
  dplyr::select(site, year, month, treatment, date, exp_dates, dry_gm2) %>% 
  group_by(site, exp_dates, year, month, treatment, date) %>% 
  summarize(total_dry = sum(dry_gm2)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = treatment, values_from = total_dry) %>% 
  mutate(delta_annual = annual - control,
         delta_continual = continual - control) 

delta_fish_annual <- delta_fish_biomass %>% 
  dplyr::select(site, year, month, date, control, annual, delta_annual) %>% 
  drop_na(delta_annual) %>% 
  mutate(exp_dates = case_when(
    # after for annual removal:
    site == "aque" & date >= aque_after_date_annual ~ "after",
    site == "napl" & date >= napl_after_date_annual ~ "after",
    site == "ivee" & date >= ivee_after_date_annual ~ "after",
    site == "mohk" & date >= mohk_after_date_annual ~ "after",
    site == "carp" & date >= carp_after_date_annual ~ "after",
    # everything else is "during" the experiment
    TRUE ~ "during"
  ),
  exp_dates = fct_relevel(exp_dates, c("during", "after"))) %>% 
   # create a column for quarter
  mutate(quarter = case_when(
    month <= 3 ~ "Q1",
    month <= 6 ~ "Q2",
    month <= 9 ~ "Q3",
    TRUE ~ "Q4"
  )) %>% 
  # calculate time since start of experiment
  mutate(time_yrs = case_when(
    # AQUE, NAPL, MOHK, CARP: control and annual started in 2008
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q1" ~ year + 0.125 - 2008,
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q2" ~ year + 0.375 - 2008,
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q3" ~ year + 0.625 - 2008,
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q4" ~ year + 0.875 - 2008, 
    # IVEE control and annual started in 2011
    site == "ivee" & quarter == "Q1" ~ year + 0.125 - 2011,
    site == "ivee" & quarter == "Q2" ~ year + 0.375 - 2011,
    site == "ivee" & quarter == "Q3" ~ year + 0.625 - 2011,
    site == "ivee" & quarter == "Q4" ~ year + 0.875 - 2011
    )) %>% 
  group_by(site) %>% 
  mutate(time_since_start = time_yrs - min(time_yrs)) %>% 
  ungroup() %>% 
  # calculate time since end of experiment
  group_by(site, exp_dates) %>% 
  # if "after", then simple: the time in years - the minimum time in years
  # if "during", then more complex: take the max time in years and add 0.25, then subtract the time in years
  mutate(time_since_end = case_when(
    exp_dates == "during" ~ -(max(time_yrs) + 0.25 - time_yrs),
    exp_dates == "after" ~ time_yrs - min(time_yrs)
  )) %>% 
  ungroup() %>% 
  left_join(., enframe(sites_full), by = c("site" = "name")) %>% 
  rename(site_full = value) %>% 
  mutate(site_full = fct_relevel(site_full, "Arroyo Quemado (AQUE)", "Naples (NAPL)", "Isla Vista (IVEE)", "Mohawk (MOHK)", "Carpinteria (CARP)")) %>% 
  # create a new column for "kelp year"
  mutate(quarter = fct_relevel(quarter, "Q2", "Q3", "Q4", "Q1")) %>% 
  mutate(kelp_year = case_when(
    quarter %in% c("Q2", "Q3", "Q4") ~ year,
    quarter == "Q1" ~ year - 1
  )) %>% 
  mutate(kelp_year = paste("kelp_", kelp_year, "-", kelp_year + 1, sep = "")) %>% 
  # create a column for the points to compare for "2 year interval"
  mutate(comp_2yrs = case_when(
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2008-2009", "kelp_2009-2010") ~ "start",
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2015-2016", "kelp_2016-2017") ~ "during", 
    site == "ivee" & kelp_year %in% c("kelp_2011-2012", "kelp_2012-2013") ~ "start",
    site == "ivee" & kelp_year %in% c("kelp_2015-2016", "kelp_2016-2017") ~ "during",
    kelp_year %in% c("kelp_2020-2021", "kelp_2021-2022") ~ "after"
  )) %>% 
  mutate(comp_2yrs = fct_relevel(comp_2yrs, "start", "during", "after")) %>% 
  # create a column for the points to compare for "3 year interval"
  mutate(comp_3yrs = case_when(
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2008-2009", "kelp_2009-2010", "kelp_2010-2011") ~ "start",
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2014-2015", "kelp_2015-2016", "kelp_2016-2017") ~ "during", 
    site == "ivee" & kelp_year %in% c("kelp_2011-2012", "kelp_2012-2013", "kelp_2013-2014") ~ "start",
    site == "ivee" & kelp_year %in% c("kelp_2014-2015", "kelp_2015-2016", "kelp_2016-2017") ~ "during",
    kelp_year %in% c("kelp_2019-2020", "kelp_2020-2021", "kelp_2021-2022") ~ "after"
  )) %>% 
  mutate(comp_3yrs = fct_relevel(comp_3yrs, "start", "during", "after"))

delta_fish_continual <- delta_fish_biomass %>% 
  dplyr::select(site, year, month, date, control, continual, delta_continual) %>% 
  # take out years where continual removal hadn't happened yet
  drop_na(delta_continual) %>% 
  mutate(exp_dates = case_when(
    # after for annual removal:
    site == "aque" & date >= aque_after_date_continual ~ "after",
    site == "napl" & date >= napl_after_date_continual ~ "after",
    site == "mohk" & date >= mohk_after_date_continual ~ "after",
    site == "carp" & date >= carp_after_date_continual ~ "after",
    # everything else is "during" the experiment
    TRUE ~ "during"
  ),
  exp_dates = fct_relevel(exp_dates, c("during", "after"))) %>% 
  # create a column for quarter
  mutate(quarter = case_when(
    month <= 3 ~ "Q1",
    month <= 6 ~ "Q2",
    month <= 9 ~ "Q3",
    TRUE ~ "Q4"
  )) %>% 
  # calculate time since start of experiment
  mutate(time_yrs = case_when(
    # AQUE, NAPL, MOHK, CARP: continual started in 2010
    quarter == "Q1" ~ year + 0.125 - 2010,
    quarter == "Q2" ~ year + 0.375 - 2010,
    quarter == "Q3" ~ year + 0.625 - 2010,
    quarter == "Q4" ~ year + 0.875 - 2010
  )) %>% 
  group_by(site) %>% 
  mutate(time_since_start = time_yrs - min(time_yrs)) %>% 
  ungroup() %>% 
  # calculate time since end of experiment
  group_by(site, exp_dates) %>% 
  mutate(time_since_end = case_when(
    exp_dates == "during" ~ -(max(time_yrs) + 0.25 - time_yrs),
    exp_dates == "after" ~ time_yrs - min(time_yrs)
  )) %>% 
  ungroup() %>% 
  left_join(., enframe(sites_full), by = c("site" = "name")) %>% 
  rename(site_full = value) %>% 
  mutate(site_full = fct_relevel(site_full, "Arroyo Quemado (AQUE)", "Naples (NAPL)", "Mohawk (MOHK)", "Carpinteria (CARP)")) %>% 
  # create a new column for "kelp year"
  mutate(quarter = fct_relevel(quarter, "Q2", "Q3", "Q4", "Q1")) %>% 
  mutate(kelp_year = case_when(
    quarter %in% c("Q2", "Q3", "Q4") ~ year,
    quarter == "Q1" ~ year - 1
  )) %>% 
  mutate(kelp_year = paste("kelp_", kelp_year, "-", kelp_year + 1, sep = "")) %>% 
  # create a column for the points to compare for "2 year interval"
  mutate(comp_2yrs = case_when(
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2010-2011", "kelp_2011-2012") ~ "start",
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2015-2016", "kelp_2016-2017") ~ "during", 
    site == "ivee" & kelp_year %in% c("kelp_2011-2012", "kelp_2012-2013") ~ "start",
    site == "ivee" & kelp_year %in% c("kelp_2015-2016", "kelp_2016-2017") ~ "during",
    kelp_year %in% c("kelp_2020-2021", "kelp_2021-2022") ~ "after"
  )) %>% 
  mutate(comp_2yrs = fct_relevel(comp_2yrs, "start", "during", "after")) %>% 
  # create a column for the points to compare for "3 year interval"
  mutate(comp_3yrs = case_when(
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2010-2011", "kelp_2011-2012", "kelp_2012-2013") ~ "start",
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2014-2015", "kelp_2015-2016", "kelp_2016-2017") ~ "during", 
    site == "ivee" & kelp_year %in% c("kelp_2011-2012", "kelp_2012-2013", "kelp_2013-2014") ~ "start",
    site == "ivee" & kelp_year %in% c("kelp_2014-2015", "kelp_2015-2016", "kelp_2016-2017") ~ "during",
    kelp_year %in% c("kelp_2019-2020", "kelp_2020-2021", "kelp_2021-2022") ~ "after"
  )) %>% 
  mutate(comp_3yrs = fct_relevel(comp_3yrs, "start", "during", "after")) %>% 
  # create a new sample ID that is site, year, quarter
  unite("sample_ID", site, year, quarter, remove = FALSE) %>% 
  rename("control_fish" = control,
         "continual_fish" = continual,
         "delta_continual_fish" = delta_continual) %>% 
  left_join(., delta_continual %>% dplyr::select(sample_ID, continual, control, delta_continual), by = "sample_ID")
```

```{r}
fish_time <- delta_fish_continual %>% 
  filter(sample_ID != "mohk_2014_Q3") %>% 
  ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(aes(x = time_since_end, y = delta_continual_fish, fill = site, shape = site), size = 3, alpha = 0.9) +
  scale_shape_manual(values = shape_palette_site) +
  scale_fill_manual(values = color_palette_site) +
  # new_scale("color") + 
  # overall
  geom_smooth(aes(x = time_since_end, y = delta_continual_fish, group = exp_dates), method = "lm") +
  # scale_y_continuous(breaks = seq(-250, 750, by = 250), limits = c(-250, 750)) +
  theme_bw() + 
  theme(axis.title = element_text(size = 16),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 14), 
        legend.position = "none", 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of removal", y = "\U0394 fish biomass")
fish_time
```

# 6. delta mobile inverts

```{r}
# total biomass
herb_invert_biomass <- biomass %>% 
  filter(new_group == "herb_inverts") %>% 
  # make a new column for after dates
  after_dates_column() %>% 
  # make a new column for during and after and set factor levels
  exp_dates_column()

# delta biomass
delta_herb_invert_biomass <- herb_invert_biomass %>% 
  dplyr::select(site, year, month, treatment, date, exp_dates, dry_gm2) %>% 
  group_by(site, exp_dates, year, month, treatment, date) %>% 
  summarize(total_dry = sum(dry_gm2)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = treatment, values_from = total_dry) %>% 
  mutate(delta_annual = annual - control,
         delta_continual = continual - control) 

delta_herb_invert_annual <- delta_herb_invert_biomass %>% 
  dplyr::select(site, year, month, date, control, annual, delta_annual) %>% 
  drop_na(delta_annual) %>% 
  mutate(exp_dates = case_when(
    # after for annual removal:
    site == "aque" & date >= aque_after_date_annual ~ "after",
    site == "napl" & date >= napl_after_date_annual ~ "after",
    site == "ivee" & date >= ivee_after_date_annual ~ "after",
    site == "mohk" & date >= mohk_after_date_annual ~ "after",
    site == "carp" & date >= carp_after_date_annual ~ "after",
    # everything else is "during" the experiment
    TRUE ~ "during"
  ),
  exp_dates = fct_relevel(exp_dates, c("during", "after"))) %>% 
   # create a column for quarter
  mutate(quarter = case_when(
    month <= 3 ~ "Q1",
    month <= 6 ~ "Q2",
    month <= 9 ~ "Q3",
    TRUE ~ "Q4"
  )) %>% 
  # calculate time since start of experiment
  mutate(time_yrs = case_when(
    # AQUE, NAPL, MOHK, CARP: control and annual started in 2008
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q1" ~ year + 0.125 - 2008,
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q2" ~ year + 0.375 - 2008,
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q3" ~ year + 0.625 - 2008,
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q4" ~ year + 0.875 - 2008, 
    # IVEE control and annual started in 2011
    site == "ivee" & quarter == "Q1" ~ year + 0.125 - 2011,
    site == "ivee" & quarter == "Q2" ~ year + 0.375 - 2011,
    site == "ivee" & quarter == "Q3" ~ year + 0.625 - 2011,
    site == "ivee" & quarter == "Q4" ~ year + 0.875 - 2011
    )) %>% 
  group_by(site) %>% 
  mutate(time_since_start = time_yrs - min(time_yrs)) %>% 
  ungroup() %>% 
  # calculate time since end of experiment
  group_by(site, exp_dates) %>% 
  # if "after", then simple: the time in years - the minimum time in years
  # if "during", then more complex: take the max time in years and add 0.25, then subtract the time in years
  mutate(time_since_end = case_when(
    exp_dates == "during" ~ -(max(time_yrs) + 0.25 - time_yrs),
    exp_dates == "after" ~ time_yrs - min(time_yrs)
  )) %>% 
  ungroup() %>% 
  left_join(., enframe(sites_full), by = c("site" = "name")) %>% 
  rename(site_full = value) %>% 
  mutate(site_full = fct_relevel(site_full, "Arroyo Quemado (AQUE)", "Naples (NAPL)", "Isla Vista (IVEE)", "Mohawk (MOHK)", "Carpinteria (CARP)")) %>% 
  # create a new column for "kelp year"
  mutate(quarter = fct_relevel(quarter, "Q2", "Q3", "Q4", "Q1")) %>% 
  mutate(kelp_year = case_when(
    quarter %in% c("Q2", "Q3", "Q4") ~ year,
    quarter == "Q1" ~ year - 1
  )) %>% 
  mutate(kelp_year = paste("kelp_", kelp_year, "-", kelp_year + 1, sep = "")) %>% 
  # create a column for the points to compare for "2 year interval"
  mutate(comp_2yrs = case_when(
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2008-2009", "kelp_2009-2010") ~ "start",
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2015-2016", "kelp_2016-2017") ~ "during", 
    site == "ivee" & kelp_year %in% c("kelp_2011-2012", "kelp_2012-2013") ~ "start",
    site == "ivee" & kelp_year %in% c("kelp_2015-2016", "kelp_2016-2017") ~ "during",
    kelp_year %in% c("kelp_2020-2021", "kelp_2021-2022") ~ "after"
  )) %>% 
  mutate(comp_2yrs = fct_relevel(comp_2yrs, "start", "during", "after")) %>% 
  # create a column for the points to compare for "3 year interval"
  mutate(comp_3yrs = case_when(
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2008-2009", "kelp_2009-2010", "kelp_2010-2011") ~ "start",
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2014-2015", "kelp_2015-2016", "kelp_2016-2017") ~ "during", 
    site == "ivee" & kelp_year %in% c("kelp_2011-2012", "kelp_2012-2013", "kelp_2013-2014") ~ "start",
    site == "ivee" & kelp_year %in% c("kelp_2014-2015", "kelp_2015-2016", "kelp_2016-2017") ~ "during",
    kelp_year %in% c("kelp_2019-2020", "kelp_2020-2021", "kelp_2021-2022") ~ "after"
  )) %>% 
  mutate(comp_3yrs = fct_relevel(comp_3yrs, "start", "during", "after"))

delta_herb_invert_continual <- delta_herb_invert_biomass %>% 
  dplyr::select(site, year, month, date, control, continual, delta_continual) %>% 
  # take out years where continual removal hadn't happened yet
  drop_na(delta_continual) %>% 
  mutate(exp_dates = case_when(
    # after for annual removal:
    site == "aque" & date >= aque_after_date_continual ~ "after",
    site == "napl" & date >= napl_after_date_continual ~ "after",
    site == "mohk" & date >= mohk_after_date_continual ~ "after",
    site == "carp" & date >= carp_after_date_continual ~ "after",
    # everything else is "during" the experiment
    TRUE ~ "during"
  ),
  exp_dates = fct_relevel(exp_dates, c("during", "after"))) %>% 
  # create a column for quarter
  mutate(quarter = case_when(
    month <= 3 ~ "Q1",
    month <= 6 ~ "Q2",
    month <= 9 ~ "Q3",
    TRUE ~ "Q4"
  )) %>% 
  # calculate time since start of experiment
  mutate(time_yrs = case_when(
    # AQUE, NAPL, MOHK, CARP: continual started in 2010
    quarter == "Q1" ~ year + 0.125 - 2010,
    quarter == "Q2" ~ year + 0.375 - 2010,
    quarter == "Q3" ~ year + 0.625 - 2010,
    quarter == "Q4" ~ year + 0.875 - 2010
  )) %>% 
  group_by(site) %>% 
  mutate(time_since_start = time_yrs - min(time_yrs)) %>% 
  ungroup() %>% 
  # calculate time since end of experiment
  group_by(site, exp_dates) %>% 
  mutate(time_since_end = case_when(
    exp_dates == "during" ~ -(max(time_yrs) + 0.25 - time_yrs),
    exp_dates == "after" ~ time_yrs - min(time_yrs)
  )) %>% 
  ungroup() %>% 
  left_join(., enframe(sites_full), by = c("site" = "name")) %>% 
  rename(site_full = value) %>% 
  mutate(site_full = fct_relevel(site_full, "Arroyo Quemado (AQUE)", "Naples (NAPL)", "Mohawk (MOHK)", "Carpinteria (CARP)")) %>% 
  # create a new column for "kelp year"
  mutate(quarter = fct_relevel(quarter, "Q2", "Q3", "Q4", "Q1")) %>% 
  mutate(kelp_year = case_when(
    quarter %in% c("Q2", "Q3", "Q4") ~ year,
    quarter == "Q1" ~ year - 1
  )) %>% 
  mutate(kelp_year = paste("kelp_", kelp_year, "-", kelp_year + 1, sep = "")) %>% 
  # create a column for the points to compare for "2 year interval"
  mutate(comp_2yrs = case_when(
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2010-2011", "kelp_2011-2012") ~ "start",
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2015-2016", "kelp_2016-2017") ~ "during", 
    site == "ivee" & kelp_year %in% c("kelp_2011-2012", "kelp_2012-2013") ~ "start",
    site == "ivee" & kelp_year %in% c("kelp_2015-2016", "kelp_2016-2017") ~ "during",
    kelp_year %in% c("kelp_2020-2021", "kelp_2021-2022") ~ "after"
  )) %>% 
  mutate(comp_2yrs = fct_relevel(comp_2yrs, "start", "during", "after")) %>% 
  # create a column for the points to compare for "3 year interval"
  mutate(comp_3yrs = case_when(
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2010-2011", "kelp_2011-2012", "kelp_2012-2013") ~ "start",
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2014-2015", "kelp_2015-2016", "kelp_2016-2017") ~ "during", 
    site == "ivee" & kelp_year %in% c("kelp_2011-2012", "kelp_2012-2013", "kelp_2013-2014") ~ "start",
    site == "ivee" & kelp_year %in% c("kelp_2014-2015", "kelp_2015-2016", "kelp_2016-2017") ~ "during",
    kelp_year %in% c("kelp_2019-2020", "kelp_2020-2021", "kelp_2021-2022") ~ "after"
  )) %>% 
  mutate(comp_3yrs = fct_relevel(comp_3yrs, "start", "during", "after")) %>% 
  # create a new sample ID that is site, year, quarter
  unite("sample_ID", site, year, quarter, remove = FALSE) %>% 
  rename("control_herb_invert" = control,
         "continual_herb_invert" = continual,
         "delta_continual_herb_invert" = delta_continual) %>% 
  left_join(., delta_continual %>% dplyr::select(sample_ID, continual, control, delta_continual), by = "sample_ID")
```

```{r}
herb_invert_time <- delta_herb_invert_continual %>% 
  # filter(sample_ID != "mohk_2014_Q3") %>% 
  ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(aes(x = time_since_end, y = control_herb_invert, fill = site, shape = site), size = 3, alpha = 0.9) +
  scale_shape_manual(values = shape_palette_site) +
  scale_fill_manual(values = color_palette_site) +
  scale_y_continuous(limits = c(0, 1300)) +
  # new_scale("color") + 
  # overall
  geom_smooth(aes(x = time_since_end, y = control_herb_invert, group = exp_dates), method = "lm") +
  # scale_y_continuous(breaks = seq(-250, 750, by = 250), limits = c(-250, 750)) +
  theme_bw() + 
  theme(axis.title = element_text(size = 16),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 14), 
        legend.position = "none", 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of removal", y = "herbivorous invert biomass",
       title = "Control")
herb_invert_time
```

# 7. delta carnivorous inverts

```{r}
# total biomass
carn_invert_biomass <- biomass %>% 
  filter(new_group == "carn_inverts") %>% 
  # make a new column for after dates
  after_dates_column() %>% 
  # make a new column for during and after and set factor levels
  exp_dates_column()

# delta biomass
delta_carn_invert_biomass <- carn_invert_biomass %>% 
  dplyr::select(site, year, month, treatment, date, exp_dates, dry_gm2) %>% 
  group_by(site, exp_dates, year, month, treatment, date) %>% 
  summarize(total_dry = sum(dry_gm2)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = treatment, values_from = total_dry) %>% 
  mutate(delta_annual = annual - control,
         delta_continual = continual - control) 

delta_carn_invert_annual <- delta_carn_invert_biomass %>% 
  dplyr::select(site, year, month, date, control, annual, delta_annual) %>% 
  drop_na(delta_annual) %>% 
  mutate(exp_dates = case_when(
    # after for annual removal:
    site == "aque" & date >= aque_after_date_annual ~ "after",
    site == "napl" & date >= napl_after_date_annual ~ "after",
    site == "ivee" & date >= ivee_after_date_annual ~ "after",
    site == "mohk" & date >= mohk_after_date_annual ~ "after",
    site == "carp" & date >= carp_after_date_annual ~ "after",
    # everything else is "during" the experiment
    TRUE ~ "during"
  ),
  exp_dates = fct_relevel(exp_dates, c("during", "after"))) %>% 
   # create a column for quarter
  mutate(quarter = case_when(
    month <= 3 ~ "Q1",
    month <= 6 ~ "Q2",
    month <= 9 ~ "Q3",
    TRUE ~ "Q4"
  )) %>% 
  # calculate time since start of experiment
  mutate(time_yrs = case_when(
    # AQUE, NAPL, MOHK, CARP: control and annual started in 2008
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q1" ~ year + 0.125 - 2008,
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q2" ~ year + 0.375 - 2008,
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q3" ~ year + 0.625 - 2008,
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q4" ~ year + 0.875 - 2008, 
    # IVEE control and annual started in 2011
    site == "ivee" & quarter == "Q1" ~ year + 0.125 - 2011,
    site == "ivee" & quarter == "Q2" ~ year + 0.375 - 2011,
    site == "ivee" & quarter == "Q3" ~ year + 0.625 - 2011,
    site == "ivee" & quarter == "Q4" ~ year + 0.875 - 2011
    )) %>% 
  group_by(site) %>% 
  mutate(time_since_start = time_yrs - min(time_yrs)) %>% 
  ungroup() %>% 
  # calculate time since end of experiment
  group_by(site, exp_dates) %>% 
  # if "after", then simple: the time in years - the minimum time in years
  # if "during", then more complex: take the max time in years and add 0.25, then subtract the time in years
  mutate(time_since_end = case_when(
    exp_dates == "during" ~ -(max(time_yrs) + 0.25 - time_yrs),
    exp_dates == "after" ~ time_yrs - min(time_yrs)
  )) %>% 
  ungroup() %>% 
  left_join(., enframe(sites_full), by = c("site" = "name")) %>% 
  rename(site_full = value) %>% 
  mutate(site_full = fct_relevel(site_full, "Arroyo Quemado (AQUE)", "Naples (NAPL)", "Isla Vista (IVEE)", "Mohawk (MOHK)", "Carpinteria (CARP)")) %>% 
  # create a new column for "kelp year"
  mutate(quarter = fct_relevel(quarter, "Q2", "Q3", "Q4", "Q1")) %>% 
  mutate(kelp_year = case_when(
    quarter %in% c("Q2", "Q3", "Q4") ~ year,
    quarter == "Q1" ~ year - 1
  )) %>% 
  mutate(kelp_year = paste("kelp_", kelp_year, "-", kelp_year + 1, sep = "")) %>% 
  # create a column for the points to compare for "2 year interval"
  mutate(comp_2yrs = case_when(
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2008-2009", "kelp_2009-2010") ~ "start",
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2015-2016", "kelp_2016-2017") ~ "during", 
    site == "ivee" & kelp_year %in% c("kelp_2011-2012", "kelp_2012-2013") ~ "start",
    site == "ivee" & kelp_year %in% c("kelp_2015-2016", "kelp_2016-2017") ~ "during",
    kelp_year %in% c("kelp_2020-2021", "kelp_2021-2022") ~ "after"
  )) %>% 
  mutate(comp_2yrs = fct_relevel(comp_2yrs, "start", "during", "after")) %>% 
  # create a column for the points to compare for "3 year interval"
  mutate(comp_3yrs = case_when(
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2008-2009", "kelp_2009-2010", "kelp_2010-2011") ~ "start",
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2014-2015", "kelp_2015-2016", "kelp_2016-2017") ~ "during", 
    site == "ivee" & kelp_year %in% c("kelp_2011-2012", "kelp_2012-2013", "kelp_2013-2014") ~ "start",
    site == "ivee" & kelp_year %in% c("kelp_2014-2015", "kelp_2015-2016", "kelp_2016-2017") ~ "during",
    kelp_year %in% c("kelp_2019-2020", "kelp_2020-2021", "kelp_2021-2022") ~ "after"
  )) %>% 
  mutate(comp_3yrs = fct_relevel(comp_3yrs, "start", "during", "after"))

delta_carn_invert_continual <- delta_carn_invert_biomass %>% 
  dplyr::select(site, year, month, date, control, continual, delta_continual) %>% 
  # take out years where continual removal hadn't happened yet
  drop_na(delta_continual) %>% 
  mutate(exp_dates = case_when(
    # after for annual removal:
    site == "aque" & date >= aque_after_date_continual ~ "after",
    site == "napl" & date >= napl_after_date_continual ~ "after",
    site == "mohk" & date >= mohk_after_date_continual ~ "after",
    site == "carp" & date >= carp_after_date_continual ~ "after",
    # everything else is "during" the experiment
    TRUE ~ "during"
  ),
  exp_dates = fct_relevel(exp_dates, c("during", "after"))) %>% 
  # create a column for quarter
  mutate(quarter = case_when(
    month <= 3 ~ "Q1",
    month <= 6 ~ "Q2",
    month <= 9 ~ "Q3",
    TRUE ~ "Q4"
  )) %>% 
  # calculate time since start of experiment
  mutate(time_yrs = case_when(
    # AQUE, NAPL, MOHK, CARP: continual started in 2010
    quarter == "Q1" ~ year + 0.125 - 2010,
    quarter == "Q2" ~ year + 0.375 - 2010,
    quarter == "Q3" ~ year + 0.625 - 2010,
    quarter == "Q4" ~ year + 0.875 - 2010
  )) %>% 
  group_by(site) %>% 
  mutate(time_since_start = time_yrs - min(time_yrs)) %>% 
  ungroup() %>% 
  # calculate time since end of experiment
  group_by(site, exp_dates) %>% 
  mutate(time_since_end = case_when(
    exp_dates == "during" ~ -(max(time_yrs) + 0.25 - time_yrs),
    exp_dates == "after" ~ time_yrs - min(time_yrs)
  )) %>% 
  ungroup() %>% 
  left_join(., enframe(sites_full), by = c("site" = "name")) %>% 
  rename(site_full = value) %>% 
  mutate(site_full = fct_relevel(site_full, "Arroyo Quemado (AQUE)", "Naples (NAPL)", "Mohawk (MOHK)", "Carpinteria (CARP)")) %>% 
  # create a new column for "kelp year"
  mutate(quarter = fct_relevel(quarter, "Q2", "Q3", "Q4", "Q1")) %>% 
  mutate(kelp_year = case_when(
    quarter %in% c("Q2", "Q3", "Q4") ~ year,
    quarter == "Q1" ~ year - 1
  )) %>% 
  mutate(kelp_year = paste("kelp_", kelp_year, "-", kelp_year + 1, sep = "")) %>% 
  # create a column for the points to compare for "2 year interval"
  mutate(comp_2yrs = case_when(
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2010-2011", "kelp_2011-2012") ~ "start",
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2015-2016", "kelp_2016-2017") ~ "during", 
    site == "ivee" & kelp_year %in% c("kelp_2011-2012", "kelp_2012-2013") ~ "start",
    site == "ivee" & kelp_year %in% c("kelp_2015-2016", "kelp_2016-2017") ~ "during",
    kelp_year %in% c("kelp_2020-2021", "kelp_2021-2022") ~ "after"
  )) %>% 
  mutate(comp_2yrs = fct_relevel(comp_2yrs, "start", "during", "after")) %>% 
  # create a column for the points to compare for "3 year interval"
  mutate(comp_3yrs = case_when(
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2010-2011", "kelp_2011-2012", "kelp_2012-2013") ~ "start",
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2014-2015", "kelp_2015-2016", "kelp_2016-2017") ~ "during", 
    site == "ivee" & kelp_year %in% c("kelp_2011-2012", "kelp_2012-2013", "kelp_2013-2014") ~ "start",
    site == "ivee" & kelp_year %in% c("kelp_2014-2015", "kelp_2015-2016", "kelp_2016-2017") ~ "during",
    kelp_year %in% c("kelp_2019-2020", "kelp_2020-2021", "kelp_2021-2022") ~ "after"
  )) %>% 
  mutate(comp_3yrs = fct_relevel(comp_3yrs, "start", "during", "after")) %>% 
  # create a new sample ID that is site, year, quarter
  unite("sample_ID", site, year, quarter, remove = FALSE) %>% 
  rename("control_carn_invert" = control,
         "continual_carn_invert" = continual,
         "delta_continual_carn_invert" = delta_continual) %>% 
  left_join(., delta_continual %>% dplyr::select(sample_ID, continual, control, delta_continual), by = "sample_ID")
```

```{r}
carn_invert_time <- delta_carn_invert_continual %>% 
  # filter(sample_ID != "mohk_2014_Q3") %>% 
  ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  geom_point(aes(x = time_since_end, y = delta_continual_carn_invert, fill = site, shape = site), size = 3, alpha = 0.9) +
  scale_shape_manual(values = shape_palette_site) +
  scale_fill_manual(values = color_palette_site) +
  # new_scale("color") + 
  # overall
  geom_smooth(aes(x = time_since_end, y = delta_continual_carn_invert, group = exp_dates), method = "lm") +
  # scale_y_continuous(breaks = seq(-250, 750, by = 250), limits = c(-250, 750)) +
  theme_bw() + 
  theme(axis.title = element_text(size = 16),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 14), 
        legend.position = "none", 
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = "Time since end of removal", y = "\U0394 carnivorous invert biomass")
carn_invert_time
```



# 8. plots together

### class vs kelp
```{r}
plots_together <- algae_vs_kelp_spearman + inverts_vs_kelp_spearman &
    plot_annotation(tag_levels = "A") &
    theme(plot.tag = element_text(size = 30))
plots_together
ggsave(here::here("figures", paste("fig5_", todays_date, ".jpg", sep = "")), 
       plot = plots_together, 
       height = 8, width = 16, dpi = 150)
```


### algae and inverts

```{r}
plots_together <- algae_time/invert_time/clam_time &
  plot_annotation(tag_levels = "A") &
    theme(plot.tag = element_text(size = 20))

plots_together
ggsave(here::here("figures", paste("algae_invert_time_delta-site_int-", todays_date, ".jpg", sep = "")), 
       plot = plots_together, 
       height = 12, width = 16, dpi = 150)

plots_together_raw <- raw_algae_time/raw_invert_time/raw_clam_time &
  plot_annotation(tag_levels = "A") &
    theme(plot.tag = element_text(size = 20))
plots_together_raw

ggsave(here::here("figures", paste("algae_invert_time_control-", todays_date, ".jpg", sep = "")), 
       plot = plots_together_raw, 
       height = 12, width = 16, dpi = 150)
```

# 9. algae vs inverts

```{r}
alg_inv_df <- delta_algae_continual %>% 
  select(sample_ID, control_algae, continual_algae, delta_continual_algae) %>% 
  left_join(., delta_invert_continual, by = "sample_ID")

alg_inv_df %>% 
  ggplot(aes(x = delta_continual_algae, y = delta_continual_inverts)) +
  geom_point(aes(col = comp_3yrs))
```


# 10. annualized data for algae species from rank abundance


```{r}
# total biomass
algae_spp_biomass <- biomass %>% 
  filter(sp_code %in% c("PTCA", "CO", "CC", "EGME", "CYOS", "DL", "R")) %>% 
  # # make a new column for after dates
  after_dates_column() %>% 
  # make a new column for during and after and set factor levels
  exp_dates_column()

# delta biomass
delta_algae_spp_biomass <- algae_spp_biomass %>% 
  dplyr::select(site, year, month, treatment, date, exp_dates, sp_code, dry_gm2) %>% 
  group_by(site, exp_dates, year, month, treatment, date, sp_code) %>% 
  summarize(total_dry = sum(dry_gm2)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = treatment, values_from = total_dry) %>% 
  mutate(delta_annual = annual - control,
         delta_continual = continual - control) 

delta_algae_spp_annual <- delta_algae_spp_biomass %>% 
  dplyr::select(site, year, month, date, sp_code, control, annual, delta_annual) %>% 
  drop_na(delta_annual) %>% 
  mutate(exp_dates = case_when(
    # after for annual removal:
    site == "aque" & date >= aque_after_date_annual ~ "after",
    site == "napl" & date >= napl_after_date_annual ~ "after",
    site == "ivee" & date >= ivee_after_date_annual ~ "after",
    site == "mohk" & date >= mohk_after_date_annual ~ "after",
    site == "carp" & date >= carp_after_date_annual ~ "after",
    # everything else is "during" the experiment
    TRUE ~ "during"
  ),
  exp_dates = fct_relevel(exp_dates, c("during", "after"))) %>% 
   # create a column for quarter
  mutate(quarter = case_when(
    month <= 3 ~ "Q1",
    month <= 6 ~ "Q2",
    month <= 9 ~ "Q3",
    TRUE ~ "Q4"
  )) %>% 
  # calculate time since start of experiment
  mutate(time_yrs = case_when(
    # AQUE, NAPL, MOHK, CARP: control and annual started in 2008
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q1" ~ year + 0.125 - 2008,
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q2" ~ year + 0.375 - 2008,
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q3" ~ year + 0.625 - 2008,
    site %in% c("aque", "napl", "mohk", "carp") & quarter == "Q4" ~ year + 0.875 - 2008, 
    # IVEE control and annual started in 2011
    site == "ivee" & quarter == "Q1" ~ year + 0.125 - 2011,
    site == "ivee" & quarter == "Q2" ~ year + 0.375 - 2011,
    site == "ivee" & quarter == "Q3" ~ year + 0.625 - 2011,
    site == "ivee" & quarter == "Q4" ~ year + 0.875 - 2011
    )) %>% 
  group_by(site) %>% 
  mutate(time_since_start = time_yrs - min(time_yrs)) %>% 
  ungroup() %>% 
  # calculate time since end of experiment
  group_by(site, exp_dates) %>% 
  # if "after", then simple: the time in years - the minimum time in years
  # if "during", then more complex: take the max time in years and add 0.25, then subtract the time in years
  mutate(time_since_end = case_when(
    exp_dates == "during" ~ -(max(time_yrs) + 0.25 - time_yrs),
    exp_dates == "after" ~ time_yrs - min(time_yrs)
  )) %>% 
  ungroup() %>% 
  left_join(., enframe(sites_full), by = c("site" = "name")) %>% 
  rename(site_full = value) %>% 
  mutate(site_full = fct_relevel(site_full, "Arroyo Quemado (AQUE)", "Naples (NAPL)", "Isla Vista (IVEE)", "Mohawk (MOHK)", "Carpinteria (CARP)")) %>% 
  # create a new column for "kelp year"
  mutate(quarter = fct_relevel(quarter, "Q2", "Q3", "Q4", "Q1")) %>% 
  mutate(kelp_year = case_when(
    quarter %in% c("Q2", "Q3", "Q4") ~ year,
    quarter == "Q1" ~ year - 1
  )) %>% 
  mutate(kelp_year = paste("kelp_", kelp_year, "-", kelp_year + 1, sep = "")) %>% 
  # create a column for the points to compare for "2 year interval"
  mutate(comp_2yrs = case_when(
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2008-2009", "kelp_2009-2010") ~ "start",
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2015-2016", "kelp_2016-2017") ~ "during", 
    site == "ivee" & kelp_year %in% c("kelp_2011-2012", "kelp_2012-2013") ~ "start",
    site == "ivee" & kelp_year %in% c("kelp_2015-2016", "kelp_2016-2017") ~ "during",
    kelp_year %in% c("kelp_2020-2021", "kelp_2021-2022") ~ "after"
  )) %>% 
  mutate(comp_2yrs = fct_relevel(comp_2yrs, "start", "during", "after")) %>% 
  # create a column for the points to compare for "3 year interval"
  mutate(comp_3yrs = case_when(
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2008-2009", "kelp_2009-2010", "kelp_2010-2011") ~ "start",
    site %in% c("aque", "napl", "mohk", "carp") & kelp_year %in% c("kelp_2014-2015", "kelp_2015-2016", "kelp_2016-2017") ~ "during", 
    site == "ivee" & kelp_year %in% c("kelp_2011-2012", "kelp_2012-2013", "kelp_2013-2014") ~ "start",
    site == "ivee" & kelp_year %in% c("kelp_2014-2015", "kelp_2015-2016", "kelp_2016-2017") ~ "during",
    kelp_year %in% c("kelp_2019-2020", "kelp_2020-2021", "kelp_2021-2022") ~ "after"
  )) %>% 
  mutate(comp_3yrs = fct_relevel(comp_3yrs, "start", "during", "after"))
```

```{r}
algae_spp_annual_means <- delta_algae_spp_annual %>% 
  group_by(site, sp_code, kelp_year) %>% 
  mutate(mean_delta = mean(delta_annual), 
         mean_tse = mean(time_since_end),
         se_delta = se(delta_annual)) %>% 
  dplyr::select(site, site_full, kelp_year, sp_code, mean_delta, mean_tse, exp_dates, se_delta) %>% 
  unique() %>% 
  full_join(., site_quality, by = "site")

algae_spp_annual_after_means <- algae_spp_annual_means %>% 
  filter(exp_dates == "after")

linear_model_sel_during <- lm(mean_delta ~ mean_tse + quality + sp_code + mean_tse*quality + mean_tse*sp_code + sp_code*quality, data = (algae_spp_annual_means %>% filter(exp_dates == "during")), na.action = na.pass)
summary(linear_model_sel_during)
plot(simulateResiduals(linear_model_sel_during))
# ggeffects
predicted_during <- ggpredict(linear_model_sel_during, terms = ~ mean_tse + quality + sp_code + mean_tse*quality + mean_tse*sp_code + sp_code*quality, type = "fixed") %>% 
  rename("quality" = group) %>% 
  rename("sp_code" = facet)

linear_model <- lm(mean_delta ~ mean_tse + quality + sp_code + mean_tse*quality + mean_tse*sp_code + sp_code*quality, data = algae_spp_annual_after_means, na.action = na.pass)
dredge(linear_model) %>% 
  model.sel() %>% 
  gt()
linear_model_sel <- glm(mean_delta ~ mean_tse + quality + sp_code + mean_tse*quality + mean_tse*sp_code + sp_code*quality, data = algae_spp_annual_after_means, na.action = na.pass)
summary(linear_model_sel)
plot(simulateResiduals(linear_model_sel))
# ggeffects
predicted <- ggpredict(linear_model_sel, terms = ~ mean_tse + quality + sp_code + mean_tse*quality + mean_tse*sp_code + sp_code*quality, type = "fixed") %>% 
  rename("quality" = group) %>% 
  rename("sp_code" = facet)
# emmeans
grid <- ref_grid(linear_model_sel, cov.keep = c("mean_tse", "quality", "sp_code"))
emm <- emmeans(grid, spec = c("mean_tse", "quality", "sp_code"), level = 0.95) %>% 
  data.frame(.)

annual_algae_spp_sitequality_ggpredict <- ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  # raw data: means and error bars
  facet_wrap(~sp_code+quality, ncol = 3) +
  geom_point(data = algae_spp_annual_means, aes(x = mean_tse, y = mean_delta, shape = exp_dates, col = sp_code), alpha = 0.6) +
  scale_shape_manual(values = c("during" = 1, "after" = 16), guide = "none") +
  # predicted values: during
  geom_ribbon(data = predicted_during, aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high, fill = sp_code), alpha = 0.2) +
  geom_line(data = predicted_during, aes(x = x, y = predicted, group = sp_code, col = sp_code), size = 1) +
  # predicted values: after
  geom_ribbon(data = predicted, aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high, fill = sp_code), alpha = 0.2, show.legend = TRUE) +
  geom_line(data = predicted, aes(x = x, y = predicted, group = sp_code, col = sp_code), size = 1) +
  # theme
  theme_bw() + 
  theme(axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10),
        legend.position = "none") +
  labs(x = "Time since end of experiment", y = "\U0394 biomass (treatment - control)",
       title = "Focal algal species",
       caption = "ggpredict")

ggsave(here::here("figures", "algae_biomass_ts-grid.jpg"), annual_algae_spp_sitequality_ggpredict, 
       height = 16, width = 8, dpi = 300)

annual_algae_sitequality_emmeans <- ggplot() +
  geom_hline(yintercept = 0, lty = 2) +
  facet_wrap(~quality, nrow = 1) +
  geom_point(data = algae_spp_annual_means, aes(x = mean_tse, y = mean_delta, color = exp_dates, shape = site)) +
  scale_color_manual(values = c("during" = "grey", "after" = "black"), guide = "none") +
  # predicted values
  geom_ribbon(data = emm, aes(x = mean_tse, y = emmean, ymin = lower.CL, ymax = upper.CL, fill = sp_code), alpha = 0.2, show.legend = FALSE) +
  geom_line(data = emm, aes(x = mean_tse, y = emmean, group = sp_code)) +
  theme_bw() + 
  theme(axis.title = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10)) +
  labs(x = "Time since end of experiment", y = "\U0394 biomass (treatment - control)",
       title = "Focal algal species", 
       caption = "emmeans")
```

